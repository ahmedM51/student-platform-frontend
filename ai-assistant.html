<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ | Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
    <meta name="description" content="Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø§Øª ÙÙˆØ±ÙŠØ© Ø¹Ù† Ø£Ø³Ø¦Ù„ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ù† Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ.">
    <meta name="keywords" content="Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ, Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªØ¹Ù„ÙŠÙ…ÙŠ, Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©, Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø©, Ù…Ø³Ø§Ø¹Ø¯ Ø·Ù„Ø§Ø¨ÙŠ, ØªØ¹Ù„Ù… ØªÙØ§Ø¹Ù„ÙŠ">
    <meta name="author" content="ÙØ±ÙŠÙ‚ Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <meta property="og:description" content="Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø°ÙƒÙŠ ÙŠØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙƒ ÙˆÙŠÙ†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ù† Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://student-platform-frontend.vercel.app/ai-assistant.html">
    <meta property="og:site_name" content="Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <meta property="og:locale" content="ar_SA">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://student-platform-frontend.vercel.app/ai-assistant.html">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .chat-message { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        .message { margin-bottom: 1rem; }
        .user-message {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 0.25rem 1rem;
            margin-left: 2rem;
            text-align: right;
            max-width: 85%;
            word-wrap: break-word;
        }
        .ai-message {
            background: #f3f4f6;
            color: #374151;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 1rem 0.25rem;
            margin-right: 2rem;
            max-width: 85%;
            word-wrap: break-word;
        }
        /* Custom scrollbar for chat area */
        #chatArea::-webkit-scrollbar {
            width: 8px;
        }
        #chatArea::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
        #chatArea::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button onclick="window.location.href='index.html'" class="text-gray-600 hover:text-gray-900 ml-4">
                        <i class="fas fa-arrow-right text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900 mr-4">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span id="userEmail" class="text-sm text-gray-600"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-sign-out-alt ml-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Q&A Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-comments text-blue-500 ml-3"></i>
                    Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
                </h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©:</label>
                    <select id="qaLectureSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="enableQA()">
                        <option value="">-- Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© --</option>
                    </select>
                </div>

                <div id="chatArea" class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto mb-4 border">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ§Ø³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ØªØ±ÙŠØ¯</p>
                    </div>
                </div>

                <div class="flex space-x-2 space-x-reverse">
                    <input type="text" id="questionInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." 
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           disabled onkeypress="handleEnterKey(event)">
                    <button id="askBtn" onclick="sendMessage()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Quiz Section -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-clipboard-question ml-3"></i>
                        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±
                    </h2>
                    <p class="text-green-100 mt-2">Ø£Ù†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø± ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>
                </div>
                
                <div class="p-6">
                    <!-- Quiz Settings -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</label>
                            <select id="quizLectureSelect" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent h-32">
                            </select>
                            <p class="text-xs text-gray-500 mt-1">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ø¹ Ctrl</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                <select id="questionType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="multiple">Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯</option>
                                    <option value="truefalse">ØµØ­ ÙˆØ®Ø·Ø£</option>
                                    <option value="mixed">Ù…Ø®ØªÙ„Ø·</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                <select id="questionCount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="5">5 Ø£Ø³Ø¦Ù„Ø©</option>
                                    <option value="10" selected>10 Ø£Ø³Ø¦Ù„Ø©</option>
                                    <option value="15">15 Ø³Ø¤Ø§Ù„</option>
                                    <option value="20">20 Ø³Ø¤Ø§Ù„</option>
                                    <option value="25">25 Ø³Ø¤Ø§Ù„</option>
                                    <option value="30">30 Ø³Ø¤Ø§Ù„</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button id="generateQuizBtn" onclick="generateQuiz()" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-magic ml-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ÙÙˆØ±ÙŠ
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Display Area -->
        <div id="quizContainer" class="hidden mt-8">
            <!-- Quiz content will be injected here -->
        </div>

        <!-- Quiz Results -->
        <div id="quizResults" class="hidden mt-8">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-trophy ml-3"></i>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </h2>
                </div>
                
                <div class="p-6" id="resultsContent">
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        // Gemini API Configuration
        // ğŸ›‘ ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø§Ø¦Ø¨ Ø¨Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­.
        // Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ø§Ù„Ø¢Ù† Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… ÙˆØ­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø§Øª Gemini.
        const GEMINI_API_KEY ="AIzaSyBp5fSEvq0yoTANjQlxpstYMmG2fT1EScs";
        
        let currentUser = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];

        /**
         * Get AI text response from Gemini API for Q&A, grounded in lecture context.
         * @param {string} textPrompt - User's question or prompt
         * @param {object} lectureContext - Lecture context for educational responses
         * @returns {Promise<string>} The generated text response.
         */
        async function getGeminiQaResponse(textPrompt, lectureContext) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            // Build comprehensive context from lecture data
            let lectureContent = '';
            if (lectureContext.full_content) {
                lectureContent = lectureContext.full_content;
            } else {
                // Fallback compilation if full_content is missing
                lectureContent = `Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lectureContext.title}\n`;
                if (lectureContext.description) lectureContent += `ÙˆØµÙ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lectureContext.description}\n`;
                if (lectureContext.file_content) lectureContent += `Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù: ${lectureContext.file_content}\n`;
                if (lectureContext.notes) lectureContent += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: ${lectureContext.notes}\n`;
            }

            // System Instruction (Persona and Rules) - **CRITICAL FOR GROUNDING**
            const systemInstructionText = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø°ÙƒÙŠ ÙˆØ®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø¯Ù‚Ø© ÙˆØ§Ø¹ØªÙ…Ø§Ø¯Ø§Ù‹ Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø°ÙŠ ÙŠØªÙ… ØªØ²ÙˆÙŠØ¯Ùƒ Ø¨Ù‡.
            
            **Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:**
            1.  **Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰ Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©**: Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø¯Ù… ÙÙ‚Ø·.
            2.  **Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©**: Ù‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø© Ø´Ø§Ù…Ù„Ø©ØŒ Ù…ÙØµÙ„Ø©ØŒ ÙˆØ¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰ ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø·Ù„Ø§Ø¨. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (Ù†Ù‚Ø§Ø·ØŒ ÙÙ‚Ø±Ø§ØªØŒ Ø¹Ù†Ø§ÙˆÙŠÙ†) Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.
            3.  **Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù„ØºØ§Øª**: Ù‚Ù… Ø¨Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ ÙˆÙ„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø£Ùˆ Ø§Ù„ÙÙ‚Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±.
            4.  **Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬**: ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¨ÙˆØ¶ÙˆØ­ØŒ Ø§Ø³ØªÙ†ØªØ¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.
            5.  **Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø©**: Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ù„Ù… ØªØªÙˆÙØ± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¥Ø·Ù„Ø§Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ ÙˆÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© **ÙŠØ¬Ø¨ Ø£Ù† ØªØ´ÙŠØ±** Ø¥Ù„Ù‰ Ø£Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØªØ£ØªÙŠ Ù…Ù† Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆÙ„ÙŠØ³ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.`;

            // User Query Content
            const userContentParts = [
                {
                    text: `Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…ØªØ§Ø­ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„ÙŠÙ‡:
======================================
${lectureContent}
======================================`
                },
                {
                    text: `Ø³Ø¤Ø§Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨: ${textPrompt}`
                }
            ];

            const payload = {
                contents: [{ parts: userContentParts }],
                systemInstruction: { parts: [{ text: systemInstructionText }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
                }

                const result = await response.json();
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponse) {
                    return aiResponse;
                } else {
                    throw new Error('Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¯.');
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                return `Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ: ${error.message}`;
            }
        }

        /**
         * Get AI structured JSON response for Quiz generation.
         */
        async function getGeminiQuiz(lectureContent, questionCount, questionType) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            // Define the JSON schema for the quiz structure
            const quizSchema = {
                type: "OBJECT",
                properties: {
                    title: { type: "STRING", description: "Ø¹Ù†ÙˆØ§Ù† Ø¬Ø°Ø§Ø¨ ÙˆÙ…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±." },
                    questions: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                question: { type: "STRING", description: "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„." },
                                type: { type: "STRING", description: "Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„: 'multiple' Ø£Ùˆ 'truefalse'." },
                                options: { 
                                    type: "ARRAY", 
                                    items: { type: "STRING" },
                                    description: "Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ù…Ø«Ù„Ø§Ù‹: Ø£) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ØŒ Ø¨) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠØŒ Ø¬) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«ØŒ Ø¯) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹) Ø£Ùˆ (ØµØ­ØŒ Ø®Ø·Ø£)."
                                },
                                correct: { type: "INTEGER", description: "Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (0ØŒ 1ØŒ 2ØŒ 3 Ø£Ùˆ 0ØŒ 1)." }
                            },
                            required: ["question", "type", "options", "correct"]
                        }
                    }
                },
                required: ["title", "questions"]
            };

            let questionTypeInstructions = '';
            if (questionType === 'multiple') {
                questionTypeInstructions = `Ø£Ù†Ø´Ø¦ ${questionCount} Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ (multiple) Ø¨Ù€ 4 Ø®ÙŠØ§Ø±Ø§Øª Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„.`;
            } else if (questionType === 'truefalse') {
                questionTypeInstructions = `Ø£Ù†Ø´Ø¦ ${questionCount} Ø³Ø¤Ø§Ù„ ØµØ­ ÙˆØ®Ø·Ø£ (truefalse) Ø¨Ø®ÙŠØ§Ø±ÙŠÙ† (ØµØ­ Ø£Ùˆ Ø®Ø·Ø£) Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„.`;
            } else if (questionType === 'mixed') {
                const multipleCount = Math.ceil(questionCount * 0.6);
                const trueFalseCount = questionCount - multipleCount;
                questionTypeInstructions = `Ø£Ù†Ø´Ø¦ ${multipleCount} Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ (multiple) Ùˆ ${trueFalseCount} Ø³Ø¤Ø§Ù„ ØµØ­ ÙˆØ®Ø·Ø£ (truefalse).`;
            }

            const quizPrompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ©. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø­ØµØ±Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…Ù‚Ø¯Ù….

            **Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:**
            - **Ø§Ù„Ù…Ø­ØªÙˆÙ‰**: ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ø³ØªÙ…Ø¯Ø© Ù…Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚ Ø£Ø¯Ù†Ø§Ù‡.
            - **Ø§Ù„Ø¹Ø¯Ø¯ ÙˆØ§Ù„Ù†ÙˆØ¹**: ${questionTypeInstructions}
            - **Ø§Ù„ØªÙ†Ø³ÙŠÙ‚**: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø¨ØµÙŠØºØ© JSON ØµØ§Ù„Ø­ ÙŠØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯ØŒ ÙˆÙ„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„Ù€ JSON.

            Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©:
            ======================================
            ${lectureContent}
            ======================================`;

            const payload = {
                contents: [{ parts: [{ text: quizPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: quizSchema
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    return JSON.parse(jsonText);
                } else {
                    throw new Error('Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ JSON ØµØ§Ù„Ø­.');
                }
            } catch (error) {
                console.error("Gemini API Error (Quiz):", error);
                throw new Error(`ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Gemini Ø£Ùˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${error.message}`);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Supabase
                if (window.initializeSupabase) {
                    await window.initializeSupabase();
                }
                
                // Wait for authentication
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check authentication
                const isAuthenticated = await checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                // Load user data and lectures
                await loadUserData();
                await loadLectures();
                
                console.log('âœ… AI Assistant initialized successfully');
                
            } catch (error) {
                console.error('âŒ Error initializing AI assistant:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ', 'error');
            }
        });

        // Check authentication
        async function checkAuthentication() {
            try {
                if (!window.supabaseClient || !window.supabaseAuth) {
                    return false;
                }
                
                const { data } = await window.supabaseAuth.getSession();
                if (data?.session?.user) {
                    currentUser = data.session.user;
                    localStorage.setItem('userEmail', currentUser.email);
                    localStorage.setItem('userId', currentUser.id);
                    localStorage.setItem('userName', currentUser.user_metadata?.full_name || currentUser.email.split('@')[0]);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Authentication check error:', error);
                return false;
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const userName = localStorage.getItem('userName') || currentUser?.email?.split('@')[0] || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                // const userEmail = localStorage.getItem('userEmail') || currentUser?.email || ''; // Unused variable
                document.getElementById('userEmail').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${userName}`;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load lectures for dropdown
        async function loadLectures() {
            try {
                if (!currentUser) {
                    console.warn('No current user available');
                    return;
                }

                // Load subjects from database
                const subjectsResult = await window.supabaseDB.subjects.getByUser(currentUser.id);
                if (subjectsResult.error) {
                    console.error('Error loading subjects:', subjectsResult.error);
                    return;
                }

                const subjects = subjectsResult.data || [];
                const qaLectureSelect = document.getElementById('qaLectureSelect');
                const quizLectureSelect = document.getElementById('quizLectureSelect');
                
                qaLectureSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© --</option>';
                quizLectureSelect.innerHTML = ''; // Keep quiz empty until data is loaded

                // Load lectures for each subject
                let hasLectures = false;
                for (const subject of subjects) {
                    const lecturesResult = await window.supabaseDB.lectures.getBySubject(subject.id);
                    if (lecturesResult.data && lecturesResult.data.length > 0) {
                        hasLectures = true;
                        lecturesResult.data.forEach(lecture => {
                            const lectureTitle = `${lecture.title} - ${subject.name}`;

                            // Add to Q&A dropdown
                            const qaOption = document.createElement('option');
                            qaOption.value = lecture.id;
                            qaOption.textContent = lectureTitle;
                            qaLectureSelect.appendChild(qaOption);

                            // Add to Quiz dropdown
                            const quizOption = document.createElement('option');
                            quizOption.value = lecture.id;
                            quizOption.textContent = lectureTitle;
                            quizLectureSelect.appendChild(quizOption);
                        });
                    }
                }

                if (!hasLectures) {
                    const noLectureText = '<option value="" disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…ØªØ§Ø­Ø© - Ø£Ø¶Ù Ù…Ø­Ø§Ø¶Ø±Ø§Øª</option>';
                    qaLectureSelect.innerHTML = noLectureText;
                    quizLectureSelect.innerHTML = noLectureText;
                } else {
                     // Add a default selection prompt for quiz selection if needed
                     // Not necessary for multi-select, but helpful for single select Q&A
                }

                console.log('âœ… Lectures loaded from database');

            } catch (error) {
                console.error('âŒ Error loading lectures:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª', 'error');
            }
        }

        // Enable Q&A when lecture is selected
        function enableQA() {
            const lectureId = document.getElementById('qaLectureSelect').value;
            const questionInput = document.getElementById('questionInput');
            const askBtn = document.getElementById('askBtn');
            const chatArea = document.getElementById('chatArea');
            
            if (lectureId) {
                questionInput.disabled = false;
                askBtn.disabled = false;
                
                chatArea.innerHTML = `
                    <div class="ai-message chat-message">
                        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ù„Ù‚Ø¯ Ø§Ø®ØªØ±Øª Ù…Ø­Ø§Ø¶Ø±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø·Ø±Ø­ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.</p>
                    </div>
                `;
            } else {
                questionInput.disabled = true;
                askBtn.disabled = true;
                chatArea.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ§Ø³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ØªØ±ÙŠØ¯</p>
                    </div>
                `;
            }
            scrollToBottom();
        }

        // Enable quiz generation when lectures are selected
        document.getElementById('quizLectureSelect').addEventListener('change', function() {
            const selectedLectures = Array.from(this.selectedOptions);
            document.getElementById('generateQuizBtn').disabled = selectedLectures.length === 0;
        });

        // Handle Enter key for questions
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('questionInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const lectureSelect = document.getElementById('qaLectureSelect');
            if (!lectureSelect.value) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¶Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message typing-indicator-wrapper';
            typingDiv.innerHTML = `
                <div class="ai-message">
                    <div class="flex items-center">
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="mr-2">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙƒØªØ¨...</span>
                    </div>
                </div>
            `;
            document.getElementById('chatArea').appendChild(typingDiv);
            scrollToBottom();

            try {
                const lectureId = lectureSelect.value;
                
                // Get lecture content from database including file content
                const lectureResult = await window.supabaseDB.lectures.getWithContent(lectureId);
                const lecture = lectureResult.data;
                
                if (!lecture) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©');
                }

                // Generate AI response using the updated grounded function
                const response = await getGeminiQaResponse(message, lecture);
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add AI response
                addMessage(response, 'ai');
                
            } catch (error) {
                console.error('Error generating response:', error);
                typingDiv.remove();
                addMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø¤Ø§Ù„Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'ai');
            }
        }

        // Generate quiz
        async function generateQuiz() {
            const lectureSelect = document.getElementById('quizLectureSelect');
            const selectedOptions = Array.from(lectureSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }

            const generateQuizBtn = document.getElementById('generateQuizBtn');
            const originalBtnText = generateQuizBtn.innerHTML;
            generateQuizBtn.disabled = true;
            generateQuizBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';

            try {
                // Show loading state
                const quizContainer = document.getElementById('quizContainer');
                quizContainer.classList.remove('hidden');
                quizContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-magic ml-3"></i>Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                                <p class="text-gray-600">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...</p>
                                <p class="text-sm text-gray-500 mt-2">Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù</p>
                            </div>
                        </div>
                    </div>
                `;

                // Get quiz settings
                const questionCount = parseInt(document.getElementById('questionCount').value) || 10;
                const questionType = document.getElementById('questionType').value || 'multiple';
                
                // Use content from the first selected lecture for simplicity in prompting
                const lectureId = selectedOptions[0].value;
                const lectureResult = await window.supabaseDB.lectures.getWithContent(lectureId);
                const lecture = lectureResult.data;
                
                if (!lecture) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©');
                }

                // Build comprehensive lecture content for prompting
                let lectureContent = '';
                if (lecture.full_content) {
                    lectureContent = lecture.full_content;
                } else {
                    lectureContent = `Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lecture.title}\n`;
                    if (lecture.description) lectureContent += `ÙˆØµÙ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lecture.description}\n`;
                    if (lecture.file_content) lectureContent += `Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù: ${lecture.file_content}\n`;
                    if (lecture.notes) lectureContent += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: ${lecture.notes}\n`;
                }

                // Generate quiz data using the structured response function
                const quizData = await getGeminiQuiz(lectureContent, questionCount, questionType);
                
                // Reset button state
                generateQuizBtn.innerHTML = originalBtnText;
                generateQuizBtn.disabled = false;

                // Validation (minimal check before display)
                if (!quizData || !quizData.questions || quizData.questions.length === 0) {
                    throw new Error('Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.');
                }

                currentQuiz = quizData;
                currentQuestionIndex = 0;
                userAnswers = new Array(currentQuiz.questions.length).fill(-1);
                
                displayQuiz();
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
            } catch (error) {
                console.error('Error generating quiz:', error);
                
                // Reset button state
                generateQuizBtn.innerHTML = originalBtnText;
                generateQuizBtn.disabled = Array.from(lectureSelect.selectedOptions).length === 0;

                document.getElementById('quizContainer').innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-red-500 to-red-600 p-6">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-exclamation-triangle ml-3"></i>Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                            </h2>
                        </div>
                        <div class="p-6 text-center">
                            <div class="text-red-500 mb-4">
                                <i class="fas fa-exclamation-triangle text-4xl"></i>
                            </div>
                            <p class="text-red-600 mb-4">${error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'}</p>
                            <button onclick="generateQuiz()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                                <i class="fas fa-redo ml-2"></i>Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                            </button>
                        </div>
                    </div>
                `;
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }

        // Display quiz
        function displayQuiz() {
            if (!currentQuiz || !currentQuiz.questions || currentQuiz.questions.length === 0) {
                console.error('No quiz data available');
                return;
            }

            // Initialize user answers array
            if (userAnswers.length !== currentQuiz.questions.length) {
                userAnswers = new Array(currentQuiz.questions.length).fill(-1);
            }
            
            const quizArea = document.getElementById('quizContainer');
            quizArea.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-green-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-green-800">${currentQuiz.title || 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯'}</h3>
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm" id="questionCounter">
                            Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${currentQuiz.questions.length}
                        </span>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span>
                            <span class="text-sm font-medium text-green-600" id="progressPercentage">
                                ${Math.round(((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100)}%
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                            <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" 
                                 id="progressBar" style="width: ${((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>ØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ <span id="answeredCount">${userAnswers.filter(a => a !== -1).length}</span> Ù…Ù† ${currentQuiz.questions.length} Ø³Ø¤Ø§Ù„</span>
                            <span>${currentQuiz.questions.length - userAnswers.filter(a => a !== -1).length} Ø³Ø¤Ø§Ù„ Ù…ØªØ¨Ù‚ÙŠ</span>
                        </div>
                    </div>

                    <div id="questionContainer" class="mb-6">
                        ${renderQuestion(currentQuestionIndex)}
                    </div>

                    <div class="flex justify-between flex-wrap gap-3">
                        <button id="prevBtn" onclick="previousQuestion()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-right ml-2"></i>
                            Ø§Ù„Ø³Ø§Ø¨Ù‚
                        </button>
                        
                        <button id="nextBtn" onclick="nextQuestion()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors flex-1 min-w-[120px]">
                            ${currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                                '<i class="fas fa-check ml-2"></i>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 
                                'Ø§Ù„ØªØ§Ù„ÙŠ<i class="fas fa-arrow-left mr-2"></i>'}
                        </button>
                    </div>
                </div>
            `;
            // Scroll to quiz section
            quizArea.scrollIntoView({ behavior: 'smooth' });
        }

        function renderQuestion(index) {
            const question = currentQuiz.questions[index];
            if (!question) return '';

            let optionsHtml = '';
            question.options.forEach((option, optionIndex) => {
                const isSelected = userAnswers[index] === optionIndex;
                optionsHtml += `
                    <div class="mb-3">
                        <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200'}">
                            <input type="radio" name="question_${index}" value="${optionIndex}" 
                                   onchange="selectAnswer(${index}, ${optionIndex})" 
                                   ${isSelected ? 'checked' : ''} class="ml-3">
                            <span class="text-gray-800">${option}</span>
                        </label>
                    </div>
                `;
            });

            return `
                <div class="question-content">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}: ${question.question}</h4>
                    <div class="options-container">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }

        function selectAnswer(questionIndex, answerIndex) {
            userAnswers[questionIndex] = answerIndex;
            
            // Update progress indicators immediately
            updateQuizProgress();
            
            // Add visual feedback
            const selectedOption = document.querySelector(`input[name="question_${questionIndex}"][value="${answerIndex}"]`);
            if (selectedOption) {
                const label = selectedOption.closest('label');
                // Remove previous selections
                document.querySelectorAll(`input[name="question_${questionIndex}"]`).forEach(input => {
                    const parentLabel = input.closest('label');
                    parentLabel.classList.remove('border-green-500', 'bg-green-50');
                    parentLabel.classList.add('border-gray-200');
                });
                
                // Highlight selected option
                label.classList.remove('border-gray-200');
                label.classList.add('border-green-500', 'bg-green-50');
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
                updateNavigationButtons();
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
                updateNavigationButtons();
            }
        }

        function updateQuizProgress() {
            const progressBar = document.getElementById('progressBar');
            const questionCounter = document.getElementById('questionCounter');
            const progressPercentage = document.getElementById('progressPercentage');
            const answeredCount = document.getElementById('answeredCount');
            
            if (!currentQuiz) return; // Guard against null quiz
            
            if (progressBar) {
                const progressPercent = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
                progressBar.style.width = `${progressPercent}%`;
            }
            
            if (questionCounter) {
                questionCounter.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${currentQuiz.questions.length}`;
            }
            
            if (progressPercentage) {
                progressPercentage.textContent = `${Math.round(((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100)}%`;
            }
            
            if (answeredCount) {
                const answered = userAnswers.filter(a => a !== -1).length;
                answeredCount.textContent = `${answered}`;
                
                // Update remaining count
                const remainingElement = answeredCount.parentElement.nextElementSibling;
                if (remainingElement) {
                    remainingElement.textContent = `${currentQuiz.questions.length - answered} Ø³Ø¤Ø§Ù„ Ù…ØªØ¨Ù‚ÙŠ`;
                }
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentQuestionIndex === 0;
            }
            
            if (nextBtn) {
                nextBtn.innerHTML = currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                    '<i class="fas fa-check ml-2"></i>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 
                    'Ø§Ù„ØªØ§Ù„ÙŠ<i class="fas fa-arrow-left mr-2"></i>';
            }
        }

        function finishQuiz() {
            const score = calculateScore();
            const percentage = Math.round((score / currentQuiz.questions.length) * 100);
            
            // Calculate grade
            let gradeColor = 'text-red-600';
            let gradeMessage = 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ';
            
            if (percentage >= 90) {
                gradeColor = 'text-green-600';
                gradeMessage = 'Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹! ';
            } else if (percentage >= 80) {
                gradeColor = 'text-green-600';
                gradeMessage = 'Ù…Ù…ØªØ§Ø²! ';
            } else if (percentage >= 70) {
                gradeColor = 'text-blue-600';
                gradeMessage = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! ';
            } else if (percentage >= 60) {
                gradeColor = 'text-yellow-600';
                gradeMessage = 'Ø¬ÙŠØ¯! ';
            } else if (percentage >= 50) {
                gradeColor = 'text-orange-600';
                gradeMessage = 'Ù…Ù‚Ø¨ÙˆÙ„ ';
            }
            
            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-blue-200 p-6 text-center">
                    <div class="mb-6">
                        <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h3>
                        <p class="text-gray-600">Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                        <div class="text-4xl font-bold text-blue-600">${percentage}%</div>
                        <div class="text-lg text-gray-700 mb-2">${score} Ù…Ù† ${currentQuiz.questions.length} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
                        <div class="text-lg font-medium ${gradeColor}">${gradeMessage}</div>
                    </div>
                    
                    <div class="flex gap-4 justify-center flex-wrap">
                        <button onclick="reviewAnswers()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-eye ml-2"></i>
                            Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                        </button>
                        <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-redo ml-2"></i>
                            Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            `;
            quizContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function calculateScore() {
            let score = 0;
            for (let i = 0; i < currentQuiz.questions.length; i++) {
                if (userAnswers[i] === currentQuiz.questions[i].correct) {
                    score++;
                }
            }
            return score;
        }

        function reviewAnswers() {
            let reviewHtml = `
                <div class="bg-white rounded-lg border-2 border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6 flex-wrap gap-2">
                        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-list-check ml-2"></i>
                            Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                        </h4>
                        <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-plus ml-1"></i>
                            Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
            `;

            currentQuiz.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = question.correct;
                const isCorrect = userAnswer === correctAnswer;
                const wasAnswered = userAnswer !== -1;

                // Ensure options are safe
                const correctOptionText = question.options[correctAnswer] || 'ØºÙŠØ± Ù…ØªØ§Ø­';
                const userAnswerText = wasAnswered ? (question.options[userAnswer] || 'ØºÙŠØ± Ù…ØªØ§Ø­') : 'Ù„Ù… ØªØ¬Ø¨ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„';

                reviewHtml += `
                    <div class="mb-6 p-4 border rounded-lg ${
                        !wasAnswered ? 'border-gray-300 bg-gray-50' :
                        isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'
                    }">
                        <div class="flex items-center mb-3">
                            <i class="fas ${
                                !wasAnswered ? 'fa-question-circle text-gray-500' :
                                isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'
                            } ml-2"></i>
                            <span class="font-semibold">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}</span>
                        </div>
                        <p class="font-medium mb-3">${question.question}</p>
                        <div class="text-sm space-y-2 border-t pt-3">
                            <div class="flex items-start">
                                <span class="text-gray-600 ml-2 min-w-[70px]">Ø¥Ø¬Ø§Ø¨ØªÙƒ:</span>
                                <span class="${wasAnswered && isCorrect ? 'text-green-600 font-medium' : wasAnswered ? 'text-red-600 line-through' : 'text-gray-500 italic'}">${userAnswerText}</span>
                            </div>
                            
                            ${!isCorrect || !wasAnswered ? `
                                <div class="flex items-start">
                                    <span class="text-gray-600 ml-2 min-w-[70px]">Ø§Ù„ØµØ­ÙŠØ­Ø©:</span>
                                    <span class="text-green-600 font-medium">${correctOptionText}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            reviewHtml += `
                </div>
            `;

            document.getElementById('quizContainer').innerHTML = reviewHtml;
            document.getElementById('quizContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Generate new quiz
        function generateNewQuiz() {
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            
            // Reset quiz state
            currentQuiz = null;
            currentQuestionIndex = 0;
            userAnswers = [];
            
            // Reset form (optional: keeps selected options, just resets state)
            // document.getElementById('quizLectureSelect').selectedIndex = 0;
            // document.getElementById('generateQuizBtn').disabled = true;
            
            // Scroll to quiz generation section
            document.querySelector('.bg-gradient-to-r.from-green-500').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Add message to chat
        function addMessage(message, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message`;
            
            // Create inner content with correct class
            const innerDiv = document.createElement('div');
            innerDiv.className = `${sender}-message chat-message`;
            
            // Apply line breaks for formatting
            innerDiv.innerHTML = `<p>${message.replace(/\n/g, '<br>')}</p>`;
            
            messageDiv.appendChild(innerDiv);
            chatArea.appendChild(messageDiv);
            
            // Remove any old typing indicators if they somehow persisted
            document.querySelectorAll('.typing-indicator-wrapper').forEach(el => el.remove());
            
            scrollToBottom();
        }

        // Scroll to bottom of chat area
        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white font-medium z-50 transition-all duration-300 transform translate-x-0 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animation for removal
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                notification.classList.remove('translate-x-0');
            }, 2500);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Logout function
        async function logout() {
            try {
                if (window.supabaseAuth) {
                    await window.supabaseAuth.signOut();
                }
                localStorage.clear();
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('âŒ Logout error:', error);
                window.location.href = 'auth.html';
            }
        }
    </script>
</body>
</html>

