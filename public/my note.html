<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <script>try{var t=localStorage.getItem('theme');var d=t?t==='dark':(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches);if(d){document.documentElement.classList.add('dark')}}catch(e){}</script>
    <link href="css/dark-mode.css" rel="stylesheet">
    <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ØªØ­Ù…ÙŠÙ„ Ø®Ø· Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙˆÙ„ÙƒÙ† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        /* Ø£Ù†Ù…Ø§Ø· Ø®Ø§ØµØ© Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
        .recording-pulse {
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
    <script src="js/i18n.js"></script>
    <!-- Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯ÙˆØ§Ù„ Firestore
        import { initializeFirestore, doc, collection, onSnapshot, setDoc, query, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙˆÙ‰ Ø³Ø¬Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ Ù„Ù€ Firestore
        setLogLevel('Debug');

        // Ù…ØªØºÙŠØ±Ø§Øª Firebase Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
        window.app;
        window.db;
        window.auth;
        window.userId = null;
        window.categories = []; // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
        window.notes = []; // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©

        // ** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠ: ØªØ¹Ø±ÙŠØ¶ Ø¯ÙˆØ§Ù„ Firestore Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„ÙƒØªÙ„Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø§Ù„Ø¹Ø§Ù…Ø© **
        window.firestoreCollection = collection;
        window.firestoreAddDoc = addDoc;
        window.firestoreServerTimestamp = serverTimestamp;
        window.firestoreSetDoc = setDoc;
        window.firestoreDoc = doc;


        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„ØªÙŠ ÙŠÙˆÙØ±Ù‡Ø§ Canvas (ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø¯Ø§Ø¦Ù…Ù‹Ø§)
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyBM7Y6ZEFwMOOPno1ighvtVumHB1f3keVA",
          authDomain: "pharmacy-769cb.firebaseapp.com",
          projectId: "pharmacy-769cb",
          storageBucket: "pharmacy-769cb.firebasestorage.app",
          messagingSenderId: "1024742648973",
          appId: "1:1024742648973:web:d45439f85a8e3eca0146c4",
          measurementId: "G-2EN0X2SL8P"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
         */
        async function initializeFirebase() {
            try {
                // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                window.app = initializeApp(firebaseConfig);
                window.db = initializeFirestore(window.app, { experimentalForceLongPolling: true, useFetchStreams: false });
                window.auth = getAuth(window.app);

                // 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù…ÙŠØ² Ø£Ùˆ ÙƒÙ…Ø¬Ù‡ÙˆÙ„
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-id-display').textContent = window.userId;
                        console.log("Firebase Auth Ready. User ID:", window.userId);
                        // Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©ØŒ Ø§Ø¨Ø¯Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        setupDataListeners();
                    } else {
                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù…ÙŠØ² Ø£Ùˆ Ù…Ø¬Ù‡ÙˆÙ„Ø§Ù‹
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    }
                });

                // Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('main-content').innerHTML = `
                    <div class="p-4 text-center text-red-600 bg-red-100 rounded-lg">
                        Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­.
                    </div>
                `;
            }
        }

        /**
         * Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† (onSnapshot) Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
         */
        function setupDataListeners() {
            if (!window.db || !window.userId) return;

            const baseCollectionPath = `/artifacts/${window.appId}/users/${window.userId}`;

            // 1. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø¥Ù„Ù‰ Ø§Ù„ÙØ¦Ø§Øª
            const categoriesRef = collection(window.db, `${baseCollectionPath}/categories`);
            onSnapshot(categoriesRef, (snapshot) => {
                window.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories();
            }, (error) => {
                console.error("Error listening to categories:", error);
            });

            // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const notesRef = query(collection(window.db, `${baseCollectionPath}/notes`));
            onSnapshot(notesRef, (snapshot) => {
                // ÙØ±Ø² Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­Ø³Ø¨ Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹
                window.notes = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderNotes();
            }, (error) => {
                console.error("Error listening to notes:", error);
            });
        }

        /**
         * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ÙØ¦Ø§Øª
         */
        async function initializeDefaultCategories() {
            const defaultCategories = [
                { name: 'Ø§Ø¬ØªÙ…Ø§Ø¹', icon: 'ğŸ—£ï¸', color: 'blue' },
                { name: 'Ù…Ø­Ø§Ø¶Ø±Ø©', icon: 'ğŸ“', color: 'green' },
                { name: 'Ø³ÙØ±', icon: 'âœˆï¸', color: 'purple' },
                { name: 'ÙÙƒØ±Ø© Ø³Ø±ÙŠØ¹Ø©', icon: 'ğŸ’¡', color: 'yellow' },
            ];

            const baseCollectionPath = `/artifacts/${window.appId}/users/${window.userId}`;
            const categoriesRef = collection(window.db, `${baseCollectionPath}/categories`);

            // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø£ÙŠ ÙØ¦Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙƒØ°Ù„ÙƒØŒ Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            if (window.categories.length === 0) {
                for (const cat of defaultCategories) {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© ÙƒÙ€ ID Ù„Ù„ØªÙØ±Ø¯ (ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±)
                    await setDoc(doc(categoriesRef, cat.name), cat);
                }
            }
        }

        window.onload = () => {
            initializeFirebase();
            document.getElementById('add-note-btn').onclick = () => openAddNoteModal();
            document.getElementById('close-modal-btn').onclick = () => closeAddNoteModal();
            // ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† handleNewNoteSubmission ÙÙŠ ÙƒØªÙ„Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ ØºÙŠØ± Ø§Ù„Ù†Ù…Ø·ÙŠØ©
            document.getElementById('new-note-form').onsubmit = handleNewNoteSubmission;
            // ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† handleAddCategory ÙÙŠ ÙƒØªÙ„Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ ØºÙŠØ± Ø§Ù„Ù†Ù…Ø·ÙŠØ©
            document.getElementById('add-category-btn').onclick = handleAddCategory;
            document.getElementById('record-toggle-btn').onclick = toggleRecording; // ØªØ¹ÙŠÙŠÙ† ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        };

        // Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ø¦Ù† window Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ù…ØªØ§Ø­Ø© Ù„Ù€ HTML
        window.renderCategories = renderCategories;
        window.renderNotes = renderNotes;
        window.initializeDefaultCategories = initializeDefaultCategories;
    </script>
    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const API_KEY = "AIzaSyAS3iCmoqqhSyodCeVMD7gl42Bfgz4gemk"; 
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-05-20';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;
        // Ø­Ø¯ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØª Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ† Ù„Ù€ Gemini Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ø¨ÙƒÙØ§Ø¡Ø© (5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)
        const MAX_FILE_SIZE_MB = 5; 
        const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

        // Ø­Ø§Ù„Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        let selectedCategoryFilter = 'all';

        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordedFile = null; // Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³Ø¬Ù„ Ù‡Ù†Ø§
        let recordingStartTime = 0; // Ù„Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø©

        /**
         * ØªØ­ÙˆÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Base64
         * @param {File} file - Ù…Ù„Ù Ø§Ù„ØµÙˆØª
         * @returns {Promise<string>} Base64 data string
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        /**
         * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¯Ø© Ù…Ù† Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø¥Ù„Ù‰ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ«Ø§Ù†ÙŠØ©
         * @param {number} totalSeconds - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
         * @returns {string} Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø©
         */
        function formatDuration(totalSeconds) {
            const totalSecondsRounded = Math.round(totalSeconds);
            const minutes = Math.floor(totalSecondsRounded / 60);
            const seconds = totalSecondsRounded % 60;
            if (minutes > 0) {
                return `${minutes} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ${seconds} Ø«Ø§Ù†ÙŠØ©`;
            }
            return `${seconds} Ø«Ø§Ù†ÙŠØ©`;
        }

        /**
         * Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØµÙŠ ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini API
         * @param {string} base64Audio - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØª Ø¨ØªØ±Ù…ÙŠØ² Base64
         * @param {string} mimeType - Ù†ÙˆØ¹ MIME Ù„Ù„Ù…Ù„Ù (Ù…Ø«Ù„ audio/mpeg)
         * @returns {Promise<{text: string, translation: string}>}
         */
        async function processAudioWithGemini(base64Audio, mimeType) {
            console.log(`Sending audio to Gemini. MimeType: ${mimeType}. Payload size (Base64 length): ${base64Audio.length}`);
            
            if (!API_KEY) {
                return {
                    text: 'âš ï¸ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„: ØªÙ… ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙˆÙÙŠØ± Ù…ÙØªØ§Ø­ Gemini API Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ.',
                    translation: 'âš ï¸ Ø§Ù„ØªØ±Ø¬Ù…Ø©: ÙŠØªÙ… Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ ÙƒØªØ±Ø¬Ù…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ API.',
                };
            }

            const prompt = "Please transcribe the attached audio and then provide a direct Arabic translation of the transcription. Format the response as a JSON object with two fields: 'transcription' and 'arabicTranslation'.";
            
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Audio
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "transcription": { "type": "STRING", "description": "The full transcribed text in the original language." },
                            "arabicTranslation": { "type": "STRING", "description": "The translation of the transcription into Arabic." }
                        }
                    },
                }
            };

            let lastError = null;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API response error: ${response.statusText}. Details: ${JSON.stringify(errorBody)}`);
                    }

                    const result = await response.json();
                    const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (jsonString) {
                        const parsedJson = JSON.parse(jsonString);
                        console.log("Gemini API successful.");
                        return { 
                            text: parsedJson.transcription || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Øµ Ù…Ø­ÙˆÙ‘Ù„.', 
                            translation: parsedJson.arabicTranslation || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ±Ø¬Ù…Ø© Ø¹Ø±Ø¨ÙŠØ©.' 
                        };
                    }
                    throw new Error("Invalid response structure from Gemini or empty content.");

                } catch (error) {
                    lastError = error;
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${1000 * (2 ** i)}ms...`, error);
                    await new Promise(resolve => setTimeout(resolve, 1000 * (2 ** i)));
                }
            }
            console.error("All retries failed.", lastError);
            throw new Error(`Failed to process audio after ${MAX_RETRIES} attempts. Last error: ${lastError?.message || "Unknown error"}`);
        }

        /**
         * Ø¨Ø¯Ø¡ Ø£Ùˆ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
         */
        async function toggleRecording() {
            const recordBtn = document.getElementById('record-toggle-btn');
            const audioUploadInput = document.getElementById('audio-upload');
            const recordStatus = document.getElementById('record-status');
            const recordingTime = document.getElementById('recording-time');
            const audioFileNameDisplay = document.getElementById('audio-file-name');


            if (!isRecording) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    // Ù†Ø³ØªØ®Ø¯Ù… webm/ogg Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø£ÙØ¶Ù„ Ù…Ø¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ÙˆGemini
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); 
                    audioChunks = [];
                    recordedFile = null; // Ù…Ø³Ø­ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚
                    audioUploadInput.disabled = true; // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                    audioFileNameDisplay.classList.add('hidden');
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† File ÙˆÙ‡Ù…ÙŠ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                        recordedFile = new File([audioBlob], `recorded-note-${Date.now()}.webm`, { type: mediaRecorder.mimeType });
                        
                        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
                        audioFileNameDisplay.textContent = `ØªÙ… ØªØ³Ø¬ÙŠÙ„: ${formatDuration((Date.now() - recordingStartTime) / 1000)}`;
                        audioFileNameDisplay.classList.remove('hidden');

                        // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    recordingStartTime = Date.now();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    recordBtn.innerHTML = '<span class="recording-pulse">ğŸ”´</span> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
                    recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    recordBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                    recordStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
                    recordStatus.classList.add('text-red-500');
                    
                    // Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª
                    let seconds = 0;
                    window.recordingInterval = setInterval(() => {
                        seconds++;
                        recordingTime.textContent = formatDuration(seconds);
                    }, 1000);

                    showMessage("Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ø¯Ø« Ø¨ÙˆØ¶ÙˆØ­.", 'bg-blue-500');

                } catch (error) {
                    console.error("Error accessing microphone:", error);
                    showMessage(`ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø·Ø§Ø¡ Ø¥Ø°Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ù…ØªØµÙØ­: ${error.message}`, 'bg-red-600');
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                    isRecording = false;
                    recordBtn.innerHTML = '<span class="ml-1">ğŸ¤</span> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
                    recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    recordBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                }

            } else {
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                mediaRecorder.stop();
                isRecording = false;
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª
                clearInterval(window.recordingInterval);

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                recordBtn.innerHTML = '<span class="ml-1">ğŸ¤</span> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                audioUploadInput.disabled = true; // ÙŠØ¨Ù‚Ù‰ Ù…Ø¹Ø·Ù„Ø§Ù‹ Ù„Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù„Ù Ù…ÙØ³Ø¬Ù„
                recordStatus.textContent = 'ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù. Ø¬Ø§Ù‡Ø² Ù„Ù„Ø­ÙØ¸.';
                recordStatus.classList.remove('text-red-500');
                
                showMessage("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.", 'bg-green-600');
            }
        }

        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©
         */
        async function handleNewNoteSubmission(e) {
            e.preventDefault();
            
            const form = e.target;
            const categoryId = form.elements['category-select'].value;
            const submitButton = form.elements['submit-note-btn'];
            const loadingIndicator = document.getElementById('loading-spinner');
            
            // ØªØ­Ø¯ÙŠØ¯ Ù…ØµØ¯Ø± Ø§Ù„Ù…Ù„Ù
            let sourceFile = null;
            
            const uploadedFile = form.elements['audio-upload'].files[0];
            
            // Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙØ­Ù…Ù‘ÙÙ„ØŒ Ø«Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙØ³Ø¬Ù‘ÙÙ„
            if (uploadedFile) {
                sourceFile = uploadedFile;
            } else if (recordedFile) {
                sourceFile = recordedFile;
            } else {
                showMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ù…Ø§ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø£Ùˆ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©.", 'bg-red-500');
                return;
            }

            if (!categoryId) {
                showMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.", 'bg-red-500');
                return;
            }
            if (!window.userId) {
                showMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….", 'bg-red-500');
                return;
            }
            if (isRecording) {
                 showMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.", 'bg-red-500');
                 return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
            if (sourceFile.size > MAX_FILE_SIZE_BYTES) {
                showMessage(`Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (${(sourceFile.size / 1024 / 1024).toFixed(2)}MB) ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ (${MAX_FILE_SIZE_MB}MB). Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚Ø·Ø¹ Ø£Ù‚ØµØ± Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø£ØµØºØ±.`, 'bg-red-500');
                return;
            }

            submitButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Base64
                const base64Audio = await fileToBase64(sourceFile);
                const mimeType = sourceFile.type || 'audio/webm'; 

                // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini
                const results = await processAudioWithGemini(base64Audio, mimeType);

                // 3. Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙÙŠ Firestore
                const baseCollectionPath = `/artifacts/${window.appId}/users/${window.userId}`;
                // ** Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ø§Ù… Ù„Ù€ collection **
                const notesRef = window.firestoreCollection(window.db, `${baseCollectionPath}/notes`);
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø©
                const durationSeconds = (Date.now() - recordingStartTime) / 1000;
                const durationDisplay = formatDuration(durationSeconds);
                
                const newNote = {
                    categoryId: categoryId,
                    audioFileName: sourceFile.name,
                    duration: durationDisplay,
                    transcription: results.text,
                    translation: results.translation,
                    // ** Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ø§Ù… Ù„Ù€ serverTimestamp **
                    createdAt: window.firestoreServerTimestamp(),
                };

                // ** Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ø§Ù… Ù„Ù€ addDoc **
                await window.firestoreAddDoc(notesRef, newNote);
                showMessage("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø©.", 'bg-green-600');
                closeAddNoteModal();

            } catch (error) {
                console.error("Submission Error:", error);
                showMessage(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©. Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: ${error.message}. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….`, 'bg-red-500');
            } finally {
                submitButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©
         */
        async function handleAddCategory() {
            const categoryNameInput = document.getElementById('new-category-name');
            const newName = categoryNameInput.value.trim();

            if (!newName) {
                showMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„ÙØ¦Ø©.", 'bg-red-500');
                return;
            }

            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ÙØ¦Ø©
            if (window.categories.some(cat => cat.name === newName)) {
                showMessage("Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„.", 'bg-yellow-500');
                return;
            }

            try {
                const baseCollectionPath = `/artifacts/${window.appId}/users/${window.userId}`;
                // ** Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ø§Ù… Ù„Ù€ collection **
                const categoriesRef = window.firestoreCollection(window.db, `${baseCollectionPath}/categories`);
                
                const newCategory = { 
                    name: newName, 
                    icon: 'ğŸ”–', // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    color: 'pink' // Ù„ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ
                };
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© ÙƒÙ€ ID Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙØ±Ø¯
                // ** Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù€ setDoc Ùˆ doc **
                await window.firestoreSetDoc(window.firestoreDoc(categoriesRef, newName), newCategory); 
                showMessage(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© "${newName}" Ø¨Ù†Ø¬Ø§Ø­!`, 'bg-indigo-500');
                categoryNameInput.value = '';

            } catch (error) {
                console.error("Error adding category:", error);
                showMessage(`ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©: ${error.message}`, 'bg-red-500');
            }
        }

        /**
         * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø¯ÙŠÙ„ Ù„Ù€ alert)
         */
        function showMessage(message, bgColor) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `${bgColor} text-white p-3 rounded-lg fixed top-4 right-4 z-50 shadow-xl transition-opacity duration-300`;
            messageBox.classList.remove('opacity-0', 'pointer-events-none');
            
            setTimeout(() => {
                messageBox.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        // ------------------ Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ------------------

        /**
         * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
         */
        function renderCategories() {
            const categoriesContainer = document.getElementById('categories-list');
            const categorySelect = document.getElementById('category-select');
            
            categoriesContainer.innerHTML = '';
            categorySelect.innerHTML = `<option value="" disabled selected>${t('mynote.form.choose_category')}</option>`;
            
            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„"
            categoriesContainer.innerHTML += `
                <button onclick="setSelectedCategoryFilter('all')" class="p-2 w-full text-right text-sm rounded-lg transition duration-200 ${selectedCategoryFilter === 'all' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                    <span class="ml-2">ğŸ“‚</span> ${t('mynote.sidebar.all')}
                </button>
            `;

            window.categories.forEach(cat => {
                // Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ù„Ù„ØªØµÙÙŠØ©)
                categoriesContainer.innerHTML += `
                    <button onclick="setSelectedCategoryFilter('${cat.id}')" class="p-2 w-full text-right text-sm rounded-lg transition duration-200 ${selectedCategoryFilter === cat.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                        <span class="ml-2">${cat.icon || 'ğŸ”–'}</span> ${cat.name}
                    </button>
                `;
                
                // Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©)
                categorySelect.innerHTML += `<option value="${cat.id}">${cat.icon || 'ğŸ”–'} ${cat.name}</option>`;
            });

            // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©
            if (window.categories.length === 0 && window.userId) {
                initializeDefaultCategories();
            }
            
            renderNotes(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø§Øª
        }

        window.setSelectedCategoryFilter = (categoryId) => {
            selectedCategoryFilter = categoryId;
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
            renderCategories(); 
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
            renderNotes(); 
        };

        /**
         * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯
         */
        function renderNotes() {
            const notesContainer = document.getElementById('notes-list');
            notesContainer.innerHTML = '';
            
            const filteredNotes = window.notes.filter(note => 
                selectedCategoryFilter === 'all' || note.categoryId === selectedCategoryFilter
            );

            if (filteredNotes.length === 0) {
                notesContainer.innerHTML = `
                    <div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-md" data-i18n="mynote.empty">
                        ${t('mynote.empty')}
                    </div>
                `;
                return;
            }

            filteredNotes.forEach(note => {
                const category = window.categories.find(c => c.id === note.categoryId);
                const categoryName = category ? category.name : 'ÙØ¦Ø© Ù…Ø­Ø°ÙˆÙØ©';
                const categoryIcon = category ? category.icon : 'â“';
                const colorClass = category?.color || 'gray';
                
                // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
                const colorMap = {
                    'blue': 'bg-blue-100 text-blue-700 border-blue-500',
                    'green': 'bg-green-100 text-green-700 border-green-500',
                    'purple': 'bg-purple-100 text-purple-700 border-purple-500',
                    'yellow': 'bg-yellow-100 text-yellow-700 border-yellow-500',
                    'pink': 'bg-pink-100 text-pink-700 border-pink-500',
                    'gray': 'bg-gray-100 text-gray-700 border-gray-500'
                };
                const tagColorClass = colorMap[colorClass] || colorMap['gray'];

                const noteCard = `
                    <div class="bg-white p-4 rounded-xl shadow-lg border-r-4 border-${colorClass}-500">
                        <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ÙØ¦Ø© -->
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold text-gray-800">${note.audioFileName}</h3>
                            <span class="text-xs font-medium px-3 py-1 ${tagColorClass} rounded-full">
                                ${categoryIcon} ${categoryName}
                            </span>
                        </div>
                        
                        <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¯Ø© -->
                        <p class="text-xs text-gray-500 mb-4">
                            ${note.createdAt ? new Date(note.createdAt.toDate()).toLocaleString('ar-EG') : 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...'} | Ø§Ù„Ù…Ø¯Ø©: ${note.duration}
                        </p>

                        <!-- Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„ -->
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="font-semibold text-sm text-gray-700 mb-1 flex items-center">
                                <span class="ml-1 text-xl">ğŸ“</span> ${t('mynote.note.transcription')}
                            </p>
                            <p class="text-sm text-gray-600">${note.transcription || 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...'}</p>
                        </div>
                        
                        <!-- Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© -->
                        <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                            <p class="font-semibold text-sm text-indigo-800 mb-1 flex items-center">
                                <span class="ml-1 text-xl">ğŸŒ</span> ${t('mynote.note.translation')}
                            </p>
                            <p class="text-sm text-indigo-700">${note.translation || 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø©...'}</p>
                        </div>
                    </div>
                `;
                notesContainer.innerHTML += noteCard;
            });
        }

        /**
         * ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
         */
        function openAddNoteModal() {
            document.getElementById('add-note-modal').classList.remove('hidden');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            recordedFile = null; 
            document.getElementById('audio-upload').value = ''; // Ù…Ø³Ø­ Ù…Ù„Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„
            document.getElementById('audio-upload').disabled = false; // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            document.getElementById('audio-file-name').classList.add('hidden');
            document.getElementById('recording-time').textContent = '0 Ø«Ø§Ù†ÙŠØ©';
            document.getElementById('record-status').textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„';
            document.getElementById('record-status').classList.remove('text-red-500');

            // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const recordBtn = document.getElementById('record-toggle-btn');
            recordBtn.innerHTML = '<span class="ml-1">ğŸ¤</span> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
            recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            recordBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');

            if (isRecording) {
                 mediaRecorder.stop();
                 isRecording = false;
                 clearInterval(window.recordingInterval);
            }
        }

        function closeAddNoteModal() {
            document.getElementById('add-note-modal').classList.add('hidden');
            document.getElementById('new-note-form').reset();
             // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù…Ø§Ø²Ø§Ù„ ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            if (isRecording && mediaRecorder) {
                mediaRecorder.stop();
                isRecording = false;
                clearInterval(window.recordingInterval);
            }
             // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            recordedFile = null; 
            document.getElementById('audio-upload').disabled = false;
            document.getElementById('audio-file-name').classList.add('hidden');
        }
    </script>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ø¨Ø¯ÙŠÙ„ Ù„Ù€ alert) -->
    <div id="message-box" class="opacity-0 pointer-events-none transition duration-300"></div>

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„ÙØ¦Ø§Øª -->
    <div class="hidden md:block fixed right-0 top-0 h-full w-64 bg-white border-l shadow-xl p-4 overflow-y-auto">
        <h2 class="text-xl font-extrabold text-indigo-700 mb-6 border-b pb-2" data-i18n="mynote.sidebar.categories">ğŸ“‚ Ø§Ù„ÙØ¦Ø§Øª</h2>
        
        <!-- Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
        <div class="mb-6 p-3 bg-gray-50 rounded-lg shadow-inner">
            <input type="text" id="new-category-name" data-i18n-attr="placeholder:mynote.form.new_category_placeholder" placeholder="Ø§Ø³Ù… ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©..." class="w-full p-2 text-sm border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <button id="add-category-btn" class="mt-2 w-full bg-indigo-500 text-white p-2 text-sm font-semibold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                + <span data-i18n="mynote.btn.add_category">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</span>
            </button>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª Ù„Ù„ØªØµÙÙŠØ© -->
        <div id="categories-list" class="space-y-2">
            <!-- Ø§Ù„ÙØ¦Ø§Øª ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© renderCategories() -->
        </div>
        
        <div class="mt-8 pt-4 border-t text-xs text-gray-400">
             <p><span data-i18n="mynote.user.label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span> <span id="user-id-display" class="font-mono text-gray-500 text-sm break-all" data-i18n="mynote.user.loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></p>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
    <main class="flex-grow p-4 md:mr-64 transition-all duration-300" id="main-content">
        <header class="mb-8 p-4 bg-white rounded-xl shadow-lg flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-800" data-i18n="mynote.title">Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ ğŸ§</h1>
            <button id="add-note-btn" class="flex items-center bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span data-i18n="mynote.btn.add_note">Ù…Ù„Ø§Ø­Ø¸Ø© ØµÙˆØªÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</span>
            </button>
        </header>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
        <div id="notes-list" class="space-y-6">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© renderNotes() -->
            <div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-md" data-i18n="mynote.loading_notes">
                Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...
            </div>
        </div>

    </main>

    <!-- Site Footer -->
    <footer class="mt-10 border-t bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-sm text-gray-600 flex flex-col md:flex-row items-center justify-between gap-3">
        <div>Â© <span id="footerYear"></span> Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ</div>
        <div class="space-x-4 space-x-reverse">
        </div>
      </div>
    </footer>
    <script>try{document.getElementById('footerYear').textContent=new Date().getFullYear()}catch(e){}</script>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
    <div id="add-note-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md mx-auto rounded-xl shadow-2xl p-6 transform transition-all duration-300">
            
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-indigo-700" data-i18n="mynote.modal.title">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© ØµÙˆØªÙŠØ©</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="new-note-form" class="space-y-4">
                
                <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø© -->
                <div>
                    <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="mynote.form.category_label">Ø§Ø®ØªØ± ÙØ¦Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</label>
                    <select id="category-select" name="category-select" required 
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                    </select>
                </div>
                
                <!-- Ø®ÙŠØ§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="mynote.form.live_recording">Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:</label>
                    <div class="flex items-center justify-between space-x-2 rtl:space-x-reverse mb-2 p-2 bg-gray-50 rounded-lg">
                        <span id="record-status" class="text-sm font-semibold text-gray-600" data-i18n="mynote.form.status.ready">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„</span>
                        <span id="recording-time" class="text-lg font-mono text-gray-800" data-i18n="mynote.form.time_zero">0 Ø«Ø§Ù†ÙŠØ©</span>
                    </div>
                    
                    <button type="button" id="record-toggle-btn"
                            class="w-full flex items-center justify-center bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition duration-150 shadow-md">
                        <span class="ml-1">ğŸ¤</span> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                    </button>
                    <p class="text-xs text-gray-500 mt-2 text-center" data-i18n="mynote.form.record_hint">Ø§Ù†Ù‚Ø± Ù„Ù„Ø¨Ø¯Ø¡ØŒ Ø«Ù… Ø§Ù†Ù‚Ø± Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù.</p>
                </div>

                <div class="border-t pt-4">
                     <!-- Ø®ÙŠØ§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ÙŠØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„) -->
                    <label for="audio-upload" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="mynote.form.upload_audio">Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ØµÙˆØªÙŠ</label>
                    <input type="file" id="audio-upload" name="audio-upload" accept="audio/*"
                           class="w-full p-3 border border-gray-300 rounded-lg shadow-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <p id="audio-file-name" class="text-xs text-green-600 mt-1 hidden font-medium" data-i18n="mynote.form.uploaded_audio">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ù ØµÙˆØªÙŠ.</p>
                </div>

                <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
                <button type="submit" id="submit-note-btn"
                        class="w-full flex items-center justify-center bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-lg disabled:bg-gray-400">
                <span id="loading-spinner" class="hidden animate-spin h-5 w-5 ml-2 border-2 border-white border-t-transparent rounded-full"></span>
                    <span data-i18n="mynote.form.submit">${t('mynote.form.submit')}</span>
                </button>
            </form>

        </div>
    </div>
    <script src="js/theme.js"></script>
</body>
</html>

