<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Tailwind Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Cairo', 'Inter', 'sans-serif'],
                    }
                }
            }
        }

        // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¨Ø³ÙŠØ· (i18n Mock)
        const translations = {
            'mynote.form.choose_category': 'Ø§Ø®ØªØ± ÙØ¦Ø©...',
            'mynote.sidebar.all': 'ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
            'mynote.empty': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.',
            'mynote.note.transcription': 'Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬',
            'mynote.note.translation': 'Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'
        };
        window.t = (key) => translations[key] || key;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        try {
            var storedTheme = localStorage.getItem('theme');
            var d = storedTheme ? storedTheme === 'dark' : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (d) document.documentElement.classList.add('dark');
        } catch (e) {}
    </script>

    <style>
        /* Ø£Ù†Ù…Ø§Ø· Ù…Ø®ØµØµØ© */
        body { font-family: 'Cairo', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Ù†Ø¨Ø¶ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, setDoc, doc, query, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
        const configFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const firebaseConfig = Object.keys(configFromEnv).length > 0 ? configFromEnv : {
             apiKey: "AIzaSyBM7Y6ZEFwMOOPno1ighvtVumHB1f3keVA",
             authDomain: "pharmacy-769cb.firebaseapp.com",
             projectId: "pharmacy-769cb",
             storageBucket: "pharmacy-769cb.firebasestorage.app",
             appId: "1:1024742648973:web:d45439f85a8e3eca0146c4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                window.userId = user.uid; // ØªØ¹Ø±ÙŠØ¶ Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
                console.log("Logged in:", user.uid);
                setupDataListeners();
                document.getElementById('loading-screen').classList.add('hidden');
            }
        });

        initAuth();

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        window.categories = [];
        window.notes = [];

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function setupDataListeners() {
            if (!currentUser) return;
            const baseCollectionPath = `artifacts/${appId}/users/${currentUser.uid}`;

            // Ø§Ù„ÙØ¦Ø§Øª
            const catQuery = query(collection(db, baseCollectionPath, 'categories'));
            onSnapshot(catQuery, (snapshot) => {
                window.categories = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØ¦Ø§ØªØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                if (window.categories.length === 0) {
                    initializeDefaultCategories();
                } else {
                    window.renderCategories();
                }
            });

            // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const notesQuery = query(collection(db, baseCollectionPath, 'notes'), orderBy('createdAt', 'desc'));
            onSnapshot(collection(db, baseCollectionPath, 'notes'), (snapshot) => {
                window.notes = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                window.notes.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                window.renderNotes();
            });
        }

        // Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        async function initializeDefaultCategories() {
            const baseCollectionPath = `artifacts/${appId}/users/${currentUser.uid}`;
            const defaultCategories = [
                { name: 'Ø§Ø¬ØªÙ…Ø§Ø¹', icon: 'ğŸ—£ï¸', color: 'blue' },
                { name: 'Ù…Ø­Ø§Ø¶Ø±Ø©', icon: 'ğŸ“', color: 'green' },
                { name: 'Ø³ÙØ±', icon: 'âœˆï¸', color: 'purple' },
                { name: 'ÙÙƒØ±Ø© Ø³Ø±ÙŠØ¹Ø©', icon: 'ğŸ’¡', color: 'yellow' },
            ];
            
            const promises = defaultCategories.map(cat => 
                setDoc(doc(db, baseCollectionPath, 'categories', cat.name), cat)
            );
            
            await Promise.all(promises);
            console.log("Default categories initialized");
        }

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø­Ø°Ù (Ù…Ø¹Ø±ÙˆØ¶Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¢Ø®Ø±)
        // ** Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù…Ø¹ Firebase Modules **
        window.saveNoteToFirestore = async (noteData) => {
            if (!currentUser) throw new Error("User not logged in");
            const baseCollectionPath = `artifacts/${appId}/users/${currentUser.uid}`;
            await addDoc(collection(db, baseCollectionPath, 'notes'), {
                ...noteData,
                createdAt: serverTimestamp()
            });
        };

        window.saveCategoryToFirestore = async (catData) => {
            if (!currentUser) throw new Error("User not logged in");
            const baseCollectionPath = `artifacts/${appId}/users/${currentUser.uid}`;
            await setDoc(doc(db, baseCollectionPath, 'categories', catData.name), catData);
        };

        window.deleteNoteFromFirestore = async (noteId) => {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) return;
            const baseCollectionPath = `artifacts/${appId}/users/${currentUser.uid}`;
            await deleteDoc(doc(db, baseCollectionPath, 'notes', noteId));
        };
    </script>

    <!-- Main Logic Script -->
    <script>
        const apiKey = "AIzaSyBks1niA75pswcefkI1dKmxLd2hNjzowgk"; 
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';

        // --- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = 0;
        let recordingInterval;
        let recordedFile = null;
        let selectedCategoryFilter = 'all';

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-5 left-5 px-6 py-3 rounded-lg text-white shadow-lg z-50 transform transition-all duration-300 translate-y-10 opacity-0 ${type === 'error' ? 'bg-red-500' : 'bg-green-600'}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-y-10', 'opacity-0'));
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function processWithGemini(base64Data, mimeType) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            
            const prompt = `
            You are an expert transcriber and translator.
            1. Transcribe the audio exactly as spoken (Arabic or English).
            2. Translate the transcription to Arabic (if it's not already Arabic).
            3. Return ONLY a valid JSON object without markdown formatting:
            { "transcription": "...", "translation": "..." }
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }],
                generationConfig: { responseMimeType: "application/json" }
            };

            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`Gemini API Error: ${response.status}`);
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Empty response from Gemini");
                    
                    return JSON.parse(text);
                } catch (e) {
                    console.warn(`Attempt ${i+1} failed:`, e);
                    if (i === 2) throw e;
                    await new Promise(r => setTimeout(r, 1000 * (i+1)));
                }
            }
        }

        // --- Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ ---
        async function toggleRecording() {
            const btn = document.getElementById('record-btn');
            const statusText = document.getElementById('record-status');
            const timer = document.getElementById('record-timer');

            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        recordedFile = new File([blob], `recording-${Date.now()}.webm`, { type: 'audio/webm' });
                        document.getElementById('file-info').classList.remove('hidden');
                        document.getElementById('filename-display').textContent = "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ";
                        // Reset file input if recording is used
                        document.getElementById('file-upload').value = '';
                        stream.getTracks().forEach(t => t.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    recordingStartTime = Date.now();
                    
                    btn.innerHTML = '<i class="fas fa-stop"></i>';
                    btn.classList.add('bg-red-600', 'animate-pulse');
                    statusText.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
                    
                    recordingInterval = setInterval(() => {
                        const seconds = (Date.now() - recordingStartTime) / 1000;
                        timer.textContent = formatDuration(seconds);
                    }, 1000);

                } catch (e) {
                    showToast("ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†", "error");
                    console.error(e);
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                clearInterval(recordingInterval);
                
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                btn.classList.remove('bg-red-600', 'animate-pulse');
                btn.classList.add('bg-indigo-600');
                statusText.textContent = "ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù";
            }
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        window.renderCategories = () => {
            const list = document.getElementById('category-list');
            const select = document.getElementById('category-select');
            
            // Sidebar List
            let html = `
                <button onclick="filterNotes('all')" 
                    class="w-full text-right px-4 py-2 rounded-lg mb-2 transition-colors flex items-center gap-2 
                    ${selectedCategoryFilter === 'all' ? 'bg-indigo-600 text-white' : 'hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200'}">
                    <i class="fas fa-layer-group"></i> ${t('mynote.sidebar.all')}
                </button>
            `;
            
            // Select Options
            let options = `<option value="" disabled selected>${t('mynote.form.choose_category')}</option>`;

            window.categories.forEach(cat => {
                html += `
                    <button onclick="filterNotes('${cat.id}')" 
                        class="w-full text-right px-4 py-2 rounded-lg mb-2 transition-colors flex items-center gap-2 
                        ${selectedCategoryFilter === cat.id ? 'bg-indigo-600 text-white' : 'hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200'}">
                        <span>${cat.icon}</span> ${cat.name}
                    </button>
                `;
                options += `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`;
            });

            list.innerHTML = html;
            select.innerHTML = options;
        };

        window.filterNotes = (catId) => {
            selectedCategoryFilter = catId;
            renderCategories(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
            renderNotes();
        };

        window.renderNotes = () => {
            const container = document.getElementById('notes-grid');
            const filtered = window.notes.filter(n => selectedCategoryFilter === 'all' || n.categoryId === selectedCategoryFilter);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-10 text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>${t('mynote.empty')}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(note => {
                const cat = window.categories.find(c => c.id === note.categoryId) || {name: 'ØºÙŠØ± Ù…ØµÙ†Ù', icon: 'â“', color: 'gray'};
                const date = note.createdAt ? new Date(note.createdAt.seconds * 1000).toLocaleDateString('ar-EG') : '...';
                
                return `
                <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow border-t-4 border-${cat.color}-500 relative group">
                    <button onclick="deleteNoteFromFirestore('${note.id}')" class="absolute top-3 left-3 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-trash"></i>
                    </button>
                    
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-semibold px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-md text-gray-600 dark:text-gray-300">
                            ${cat.icon} ${cat.name}
                        </span>
                        <span class="text-xs text-gray-400">${date}</span>
                    </div>

                    <h3 class="font-bold text-gray-800 dark:text-white mb-2 truncate">${note.audioFileName || 'Ù…Ù„Ø§Ø­Ø¸Ø© Ù†ØµÙŠØ©'}</h3>
                    
                    <div class="space-y-3">
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                <i class="fas fa-align-right"></i> ${t('mynote.note.transcription')}
                            </p>
                            <p class="text-sm text-gray-700 dark:text-gray-200 leading-relaxed">
                                ${note.transcription || '...'}
                            </p>
                        </div>

                        <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg">
                            <p class="text-xs text-indigo-600 dark:text-indigo-400 mb-1 flex items-center gap-1">
                                <i class="fas fa-language"></i> ${t('mynote.note.translation')}
                            </p>
                            <p class="text-sm text-indigo-800 dark:text-indigo-200 leading-relaxed">
                                ${note.translation || '...'}
                            </p>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        };

        // --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ---
        window.openModal = () => {
            document.getElementById('modal').classList.remove('hidden');
            recordedFile = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('file-info').classList.add('hidden');
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('record-timer').textContent = "0:00";
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
            if (isRecording) toggleRecording(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„
        };

        window.handleFileSelect = (e) => {
            const file = e.target.files[0];
            if (file) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹ ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„
                recordedFile = null; 
                document.getElementById('file-info').classList.remove('hidden');
                document.getElementById('filename-display').textContent = file.name;
            }
        };

        window.submitNote = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const catId = document.getElementById('category-select').value;
            const fileInput = document.getElementById('file-upload');
            
            // ØªØ­Ø¯ÙŠØ¯ Ù…ØµØ¯Ø± Ø§Ù„Ù…Ù„Ù: Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ù…Ø±ÙÙˆØ¹ Ø«Ù… Ø§Ù„Ù…Ø³Ø¬Ù„
            let finalFile = fileInput.files[0] || recordedFile;

            // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„
            if (!catId) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø©", "error");
                return;
            }
            if (!finalFile) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª Ø£Ùˆ Ø±ÙØ¹ Ù…Ù„Ù", "error");
                return;
            }

            if (finalFile.size > 15 * 1024 * 1024) {
                showToast("Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 15 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)", "error");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

            try {
                // 2. Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Base64
                const base64 = await fileToBase64(finalFile);
                
                // 3. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¹ Gemini
                const result = await processWithGemini(base64, finalFile.type || 'audio/webm');

                // 4. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firestore (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹)
                await saveNoteToFirestore({
                    categoryId: catId,
                    audioFileName: finalFile.name,
                    transcription: result.transcription,
                    translation: result.translation,
                    duration: finalFile === recordedFile ? formatDuration((Date.now() - recordingStartTime)/1000) : "Ù…Ù„Ù Ù…Ø±ÙÙ‚"
                });

                showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
                closeModal();
            } catch (error) {
                console.error(error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©';
            }
        };

        window.addCategory = async () => {
            const input = document.getElementById('new-cat-input');
            const name = input.value.trim();
            if (!name) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
            if (window.categories.some(c => c.name === name)) {
                showToast("Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„", "error");
                return;
            }

            try {
                await saveCategoryToFirestore({
                    name: name,
                    icon: 'ğŸ”–',
                    color: 'pink'
                });
                input.value = '';
                showToast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©");
            } catch (e) {
                showToast("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©: " + e.message, "error");
            }
        };

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡
        window.onclick = (e) => {
            const modal = document.getElementById('modal');
            if (e.target === modal) closeModal();
        };
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-white min-h-screen transition-colors duration-300">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-gray-500 dark:text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex-shrink-0 hidden md:flex flex-col">
            <div class="p-6 border-b dark:border-gray-700">
                <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 flex items-center gap-2">
                    <i class="fas fa-brain"></i> Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ
                </h1>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="mb-4">
                    <h2 class="text-xs font-semibold text-gray-400 uppercase mb-3 px-2">Ø§Ù„ÙØ¦Ø§Øª</h2>
                    <div id="category-list">
                        <!-- Categories injected here -->
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t dark:border-gray-700">
                    <div class="flex gap-2">
                        <input id="new-cat-input" type="text" placeholder="ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©..." class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 ring-indigo-500">
                        <button onclick="addCategory()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg transition-colors">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t dark:border-gray-700">
                <button onclick="toggleTheme()" class="w-full flex items-center justify-center gap-2 py-2 text-gray-500 hover:text-gray-800 dark:hover:text-white transition-colors">
                    <i class="fas fa-adjust"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¸Ù‡Ø±
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <!-- Mobile Header -->
            <header class="md:hidden bg-white dark:bg-gray-800 p-4 flex justify-between items-center shadow-sm z-10">
                <h1 class="font-bold text-lg text-indigo-600">Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</h1>
                <button onclick="toggleTheme()" class="text-gray-500"><i class="fas fa-adjust"></i></button>
            </header>

            <!-- Scrollable Area -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8">
                <div id="notes-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-20">
                    <!-- Notes injected here -->
                </div>
            </div>

            <!-- Floating Action Button -->
            <button onclick="openModal()" class="fixed bottom-6 left-6 md:bottom-8 md:left-8 bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-xl transition-transform hover:scale-110 z-20">
                <i class="fas fa-microphone"></i>
            </button>
        </main>

    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-40 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>

                <form onsubmit="submitNote(event)">
                    <!-- Category Select -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                        <select id="category-select" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl px-4 py-3 outline-none focus:ring-2 ring-indigo-500 transition-all">
                            <!-- Options injected -->
                        </select>
                    </div>

                    <!-- Audio Controls -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 mb-6 text-center border-2 border-dashed border-gray-200 dark:border-gray-600">
                        <div class="mb-4">
                            <span id="record-timer" class="text-3xl font-mono font-bold text-gray-700 dark:text-gray-200">0:00</span>
                            <p id="record-status" class="text-xs text-gray-400 mt-1">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„</p>
                        </div>

                        <div class="flex justify-center gap-4 items-center">
                            <button type="button" id="record-btn" onclick="toggleRecording()" class="w-16 h-16 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-2xl shadow-lg transition-all flex items-center justify-center">
                                <i class="fas fa-microphone"></i>
                            </button>
                            
                            <div class="text-gray-400">Ø£Ùˆ</div>
                            
                            <label class="cursor-pointer bg-white dark:bg-gray-600 hover:bg-gray-100 dark:hover:bg-gray-500 text-gray-700 dark:text-white px-4 py-2 rounded-lg shadow-sm border border-gray-200 dark:border-gray-500 transition-colors">
                                <i class="fas fa-upload mr-2"></i> Ø±ÙØ¹ Ù…Ù„Ù
                                <input type="file" id="file-upload" accept="audio/*" class="hidden" onchange="handleFileSelect(event)">
                            </label>
                        </div>

                        <div id="file-info" class="hidden mt-4 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 px-3 py-2 rounded-lg text-sm truncate">
                            <i class="fas fa-file-audio ml-2"></i> <span id="filename-display"></span>
                        </div>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-md transition-all">
                        Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
                    </button>
                </form>
            </div>
        </div>
    </div>

</body>
</html>
