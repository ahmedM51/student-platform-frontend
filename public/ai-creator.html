<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina - Next Gen AI Presentations</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase client + platform config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Cairo', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #000; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (Inline SVGs) ---
        const Icons = {
            Sparkles: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></svg>
            ),
            Plus: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            ),
            Image: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
            ),
            ChevronRight: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
            ),
            ArrowLeft: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
            ),
            Play: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
            ),
            Share: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>
            ),
            Settings: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            ),
            Presentation: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h20"/><path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"/><path d="m7 21 5-5 5 5"/></svg>
            ),
            FileText: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
            ),
            Monitor: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>
            ),
            Wand: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>
            ),
            Refresh: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
            )
        };

        // --- API Configuration ---
        const GEMINI_TEXT_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const GEMINI_IMAGE_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict";

        // --- API Logic ---
        
        // 1. Generate Images (With Fallback)
        const generateImagenImage = async (apiKey, prompt) => {
            try {
                if (!apiKey) throw new Error("No API Key provided");
                
                const response = await fetch(`${GEMINI_IMAGE_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instances: [{ prompt: prompt + ", photorealistic, 4k, high quality, vivid colors" }],
                        parameters: { sampleCount: 1 }
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                if (data.predictions && data.predictions[0]) {
                    return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                }
                throw new Error("No image data returned");

            } catch (e) {
                console.warn("⚠️ Switching to Pollinations.ai fallback due to:", e);
                return `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=800&height=600&nologo=true&seed=${Math.random()}`;
            }
        };

        // 2. Rewrite Text
        const rewriteTextWithAI = async (apiKey, text, instruction) => {
            try {
                const prompt = `Rewrite this text: "${text}". Instruction: ${instruction}. Return ONLY the rewritten text.`;
                const url = `${GEMINI_TEXT_URL}?key=${apiKey}`;
                const r = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!r.ok) throw new Error('Gemini rewrite error: ' + r.status);
                const j = await r.json();
                const out = j?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                return out && out.length ? out : text;
            } catch (e) {
                console.error('Rewrite Error', e);
                return text;
            }
        };

        // 3. Generate Structure
        const fetchGeminiContent = async (apiKey, topic, type) => {
            const prompt = `
                Create a 4-slide ${type} about "${topic}".
                Return ONLY raw JSON array (no markdown).
                Structure per slide:
                {
                "title": "Slide Title",
                "blocks": [
                    { "type": "heading", "content": "..." },
                    { "type": "paragraph", "content": "..." },
                    { "type": "image", "content": "Detailed visual description for AI image generation (e.g. 'futuristic city, neon lights, 8k')" }
                ]
                }
                RULES:
                1. EACH slide MUST have exactly one 'image' block. This is MANDATORY.
                2. The 'image' content must be a descriptive prompt in English.
                3. Do not wrap response in \`\`\`.
            `;

            // Direct call first, then fallback to backend only if it fails
            try {
                if (!apiKey) throw new Error('Missing API key');
                const directUrl = `${GEMINI_TEXT_URL}?key=${apiKey}`;
                const directRes = await fetch(directUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!directRes.ok) throw new Error('Direct Gemini error: ' + directRes.status);
                const dj = await directRes.json();
                let textResponse = dj?.candidates?.[0]?.content?.parts?.[0]?.text || "[]";
                textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                let parsedData;
                try { parsedData = JSON.parse(textResponse); } catch (_) { parsedData = []; }
                const hydratedSlides = await Promise.all(parsedData.map(async (slide, sIdx) => ({
                    id: `s-${sIdx}`,
                    title: slide.title,
                    blocks: await Promise.all((slide.blocks || []).map(async (b, bIdx) => {
                        let imageUrl = undefined;
                        if (b.type === 'image') {
                            imageUrl = await generateImagenImage(apiKey, b.content);
                        }
                        return {
                            id: `b-${sIdx}-${bIdx}`,
                            type: b.type,
                            content: b.content,
                            imagePrompt: b.type === 'image' ? b.content : undefined,
                            imageUrl: imageUrl
                        };
                    }))
                })));
                return hydratedSlides;
            } catch (directErr) {
                console.warn('Direct Gemini failed, trying backend...', directErr);
                try {
                    const res = await fetch('/api/ai/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: prompt, context: '' })
                    });
                    if (!res.ok) throw new Error('AI backend error: ' + res.status);
                    const data = await res.json();
                    let textResponse = (data && data.response) ? data.response : "[]";
                    textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                    let parsedData;
                    try { parsedData = JSON.parse(textResponse); } catch (e) { parsedData = []; }
                    const hydratedSlides = await Promise.all(parsedData.map(async (slide, sIdx) => ({
                        id: `s-${sIdx}`,
                        title: slide.title,
                        blocks: await Promise.all((slide.blocks || []).map(async (b, bIdx) => {
                            let imageUrl = undefined;
                            if (b.type === 'image') {
                                imageUrl = await generateImagenImage(apiKey, b.content);
                            }
                            return {
                                id: `b-${sIdx}-${bIdx}`,
                                type: b.type,
                                content: b.content,
                                imagePrompt: b.type === 'image' ? b.content : undefined,
                                imageUrl: imageUrl
                            };
                        }))
                    })));
                    return hydratedSlides;
                } catch (backendErr) {
                    console.error('Both direct and backend generation failed:', backendErr);
                    alert('Failed to generate content. Please check your API Key.');
                    return [];
                }
            }
        };

        // --- Components ---

        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey, isOwner }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[60]">
                     <div className="bg-[#1C1C1C] border border-gray-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <Icons.Settings className="w-5 h-5" /> إعدادات API
                        </h2>
                        <p className="text-gray-400 text-sm mb-4">
                            مفتاح API معد مسبقاً لهذا العرض التوضيحي.<br/>
                            <span className="text-xs text-gray-500">يدعم Gemini Flash و Imagen.</span>
                        </p>
                        <input 
                            type="password" 
                            value={apiKey}
                            onChange={(e) => { if (isOwner) setApiKey(e.target.value); }}
                            readOnly={!isOwner}
                            placeholder="أدخل المفتاح هنا..."
                            className="w-full bg-black/30 border border-gray-600 rounded-lg p-3 text-white focus:border-purple-500 outline-none mb-4 text-left"
                        />
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">إغلاق</button>
                            <button onClick={onClose} disabled={!isOwner} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">حفظ</button>
                        </div>
                     </div>
                </div>
            )
        }

        const AIEditPopup = ({ isOpen, onClose, onApply, position }) => {
            const [prompt, setPrompt] = useState('');
            const [loading, setLoading] = useState(false);

            if (!isOpen) return null;

            const handleApply = async () => {
                setLoading(true);
                await onApply(prompt);
                setLoading(false);
                setPrompt('');
                onClose();
            };

            return (
                <div 
                    className="absolute z-50 bg-[#1C1C1C] border border-blue-500/50 shadow-2xl rounded-xl p-3 w-64 flex flex-col gap-2 animate-in fade-in zoom-in duration-200"
                    style={{ top: position.top, left: position.left }}
                >
                    <div className="flex items-center gap-2 text-xs font-bold text-blue-400 uppercase tracking-wider mb-1">
                        <Icons.Sparkles className="w-3 h-3" /> تعديل ذكي
                    </div>
                    <input 
                        autoFocus
                        value={prompt}
                        onChange={(e) => setPrompt(e.target.value)}
                        placeholder="اجعله أقصر، ترجم..."
                        className="bg-black/50 border border-gray-700 rounded p-2 text-sm text-white outline-none focus:border-blue-500"
                        onKeyDown={(e) => e.key === 'Enter' && handleApply()}
                    />
                    <div className="flex gap-1 overflow-x-auto pb-1 no-scrollbar">
                        {['لخص', 'ترجم للعربية', 'اجعله احترافي'].map(p => (
                            <button key={p} onClick={() => { setPrompt(p); handleApply(); }} className="px-2 py-1 bg-white/5 hover:bg-white/10 rounded text-xs whitespace-nowrap transition">
                                {p}
                            </button>
                        ))}
                    </div>
                    <button 
                        onClick={handleApply} 
                        disabled={loading || !prompt}
                        className="bg-blue-600 text-white rounded py-1 text-xs font-bold hover:bg-blue-500 disabled:opacity-50"
                    >
                        {loading ? 'جاري التوليد...' : 'تطبيق'}
                    </button>
                </div>
            )
        }

        const LandingPage = ({ onLogin }) => (
            <div className="min-h-screen bg-black text-white font-sans relative overflow-hidden flex flex-col">
                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[600px] bg-blue-600/20 blur-[100px] rounded-full pointer-events-none"></div>
                <nav className="flex justify-between items-center p-6 relative z-10 max-w-7xl mx-auto w-full">
                    <div className="flex items-center gap-2 font-bold text-2xl">
                        <div className="w-8 h-8 bg-gradient-to-br from-blue-400 to-cyan-600 rounded-lg flex items-center justify-center">
                            <Icons.Sparkles className="w-5 h-5 text-white" />
                        </div>
                        Lumina
                    </div>
                    <button onClick={onLogin} className="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full font-medium transition shadow-lg shadow-blue-500/30">
                        ابدأ الآن
                    </button>
                </nav>
                <main className="relative z-10 max-w-5xl mx-auto text-center mt-12 px-6 flex-1 flex flex-col items-center">
                    <h1 className="text-5xl md:text-7xl font-bold leading-tight tracking-tight mb-6">
                        أطلق العنان لأفكارك <br />
                        <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-400 to-teal-400">مع Lumina AI</span>
                    </h1>
                    <p className="text-xl text-gray-400 mb-10 max-w-2xl mx-auto leading-relaxed">
                        منصة الجيل القادم للعروض التقديمية. حوّل نصوصك إلى قصص بصرية مذهلة في ثوانٍ باستخدام أحدث تقنيات الذكاء الاصطناعي.
                    </p>
                    <div className="flex justify-center gap-4">
                        <button onClick={onLogin} className="bg-white text-black px-8 py-4 rounded-full font-bold text-lg hover:bg-gray-200 transition flex items-center gap-2 transform hover:scale-105 duration-200">
                            <Icons.Sparkles className="w-5 h-5 text-blue-600" /> جرب الديمو مجاناً
                        </button>
                    </div>
                </main>
            </div>
        );

        const CreateProjectModal = ({ onClose, onCreate, hasKey }) => {
            const [topic, setTopic] = useState('');
            const [activeType, setActiveType] = useState('presentation');

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                    <div className="bg-[#1C1C1C] border border-gray-700 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden">
                        <div className="p-6 border-b border-gray-800 flex justify-between items-center">
                            <h2 className="text-xl font-semibold text-white flex items-center gap-2">
                                <Icons.Sparkles className="w-5 h-5 text-blue-500" /> إنشاء جديد
                            </h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white">✕</button>
                        </div>
                        <div className="p-8">
                            <div className="flex gap-4 mb-8">
                                {[{ id: 'presentation', icon: Icons.Presentation, label: 'عرض تقديمي' }, { id: 'document', icon: Icons.FileText, label: 'مستند' }, { id: 'webpage', icon: Icons.Monitor, label: 'صفحة ويب' }].map((item) => (
                                    <button key={item.id} onClick={() => setActiveType(item.id)} className={`flex-1 p-4 rounded-xl border flex flex-col items-center gap-2 transition ${activeType === item.id ? 'bg-blue-500/10 border-blue-500 text-blue-400' : 'bg-gray-800/50 border-transparent text-gray-400 hover:bg-gray-800'}`}>
                                        <item.icon className="w-6 h-6" /> <span className="text-sm font-medium">{item.label}</span>
                                    </button>
                                ))}
                            </div>
                            <textarea value={topic} onChange={(e) => setTopic(e.target.value)} placeholder="اكتب موضوع العرض هنا... (مثلاً: مستقبل الطاقة المتجددة)" className="w-full bg-black/30 border border-gray-700 rounded-xl p-4 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 resize-none h-32 text-right" dir="auto" />
                        </div>
                        <div className="p-6 bg-gray-900/50 border-t border-gray-800 flex justify-end">
                            <button disabled={!topic} onClick={() => onCreate(topic, activeType)} className={`px-6 py-2 rounded-lg font-medium flex items-center gap-2 transition ${!topic ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-500'}`}>
                                توليد المحتوى <Icons.ChevronRight className="w-4 h-4 rotate-180" />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Editor = ({ project, onBack, apiKey, onSave }) => {
            const [slides, setSlides] = useState(project.slides);
            const [activeSlideId, setActiveSlideId] = useState(slides[0]?.id);
            const [theme, setTheme] = useState(project.theme);
            
            const [editingBlockId, setEditingBlockId] = useState(null);
            const [editPopupPos, setEditPopupPos] = useState({ top: 0, left: 0 });
            
            const activeSlide = slides.find(s => s.id === activeSlideId) || slides[0];

            const updateBlockContent = (blockId, newContent) => {
                setSlides(prev => prev.map(slide => {
                    if (slide.id !== activeSlideId) return slide;
                    return { ...slide, blocks: slide.blocks.map(b => b.id === blockId ? { ...b, content: newContent } : b) };
                }));
            };

            const handleAIEditClick = (e, blockId) => {
                const rect = e.target.getBoundingClientRect();
                setEditPopupPos({ top: rect.bottom + window.scrollY + 10, left: rect.left });
                setEditingBlockId(blockId);
            };

            const handleAIApply = async (instruction) => {
                if (!editingBlockId || !apiKey) { if(!apiKey) alert("Set API Key!"); return; }
                const currentBlock = activeSlide.blocks.find(b => b.id === editingBlockId);
                if (!currentBlock) return;
                const newText = await rewriteTextWithAI(apiKey, currentBlock.content, instruction);
                updateBlockContent(editingBlockId, newText);
                setEditingBlockId(null);
            };

            const handleRegenerateImage = async (blockId, prompt) => {
                setSlides(prev => prev.map(s => s.id === activeSlideId ? { ...s, blocks: s.blocks.map(b => b.id === blockId ? { ...b, isGeneratingImage: true } : b) } : s));
                const newUrl = await generateImagenImage(apiKey, prompt);
                setSlides(prev => prev.map(s => s.id === activeSlideId ? { ...s, blocks: s.blocks.map(b => b.id === blockId ? { ...b, imageUrl: newUrl, isGeneratingImage: false } : b) } : s));
            };

            const handleSaveClick = () => {
                if (!onSave) return;
                const payload = {
                    ...project,
                    slides,
                    theme
                };
                onSave(payload);
            };

            const handleExport = async (format) => {
                if (!project.id || (typeof project.id === 'string' && project.id.startsWith('tmp-'))) {
                    alert('يجب حفظ العرض في المنصة أولاً قبل التصدير.');
                    return;
                }
                const endpoint = format === 'pdf'
                    ? '/api/presentations/export/pdf'
                    : '/api/presentations/export/pptx';
                try {
                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: project.id })
                    });
                    if (!res.ok) {
                        throw new Error('Export failed: ' + res.status);
                    }
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const safeTitle = (project.title || 'عرض-ذكّي').replace(/[^a-zA-Z0-9\u0600-\u06FF-_ ]/g, '').trim() || 'عرض-ذكّي';
                    a.href = url;
                    a.download = format === 'pdf' ? `${safeTitle}.pdf` : `${safeTitle}.pptx`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.error('Export error:', e);
                    alert('حدث خطأ أثناء التصدير. تأكد من اتصالك بالشبكة ومن حفظ العرض في المنصة.');
                }
            };

            const themeClasses = {
                light: 'bg-white text-gray-900',
                dark: 'bg-[#1a1a1a] text-gray-100',
                navy: 'bg-[#0f172a] text-white',
                purple: 'bg-[#2e1065] text-white'
            };

            // Guard: if no slides, show fallback UI to avoid runtime errors
            if (!slides || slides.length === 0) {
                return (
                    <div className={`h-screen flex flex-col bg-[#1a1a1a] text-white`}>
                        <header className="h-14 border-b border-white/10 flex items-center justify-between px-4 bg-inherit z-20">
                            <div className="flex items-center gap-4">
                                <button onClick={onBack} className="p-2 hover:bg-white/10 rounded-lg transition"><Icons.ArrowLeft className="w-5 h-5" /></button>
                                <h1 className="font-semibold text-lg truncate max-w-[200px]">{project.title}</h1>
                            </div>
                        </header>
                        <main className="flex-1 flex items-center justify-center p-8 text-center opacity-80">
                            <div>
                                <div className="text-xl mb-2">لم يتم توليد أي شرائح.</div>
                                <div className="text-sm text-white/70">جرّب إنشاء المحتوى مرة أخرى أو عد إلى لوحة التحكم.</div>
                            </div>
                        </main>
                    </div>
                );
            }

            return (
                <div className={`h-screen flex flex-col ${themeClasses[theme]} transition-colors duration-500 relative`}>
                    <AIEditPopup isOpen={!!editingBlockId} onClose={() => setEditingBlockId(null)} onApply={handleAIApply} position={editPopupPos} />
                    <header className="h-14 border-b border-white/10 flex items-center justify-between px-4 bg-inherit z-20">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="p-2 hover:bg-white/10 rounded-lg transition"><Icons.ArrowLeft className="w-5 h-5" /></button>
                            <h1 className="font-semibold text-lg truncate max-w-[200px]">{project.title}</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="flex bg-white/5 rounded-lg p-1 mr-2">
                                {['light', 'dark', 'navy', 'purple'].map(t => (
                                    <button key={t} onClick={() => setTheme(t)} className={`w-6 h-6 rounded-md border border-transparent hover:border-white/50 transition ${t === 'light' ? 'bg-white' : t === 'dark' ? 'bg-[#333]' : t === 'navy' ? 'bg-[#0f172a]' : 'bg-[#2e1065]'} ${theme === t ? 'ring-2 ring-blue-500' : ''}`} />
                                ))}
                            </div>
                            <button onClick={handleSaveClick} className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium transition">حفظ في المنصة</button>
                            <button onClick={() => handleExport('pdf')} className="hidden md:flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition">PDF</button>
                            <button onClick={() => handleExport('pptx')} className="hidden md:flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition">PowerPoint</button>
                            <button className="flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition"><Icons.Play className="w-4 h-4" /> عرض</button>
                        </div>
                    </header>
                    <div className="flex flex-1 overflow-hidden">
                        <aside className="w-48 border-r border-white/10 flex flex-col bg-inherit/50 overflow-y-auto hidden md:flex">
                            <div className="p-4 space-y-2">
                                {slides.map((slide, idx) => (
                                    <button key={slide.id} onClick={() => setActiveSlideId(slide.id)} className={`w-full text-left p-3 rounded-lg border transition group ${activeSlideId === slide.id ? 'border-blue-500 bg-blue-500/10' : 'border-transparent hover:bg-white/5'}`}>
                                        <div className="text-xs opacity-50 mb-1">0{idx + 1}</div>
                                        <div className="text-sm font-medium truncate">{slide.title}</div>
                                    </button>
                                ))}
                            </div>
                        </aside>
                        <main className="flex-1 overflow-y-auto bg-inherit relative p-8 md:p-16 flex justify-center">
                            <div key={activeSlideId} className="w-full max-w-4xl space-y-8 pb-20 animate-fade-in">
                                <input value={activeSlide.title} onChange={(e) => setSlides(prev => prev.map(s => s.id === activeSlideId ? { ...s, title: e.target.value } : s))} className="w-full bg-transparent text-4xl md:text-5xl font-bold outline-none" />
                                <div className="space-y-6">
                                    {activeSlide.blocks.map((block) => (
                                        <div key={block.id} className="group relative transition-all hover:bg-white/5 p-2 -mx-2 rounded-lg">
                                            {(block.type === 'paragraph' || block.type === 'list') && (
                                                <button onClick={(e) => handleAIEditClick(e, block.id)} className="absolute -right-8 top-0 p-1.5 bg-blue-600 rounded text-white opacity-0 group-hover:opacity-100 transition hover:bg-blue-500 shadow-lg" title="Edit with AI"><Icons.Wand className="w-4 h-4" /></button>
                                            )}
                                            {block.type === 'heading' && <input defaultValue={block.content} className="w-full bg-transparent text-2xl font-semibold outline-none border-l-2 border-transparent focus:border-blue-500 pl-2 transition" />}
                                            {block.type === 'paragraph' && <textarea defaultValue={block.content} className="w-full bg-transparent text-lg opacity-90 outline-none resize-none h-auto border-l-2 border-transparent focus:border-blue-500 pl-2 transition leading-relaxed" rows={Math.ceil(block.content.length / 80)} />}
                                            {block.type === 'list' && <div className="pl-4 border-l-2 border-blue-500/30">{block.content.split('\n').map((line, i) => <div key={i} className="flex items-start gap-2 mb-2"><div className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2.5 flex-shrink-0" /><div className="text-lg opacity-90">{line}</div></div>)}</div>}
                                            {block.type === 'image' && (
                                                <div className="relative rounded-xl overflow-hidden border border-white/10 group-hover:border-blue-500/50 transition min-h-[300px] bg-gray-900 flex items-center justify-center">
                                                    {block.isGeneratingImage ? (
                                                        <div className="flex flex-col items-center gap-3"><div className="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div><span className="text-xs text-blue-300 animate-pulse">جاري الرسم...</span></div>
                                                    ) : (
                                                        <>
                                                            <img src={block.imageUrl} alt="AI Gen" className="w-full h-auto object-cover max-h-[500px]" />
                                                            <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition flex gap-2">
                                                                <button onClick={() => handleRegenerateImage(block.id, block.imagePrompt || "")} className="bg-black/70 backdrop-blur p-2 rounded-full text-white hover:bg-blue-600 transition" title="Regenerate"><Icons.Refresh className="w-4 h-4" /></button>
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ projects, onOpenProject, onNewProject, onOpenSettings }) => (
            <div className="min-h-screen bg-[#121212] text-white">
                <nav className="h-16 border-b border-white/10 flex items-center px-6 justify-between bg-[#1C1C1C]">
                    <div className="font-bold text-xl flex items-center gap-2"><div className="w-6 h-6 bg-blue-600 rounded flex items-center justify-center"><span className="text-xs">L</span></div>Lumina</div>
                    <div className="flex gap-3">
                        <button onClick={onOpenSettings} className="p-2 hover:bg-white/10 rounded-full transition" title="API Settings"><Icons.Settings className="w-5 h-5 text-gray-400" /></button>
                        <div className="w-8 h-8 bg-gradient-to-tr from-blue-400 to-cyan-500 rounded-full"></div>
                    </div>
                </nav>
                <main className="p-8 max-w-7xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <h1 className="text-2xl font-bold">مشاريعي</h1>
                        <button onClick={onNewProject} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition"><Icons.Plus className="w-5 h-5" /> مشروع جديد</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <button onClick={onNewProject} className="group aspect-[4/3] border border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center gap-3 hover:border-blue-500 hover:bg-white/5 transition">
                            <div className="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center group-hover:bg-blue-500 group-hover:text-white transition"><Icons.Plus className="w-6 h-6" /></div>
                            <span className="font-medium text-white/60 group-hover:text-white">إنشاء ذكي</span>
                        </button>
                        {projects.map((p) => (
                            <div key={p.id} onClick={() => onOpenProject(p)} className="group cursor-pointer relative aspect-[4/3] bg-gray-900 rounded-xl overflow-hidden border border-white/10 hover:border-white/30 transition">
                                <div className="absolute inset-0 p-6 bg-gradient-to-br from-gray-800 to-black group-hover:scale-105 transition duration-500">
                                    <div className="w-1/2 h-2 bg-white/20 rounded mb-2"></div>
                                    <div className="w-full h-1 bg-white/10 rounded mb-1"></div>
                                    <div className="w-full h-20 bg-white/5 rounded border border-white/5 flex items-center justify-center mt-4 overflow-hidden">
                                        {p.slides[0].blocks.find(b => b.type === 'image')?.imageUrl ? <img src={p.slides[0].blocks.find(b => b.type === 'image')?.imageUrl} className="w-full h-full object-cover opacity-50" /> : <Icons.Image className="w-8 h-8 text-white/10" />}
                                    </div>
                                </div>
                                <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                                    <h3 className="font-semibold truncate text-right" dir="auto">{p.title}</h3>
                                    <div className="flex justify-between text-xs text-white/50 mt-1"><span className="capitalize">{p.type}</span><span>الآن</span></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </main>
            </div>
        );

        const AILoading = () => (
            <div className="fixed inset-0 bg-black flex flex-col items-center justify-center z-50">
                <div className="w-full max-w-md text-center space-y-8">
                    <div className="relative w-24 h-24 mx-auto">
                        <div className="absolute inset-0 rounded-full border-4 border-blue-900/50"></div>
                        <div className="absolute inset-0 rounded-full border-4 border-t-blue-500 animate-spin"></div>
                        <Icons.Sparkles className="absolute inset-0 m-auto w-8 h-8 text-blue-400 animate-pulse" />
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold text-white mb-2">جارٍ التصميم باستخدام Lumina...</h2>
                        <p className="text-blue-300/80 animate-pulse">كتابة المحتوى • رسم الصور بدقة 4K • تنسيق الشرائح</p>
                    </div>
                </div>
            </div>
        );

        // --- Main App Logic ---
        const App = () => {
            const [view, setView] = useState('landing');
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [isAIGenerating, setIsAIGenerating] = useState(false);
            const DEFAULT_API_KEY = 'AIzaSyBks1niA75pswcefkI1dKmxLd2hNjzowgk';
            const [apiKey, setApiKey] = useState(DEFAULT_API_KEY);

            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [user, setUser] = useState(null);
            const supabaseClientRef = useRef(null);

            const OWNER_ID = (window && window.LUMINA_OWNER_ID) || 'owner-id-placeholder';
            const getUserId = (u) => (u && (u.id || (u.user && u.user.id))) || null;
            const isOwner = getUserId(user) === OWNER_ID;

            // Initialize Supabase and current user (reuse platform config)
            useEffect(() => {
                const initSupabaseUser = async () => {
                    try {
                        if (!window.initializeSupabase || !window.supabaseAuth) {
                            console.warn('Supabase helpers not found, using offline demo mode for Lumina');
                            setUser({ id: 'offline-user', isOffline: true });
                            return;
                        }
                        const client = window.supabaseClient || window.initializeSupabase();
                        supabaseClientRef.current = client;

                        const { data: userData, error } = await window.supabaseAuth.getCurrentUser();
                        if (error || !userData) {
                            console.warn('No logged-in user for Lumina, using offline demo mode');
                            setUser({ id: 'offline-user', isOffline: true });
                            return;
                        }

                        setUser(userData);
                    } catch (e) {
                        console.error('Supabase init error for Lumina:', e);
                        setUser({ id: 'offline-user', isOffline: true });
                    }
                };

                initSupabaseUser();
            }, []);

            const handleCreateProject = async (topic, type) => {
                setShowCreateModal(false);
                setIsAIGenerating(true);

                let slides = [];

                if (apiKey) {
                    slides = await fetchGeminiContent(apiKey, topic, type);
                } else {
                    await new Promise(r => setTimeout(r, 2000));
                    slides = [{ id: '1', title: topic, blocks: [{ id: 'b1', type: 'heading', content: 'Demo Mode' }, { id: 'b2', type: 'paragraph', content: 'Enter API Key for real AI.' }, { id: 'b3', type: 'image', content: 'demo', imageUrl: 'https://placehold.co/600x400/purple/white?text=Demo+Image' }] }];
                }
                
                // Fallback to a minimal slide if AI returns no slides
                if (!slides || slides.length === 0) {
                    slides = [{ id: '1', title: topic, blocks: [
                        { id: 'b1', type: 'heading', content: topic },
                        { id: 'b2', type: 'paragraph', content: 'تم توليد مخطط بسيط. يمكنك التعديل والحفظ.' }
                    ] }];
                }

                const newProject = { id: Date.now().toString(), title: topic, type, slides, theme: 'dark', createdAt: new Date() };
                setProjects([newProject, ...projects]);
                setCurrentProject(newProject);
                setIsAIGenerating(false);
                setView('editor');
            };

            const handleSaveProjectToPlatform = async (projectToSave) => {
                if (!user || !supabaseClientRef.current || user.isOffline) {
                    alert('لا يمكن الحفظ في المنصة بدون تسجيل الدخول. سيتم استخدام وضع العرض التجريبي فقط.');
                    return;
                }

                const client = supabaseClientRef.current;
                try {
                    const payload = {
                        title: projectToSave.title || 'عرض بدون عنوان',
                        type: projectToSave.type || 'presentation',
                        slides: projectToSave.slides || [],
                        theme: projectToSave.theme || 'dark',
                        user_id: user.id
                    };

                    let saved;
                    if (projectToSave.id && typeof projectToSave.id === 'string' && !projectToSave.id.startsWith('tmp-')) {
                        const { data, error } = await client
                            .from('presentations')
                            .update(payload)
                            .eq('id', projectToSave.id)
                            .eq('user_id', user.id)
                            .select()
                            .single();
                        if (error) throw error;
                        saved = data;
                    } else {
                        const { data, error } = await client
                            .from('presentations')
                            .insert([{ ...payload }])
                            .select()
                            .single();
                        if (error) throw error;
                        saved = data;
                    }

                    if (saved) {
                        setCurrentProject(prev => ({ ...(prev || {}), ...saved }));
                        setProjects(prev => {
                            const others = prev.filter(p => p.id !== saved.id);
                            return [saved, ...others];
                        });
                        alert('تم حفظ العرض في المنصة بنجاح ✅');
                    }
                } catch (error) {
                    console.error('Error saving presentation:', error);
                    alert('حدث خطأ أثناء حفظ العرض. تأكد من وجود جدول presentations في قاعدة البيانات وسياسات RLS المناسبة.');
                }
            };

            return (
                <div className="font-sans text-slate-900 bg-white">
                    {view === 'landing' && <LandingPage onLogin={() => setView('dashboard')} />}
                    {view === 'dashboard' && (
                        <>
                            <Dashboard projects={projects} onOpenProject={(p) => { setCurrentProject(p); setView('editor'); }} onNewProject={() => setShowCreateModal(true)} onOpenSettings={() => (isOwner ? setShowSettings(true) : alert('غير مسموح بتعديل مفتاح API'))} />
                            <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} apiKey={apiKey} setApiKey={setApiKey} isOwner={isOwner} />
                            {showCreateModal && <CreateProjectModal onClose={() => setShowCreateModal(false)} onCreate={handleCreateProject} hasKey={!!apiKey} />}
                            {isAIGenerating && <AILoading />}
                        </>
                    )}
                    {view === 'editor' && currentProject && <Editor project={currentProject} onBack={() => setView('dashboard')} apiKey={apiKey} onSave={handleSaveProjectToPlatform} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
