<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>صديق الدراسة الذكي - النسخة الصوتية</title>
  <meta name="description" content="صديق الدراسة الذكي (Voice-First): محاكاة جلسة دراسية مباشرة مع مرشد ودود. تفاعل صوتي بالعربية مع دعم للنص والصوت." />
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --accent: #16a34a;
      --danger: #ef4444;
      --ring: rgba(37, 99, 235, 0.15);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Cairo, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    header {
      background: var(--card);
      border-bottom: 1px solid #e5e7eb;
      position: sticky; top: 0; z-index: 10;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 992px) { .row { grid-template-columns: 1.1fr 0.9fr; } }
    .card { background: var(--card); border: 1px solid #eef2f7; border-radius: 14px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.03); }
    .card-body { padding: 16px; }
    .title { margin: 0; font-size: 20px; font-weight: 800; }
    .sub { color: var(--muted); font-size: 14px; margin-top: 6px; }
    .stack-v { display: flex; flex-direction: column; gap: 12px; }
    .stack-h { display: flex; gap: 8px; align-items: center; }
    .pill { background: #f1f5f9; color: #0f172a; padding: 8px 12px; border-radius: 999px; font-size: 13px; }
    .btn {
      border: 0; border-radius: 12px; padding: 12px 14px; font-weight: 700; cursor: pointer; transition: transform .05s ease-in-out, background .2s;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-ghost { background: #f1f5f9; color: #0f172a; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .input, textarea {
      width: 100%; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 14px; font-size: 15px; outline: none;
    }
    .input:focus, textarea:focus { box-shadow: 0 0 0 4px var(--ring); border-color: var(--primary); }
    textarea { min-height: 650px; resize: vertical; }
    .chat { height: 560px; overflow: auto; display: flex; flex-direction: column; gap: 10px; padding: 8px; border: 1px solid #eef2f7; border-radius: 12px; background: #fafafa; }
    .msg { display: flex; gap: 10px; align-items: flex-start; }
    .msg .bubble {
      padding: 10px 12px; border-radius: 14px; max-width: 95%; line-height: 1.7; font-size: 16px; word-wrap: break-word;
    }
    .from-user .bubble { background: var(--primary); color: #fff; border-top-left-radius: 4px; margin-left: 32px; }
    .from-ai .bubble { background: #eef2f7; color: #0f172a; border-top-right-radius: 4px; margin-right: 32px; }
    .muted { color: var(--muted); font-size: 13px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f1f5f9; color: #0f172a; font-size: 12px; }
    .footer { padding-top: 8px; }
    .screen-box { border:1px dashed #cbd5e1; border-radius:12px; padding:10px; background:#f8fafc }
    video#screenPreview { width:100%; max-height:220px; background:#000; border-radius:10px }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- PDF.js for client-side PDF text extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    }
  </script>
  <script src="js/i18n.js"></script>
</head>
<body>
  <header>
    <div class="container stack-h" style="justify-content: space-between;">
      <div class="stack-h">
        <button class="btn btn-ghost" onclick="window.location.href='index.html'" title="الرجوع">
          ← رجوع
        </button>
        <div>
          <h1 class="title" data-i18n="voice.title">صديق الدراسة الذكي — النسخة الصوتية</h1>
          <div class="sub">&nbsp;</div>
        </div>
      </div>
      <div class="stack-h">
        <select id="langSelect" onchange="setLanguage(this.value)" class="pill" style="padding:6px 10px;">
          <option value="ar">العربية</option>
          <option value="en">English</option>
        </select>
        <span class="badge" data-i18n="voice.badge">وضع صوت أولاً</span>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top: 16px;">
    <div class="row">
      <section class="card">
        <div class="card-body stack-v">
          <div>
            <div class="title" style="font-size:18px" data-i18n="voice.session">جلسة مباشرة</div>
            <div class="sub">&nbsp;</div>
          </div>

          <div class="stack-h" style="flex-wrap: wrap; gap: 8px 8px;">
            <button id="micBtn" class="btn btn-primary" onclick="toggleMic()" data-i18n="voice.buttons.mic_on">تشغيل الميكروفون 🎙️</button>
            <button id="audioEnableBtn" class="btn btn-accent" onclick="enableAudioOnMobile()" style="display:none" data-i18n="voice.buttons.enable_audio">تفعيل الصوت 🔊</button>
            <button id="pttBtn" class="btn btn-primary" onclick="togglePTT()" style="display:none" data-i18n="voice.buttons.ptt">اضغط وتكلم 🎤</button>
            <button id="speakBtn" class="btn btn-accent" onclick="ttsPlayLast()" disabled data-i18n="voice.buttons.replay">إعادة تشغيل الصوت 🔊</button>
            <button class="btn btn-ghost" onclick="clearChat()" data-i18n="voice.buttons.clear">مسح المحادثة</button>
            <button id="modeBtn" class="btn btn-ghost" onclick="toggleDirectMode()" title="وضع إجابة مباشرة" data-i18n="voice.buttons.direct_on">وضع إجابة مباشرة: مفعل</button>
          </div>

          <div id="chat" class="chat">
            <div class="msg from-ai">
              <div class="bubble">
                <span data-i18n="voice.greeting">مرحباً! أنا جاهز أذاكر معاك. الصق نص المحاضرة أو ابدأ بسؤالك الأول.</span>
              </div>
            </div>
          </div>

          <div class="footer stack-h">
            <input id="textInput" class="input" data-i18n-attr="placeholder:voice.input.placeholder" placeholder="اكتب أو الصق سؤالك هنا... ثم اضغط Enter" onkeypress="if(event.key==='Enter'){submitText()}" />
            <button class="btn btn-primary" onclick="submitText()">Send</button>
          </div>
          <div class="muted" data-i18n="voice.tip">Tip: After each answer I may ask if you want more detail or an example.</div>
        </div>
      </section>

      <aside class="card">
        <div class="card-body stack-v">
          <div>
            <div class="title" style="font-size:18px" data-i18n="voice.source.title">مصدر المحاضرة</div>
            <div class="sub" data-i18n="voice.source.subtitle">ألصق نص المحاضرة هنا. سيتم التعامل معه كمصدر الحقيقة أثناء الجلسة.</div>
          </div>
          <textarea id="lectureInput" data-i18n-attr="placeholder:voice.lectureInput.placeholder" placeholder="الصق هنا نص المحاضرة ..." oninput="updateLectureStats()"></textarea>
          <div class="muted" id="lectureStats"></div>

          <div class="stack-v">
            <div class="title" style="font-size:16px" data-i18n="voice.files.title">ملفات للمذاكرة</div>
            <div class="sub" data-i18n="voice.files.subtitle">ارفع ملفات PDF/TXT/MD وسيتم استخراج النص وإضافته للمصدر</div>
            <div class="stack-h" style="flex-wrap:wrap">
              <input id="pdfFiles" type="file" multiple accept=".pdf,.txt,.md" class="input" style="padding:10px" />
              <button class="btn btn-primary" onclick="uploadSelectedFiles()" data-i18n="voice.files.upload_btn">رفع الملفات</button>
              <button class="btn btn-accent" onclick="startAutoExplain()" data-i18n="voice.buttons.auto_explain">ابدأ الشرح الآن</button>
              <button class="btn btn-ghost" onclick="startLiveAboutLecture()">التحدث Live عن ذلك</button>
              <button class="btn btn-primary" onclick="generateAudioFromLecture()">إنشاء ملخّص صوتي 🎧</button>
              <button class="btn btn-ghost" onclick="readLectureAloud()" data-i18n="voice.buttons.read_aloud">قراءة المحاضرة بصوت</button>
              <button class="btn btn-danger" onclick="stopReading()" data-i18n="voice.buttons.stop_reading">إيقاف القراءة</button>
            </div>
            <div id="uploadsList" class="muted"></div>
            <div id="audioResult" class="stack-v" style="margin-top:8px">
              <audio id="aiAudio" controls style="width:100%; display:none"></audio>
              <a id="audioDownload" href="#" download="lecture-explain.mp3" style="display:none">تحميل الصوت (MP3)</a>
              <div id="customPlayer" style="display:none; background:#f1f5f9; border:1px solid #e5e7eb; border-radius:14px; padding:10px;">
                <div style="display:flex; align-items:center; gap:12px;">
                  <input id="cpBar" type="range" min="0" max="100" value="0" style="flex:1;" />
                  <span id="cpTime" class="muted">0:00</span>
                </div>
                <div style="display:flex; align-items:center; justify-content:center; gap:18px; margin-top:6px;">
                  <button id="cpDownload" class="btn btn-ghost" title="تحميل">⬇️</button>
                  <button id="cpBack" class="btn btn-ghost" title="-10s">↺10</button>
                  <button id="cpPlay" class="btn btn-primary" title="تشغيل">▶️</button>
                  <button id="cpFwd" class="btn btn-ghost" title="+10s">10↻</button>
                  <button id="cpSpeed" class="btn btn-ghost" title="السرعة">1x</button>
                </div>
              </div>
            </div>
          </div>

          <div class="stack-v">
            <div class="title" style="font-size:16px" data-i18n="voice.share.title">مشاركة الشاشة (تجريبي)</div>
            <div class="sub" data-i18n="voice.share.subtitle">شارك شاشة المحاضرة، التقط لقطة، واستخرج النص تلقائياً لإضافته للمصدر.</div>
            <div class="screen-box stack-v">
              <video id="screenPreview" autoplay muted playsinline></video>
              <div class="stack-h" style="flex-wrap:wrap;margin-top:8px">
                <button id="shareBtn" class="btn btn-primary" onclick="startScreenShare()" data-i18n="voice.buttons.share_screen">بدء مشاركة الشاشة</button>
                <button id="stopShareBtn" class="btn btn-danger" onclick="stopScreenShare()" disabled data-i18n="voice.buttons.stop_share">إيقاف</button>
                <button id="snapOcrBtn" class="btn btn-accent" onclick="captureAndOCR()" disabled data-i18n="voice.buttons.capture_ocr">التقاط واستخراج نص</button>
              </div>
              <div id="ocrStatus" class="muted"></div>
            </div>
          </div>

          

          <div class="stack-h" style="justify-content: space-between; flex-wrap: wrap;">
            <span class="pill" id="recStatus">الحالة: الميكروفون متوقف</span>
            <div class="stack-h">
              <button class="btn btn-ghost" onclick="loadSample()">ملء مثال</button>
              <button class="btn btn-danger" onclick="resetLecture()">مسح المصدر</button>
              <button class="btn btn-primary" onclick="summarizeLecture()">تلخيص المحاضرة</button>
              <button class="btn btn-accent" onclick="explainLecture()">اشرح المحاضرة</button>
            </div>
          </div>

          <div class="stack-v">
            <div class="title" style="font-size:16px">اختبار سريع مُتكيف</div>
            <div class="sub">إنشاء سؤال من آخر جزء تمت مناقشته</div>
            <div class="stack-h">
              <button class="btn btn-accent" onclick="makeAdaptiveQuestion()">سؤال سريع</button>
              <button class="btn btn-ghost" onclick="toggleTougher()">زيادة الصعوبة</button>
            </div>
            <div id="quizSlot" class="muted"></div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // --------------- State ---------------
    const state = {
      recognizing: false,
      lastUtterance: '',
      history: [], // {role: 'user'|'ai', text}
      tougher: false,
      questionsSinceBreak: 0,
      uploads: [],
      token: null,
      directAnswer: true,
      live: false,
      speaking: false,
      screenStream: null,
      audioEnabled: false,
      
    };

    // Persona & phrases
    const persona = {
      prefix: 'حسب اللي مكتوب في المحاضرة بتاعتنا...',
      warmups: [
        'تمام، يلا بينا نركز',
        'يا بطل، أنت ماشي صح',
        'فهمت قصدك',
        'خليني أبسّطهالك في نقطتين',
        'برافو!'
      ],
      follow: 'ها، كده تمام؟ تحب نشرحها بتفصيل أكتر أو نجيب مثال؟',
    };

    const chat = document.getElementById('chat');
    const textInput = document.getElementById('textInput');
    const lectureInput = document.getElementById('lectureInput');
    const recStatus = document.getElementById('recStatus');
    const micBtn = document.getElementById('micBtn');
    const speakBtn = document.getElementById('speakBtn');
    const quizSlot = document.getElementById('quizSlot');
    const uploadsList = document.getElementById('uploadsList');
    const lectureStats = document.getElementById('lectureStats');
    const pdfFiles = document.getElementById('pdfFiles');
    const screenPreview = document.getElementById('screenPreview');
    const ocrStatus = document.getElementById('ocrStatus');
    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent || '');
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent || '');
    let mediaStream = null;
    let mediaRecorder = null;
    let recordChunks = [];
    let readingQueue = [];
    let readingIndex = 0;
    let readingActive = false;
    

    // --------------- Helpers ---------------
    function appendMsg(role, text) {
      const wrap = document.createElement('div');
      wrap.className = `msg ${role==='user'?'from-user':'from-ai'}`;
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      wrap.appendChild(b);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      state.history.push({ role, text });
    }

    function pickWarmup(){
      const arr = persona.warmups;
      return arr[Math.floor(Math.random()*arr.length)];
    }

    function clean(text){ return (text||'').replace(/\s+/g,' ').trim(); }

    function splitSentences(t){
      return (t||'').split(/[.!؟\n]+/).map(s=>clean(s)).filter(Boolean);
    }

    function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }

    function updateLectureStats(){
      try{
        const len = (lectureInput?.value||'').length;
        if (lectureStats) lectureStats.textContent = `حجم النص: ${len.toLocaleString()} حرف`;
      }catch(_){ }
    }

    // --------------- Smart Context Chunking ---------------
    function selectContextFor(question){
      const text = getLecture();
      if(!text) return '';
      // Further increased limits to include more of the lecture in answers
      const chunkSize = 20000; // chars per chunk
      const maxSend = 60000; // total chars to send
      const chunks = [];
      for(let i=0;i<text.length;i+=chunkSize){ chunks.push(text.slice(i, i+chunkSize)); }
      const qTokens = (clean(question).toLowerCase().split(/\s+/).filter(t=>t.length>2));
      const scored = chunks.map((c,idx)=>{
        const score = qTokens.reduce((acc,t)=> acc + (c.toLowerCase().includes(t)?1:0), 0);
        return { idx, c, score };
      });
      scored.sort((a,b)=> b.score - a.score);
      let picked = '';
      // pick more top chunks within the new maxSend limit
      for(const s of scored.slice(0,4)){
        if((picked.length + s.c.length) <= maxSend){ picked += (picked?"\n\n":"") + s.c; }
      }
      return picked || text.slice(0, maxSend);
    }

    // --------------- TTS (speechSynthesis) ---------------
    function waitForVoices(timeoutMs = 1500){
      return new Promise((resolve)=>{
        try{
          const have = speechSynthesis.getVoices();
          if(have && have.length){ resolve(true); return; }
          let done = false;
          const onv = ()=>{ if(!done){ done=true; resolve(true); speechSynthesis.onvoiceschanged=null; } };
          speechSynthesis.onvoiceschanged = onv;
          setTimeout(()=>{ if(!done){ done=true; resolve(true); speechSynthesis.onvoiceschanged=null; } }, timeoutMs);
        }catch(_){ resolve(true); }
      });
    }
    function getArabicVoice(){
      const voices = speechSynthesis.getVoices() || [];
      // Prefer high-quality Arabic voices if available
      const prefs = [
        /Google.*Arabic/i,
        /Microsoft.*Arabic/i,
        /ar-SA/i,
        /ar-XA/i,
        /Arabic/i,
        /ar/i
      ];
      for (const re of prefs){
        const v = voices.find(v => re.test(`${v.name} ${v.lang}`));
        if (v) return v;
      }
      return voices[0] || null;
    }

    async function speak(text){
      if(!('speechSynthesis' in window)) return;
      // On mobile, require explicit enable due to autoplay policy
      if (isMobile && !state.audioEnabled) return;
      try{ await waitForVoices(1500); }catch(_){ }
      try{ if (speechSynthesis.paused) speechSynthesis.resume(); }catch(_){ }
      const u = new SpeechSynthesisUtterance(text);
      const v = getArabicVoice();
      if(v) u.voice = v;
      u.lang = (v && v.lang) || 'ar-SA';
      // Slightly slower, clearer rate for mobile; normal for desktop
      u.rate = isMobile ? 0.9 : 1.0; 
      u.pitch = 1.02; 
      u.volume = 1.0;
      try{ window.speechSynthesis.cancel(); }catch(_){ }
      u.onstart = ()=>{
        state.speaking = true;
        // Pause recognition while speaking to avoid echo
        try{ if(recog && state.recognizing) recog.stop(); }catch(_){ }
      };
      u.onend = ()=>{
        state.speaking = false;
        // Auto-resume listening in live mode
        if(state.live && recog && !state.recognizing){
          try{ recog.start(); }catch(_){ }
        }
      };
      window.speechSynthesis.speak(u);
      state.lastUtterance = text;
      speakBtn.disabled = false;
    }

    function ttsPlayLast(){ if(state.lastUtterance) speak(state.lastUtterance); }

    // Long-form reading of the lecture in chunks
    function splitLectureForReading(text){
      const maxChunk = 1600; // longer paragraph per utterance for fewer breaks
      const parts = [];
      let i = 0;
      while(i < text.length){
        let end = Math.min(i + maxChunk, text.length);
        // try to cut at sentence/phrase boundary for Arabic
        const slice = text.slice(i, end);
        const stops = ['.','!','؟','…','\n','،'];
        let lastStop = -1;
        for(const s of stops){ const p = slice.lastIndexOf(s); if(p > lastStop) lastStop = p; }
        if(lastStop > 200){ end = i + lastStop + 1; }
        parts.push(text.slice(i, end).trim());
        i = end;
      }
      return parts.filter(Boolean);
    }

    function stopReading(){
      readingActive = false;
      try{ window.speechSynthesis.cancel(); }catch(_){ }
      appendMsg('ai', 'تم إيقاف القراءة.');
      try{ logActivity('lecture_read_end', 'إيقاف قراءة المحاضرة بصوت', 'book'); }catch(_){ }
    }

    async function readLectureAloud(){
      const lecture = getLecture();
      if(!lecture || lecture.length < 30){
        appendMsg('ai', 'محتاج نص من المحاضرة الأول عشان أقرأه.');
        return;
      }
      if(isMobile && !state.audioEnabled){
        appendMsg('ai', 'قبل ما أقرأ، اضغط "تفعيل الصوت 🔊" علشان الصوت يشتغل على جهازك.');
        return;
      }
      if(readingActive){ appendMsg('ai', 'أنا بالفعل بقرأ. تقدر تضغط "إيقاف القراءة" لإيقافها.'); return; }
      readingQueue = splitLectureForReading(lecture);
      if(!readingQueue.length){ appendMsg('ai', 'لم أجد فقرات مناسبة للقراءة.'); return; }
      readingIndex = 0;
      readingActive = true;
      appendMsg('ai', 'حاضر، هاقرأ لك المحاضرة فقرة فقرة. تقدر توقف في أي وقت.');
      try{ logActivity('lecture_read_start', 'بدء قراءة المحاضرة بصوت', 'book'); }catch(_){ }
      const speakNext = ()=>{
        if(!readingActive) return;
        if(readingIndex >= readingQueue.length){ readingActive = false; appendMsg('ai', 'انتهيت من قراءة المحاضرة.'); return; }
        const chunk = readingQueue[readingIndex++];
        const u = new SpeechSynthesisUtterance(chunk);
        const v = getArabicVoice(); if(v) u.voice = v; u.lang = (v && v.lang) || 'ar-SA';
        u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
        u.onend = ()=>{ if(readingActive){ setTimeout(speakNext, 250); } };
        try{ window.speechSynthesis.speak(u); }catch(_){ readingActive = false; }
      };
      speakNext();
    }

    // Mobile audio unlock (required for TTS on iOS/Android)
    function enableAudioOnMobile(){
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          const ctx = new AC();
          const buffer = ctx.createBuffer(1, 1, 22050);
          const src = ctx.createBufferSource();
          src.buffer = buffer; src.connect(ctx.destination); src.start(0);
        }
      } catch(_){ }
      state.audioEnabled = true;
      const btn = document.getElementById('audioEnableBtn');
      if (btn) btn.style.display = 'none';
      try { if (state.lastUtterance) speakBtn.disabled = false; } catch(_){ }
      appendMsg('ai', 'تم تفعيل الصوت على جهازك. اسألني وسوف أجيبك بصوت.');
    }

    // --------------- STT (SpeechRecognition) ---------------
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog = null;
    if(SR){
      recog = new SR();
      recog.lang = 'ar-SA';
      // iOS Safari is more stable with non-continuous mode
      recog.continuous = isIOS ? false : true; // live loop on Android/Desktop
      recog.interimResults = false;
      recog.maxAlternatives = 1;

      recog.onstart = ()=>{ state.recognizing = true; recStatus.textContent = 'الحالة: جاري الاستماع...'; micBtn.textContent = 'إيقاف الميكروفون ⏹️'; };
      recog.onend = ()=>{
        state.recognizing = false; 
        recStatus.textContent = 'الحالة: الميكروفون متوقف'; 
        micBtn.textContent = 'تشغيل الميكروفون 🎙️';
        // If in live mode and not speaking, restart listening
        if(state.live && !state.speaking){
          try{ recog.start(); }catch(_){ }
        }
      };
      recog.onerror = ()=>{ state.recognizing = false; recStatus.textContent = 'الحالة: خطأ في الاستماع'; };
      recog.onresult = (e)=>{
        const t = e.results[0][0].transcript || '';
        if(t){ appendMsg('user', t); handleUserQuery(t); }
      };
    }

    function toggleMic(){
      if(!recog){ alert('خاصية التعرّف على الصوت غير مدعومة في هذا المتصفح. يُفضّل استخدام Chrome.'); return; }
      // Toggle live conversation mode similar to Gemini Live
      if(state.live || state.recognizing){
        state.live = false;
        try{ recog.stop(); }catch(_){ }
        return;
      }
      state.live = true;
      try{ recog.start(); }catch(_){ }
    }

    // --------------- Core Logic ---------------
    const API_BASE = 'https://student-platform-backend-one.vercel.app';
    async function ensureSession(){
      try{
        if(!window.supabaseClient) window.initializeSupabase();
        const { data } = await window.supabaseAuth.getSession();
        const tok = data?.session?.access_token;
        if(tok) state.token = tok;
        try{ state.userId = data?.session?.user?.id || state.userId; }catch(_){ }
        return tok;
      }catch(_){ return null; }
    }

    // Lightweight activity logger (safe no-op if table not present)
    async function logActivity(type, description, icon='star'){
      try{
        if(!window.supabaseDB || !window.supabaseDB.activities || !window.supabaseDB.activities.create) return;
        const tok = await ensureSession().catch(()=>null);
        const userId = state.userId || null;
        if(!tok || !userId) return; // require auth
        await window.supabaseDB.activities.create({
          user_id: userId,
          type: type,
          description: description,
          icon: icon,
          created_at: new Date().toISOString()
        });
      }catch(_){ }
    }

    async function uploadFile(file){
      try{
        const tok = await ensureSession();
        if(!tok){ return null; }
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch(`${API_BASE}/api/upload`, { method:'POST', headers:{ 'Authorization': `Bearer ${tok}` }, body: fd });
        if(!res.ok) return null;
        const json = await res.json();
        return json;
      }catch(_){ return null; }
    }

    function renderUploads(){
      if(!state.uploads.length){ uploadsList.textContent = ''; return; }
      uploadsList.innerHTML = state.uploads.map(u=>`✔️ ${u.name || 'ملف'} — ${Math.round((u.size||0)/1024)}KB`).join('<br/>');
    }

    async function uploadSelectedFiles(){
      const files = (pdfFiles && pdfFiles.files) ? Array.from(pdfFiles.files) : [];
      if(!files.length){ alert('اختر ملفات أولاً'); return; }
      for(const f of files){
        // For TXT/MD, extract locally as immediate fallback
        try{
          if(/\.(txt|md)$/i.test(f.name)){
            const localText = await f.text();
            if (localText && localText.trim()) {
              lectureInput.value = (lectureInput.value ? (lectureInput.value + "\n\n") : '') + localText;
            }
          }
        } catch (_) {}
      }

      // For PDFs, extract full text on the client using PDF.js with live progress
      try {
        if (window['pdfjsLib']) {
          for (const f of files) {
            if(/\.(pdf)$/i.test(f.name)){
              try {
                const buf = await f.arrayBuffer();
                const doc = await pdfjsLib.getDocument({ data: buf }).promise;
                for (let i = 1; i <= doc.numPages; i++) {
                  const page = await doc.getPage(i);
                  const content = await page.getTextContent();
                  const pageText = content.items.map(it => (it.str || '')).join(' ');
                  // Append per-page to avoid huge in-memory strings
                  lectureInput.value = (lectureInput.value ? (lectureInput.value + '\n\n') : '') + pageText;
                  updateLectureStats();
                  // Lightweight yield to keep UI responsive
                  await new Promise(r=>setTimeout(r,0));
                  // Show progress
                  if (uploadsList) uploadsList.textContent = `جارٍ استخراج: ${f.name} — صفحة ${i}/${doc.numPages}`;
                }
                state.uploads.push({ name: f.name, size: f.size });
                renderUploads();
              } catch(_) {}
            }
          }
        }
      } catch(_) {}

      // Optional server upload (only if logged in)
      try{
        const tokCheck = await ensureSession();
        if (tokCheck) {
          for(const f of files){
            try{
              const r = await uploadFile(f);
              if(r){
                state.uploads.push(r);
                if(r.extractedText && r.extractedText.trim()){
                  lectureInput.value = (lectureInput.value ? (lectureInput.value + "\n\n") : '') + r.extractedText;
                }
              }
              renderUploads();
            }catch(_){ }
          }
        }
      }catch(_){ }
      if(pdfFiles) pdfFiles.value = '';
      // بعد رفع الملفات ودمج النص
      try { 
        const lectureText = getLecture();
        if(!lectureText || lectureText.length < 30){
          appendMsg('ai', `${persona.prefix} محتاج نص واضح من المحاضرة عشان أشرح. جرّب رفع PDF أو TXT/MD وسيتم استخراج النص مباشرة.`);
          speak(`${persona.prefix} محتاج نص من المحاضرة عشان أبدأ أشرح.`);
        } else {
          // على الجوال: اطلب تفعيل الصوت قبل التحدث
          if (isMobile && !state.audioEnabled) {
            appendMsg('ai', 'قبل ما أتكلم، اضغط زر "تفعيل الصوت 🔊" فوق علشان أقدر أتكلم بصوت على جوالك. بعد كده اسألني وأنا هجاوبك بصوت.');
          } else {
            await startAutoExplain();
            try{ logActivity('lecture_uploaded', 'تم رفع ملفات وإضافة نص للمحاضرة', 'upload'); }catch(_){ }
          }
        }
      } catch(_){ }
    }

    async function askGemini(question){
      try{
        const tok = await ensureSession().catch(()=>null);
        const ctx = selectContextFor(question);
        const headers = { 'Content-Type':'application/json' };
        if (tok) headers['Authorization'] = `Bearer ${tok}`;
        const res = await fetch(`${API_BASE}/api/ai/ask`, { method:'POST', headers, body: JSON.stringify({ question, context: ctx }) });
        if(!res.ok) return null;
        const json = await res.json();
        return json?.response || null;
      }catch(_){ return null; }
    }

    // Streaming via SSE (fetch + manual SSE parse)
    async function askGeminiStream(question, onDelta){
      const tok = await ensureSession().catch(()=>null);
      const ctx = selectContextFor(question);
      const headers = { 'Content-Type':'application/json' };
      if (tok) headers['Authorization'] = `Bearer ${tok}`;
      const res = await fetch(`${API_BASE}/api/ai/stream`, { method:'POST', headers, body: JSON.stringify({ question, context: ctx }) });
      if(!res.ok || !res.body) throw new Error('no-stream');
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      while(true){
        const {done, value} = await reader.read(); if(done) break;
        buffer += decoder.decode(value, { stream:true });
        const parts = buffer.split(/\n\n/);
        buffer = parts.pop() || '';
        for(const evt of parts){
          const line = evt.split("\n").find(l=>l.startsWith('data: '));
          if(!line) continue;
          try{
            const payload = JSON.parse(line.slice(6));
            if(payload && payload.text){ onDelta(payload.text); }
          }catch(_){ }
        }
      }
    }

    async function summarizeLecture(){
      const content = getLecture();
      if(!content || content.length < 30){
        appendMsg('ai', `${persona.prefix} محتاج نص المحاضرة عشان أقدر أعمل تلخيص دقيق.`);
        speak('محتاج نص المحاضرة عشان أقدر أعمل تلخيص دقيق.');
        return;
      }
      const prompt = `أنت مساعد دراسي عربي. لديك نص المحاضرة بين يديك. لخّص المحتوى في نقاط واضحة ومختصرة جداً (3-6 نقاط كحد أقصى)، بدون حشو، وبالعربية الفصحى المبسطة. لا تضف مقدمات أو ختام.`;
      let replyText = await askGemini(prompt);
      if(!replyText){
        const sents = splitSentences(content).slice(0,6);
        replyText = `• ${sents.slice(0,4).join('\n• ')}`;
      }
      replyText = `${persona.prefix} \n${replyText}`;
      appendMsg('ai', replyText);
      speak(replyText);
      try{ logActivity('ai_summary', 'تلخيص المحاضرة عبر النسخة الصوتية', 'star'); }catch(_){ }
    }

    async function explainLecture(){
      const content = getLecture();
      if(!content || content.length < 30){
        appendMsg('ai', `${persona.prefix} محتاج نص كفاية من المحاضرة عشان أشرح.`);
        speak('محتاج نص كفاية من المحاضرة عشان أشرح.');
        return;
      }
      const prompt = `اشرح المحاضرة التالية بشكل مبسّط وبالعربية، ركّز على الفكرة الأساسية أولاً ثم نقطتين أو ثلاث من أهم المفاهيم مع مثال عملي صغير لكل نقطة، بدون أسئلة متابعة.`;
      let replyText = await askGemini(prompt);
      if(!replyText){
        const sents = splitSentences(content);
        const take = sents.slice(0,3).join(' ');
        replyText = `الخلاصة: ${take}`;
      }
      replyText = `${persona.prefix} ${replyText}`;
      appendMsg('ai', replyText);
      speak(replyText);
    }

    // Generate a single MP3 file that contains the Arabic explanation of the lecture
    async function generateAudioFromLecture(){
      try{
        const content = getLecture();
        if(!content || content.length < 30){
          appendMsg('ai', `${persona.prefix} محتاج نص المحاضرة الأول (ارفع PDF أو الصق النص).`);
          return;
        }
        appendMsg('ai', 'جاري إنشاء شرح موجز وتحويله إلى صوت...');
        const prompt = `اقرأ نص المحاضرة وقدّم شرحًا مبسّطًا بالعربية في فقرتين إلى ثلاث فقرات قصيرة مع أمثلة سريعة يمكن سماعها في أقل من 5 دقائق.`;
        const explanation = await askGemini(prompt) || content.slice(0, 1200);
        // Request backend TTS (returns data URL)
        const headers = { 'Content-Type':'application/json' };
        const r = await fetch(`${API_BASE}/api/tts`, { method:'POST', headers, body: JSON.stringify({ text: explanation }) });
        if(!r.ok){ appendMsg('ai', 'تعذّر توليد الصوت. تأكد من تهيئة مفتاح OPENAI_API_KEY على السيرفر.'); return; }
        const j = await r.json();
        const url = j && j.audio;
        if(!url){ appendMsg('ai', 'لم يصلني الصوت من الخادم.'); return; }
        // Show custom player styled like the screenshot
        const audio = document.getElementById('aiAudio');
        const link = document.getElementById('audioDownload');
        if(audio){ audio.src = url; audio.style.display='none'; }
        if(link){ link.href = url; link.style.display='none'; }
        setupCustomPlayer(url);
        appendMsg('ai', 'تم إنشاء مُلخّص صوتي. يمكنك تشغيله أو تحميله من المشغّل أدناه.');
      }catch(_){
        appendMsg('ai', 'حدث خطأ أثناء إنشاء الصوت.');
      }
    }

    // ---------------- Custom Audio Player ----------------
    function fmtTime(s){ s = Math.max(0, s|0); const m = (s/60)|0; const ss = (s%60)|0; return `${m}:${ss<10?'0':''}${ss}`; }
    function setupCustomPlayer(url){
      const cp = document.getElementById('customPlayer');
      const bar = document.getElementById('cpBar');
      const time = document.getElementById('cpTime');
      const play = document.getElementById('cpPlay');
      const back = document.getElementById('cpBack');
      const fwd = document.getElementById('cpFwd');
      const spd = document.getElementById('cpSpeed');
      const dl = document.getElementById('cpDownload');
      if(!cp) return;
      // single hidden audio element reused
      const a = document.getElementById('aiAudio');
      a.src = url; a.preload = 'metadata';
      cp.style.display = 'block';
      dl.onclick = ()=>{ try{ const x = document.createElement('a'); x.href=url; x.download='lecture-explain.mp3'; document.body.appendChild(x); x.click(); x.remove(); }catch(_){}}
      let speeds = [1, 1.25, 1.5, 2]; let si = 0; spd.onclick = ()=>{ si=(si+1)%speeds.length; a.playbackRate = speeds[si]; spd.textContent = `${speeds[si]}x`; };
      back.onclick = ()=>{ try{ a.currentTime = Math.max(0, a.currentTime - 10); }catch(_){ } };
      fwd.onclick = ()=>{ try{ a.currentTime = Math.min((a.duration||0), a.currentTime + 10); }catch(_){ } };
      play.onclick = async ()=>{
        try{
          if(a.paused){ await a.play(); play.textContent='⏸️'; } else { a.pause(); play.textContent='▶️'; }
        }catch(_){ }
      };
      a.onloadedmetadata = ()=>{
        try{ bar.value = 0; time.textContent = `0:00 / ${fmtTime(a.duration||0)}`; }catch(_){ }
      };
      a.ontimeupdate = ()=>{
        try{
          const d = a.duration||0; const c = a.currentTime||0; bar.value = d? Math.round((c/d)*100) : 0; time.textContent = `${fmtTime(c)} / ${fmtTime(d)}`;
        }catch(_){ }
      };
      bar.oninput = ()=>{
        try{ const d=a.duration||0; if(d){ a.currentTime = (+bar.value/100)*d; } }catch(_){ }
      };
    }

    // Quick entry to Live mode for the uploaded lecture (like Gemini Live)
    function startLiveAboutLecture(){
      const content = getLecture();
      if(!content || content.length < 30){ appendMsg('ai', 'ارفع المحاضرة أو الصق نصاً أولاً، ثم ابدأ التحدث Live.'); return; }
      appendMsg('ai', 'وضع Live مفعّل. تكلّم الآن وسأردّ معتمداً على نص المحاضرة.');
      // Ensure STT is running
      try{
        if(!recog){ alert('خاصية التعرّف على الصوت غير مدعومة في هذا المتصفح. يُفضّل استخدام Chrome.'); return; }
        if(!state.live){ state.live = true; }
        if(!state.recognizing){ recog.start(); }
      }catch(_){ }
    }

    async function startAutoExplain(){
      const content = getLecture();
      if(!content || content.length < 30){
        appendMsg('ai', `${persona.prefix} محتاج نص المحاضرة الأول عشان أبدأ أشرح. ارفع PDF أو الصق النص.`);
        speak(`${persona.prefix} محتاج نص المحاضرة الأول عشان أبدأ أشرح.`);
        return;
      }
      const prompt = `اقرأ نص المحاضرة المرفق وقدّم شرحًا موجزًا ومنظمًا بالعربية:
- جملتان تلخّصان الفكرة الأساسية.
- نقطتان أو ثلاث نقاط رئيسية مختصرة.
- مثال صغير واحد مرتبط بالمحتوى.
لا تضف أسئلة متابعة.`;
      const aiResp = await askGemini(prompt);
      const fallback = (()=>{
        const sents = splitSentences(content);
        const head = sents.slice(0,2).join(' ');
        const bullets = sents.slice(2,5).map(s=>`• ${s}`).join('\n');
        return `${head}\n${bullets}`;
      })();
      const replyText = aiResp ? `${persona.prefix} ${aiResp}` : `${persona.prefix} ${fallback}`;
      appendMsg('ai', replyText);
      speak(replyText);
    }
    function getLecture(){ return clean(lectureInput.value); }

    function answerFromLecture(question){
      const lecture = getLecture();
      const q = clean(question).toLowerCase();
      if(!lecture){
        const msg = `${persona.prefix} النقطة دي مش مذكورة بالتفصيل في المحاضرة اللي رفعتها. لكن عشان تستفيد، بشكل عام: للإجابة لازم تحط نص المحاضرة هنا الأول.`;
        return { text: msg, fromLecture: false };
      }
      // Naive extractive approach: pick sentences containing key tokens
      const sents = splitSentences(lecture);
      const tokens = q.split(/\s+/).filter(x=>x.length>2);
      let scored = sents.map(s=>({ s, score: tokens.reduce((acc,t)=>acc+(s.includes(t)?1:0),0) }));
      scored.sort((a,b)=>b.score-a.score);
      const top = scored.slice(0, 2).map(x=>x.s).filter(Boolean);
      if(top.length===0){
        const fallback = `${persona.prefix} النقطة دي مش مذكورة بالتفصيل في المحاضرة اللي رفعتها. لكن بشكل عام ممكن نقول: حاول تربط السؤال بالعنوان أو الكلمات المفتاحية الواضحة في النص.`;
        return { text: fallback, fromLecture: false };
      }
      const concise = `${persona.prefix} ${top[0]}${top[1]? ' — '+top[1] : ''}. ${pickWarmup()}!`;
      return { text: concise, fromLecture: true, context: top.join(' | ') };
    }

    async function handleUserQuery(text){
      const q = (text||'').toLowerCase();
      if(/(تلخيص|لخص|خلاصة)/.test(q)){
        await summarizeLecture();
        return;
      }
      if(/(اشرح|شرح)/.test(q)){
        await explainLecture();
        return;
      }
      if (/(اسئلة|أسئلة|سؤال|اختبار|كويز)/.test(q)){
        try{ makeAdaptiveQuestion(); }catch(_){ }
        appendMsg('ai', `${persona.prefix} عملت لك سؤال سريع من المحاضرة. جرّب تجاوبه!`);
        speak('عملت لك سؤال سريع من المحاضرة.');
        try{ logActivity('ai_quiz_generated', 'تم إنشاء سؤال متكيف من المحاضرة', 'star'); }catch(_){ }
        return;
      }
      if (/(اصعب|أصعب|صعب|زود الصعوبة|زود|أعلى صعوبة)/.test(q)){
        try{ toggleTougher(); }catch(_){ }
        appendMsg('ai', `${persona.prefix} تمام، زوّدنا الصعوبة خطوة.`);
        speak('زوّدنا الصعوبة خطوة.');
        return;
      }
      if (/(ابدأ الشرح|ابدأ|ابدا الشرح|ابدا)/.test(q)){
        await startAutoExplain();
        return;
      }
      // Try streaming first
      let bubbleWrap = document.createElement('div');
      bubbleWrap.className = 'msg from-ai';
      let bubble = document.createElement('div'); bubble.className = 'bubble'; bubble.textContent = persona.prefix + ' ';
      bubbleWrap.appendChild(bubble); chat.appendChild(bubbleWrap); chat.scrollTop = chat.scrollHeight;

      let collected = '';
      let speakBuffer = '';
      const flushSpeak = ()=>{
        const sentences = splitSentences(speakBuffer);
        if(sentences.length){ speak(sentences.join('. ')); speakBuffer=''; }
      };
      try{
        await askGeminiStream(text, (delta)=>{
          collected += delta;
          bubble.textContent = `${persona.prefix} ${collected}`;
          // accumulate until sentence end for TTS
          speakBuffer += delta;
          if(/[.!؟]\s*$/.test(delta)){
            const toSpeak = speakBuffer; speakBuffer=''; speak(toSpeak);
          }
        });
        // speak any remainder
        if(speakBuffer.trim()){ flushSpeak(); }
      }catch(_){
        // Fallback non-stream
        let replyText = null;
        const aiResp = await askGemini(text);
        if(aiResp){ replyText = `${persona.prefix} ${aiResp}`; }
        else {
          const local = answerFromLecture(text);
          if(local && (local.fromLecture || local.text)) replyText = local.text; else replyText = `${persona.prefix} ${pickWarmup()}! قل لي: ماذا تريد أن أشرح أو أسهّل؟`;
        }
        bubble.textContent = replyText;
        speak(replyText);
      }
      state.questionsSinceBreak++;

      if(!state.directAnswer){
        // Human-like small pause then follow-up
        await delay(1000);
        const follow = persona.follow;
        appendMsg('ai', follow);
        speak(follow);

        // Break hint every 5 Qs
        if(state.questionsSinceBreak % 5 === 0){
          const br = 'بصراحة تركيزك عالي جدًا! خمس دقايق بريك وارجع، ولا تحب نخلص النقطة دي ونقوم؟';
          appendMsg('ai', br);
          speak(br);
        }
      }
    }

    function submitText(){
      const t = clean(textInput.value);
      if(!t) return;
      textInput.value='';
      appendMsg('user', t);
      handleUserQuery(t);
    }

    function clearChat(){
      chat.innerHTML = '';
      state.history = [];
      appendMsg('ai', `${persona.prefix} تمام، يلا بينا نركز. نبدأ منين؟`);
    }

    function loadSample(){
      lectureInput.value = `العنوان: البراكين وحركة الصفائح التكتونية

علاقة البراكين بحركة الصفائح: تنشأ معظم البراكين على حدود الصفائح التكتونية، وخاصة عند مناطق الاندساس حيث تنغمس صفيحة محيطية أسفل صفيحة قارية مما يؤدي إلى انصهار الصخور وارتفاع الصهارة. كذلك تظهر براكين عند تباعد الصفائح (الحيد الوسط محيطية) حيث تصعد الصهارة لملء الفراغ.

العوامل المؤثرة على شدة البركان: لزوجة الصهارة، كمية الغاز الذائب، وتركيب الصهارة. كلما زادت اللزوجة وازداد الغاز ارتفع الضغط وازدادت الانفجارات.

الآثار: تؤثر البراكين على المناخ مؤقتًا عبر انبعاث الرماد والكبريتات التي تعكس أشعة الشمس، وقد تُخصّب التربة بالمعادن.
`;
    }

    function resetLecture(){ lectureInput.value=''; }

    // --------------- Adaptive Quiz (very light) ---------------
    function makeAdaptiveQuestion(){
      const lecture = getLecture();
      const sents = splitSentences(lecture);
      if(!sents.length){ quizSlot.textContent = 'أضف نص المحاضرة أولاً.'; return; }
      // Pick a sentence and mask a term
      const base = state.tougher ? sents.slice(0, Math.max(2, Math.floor(sents.length/2))) : sents;
      const s = base[Math.floor(Math.random()*base.length)];
      const words = s.split(/\s+/).filter(w=>w.length>3);
      if(words.length<3){ quizSlot.textContent = 'النص قصير لاستخراج سؤال.'; return; }
      const idx = Math.floor(Math.random()*words.length);
      const answer = words[idx];
      const question = s.replace(answer, '_____');
      quizSlot.innerHTML = `<div><strong>سؤال:</strong> أكمل الفراغ: ${question}</div><div style="margin-top:6px"><input id="quizAns" class="input" placeholder="إجابتك"/><button class=\"btn btn-primary\" style=\"margin-top:8px\" onclick=\"gradeAdaptive('${encodeURIComponent(answer)}')\">تحقق</button></div>`;
    }

    function gradeAdaptive(correctEnc){
      const correct = decodeURIComponent(correctEnc);
      const inp = document.getElementById('quizAns');
      const got = clean(inp.value||'');
      if(!got){ return; }
      if(got === correct){
        quizSlot.innerHTML = '<span style="color:var(--accent);font-weight:700">برافو! الإجابة صحيحة.</span>';
        speak('برافو!');
      } else {
        quizSlot.innerHTML = `<span style="color:var(--danger);font-weight:700">تقريبًا. الإجابة الصحيحة: ${correct}</span>`;
        speak('محاولة كويسة!');
      }
    }

    function toggleTougher(){ state.tougher = !state.tougher; alert(state.tougher? 'تم تفعيل صعوبة أعلى' : 'تم إلغاء الصعوبة العالية'); }

    // Toggle direct answer vs. conversational follow-ups
    function toggleDirectMode(){
      state.directAnswer = !state.directAnswer;
      const btn = document.getElementById('modeBtn');
      if(btn){
        btn.textContent = `وضع إجابة مباشرة: ${state.directAnswer ? 'مفعل' : 'متوقف'}`;
      }
    }

    // --------------- Screen Share + OCR ---------------
    async function startScreenShare(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia){
        alert('مشاركة الشاشة غير مدعومة في هذا المتصفح.');
        return;
      }
      try{
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            frameRate: 15,
            // Hint browsers to capture current tab on mobile-supported environments
            preferCurrentTab: true,
            displaySurface: 'browser'
          },
          audio: false
        });
        state.screenStream = stream;
        screenPreview.srcObject = stream;
        document.getElementById('shareBtn').disabled = true;
        document.getElementById('stopShareBtn').disabled = false;
        document.getElementById('snapOcrBtn').disabled = false;
        stream.getVideoTracks()[0].addEventListener('ended', ()=>{
          stopScreenShare();
        });
      }catch(err){
        console.error(err);
        alert('تعذّر بدء مشاركة الشاشة. تأكد من استخدام HTTPS والمتصفح يدعم مشاركة التبويب (Chrome على أندرويد) أو استخدم وضع الكاميرا/رفع صورة.');
      }
    }

    function stopScreenShare(){
      try{
        if(state.screenStream){
          state.screenStream.getTracks().forEach(t=>t.stop());
        }
      }catch(_){ }
      state.screenStream = null;
      if(screenPreview){ screenPreview.srcObject = null; }
      document.getElementById('shareBtn').disabled = false;
      document.getElementById('stopShareBtn').disabled = true;
      document.getElementById('snapOcrBtn').disabled = true;
    }

    async function captureAndOCR(){
      if(!state.screenStream){ alert('ابدأ مشاركة الشاشة أولاً.'); return; }
      const track = state.screenStream.getVideoTracks()[0];
      const imageCapture = ('ImageCapture' in window) ? new ImageCapture(track) : null;
      try{
        ocrStatus.textContent = 'جاري التقاط الصورة ومعالجتها...';
        let bitmap;
        if(imageCapture && imageCapture.grabFrame){
          bitmap = await imageCapture.grabFrame();
        } else {
          // Fallback: draw current frame from video
          await new Promise(r=>setTimeout(r, 100));
          const v = screenPreview;
          const c = document.createElement('canvas');
          c.width = v.videoWidth || 1280; c.height = v.videoHeight || 720;
          const ctx = c.getContext('2d');
          ctx.drawImage(v, 0, 0, c.width, c.height);
          const dataUrl = c.toDataURL('image/png');
          const img = new Image();
          await new Promise(res=>{ img.onload=()=>res(); img.src=dataUrl; });
          const c2 = document.createElement('canvas');
          c2.width = img.width; c2.height = img.height;
          c2.getContext('2d').drawImage(img,0,0);
          bitmap = await createImageBitmap(img);
        }

        // Draw bitmap to canvas for OCR
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width; canvas.height = bitmap.height;
        const ctx2 = canvas.getContext('2d');
        ctx2.drawImage(bitmap, 0, 0);

        // Run OCR via Tesseract.js (Arabic + English)
        const worker = await Tesseract.createWorker('ara+eng');
        const { data } = await worker.recognize(canvas);
        await worker.terminate();

        const extracted = (data && data.text) ? data.text.trim() : '';
        if(extracted){
          lectureInput.value = (lectureInput.value ? lectureInput.value + '\n\n' : '') + extracted;
          appendMsg('ai', `${persona.prefix} تم استخراج نص من الشاشة وإضافته للمصدر.`);
          speak('تم استخراج النص من الشاشة وإضافته.');
          ocrStatus.textContent = `تمت الإضافة (${extracted.length} حرف).`;
        } else {
          ocrStatus.textContent = 'لم يتم العثور على نص واضح. جرّب تكبير الصفحة أو صورة أوضح.';
        }
      }catch(err){
        console.error(err);
        ocrStatus.textContent = 'حدث خطأ أثناء الاستخراج.';
      }
    }

    // Initial gentle voice greeting (non-blocking)
    window.addEventListener('load', ()=>{
      // On mobile, do not auto-speak; show enable button instead
      if (isMobile) {
        const btn = document.getElementById('audioEnableBtn');
        if (btn) btn.style.display = 'inline-block';
        // Auto-enable audio on first user interaction (one-time) to satisfy autoplay policies
        const first = ()=>{ try{ enableAudioOnMobile(); }catch(_){}; document.removeEventListener('touchend', first); document.removeEventListener('click', first); };
        document.addEventListener('touchend', first, { once: true });
        document.addEventListener('click', first, { once: true });
      } else {
        try { speak('أهلاً بيك يا بطل! أنا جاهز أذاكر معاك المادة دي. إيه أول جزء حابب نركز عليه؟'); } catch(_) {}
      }
      if(typeof speechSynthesis !== 'undefined'){
        // Ensure voices are loaded
        speechSynthesis.onvoiceschanged = ()=>{};
      }
      try{ ensureSession(); }catch(_){}
      // Feature detection to guide UI
      const hasShare = !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia);
      if(!hasShare){
        const btn = document.getElementById('shareBtn'); if(btn) btn.disabled = true;
        const snap = document.getElementById('snapOcrBtn'); if(snap) snap.disabled = true;
      }
      // Update stats if prefilled
      updateLectureStats();
    });
    
  </script>
</body>
</html>
