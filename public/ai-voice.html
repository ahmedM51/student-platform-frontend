<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØµØ¯ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµÙˆØªÙŠØ©</title>
  <meta name="description" content="ØµØ¯ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠ (Voice-First): Ù…Ø­Ø§ÙƒØ§Ø© Ø¬Ù„Ø³Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ù…Ø±Ø´Ø¯ ÙˆØ¯ÙˆØ¯. ØªÙØ§Ø¹Ù„ ØµÙˆØªÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¹ Ø¯Ø¹Ù… Ù„Ù„Ù†Øµ ÙˆØ§Ù„ØµÙˆØª." />
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --accent: #16a34a;
      --danger: #ef4444;
      --ring: rgba(37, 99, 235, 0.15);
    }

    // Camera scan (mobile/tablet friendly)
    async function startCamera(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.');
        return;
      }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        state.cameraStream = stream;
        cameraPreview.srcObject = stream;
        document.getElementById('cameraStartBtn').disabled = true;
        document.getElementById('cameraStopBtn').disabled = false;
        document.getElementById('cameraSnapBtn').disabled = false;
      }catch(err){
        console.error(err);
        alert('ØªØ¹Ø°Ù‘Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.');
      }
    }

    function stopCamera(){
      try{ if(state.cameraStream){ state.cameraStream.getTracks().forEach(t=>t.stop()); } }catch(_){ }
      state.cameraStream = null;
      if(cameraPreview){ cameraPreview.srcObject = null; }
      document.getElementById('cameraStartBtn').disabled = false;
      document.getElementById('cameraStopBtn').disabled = true;
      document.getElementById('cameraSnapBtn').disabled = true;
    }

    async function captureFromCamera(){
      if(!state.cameraStream){ alert('Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£ÙˆÙ„Ø§Ù‹.'); return; }
      try{
        cameraStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬...';
        const v = cameraPreview;
        const c = document.createElement('canvas');
        c.width = v.videoWidth || 1280; c.height = v.videoHeight || 720;
        c.getContext('2d').drawImage(v,0,0,c.width,c.height);
        const worker = await Tesseract.createWorker('ara+eng');
        const { data } = await worker.recognize(c);
        await worker.terminate();
        const extracted = (data && data.text) ? data.text.trim() : '';
        if(extracted){
          lectureInput.value = (lectureInput.value ? lectureInput.value + '\n\n' : '') + extracted;
          appendMsg('ai', `${persona.prefix} ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…ØµØ¯Ø±.`);
          speak('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ¥Ø¶Ø§ÙØªÙ‡.');
          cameraStatus.textContent = `ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© (${extracted.length} Ø­Ø±Ù).`;
        } else {
          cameraStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Øµ ÙˆØ§Ø¶Ø­. Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ Ø£Ùˆ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©.';
        }
      }catch(err){
        console.error(err);
        cameraStatus.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬.';
      }
    }

    // OCR for uploaded image
    async function ocrImageFile(){
      const f = imgUpload && imgUpload.files && imgUpload.files[0];
      if(!f){ alert('Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
      try{
        imgOcrStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©...';
        const img = new Image();
        const buf = await f.arrayBuffer();
        const blob = new Blob([buf]);
        const url = URL.createObjectURL(blob);
        await new Promise(res=>{ img.onload=()=>res(); img.src=url; });
        const c = document.createElement('canvas');
        c.width = img.width; c.height = img.height;
        c.getContext('2d').drawImage(img,0,0);
        const worker = await Tesseract.createWorker('ara+eng');
        const { data } = await worker.recognize(c);
        await worker.terminate();
        URL.revokeObjectURL(url);
        const extracted = (data && data.text) ? data.text.trim() : '';
        if(extracted){
          lectureInput.value = (lectureInput.value ? lectureInput.value + '\n\n' : '') + extracted;
          appendMsg('ai', `${persona.prefix} ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ¯Ø±.`);
          speak('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡.');
          imgOcrStatus.textContent = `ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© (${extracted.length} Ø­Ø±Ù).`;
        } else {
          imgOcrStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Øµ ÙˆØ§Ø¶Ø­ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©.';
        }
      }catch(err){
        console.error(err);
        imgOcrStatus.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©.';
      }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Cairo, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    header {
      background: var(--card);
      border-bottom: 1px solid #e5e7eb;
      position: sticky; top: 0; z-index: 10;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 992px) { .row { grid-template-columns: 1.1fr 0.9fr; } }
    .card { background: var(--card); border: 1px solid #eef2f7; border-radius: 14px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.03); }
    .card-body { padding: 16px; }
    .title { margin: 0; font-size: 20px; font-weight: 800; }
    .sub { color: var(--muted); font-size: 14px; margin-top: 6px; }
    .stack-v { display: flex; flex-direction: column; gap: 12px; }
    .stack-h { display: flex; gap: 8px; align-items: center; }
    .pill { background: #f1f5f9; color: #0f172a; padding: 8px 12px; border-radius: 999px; font-size: 13px; }
    .btn {
      border: 0; border-radius: 12px; padding: 12px 14px; font-weight: 700; cursor: pointer; transition: transform .05s ease-in-out, background .2s;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-ghost { background: #f1f5f9; color: #0f172a; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .input, textarea {
      width: 100%; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 14px; font-size: 15px; outline: none;
    }
    .input:focus, textarea:focus { box-shadow: 0 0 0 4px var(--ring); border-color: var(--primary); }
    textarea { min-height: 160px; resize: vertical; }
    .chat { height: 420px; overflow: auto; display: flex; flex-direction: column; gap: 10px; padding: 8px; border: 1px solid #eef2f7; border-radius: 12px; background: #fafafa; }
    .msg { display: flex; gap: 10px; align-items: flex-start; }
    .msg .bubble {
      padding: 10px 12px; border-radius: 14px; max-width: 85%; line-height: 1.6; font-size: 15px; word-wrap: break-word;
    }
    .from-user .bubble { background: var(--primary); color: #fff; border-top-left-radius: 4px; margin-left: 32px; }
    .from-ai .bubble { background: #eef2f7; color: #0f172a; border-top-right-radius: 4px; margin-right: 32px; }
    .muted { color: var(--muted); font-size: 13px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f1f5f9; color: #0f172a; font-size: 12px; }
    .footer { padding-top: 8px; }
    .screen-box { border:1px dashed #cbd5e1; border-radius:12px; padding:10px; background:#f8fafc }
    video#screenPreview, video#cameraPreview { width:100%; max-height:220px; background:#000; border-radius:10px }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <header>
    <div class="container stack-h" style="justify-content: space-between;">
      <div class="stack-h">
        <button class="btn btn-ghost" onclick="window.location.href='index.html'" title="Ø§Ù„Ø±Ø¬ÙˆØ¹">
          â† Ø±Ø¬ÙˆØ¹
        </button>
        <div>
          <h1 class="title">ØµØ¯ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠ â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµÙˆØªÙŠØ©</h1>
          <div class="sub">ØªØ¬Ø±Ø¨Ø© Ù…Ø­Ø§Ø¯Ø«Ø© ØµÙˆØªÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ "Ø§Ù„Ù…Ø±Ø´Ø¯" â€” Ø¹Ø±Ø¨ÙŠØ©ØŒ Ø³Ø±ÙŠØ¹Ø©ØŒ ÙˆØ¯Ø§ÙØ¦Ø©</div>
        </div>
      </div>
      <span class="badge">ÙˆØ¶Ø¹ ØµÙˆØª Ø£ÙˆÙ„Ø§Ù‹</span>
    </div>
  </header>

  <main class="container" style="margin-top: 16px;">
    <div class="row">
      <section class="card">
        <div class="card-body stack-v">
          <div>
            <div class="title" style="font-size:18px">Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</div>
            <div class="sub">"Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ø¨Ø·Ù„! Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ø£Ø°Ø§ÙƒØ± Ù…Ø¹Ø§Ùƒ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¯ÙŠ. Ø¥ÙŠÙ‡ Ø£ÙˆÙ„ Ø¬Ø²Ø¡ Ø­Ø§Ø¨Ø¨ Ù†Ø±ÙƒØ² Ø¹Ù„ÙŠÙ‡ØŸ"</div>
          </div>

          <div class="stack-h" style="flex-wrap: wrap; gap: 8px 8px;">
            <button id="micBtn" class="btn btn-primary" onclick="toggleMic()">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ğŸ™ï¸</button>
            <button id="speakBtn" class="btn btn-accent" onclick="ttsPlayLast()" disabled>Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š</button>
            <button class="btn btn-ghost" onclick="clearChat()">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
            <button id="modeBtn" class="btn btn-ghost" onclick="toggleDirectMode()" title="ÙˆØ¶Ø¹ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©">ÙˆØ¶Ø¹ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©: Ù…ÙØ¹Ù„</button>
          </div>

          <div id="chat" class="chat">
            <div class="msg from-ai">
              <div class="bubble">
                Ø­Ø³Ø¨ Ø§Ù„Ù„ÙŠ Ù…ÙƒØªÙˆØ¨ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨ØªØ§Ø¹ØªÙ†Ø§... ØªÙ…Ø§Ù…ØŒ ÙŠÙ„Ø§ Ø¨ÙŠÙ†Ø§ Ù†Ø±ÙƒØ². Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ø¨Ø·Ù„! Ø£Ù†Ø§ Ø§Ù„Ù…Ø±Ø´Ø¯ ÙˆØ¬Ø§Ù‡Ø² Ù†Ø°Ø§ÙƒØ± Ø³ÙˆØ§. Ø´Ø§Ø±ÙƒÙ†ÙŠ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†ØŒ Ø£Ùˆ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙˆÙ„ Ø³Ø¤Ø§Ù„ ØªØ­Ø¨ ØªØ¨Ø¯Ø£ Ø¨ÙŠÙ‡.
              </div>
            </div>
          </div>

          <div class="footer stack-h">
            <input id="textInput" class="input" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§... Ø«Ù… Ø§Ø¶ØºØ· Enter" onkeypress="if(event.key==='Enter'){submitText()}" />
            <button class="btn btn-primary" onclick="submitText()">Ø¥Ø±Ø³Ø§Ù„</button>
          </div>
          <div class="muted">ØªÙ„Ù…ÙŠØ­: Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø©ØŒ Ù‡Ø³Ø£Ù„Ùƒ: "Ù‡Ø§ØŒ ÙƒØ¯Ù‡ ØªÙ…Ø§Ù…ØŸ ØªØ­Ø¨ Ù†Ø´Ø±Ø­Ù‡Ø§ Ø¨ØªÙØµÙŠÙ„ Ø£ÙƒØªØ± Ø£Ùˆ Ù†Ø¬ÙŠØ¨ Ù…Ø«Ø§Ù„ØŸ" Ù…Ø¹ Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØ© Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ.</div>
        </div>
      </section>

      <aside class="card">
        <div class="card-body stack-v">
          <div>
            <div class="title" style="font-size:18px">Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</div>
            <div class="sub">Ø£Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù‡Ù†Ø§. Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙƒÙ…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©.</div>
          </div>
          <textarea id="lectureInput" placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ..."></textarea>

          <div class="stack-v">
            <div class="title" style="font-size:16px">Ù…Ù„ÙØ§Øª Ù„Ù„Ù…Ø°Ø§ÙƒØ±Ø©</div>
            <div class="sub">Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Øª PDF/TXT/MD ÙˆØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ¯Ø±</div>
            <div class="stack-h" style="flex-wrap:wrap">
              <input id="pdfFiles" type="file" multiple accept=".pdf,.txt,.md" class="input" style="padding:10px" />
              <button class="btn btn-primary" onclick="uploadSelectedFiles()">Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</button>
              <button class="btn btn-accent" onclick="startAutoExplain()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ø¢Ù†</button>
            </div>
            <div id="uploadsList" class="muted"></div>
          </div>

          <div class="stack-v">
            <div class="title" style="font-size:16px">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© (ØªØ¬Ø±ÙŠØ¨ÙŠ)</div>
            <div class="sub">Ø´Ø§Ø±Ùƒ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ Ø§Ù„ØªÙ‚Ø· Ù„Ù‚Ø·Ø©ØŒ ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ¯Ø±.</div>
            <div class="screen-box stack-v">
              <video id="screenPreview" autoplay muted playsinline></video>
              <div class="stack-h" style="flex-wrap:wrap;margin-top:8px">
                <button id="shareBtn" class="btn btn-primary" onclick="startScreenShare()">Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©</button>
                <button id="stopShareBtn" class="btn btn-danger" onclick="stopScreenShare()" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
                <button id="snapOcrBtn" class="btn btn-accent" onclick="captureAndOCR()" disabled>Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ</button>
              </div>
              <div id="ocrStatus" class="muted"></div>
            </div>
          </div>

          <div class="stack-v">
            <div class="title" style="font-size:16px">ØªØµÙˆÙŠØ± Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„ØªØ§Ø¨Ù„Øª)</div>
            <div class="sub">Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ ÙˆØ¬Ù‘Ù‡Ù‡Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø³Ø¨ÙˆØ±Ø©/Ø§Ù„Ø´Ø§Ø´Ø©ØŒ Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© ÙˆØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ¯Ø±.</div>
            <div class="screen-box stack-v">
              <video id="cameraPreview" autoplay playsinline muted></video>
              <div class="stack-h" style="flex-wrap:wrap;margin-top:8px">
                <button id="cameraStartBtn" class="btn btn-primary" onclick="startCamera()">ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                <button id="cameraStopBtn" class="btn btn-danger" onclick="stopCamera()" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
                <button id="cameraSnapBtn" class="btn btn-accent" onclick="captureFromCamera()" disabled>Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ</button>
              </div>
              <div id="cameraStatus" class="muted"></div>
            </div>
          </div>

          <div class="stack-v">
            <div class="title" style="font-size:16px">Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©</div>
            <div class="sub">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (PNG/JPG) Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù†Ù‡Ø§ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ¯Ø±. Ù…ÙÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„.</div>
            <div class="stack-h" style="flex-wrap:wrap">
              <input id="imgUpload" type="file" accept="image/png,image/jpeg" class="input" style="padding:10px" />
              <button class="btn btn-primary" onclick="ocrImageFile()">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©</button>
            </div>
            <div id="imgOcrStatus" class="muted"></div>
          </div>

          <div class="stack-h" style="justify-content: space-between; flex-wrap: wrap;">
            <span class="pill" id="recStatus">Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØªÙˆÙ‚Ù</span>
            <div class="stack-h">
              <button class="btn btn-ghost" onclick="loadSample()">Ù…Ù„Ø¡ Ù…Ø«Ø§Ù„</button>
              <button class="btn btn-danger" onclick="resetLecture()">Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ¯Ø±</button>
              <button class="btn btn-primary" onclick="summarizeLecture()">ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
              <button class="btn btn-accent" onclick="explainLecture()">Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
            </div>
          </div>

          <div class="stack-v">
            <div class="title" style="font-size:16px">Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù…ÙØªÙƒÙŠÙ</div>
            <div class="sub">Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¤Ø§Ù„ Ù…Ù† Ø¢Ø®Ø± Ø¬Ø²Ø¡ ØªÙ…Øª Ù…Ù†Ø§Ù‚Ø´ØªÙ‡</div>
            <div class="stack-h">
              <button class="btn btn-accent" onclick="makeAdaptiveQuestion()">Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠØ¹</button>
              <button class="btn btn-ghost" onclick="toggleTougher()">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø©</button>
            </div>
            <div id="quizSlot" class="muted"></div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // --------------- State ---------------
    const state = {
      recognizing: false,
      lastUtterance: '',
      history: [], // {role: 'user'|'ai', text}
      tougher: false,
      questionsSinceBreak: 0,
      uploads: [],
      token: null,
      directAnswer: true,
      live: false,
      speaking: false,
      screenStream: null,
      cameraStream: null,
    };

    // Persona & phrases
    const persona = {
      prefix: 'Ø­Ø³Ø¨ Ø§Ù„Ù„ÙŠ Ù…ÙƒØªÙˆØ¨ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨ØªØ§Ø¹ØªÙ†Ø§...',
      warmups: [
        'ØªÙ…Ø§Ù…ØŒ ÙŠÙ„Ø§ Ø¨ÙŠÙ†Ø§ Ù†Ø±ÙƒØ²',
        'ÙŠØ§ Ø¨Ø·Ù„ØŒ Ø£Ù†Øª Ù…Ø§Ø´ÙŠ ØµØ­',
        'ÙÙ‡Ù…Øª Ù‚ØµØ¯Ùƒ',
        'Ø®Ù„ÙŠÙ†ÙŠ Ø£Ø¨Ø³Ù‘Ø·Ù‡Ø§Ù„Ùƒ ÙÙŠ Ù†Ù‚Ø·ØªÙŠÙ†',
        'Ø¨Ø±Ø§ÙÙˆ!'
      ],
      follow: 'Ù‡Ø§ØŒ ÙƒØ¯Ù‡ ØªÙ…Ø§Ù…ØŸ ØªØ­Ø¨ Ù†Ø´Ø±Ø­Ù‡Ø§ Ø¨ØªÙØµÙŠÙ„ Ø£ÙƒØªØ± Ø£Ùˆ Ù†Ø¬ÙŠØ¨ Ù…Ø«Ø§Ù„ØŸ',
    };

    const chat = document.getElementById('chat');
    const textInput = document.getElementById('textInput');
    const lectureInput = document.getElementById('lectureInput');
    const recStatus = document.getElementById('recStatus');
    const micBtn = document.getElementById('micBtn');
    const speakBtn = document.getElementById('speakBtn');
    const quizSlot = document.getElementById('quizSlot');
    const uploadsList = document.getElementById('uploadsList');
    const pdfFiles = document.getElementById('pdfFiles');
    const screenPreview = document.getElementById('screenPreview');
    const ocrStatus = document.getElementById('ocrStatus');
    const cameraPreview = document.getElementById('cameraPreview');
    const cameraStatus = document.getElementById('cameraStatus');
    const imgUpload = document.getElementById('imgUpload');
    const imgOcrStatus = document.getElementById('imgOcrStatus');

    // --------------- Helpers ---------------
    function appendMsg(role, text) {
      const wrap = document.createElement('div');
      wrap.className = `msg ${role==='user'?'from-user':'from-ai'}`;
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      wrap.appendChild(b);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      state.history.push({ role, text });
    }

    function pickWarmup(){
      const arr = persona.warmups;
      return arr[Math.floor(Math.random()*arr.length)];
    }

    function clean(text){ return (text||'').replace(/\s+/g,' ').trim(); }

    function splitSentences(t){
      return (t||'').split(/[.!ØŸ\n]+/).map(s=>clean(s)).filter(Boolean);
    }

    function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }

    // --------------- TTS (speechSynthesis) ---------------
    function getArabicVoice(){
      const voices = speechSynthesis.getVoices();
      const arVoices = voices.filter(v=>/ar|Arabic/i.test(v.lang||v.name));
      return arVoices[0] || voices.find(v=>/ar|Arabic/i.test(v.name)) || voices[0] || null;
    }

    function speak(text){
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      const v = getArabicVoice();
      if(v) u.voice = v;
      u.lang = (v && v.lang) || 'ar-SA';
      u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
      try{ window.speechSynthesis.cancel(); }catch(_){ }
      u.onstart = ()=>{
        state.speaking = true;
        // Pause recognition while speaking to avoid echo
        try{ if(recog && state.recognizing) recog.stop(); }catch(_){ }
      };
      u.onend = ()=>{
        state.speaking = false;
        // Auto-resume listening in live mode
        if(state.live && recog && !state.recognizing){
          try{ recog.start(); }catch(_){ }
        }
      };
      window.speechSynthesis.speak(u);
      state.lastUtterance = text;
      speakBtn.disabled = false;
    }

    function ttsPlayLast(){ if(state.lastUtterance) speak(state.lastUtterance); }

    // --------------- STT (SpeechRecognition) ---------------
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog = null;
    if(SR){
      recog = new SR();
      recog.lang = 'ar-SA';
      recog.continuous = true; // live loop
      recog.interimResults = false;
      recog.maxAlternatives = 1;

      recog.onstart = ()=>{ state.recognizing = true; recStatus.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...'; micBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† â¹ï¸'; };
      recog.onend = ()=>{
        state.recognizing = false; 
        recStatus.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØªÙˆÙ‚Ù'; 
        micBtn.textContent = 'ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ğŸ™ï¸';
        // If in live mode and not speaking, restart listening
        if(state.live && !state.speaking){
          try{ recog.start(); }catch(_){ }
        }
      };
      recog.onerror = ()=>{ state.recognizing = false; recStatus.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹'; };
      recog.onresult = (e)=>{
        const t = e.results[0][0].transcript || '';
        if(t){ appendMsg('user', t); handleUserQuery(t); }
      };
    }

    function toggleMic(){
      if(!recog){ alert('Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ¹Ø±Ù‘Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. ÙŠÙÙØ¶Ù‘Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome.'); return; }
      // Toggle live conversation mode similar to Gemini Live
      if(state.live || state.recognizing){
        state.live = false;
        try{ recog.stop(); }catch(_){ }
        return;
      }
      state.live = true;
      try{ recog.start(); }catch(_){ }
    }

    // --------------- Core Logic ---------------
    const API_BASE = '';
    async function ensureSession(){
      try{
        if(!window.supabaseClient) window.initializeSupabase();
        const { data } = await window.supabaseAuth.getSession();
        const tok = data?.session?.access_token;
        if(tok) state.token = tok;
        return tok;
      }catch(_){ return null; }
    }

    async function uploadFile(file){
      try{
        const tok = await ensureSession();
        if(!tok){ alert('ÙŠÙ„Ø²Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ'); return null; }
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch(`${API_BASE}/api/upload`, { method:'POST', headers:{ 'Authorization': `Bearer ${tok}` }, body: fd });
        if(!res.ok) return null;
        const json = await res.json();
        return json;
      }catch(_){ return null; }
    }

    function renderUploads(){
      if(!state.uploads.length){ uploadsList.textContent = ''; return; }
      uploadsList.innerHTML = state.uploads.map(u=>`âœ”ï¸ ${u.name || 'Ù…Ù„Ù'} â€” ${Math.round((u.size||0)/1024)}KB`).join('<br/>');
    }

    async function uploadSelectedFiles(){
      const files = (pdfFiles && pdfFiles.files) ? Array.from(pdfFiles.files) : [];
      if(!files.length){ alert('Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹'); return; }
      for(const f of files){
        // For TXT/MD, extract locally as immediate fallback
        try{
          if(/\.(txt|md)$/i.test(f.name)){
            const localText = await f.text();
            if(localText && localText.trim()){
              lectureInput.value = (lectureInput.value ? (lectureInput.value + "\n\n") : '') + localText;
            }
          }
        }catch(_){}

        const r = await uploadFile(f);
        if(r){
          state.uploads.push(r);
          if(r.extractedText && r.extractedText.trim()){
            lectureInput.value = (lectureInput.value ? (lectureInput.value + "\n\n") : '') + r.extractedText;
          }
        }
        renderUploads();
      }
      if(pdfFiles) pdfFiles.value = '';
      // Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¯Ù…Ø¬ Ø§Ù„Ù†ØµØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø±Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      try { 
        if(!getLecture() || getLecture().length < 30){
          appendMsg('ai', `${persona.prefix} Ø§Ù„Ù…Ù„Ù Ø§ØªØ±ÙØ¹ØŒ Ø¨Ø³ Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø¹Ø´Ø§Ù† Ø£Ø´Ø±Ø­. Ù„Ùˆ PDF Ù…Ù…ÙƒÙ† ÙŠØªØ£Ø®Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ³Ø£Ù„Ù†ÙŠ Ø¨Ø¹Ø¯ Ù„Ø­Ø¸Ø§Øª Ø£Ùˆ Ø§Ø±ÙØ¹ TXT/MD Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙˆØ±ÙŠØ©.`);
          speak(`${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ø¨Ø¯Ø£ Ø£Ø´Ø±Ø­.`);
        } else {
          await startAutoExplain(); 
        }
      } catch(_){ }
    }

    async function askGemini(question){
      try{
        const tok = await ensureSession();
        if(!tok) return null;
        const ctx = getLecture();
        const res = await fetch(`${API_BASE}/api/ai/ask`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${tok}` }, body: JSON.stringify({ question, context: ctx }) });
        if(!res.ok) return null;
        const json = await res.json();
        return json?.response || null;
      }catch(_){ return null; }
    }

    async function summarizeLecture(){
      const content = getLecture();
      if(!content || content.length < 30){
        appendMsg('ai', `${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£Ø¹Ù…Ù„ ØªÙ„Ø®ÙŠØµ Ø¯Ù‚ÙŠÙ‚.`);
        speak('Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£Ø¹Ù…Ù„ ØªÙ„Ø®ÙŠØµ Ø¯Ù‚ÙŠÙ‚.');
        return;
      }
      const prompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³ÙŠ Ø¹Ø±Ø¨ÙŠ. Ù„Ø¯ÙŠÙƒ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨ÙŠÙ† ÙŠØ¯ÙŠÙƒ. Ù„Ø®Ù‘Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù†Ù‚Ø§Ø· ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø®ØªØµØ±Ø© Ø¬Ø¯Ø§Ù‹ (3-6 Ù†Ù‚Ø§Ø· ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)ØŒ Ø¨Ø¯ÙˆÙ† Ø­Ø´ÙˆØŒ ÙˆØ¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ù…Ø¨Ø³Ø·Ø©. Ù„Ø§ ØªØ¶Ù Ù…Ù‚Ø¯Ù…Ø§Øª Ø£Ùˆ Ø®ØªØ§Ù….`;
      let replyText = await askGemini(prompt);
      if(!replyText){
        const sents = splitSentences(content).slice(0,6);
        replyText = `â€¢ ${sents.slice(0,4).join('\nâ€¢ ')}`;
      }
      replyText = `${persona.prefix} \n${replyText}`;
      appendMsg('ai', replyText);
      speak(replyText);
    }

    async function explainLecture(){
      const content = getLecture();
      if(!content || content.length < 30){
        appendMsg('ai', `${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ ÙƒÙØ§ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ø´Ø±Ø­.`);
        speak('Ù…Ø­ØªØ§Ø¬ Ù†Øµ ÙƒÙØ§ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ø´Ø±Ø­.');
        return;
      }
      const prompt = `Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ù‘Ø· ÙˆØ¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ù†Ù‚Ø·ØªÙŠÙ† Ø£Ùˆ Ø«Ù„Ø§Ø« Ù…Ù† Ø£Ù‡Ù… Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ù…Ø¹ Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ ØµØºÙŠØ± Ù„ÙƒÙ„ Ù†Ù‚Ø·Ø©ØŒ Ø¨Ø¯ÙˆÙ† Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø©.`;
      let replyText = await askGemini(prompt);
      if(!replyText){
        const sents = splitSentences(content);
        const take = sents.slice(0,3).join(' ');
        replyText = `Ø§Ù„Ø®Ù„Ø§ØµØ©: ${take}`;
      }
      replyText = `${persona.prefix} ${replyText}`;
      appendMsg('ai', replyText);
      speak(replyText);
    }

    async function startAutoExplain(){
      const content = getLecture();
      if(!content || content.length < 30){
        appendMsg('ai', `${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø£ÙˆÙ„ Ø¹Ø´Ø§Ù† Ø£Ø¨Ø¯Ø£ Ø£Ø´Ø±Ø­. Ø§Ø±ÙØ¹ PDF Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ.`);
        speak(`${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø£ÙˆÙ„ Ø¹Ø´Ø§Ù† Ø£Ø¨Ø¯Ø£ Ø£Ø´Ø±Ø­.`);
        return;
      }
      const prompt = `Ø§Ù‚Ø±Ø£ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚ ÙˆÙ‚Ø¯Ù‘Ù… Ø´Ø±Ø­Ù‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§ ÙˆÙ…Ù†Ø¸Ù…Ù‹Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:
- Ø¬Ù…Ù„ØªØ§Ù† ØªÙ„Ø®Ù‘ØµØ§Ù† Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.
- Ù†Ù‚Ø·ØªØ§Ù† Ø£Ùˆ Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø®ØªØµØ±Ø©.
- Ù…Ø«Ø§Ù„ ØµØºÙŠØ± ÙˆØ§Ø­Ø¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰.
Ù„Ø§ ØªØ¶Ù Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø©.`;
      const aiResp = await askGemini(prompt);
      const fallback = (()=>{
        const sents = splitSentences(content);
        const head = sents.slice(0,2).join(' ');
        const bullets = sents.slice(2,5).map(s=>`â€¢ ${s}`).join('\n');
        return `${head}\n${bullets}`;
      })();
      const replyText = aiResp ? `${persona.prefix} ${aiResp}` : `${persona.prefix} ${fallback}`;
      appendMsg('ai', replyText);
      speak(replyText);
    }
    function getLecture(){ return clean(lectureInput.value); }

    function answerFromLecture(question){
      const lecture = getLecture();
      const q = clean(question).toLowerCase();
      if(!lecture){
        const msg = `${persona.prefix} Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯ÙŠ Ù…Ø´ Ù…Ø°ÙƒÙˆØ±Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù„ÙŠ Ø±ÙØ¹ØªÙ‡Ø§. Ù„ÙƒÙ† Ø¹Ø´Ø§Ù† ØªØ³ØªÙÙŠØ¯ØŒ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…: Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„Ø§Ø²Ù… ØªØ­Ø· Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù‡Ù†Ø§ Ø§Ù„Ø£ÙˆÙ„.`;
        return { text: msg, fromLecture: false };
      }
      // Naive extractive approach: pick sentences containing key tokens
      const sents = splitSentences(lecture);
      const tokens = q.split(/\s+/).filter(x=>x.length>2);
      let scored = sents.map(s=>({ s, score: tokens.reduce((acc,t)=>acc+(s.includes(t)?1:0),0) }));
      scored.sort((a,b)=>b.score-a.score);
      const top = scored.slice(0, 2).map(x=>x.s).filter(Boolean);
      if(top.length===0){
        const fallback = `${persona.prefix} Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯ÙŠ Ù…Ø´ Ù…Ø°ÙƒÙˆØ±Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù„ÙŠ Ø±ÙØ¹ØªÙ‡Ø§. Ù„ÙƒÙ† Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ù…Ù…ÙƒÙ† Ù†Ù‚ÙˆÙ„: Ø­Ø§ÙˆÙ„ ØªØ±Ø¨Ø· Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ø§Ù„ÙˆØ§Ø¶Ø­Ø© ÙÙŠ Ø§Ù„Ù†Øµ.`;
        return { text: fallback, fromLecture: false };
      }
      const concise = `${persona.prefix} ${top[0]}${top[1]? ' â€” '+top[1] : ''}. ${pickWarmup()}!`;
      return { text: concise, fromLecture: true, context: top.join(' | ') };
    }

    async function handleUserQuery(text){
      const q = (text||'').toLowerCase();
      if(/(ØªÙ„Ø®ÙŠØµ|Ù„Ø®Øµ|Ø®Ù„Ø§ØµØ©)/.test(q)){
        await summarizeLecture();
        return;
      }
      if(/(Ø§Ø´Ø±Ø­|Ø´Ø±Ø­)/.test(q)){
        await explainLecture();
        return;
      }
      let replyText = null;
      const aiResp = await askGemini(text);
      if(aiResp){
        replyText = `${persona.prefix} ${aiResp}`;
      } else {
        const { text: localReply } = answerFromLecture(text);
        replyText = localReply;
      }
      appendMsg('ai', replyText);
      speak(replyText);
      state.questionsSinceBreak++;

      if(!state.directAnswer){
        // Human-like small pause then follow-up
        await delay(1000);
        const follow = persona.follow;
        appendMsg('ai', follow);
        speak(follow);

        // Break hint every 5 Qs
        if(state.questionsSinceBreak % 5 === 0){
          const br = 'Ø¨ØµØ±Ø§Ø­Ø© ØªØ±ÙƒÙŠØ²Ùƒ Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ù‹Ø§! Ø®Ù…Ø³ Ø¯Ù‚Ø§ÙŠÙ‚ Ø¨Ø±ÙŠÙƒ ÙˆØ§Ø±Ø¬Ø¹ØŒ ÙˆÙ„Ø§ ØªØ­Ø¨ Ù†Ø®Ù„Øµ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯ÙŠ ÙˆÙ†Ù‚ÙˆÙ…ØŸ';
          appendMsg('ai', br);
          speak(br);
        }
      }
    }

    function submitText(){
      const t = clean(textInput.value);
      if(!t) return;
      textInput.value='';
      appendMsg('user', t);
      handleUserQuery(t);
    }

    function clearChat(){
      chat.innerHTML = '';
      state.history = [];
      appendMsg('ai', `${persona.prefix} ØªÙ…Ø§Ù…ØŒ ÙŠÙ„Ø§ Ø¨ÙŠÙ†Ø§ Ù†Ø±ÙƒØ². Ù†Ø¨Ø¯Ø£ Ù…Ù†ÙŠÙ†ØŸ`);
    }

    function loadSample(){
      lectureInput.value = `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø§Ù„Ø¨Ø±Ø§ÙƒÙŠÙ† ÙˆØ­Ø±ÙƒØ© Ø§Ù„ØµÙØ§Ø¦Ø­ Ø§Ù„ØªÙƒØªÙˆÙ†ÙŠØ©

Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ø¨Ø±Ø§ÙƒÙŠÙ† Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ØµÙØ§Ø¦Ø­: ØªÙ†Ø´Ø£ Ù…Ø¹Ø¸Ù… Ø§Ù„Ø¨Ø±Ø§ÙƒÙŠÙ† Ø¹Ù„Ù‰ Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙØ§Ø¦Ø­ Ø§Ù„ØªÙƒØªÙˆÙ†ÙŠØ©ØŒ ÙˆØ®Ø§ØµØ© Ø¹Ù†Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø§Ù†Ø¯Ø³Ø§Ø³ Ø­ÙŠØ« ØªÙ†ØºÙ…Ø³ ØµÙÙŠØ­Ø© Ù…Ø­ÙŠØ·ÙŠØ© Ø£Ø³ÙÙ„ ØµÙÙŠØ­Ø© Ù‚Ø§Ø±ÙŠØ© Ù…Ù…Ø§ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø§Ù†ØµÙ‡Ø§Ø± Ø§Ù„ØµØ®ÙˆØ± ÙˆØ§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ‡Ø§Ø±Ø©. ÙƒØ°Ù„Ùƒ ØªØ¸Ù‡Ø± Ø¨Ø±Ø§ÙƒÙŠÙ† Ø¹Ù†Ø¯ ØªØ¨Ø§Ø¹Ø¯ Ø§Ù„ØµÙØ§Ø¦Ø­ (Ø§Ù„Ø­ÙŠØ¯ Ø§Ù„ÙˆØ³Ø· Ù…Ø­ÙŠØ·ÙŠØ©) Ø­ÙŠØ« ØªØµØ¹Ø¯ Ø§Ù„ØµÙ‡Ø§Ø±Ø© Ù„Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§Øº.

Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø¤Ø«Ø±Ø© Ø¹Ù„Ù‰ Ø´Ø¯Ø© Ø§Ù„Ø¨Ø±ÙƒØ§Ù†: Ù„Ø²ÙˆØ¬Ø© Ø§Ù„ØµÙ‡Ø§Ø±Ø©ØŒ ÙƒÙ…ÙŠØ© Ø§Ù„ØºØ§Ø² Ø§Ù„Ø°Ø§Ø¦Ø¨ØŒ ÙˆØªØ±ÙƒÙŠØ¨ Ø§Ù„ØµÙ‡Ø§Ø±Ø©. ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯Øª Ø§Ù„Ù„Ø²ÙˆØ¬Ø© ÙˆØ§Ø²Ø¯Ø§Ø¯ Ø§Ù„ØºØ§Ø² Ø§Ø±ØªÙØ¹ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ø²Ø¯Ø§Ø¯Øª Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±Ø§Øª.

Ø§Ù„Ø¢Ø«Ø§Ø±: ØªØ¤Ø«Ø± Ø§Ù„Ø¨Ø±Ø§ÙƒÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø§Ø® Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¹Ø¨Ø± Ø§Ù†Ø¨Ø¹Ø§Ø« Ø§Ù„Ø±Ù…Ø§Ø¯ ÙˆØ§Ù„ÙƒØ¨Ø±ÙŠØªØ§Øª Ø§Ù„ØªÙŠ ØªØ¹ÙƒØ³ Ø£Ø´Ø¹Ø© Ø§Ù„Ø´Ù…Ø³ØŒ ÙˆÙ‚Ø¯ ØªÙØ®ØµÙ‘Ø¨ Ø§Ù„ØªØ±Ø¨Ø© Ø¨Ø§Ù„Ù…Ø¹Ø§Ø¯Ù†.
`;
    }

    function resetLecture(){ lectureInput.value=''; }

    // --------------- Adaptive Quiz (very light) ---------------
    function makeAdaptiveQuestion(){
      const lecture = getLecture();
      const sents = splitSentences(lecture);
      if(!sents.length){ quizSlot.textContent = 'Ø£Ø¶Ù Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹.'; return; }
      // Pick a sentence and mask a term
      const base = state.tougher ? sents.slice(0, Math.max(2, Math.floor(sents.length/2))) : sents;
      const s = base[Math.floor(Math.random()*base.length)];
      const words = s.split(/\s+/).filter(w=>w.length>3);
      if(words.length<3){ quizSlot.textContent = 'Ø§Ù„Ù†Øµ Ù‚ØµÙŠØ± Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³Ø¤Ø§Ù„.'; return; }
      const idx = Math.floor(Math.random()*words.length);
      const answer = words[idx];
      const question = s.replace(answer, '_____');
      quizSlot.innerHTML = `<div><strong>Ø³Ø¤Ø§Ù„:</strong> Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº: ${question}</div><div style="margin-top:6px"><input id="quizAns" class="input" placeholder="Ø¥Ø¬Ø§Ø¨ØªÙƒ"/><button class=\"btn btn-primary\" style=\"margin-top:8px\" onclick=\"gradeAdaptive('${encodeURIComponent(answer)}')\">ØªØ­Ù‚Ù‚</button></div>`;
    }

    function gradeAdaptive(correctEnc){
      const correct = decodeURIComponent(correctEnc);
      const inp = document.getElementById('quizAns');
      const got = clean(inp.value||'');
      if(!got){ return; }
      if(got === correct){
        quizSlot.innerHTML = '<span style="color:var(--accent);font-weight:700">Ø¨Ø±Ø§ÙÙˆ! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©.</span>';
        speak('Ø¨Ø±Ø§ÙÙˆ!');
      } else {
        quizSlot.innerHTML = `<span style="color:var(--danger);font-weight:700">ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correct}</span>`;
        speak('Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙˆÙŠØ³Ø©!');
      }
    }

    function toggleTougher(){ state.tougher = !state.tougher; alert(state.tougher? 'ØªÙ… ØªÙØ¹ÙŠÙ„ ØµØ¹ÙˆØ¨Ø© Ø£Ø¹Ù„Ù‰' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©'); }

    // Toggle direct answer vs. conversational follow-ups
    function toggleDirectMode(){
      state.directAnswer = !state.directAnswer;
      const btn = document.getElementById('modeBtn');
      if(btn){
        btn.textContent = `ÙˆØ¶Ø¹ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©: ${state.directAnswer ? 'Ù…ÙØ¹Ù„' : 'Ù…ØªÙˆÙ‚Ù'}`;
      }
    }

    // --------------- Screen Share + OCR ---------------
    async function startScreenShare(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia){
        alert('Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.');
        return;
      }
      try{
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            frameRate: 15,
            // Hint browsers to capture current tab on mobile-supported environments
            preferCurrentTab: true,
            displaySurface: 'browser'
          },
          audio: false
        });
        state.screenStream = stream;
        screenPreview.srcObject = stream;
        document.getElementById('shareBtn').disabled = true;
        document.getElementById('stopShareBtn').disabled = false;
        document.getElementById('snapOcrBtn').disabled = false;
        stream.getVideoTracks()[0].addEventListener('ended', ()=>{
          stopScreenShare();
        });
      }catch(err){
        console.error(err);
        alert('ØªØ¹Ø°Ù‘Ø± Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS ÙˆØ§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ (Chrome Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯) Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø±ÙØ¹ ØµÙˆØ±Ø©.');
      }
    }

    function stopScreenShare(){
      try{
        if(state.screenStream){
          state.screenStream.getTracks().forEach(t=>t.stop());
        }
      }catch(_){ }
      state.screenStream = null;
      if(screenPreview){ screenPreview.srcObject = null; }
      document.getElementById('shareBtn').disabled = false;
      document.getElementById('stopShareBtn').disabled = true;
      document.getElementById('snapOcrBtn').disabled = true;
    }

    async function captureAndOCR(){
      if(!state.screenStream){ alert('Ø§Ø¨Ø¯Ø£ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
      const track = state.screenStream.getVideoTracks()[0];
      const imageCapture = ('ImageCapture' in window) ? new ImageCapture(track) : null;
      try{
        ocrStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§...';
        let bitmap;
        if(imageCapture && imageCapture.grabFrame){
          bitmap = await imageCapture.grabFrame();
        } else {
          // Fallback: draw current frame from video
          await new Promise(r=>setTimeout(r, 100));
          const v = screenPreview;
          const c = document.createElement('canvas');
          c.width = v.videoWidth || 1280; c.height = v.videoHeight || 720;
          const ctx = c.getContext('2d');
          ctx.drawImage(v, 0, 0, c.width, c.height);
          const dataUrl = c.toDataURL('image/png');
          const img = new Image();
          await new Promise(res=>{ img.onload=()=>res(); img.src=dataUrl; });
          const c2 = document.createElement('canvas');
          c2.width = img.width; c2.height = img.height;
          c2.getContext('2d').drawImage(img,0,0);
          bitmap = await createImageBitmap(img);
        }

        // Draw bitmap to canvas for OCR
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width; canvas.height = bitmap.height;
        const ctx2 = canvas.getContext('2d');
        ctx2.drawImage(bitmap, 0, 0);

        // Run OCR via Tesseract.js (Arabic + English)
        const worker = await Tesseract.createWorker('ara+eng');
        const { data } = await worker.recognize(canvas);
        await worker.terminate();

        const extracted = (data && data.text) ? data.text.trim() : '';
        if(extracted){
          lectureInput.value = (lectureInput.value ? lectureInput.value + '\n\n' : '') + extracted;
          appendMsg('ai', `${persona.prefix} ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ¯Ø±.`);
          speak('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡.');
          ocrStatus.textContent = `ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© (${extracted.length} Ø­Ø±Ù).`;
        } else {
          ocrStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Øµ ÙˆØ§Ø¶Ø­. Ø¬Ø±Ù‘Ø¨ ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­.';
        }
      }catch(err){
        console.error(err);
        ocrStatus.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬.';
      }
    }

    // Initial gentle voice greeting (non-blocking)
    window.addEventListener('load', ()=>{
      try { speak('Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ø¨Ø·Ù„! Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ø£Ø°Ø§ÙƒØ± Ù…Ø¹Ø§Ùƒ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¯ÙŠ. Ø¥ÙŠÙ‡ Ø£ÙˆÙ„ Ø¬Ø²Ø¡ Ø­Ø§Ø¨Ø¨ Ù†Ø±ÙƒØ² Ø¹Ù„ÙŠÙ‡ØŸ'); } catch(_) {}
      if(typeof speechSynthesis !== 'undefined'){
        // Ensure voices are loaded
        speechSynthesis.onvoiceschanged = ()=>{};
      }
      try{ ensureSession(); }catch(_){}
      // Feature detection to guide UI
      const hasShare = !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia);
      if(!hasShare){
        const btn = document.getElementById('shareBtn'); if(btn) btn.disabled = true;
        const snap = document.getElementById('snapOcrBtn'); if(snap) snap.disabled = true;
        if(ocrStatus){ ocrStatus.textContent = 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù…ØªØµÙØ­. Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: Ø¬Ø±Ù‘Ø¨ Chrome Ø«Ù… Ø§Ø®ØªØ± "Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ø°Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨". Ø¹Ù„Ù‰ iOS: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø±ÙØ¹ ØµÙˆØ±Ø©.'; }
      }
      const hasCam = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
      if(!hasCam){
        const cb = document.getElementById('cameraStartBtn'); if(cb) cb.disabled = true;
        const cs = document.getElementById('cameraSnapBtn'); if(cs) cs.disabled = true;
        if(cameraStatus){ cameraStatus.textContent = 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù…ØªØµÙØ­.'; }
      }
    });
  </script>
</body>
</html>
