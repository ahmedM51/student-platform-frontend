<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØµØ¯ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµÙˆØªÙŠØ©</title>
  <meta name="description" content="ØµØ¯ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠ (Voice-First): Ù…Ø­Ø§ÙƒØ§Ø© Ø¬Ù„Ø³Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ù…Ø±Ø´Ø¯ ÙˆØ¯ÙˆØ¯. ØªÙØ§Ø¹Ù„ ØµÙˆØªÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¹ Ø¯Ø¹Ù… Ù„Ù„Ù†Øµ ÙˆØ§Ù„ØµÙˆØª." />
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --accent: #16a34a;
      --danger: #ef4444;
      --ring: rgba(37, 99, 235, 0.15);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Cairo, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    header {
      background: var(--card);
      border-bottom: 1px solid #e5e7eb;
      position: sticky; top: 0; z-index: 10;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 992px) { .row { grid-template-columns: 1.1fr 0.9fr; } }
    .card { background: var(--card); border: 1px solid #eef2f7; border-radius: 14px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.03); }
    .card-body { padding: 16px; }
    .title { margin: 0; font-size: 20px; font-weight: 800; }
    .sub { color: var(--muted); font-size: 14px; margin-top: 6px; }
    .stack-v { display: flex; flex-direction: column; gap: 12px; }
    .stack-h { display: flex; gap: 8px; align-items: center; }
    .pill { background: #f1f5f9; color: #0f172a; padding: 8px 12px; border-radius: 999px; font-size: 13px; }
    .btn {
      border: 0; border-radius: 12px; padding: 12px 14px; font-weight: 700; cursor: pointer; transition: transform .05s ease-in-out, background .2s;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-ghost { background: #f1f5f9; color: #0f172a; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .input, textarea {
      width: 100%; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 14px; font-size: 15px; outline: none;
    }
    .input:focus, textarea:focus { box-shadow: 0 0 0 4px var(--ring); border-color: var(--primary); }
    textarea { min-height: 650px; resize: vertical; }
    .chat { height: 560px; overflow: auto; display: flex; flex-direction: column; gap: 10px; padding: 8px; border: 1px solid #eef2f7; border-radius: 12px; background: #fafafa; }
    .msg { display: flex; gap: 10px; align-items: flex-start; }
    .msg .bubble {
      padding: 10px 12px; border-radius: 14px; max-width: 95%; line-height: 1.7; font-size: 16px; word-wrap: break-word;
    }
    .from-user .bubble { background: var(--primary); color: #fff; border-top-left-radius: 4px; margin-left: 32px; }
    .from-ai .bubble { background: #eef2f7; color: #0f172a; border-top-right-radius: 4px; margin-right: 32px; }
    .muted { color: var(--muted); font-size: 13px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f1f5f9; color: #0f172a; font-size: 12px; }
    .footer { padding-top: 8px; }
    .screen-box { border:1px dashed #cbd5e1; border-radius:12px; padding:10px; background:#f8fafc }
    video#screenPreview { width:100%; max-height:220px; background:#000; border-radius:10px }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- PDF.js for client-side PDF text extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    }
  </script>
  <script src="js/i18n.js"></script>
</head>
<body>
  <header>
    <div class="container stack-h" style="justify-content: space-between;">
      <div class="stack-h">
        <button class="btn btn-ghost" onclick="window.location.href='index.html'" title="Ø§Ù„Ø±Ø¬ÙˆØ¹">
          â† Ø±Ø¬ÙˆØ¹
        </button>
        <div>
          <h1 class="title" data-i18n="voice.title">ØµØ¯ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠ â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµÙˆØªÙŠØ©</h1>
          <div class="sub">&nbsp;</div>
        </div>
      </div>
      <div class="stack-h">
        <select id="langSelect" onchange="setLanguage(this.value)" class="pill" style="padding:6px 10px;">
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">English</option>
        </select>
        <span class="badge" data-i18n="voice.badge">ÙˆØ¶Ø¹ ØµÙˆØª Ø£ÙˆÙ„Ø§Ù‹</span>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top: 16px;">
    <div class="row">
      <section class="card">
        <div class="card-body stack-v">
          <div>
            <div class="title" style="font-size:18px" data-i18n="voice.session">Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</div>
            <div class="sub">&nbsp;</div>
          </div>

          <div class="stack-h" style="flex-wrap: wrap; gap: 8px 8px;">
            <button id="micBtn" class="btn btn-primary" onclick="toggleMic()" data-i18n="voice.buttons.mic_on">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ğŸ™ï¸</button>
            <button id="audioEnableBtn" class="btn btn-accent" onclick="enableAudioOnMobile()" style="display:none" data-i18n="voice.buttons.enable_audio">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š</button>
            <button id="pttBtn" class="btn btn-primary" onclick="togglePTT()" style="display:none" data-i18n="voice.buttons.ptt">Ø§Ø¶ØºØ· ÙˆØªÙƒÙ„Ù… ğŸ¤</button>
            <button id="speakBtn" class="btn btn-accent" onclick="ttsPlayLast()" disabled data-i18n="voice.buttons.replay">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š</button>
            <button class="btn btn-ghost" onclick="clearChat()" data-i18n="voice.buttons.clear">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
            <button id="modeBtn" class="btn btn-ghost" onclick="toggleDirectMode()" title="ÙˆØ¶Ø¹ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©" data-i18n="voice.buttons.direct_on">ÙˆØ¶Ø¹ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©: Ù…ÙØ¹Ù„</button>
          </div>

          <div id="chat" class="chat">
            <div class="msg from-ai">
              <div class="bubble">
                <span data-i18n="voice.greeting">Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ø£Ø°Ø§ÙƒØ± Ù…Ø¹Ø§Ùƒ. Ø§Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ø¤Ø§Ù„Ùƒ Ø§Ù„Ø£ÙˆÙ„.</span>
              </div>
            </div>
          </div>

          <div class="footer stack-h">
            <input id="textInput" class="input" data-i18n-attr="placeholder:voice.input.placeholder" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§... Ø«Ù… Ø§Ø¶ØºØ· Enter" onkeypress="if(event.key==='Enter'){submitText()}" />
            <button class="btn btn-primary" onclick="submitText()">Send</button>
          </div>
          <div class="muted" data-i18n="voice.tip">Tip: After each answer I may ask if you want more detail or an example.</div>
        </div>
      </section>

      <aside class="card">
        <div class="card-body stack-v">
          <div>
            <div class="title" style="font-size:18px" data-i18n="voice.source.title">Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</div>
            <div class="sub" data-i18n="voice.source.subtitle">Ø£Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù‡Ù†Ø§. Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙƒÙ…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©.</div>
          </div>
          <textarea id="lectureInput" data-i18n-attr="placeholder:voice.lectureInput.placeholder" placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ..." oninput="updateLectureStats()"></textarea>
          <div class="muted" id="lectureStats"></div>

          <div class="stack-v">
            <div class="title" style="font-size:16px" data-i18n="voice.files.title">Ù…Ù„ÙØ§Øª Ù„Ù„Ù…Ø°Ø§ÙƒØ±Ø©</div>
            <div class="sub" data-i18n="voice.files.subtitle">Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Øª PDF/TXT/MD ÙˆØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ¯Ø±</div>
            <div class="stack-h" style="flex-wrap:wrap">
              <input id="pdfFiles" type="file" multiple accept=".pdf,.txt,.md" class="input" style="padding:10px" />
              <button class="btn btn-primary" onclick="uploadSelectedFiles()" data-i18n="voice.files.upload_btn">Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</button>
              <button class="btn btn-accent" onclick="startAutoExplain()" data-i18n="voice.buttons.auto_explain">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ø¢Ù†</button>
              <button class="btn btn-ghost" onclick="startLiveAboutLecture()">Ø§Ù„ØªØ­Ø¯Ø« Live Ø¹Ù† Ø°Ù„Ùƒ</button>
              <button class="btn btn-primary" onclick="generateAudioFromLecture()">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø®Ù‘Øµ ØµÙˆØªÙŠ ğŸ§</button>
              <button class="btn btn-ghost" onclick="readLectureAloud()" data-i18n="voice.buttons.read_aloud">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨ØµÙˆØª</button>
              <button class="btn btn-danger" onclick="stopReading()" data-i18n="voice.buttons.stop_reading">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</button>
            </div>
            <div id="uploadsList" class="muted"></div>
            <div id="audioResult" class="stack-v" style="margin-top:8px">
              <audio id="aiAudio" controls style="width:100%; display:none"></audio>
              <a id="audioDownload" href="#" download="lecture-explain.mp3" style="display:none">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª (MP3)</a>
              <div id="customPlayer" style="display:none; background:#f1f5f9; border:1px solid #e5e7eb; border-radius:14px; padding:10px;">
                <div style="display:flex; align-items:center; gap:12px;">
                  <input id="cpBar" type="range" min="0" max="100" value="0" style="flex:1;" />
                  <span id="cpTime" class="muted">0:00</span>
                </div>
                <div style="display:flex; align-items:center; justify-content:center; gap:18px; margin-top:6px;">
                  <button id="cpDownload" class="btn btn-ghost" title="ØªØ­Ù…ÙŠÙ„">â¬‡ï¸</button>
                  <button id="cpBack" class="btn btn-ghost" title="-10s">â†º10</button>
                  <button id="cpPlay" class="btn btn-primary" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
                  <button id="cpFwd" class="btn btn-ghost" title="+10s">10â†»</button>
                  <button id="cpSpeed" class="btn btn-ghost" title="Ø§Ù„Ø³Ø±Ø¹Ø©">1x</button>
                </div>
              </div>
            </div>
          </div>

          <div class="stack-v">
            <div class="title" style="font-size:16px" data-i18n="voice.share.title">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© (ØªØ¬Ø±ÙŠØ¨ÙŠ)</div>
            <div class="sub" data-i18n="voice.share.subtitle">Ø´Ø§Ø±Ùƒ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ Ø§Ù„ØªÙ‚Ø· Ù„Ù‚Ø·Ø©ØŒ ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ¯Ø±.</div>
            <div class="screen-box stack-v">
              <video id="screenPreview" autoplay muted playsinline></video>
              <div class="stack-h" style="flex-wrap:wrap;margin-top:8px">
                <button id="shareBtn" class="btn btn-primary" onclick="startScreenShare()" data-i18n="voice.buttons.share_screen">Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©</button>
                <button id="stopShareBtn" class="btn btn-danger" onclick="stopScreenShare()" disabled data-i18n="voice.buttons.stop_share">Ø¥ÙŠÙ‚Ø§Ù</button>
                <button id="snapOcrBtn" class="btn btn-accent" onclick="captureAndOCR()" disabled data-i18n="voice.buttons.capture_ocr">Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ</button>
              </div>
              <div id="ocrStatus" class="muted"></div>
            </div>
          </div>

          

          <div class="stack-h" style="justify-content: space-between; flex-wrap: wrap;">
            <span class="pill" id="recStatus">Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØªÙˆÙ‚Ù</span>
            <div class="stack-h">
              <button class="btn btn-ghost" onclick="loadSample()">Ù…Ù„Ø¡ Ù…Ø«Ø§Ù„</button>
              <button class="btn btn-danger" onclick="resetLecture()">Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ¯Ø±</button>
              <button class="btn btn-primary" onclick="summarizeLecture()">ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
              <button class="btn btn-accent" onclick="explainLecture()">Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
            </div>
          </div>

          <div class="stack-v">
            <div class="title" style="font-size:16px">Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù…ÙØªÙƒÙŠÙ</div>
            <div class="sub">Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¤Ø§Ù„ Ù…Ù† Ø¢Ø®Ø± Ø¬Ø²Ø¡ ØªÙ…Øª Ù…Ù†Ø§Ù‚Ø´ØªÙ‡</div>
            <div class="stack-h">
              <button class="btn btn-accent" onclick="makeAdaptiveQuestion()">Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠØ¹</button>
              <button class="btn btn-ghost" onclick="toggleTougher()">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø©</button>
            </div>
            <div id="quizSlot" class="muted"></div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // --------------- State ---------------
    const state = {
      recognizing: false,
      lastUtterance: '',
      history: [], // {role: 'user'|'ai', text}
      tougher: false,
      questionsSinceBreak: 0,
      uploads: [],
      token: null,
      directAnswer: true,
      live: false,
      speaking: false,
      screenStream: null,
      audioEnabled: false,
      
    };

    // Persona & phrases
    const persona = {
      prefix: 'Ø­Ø³Ø¨ Ø§Ù„Ù„ÙŠ Ù…ÙƒØªÙˆØ¨ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨ØªØ§Ø¹ØªÙ†Ø§...',
      warmups: [
        'ØªÙ…Ø§Ù…ØŒ ÙŠÙ„Ø§ Ø¨ÙŠÙ†Ø§ Ù†Ø±ÙƒØ²',
        'ÙŠØ§ Ø¨Ø·Ù„ØŒ Ø£Ù†Øª Ù…Ø§Ø´ÙŠ ØµØ­',
        'ÙÙ‡Ù…Øª Ù‚ØµØ¯Ùƒ',
        'Ø®Ù„ÙŠÙ†ÙŠ Ø£Ø¨Ø³Ù‘Ø·Ù‡Ø§Ù„Ùƒ ÙÙŠ Ù†Ù‚Ø·ØªÙŠÙ†',
        'Ø¨Ø±Ø§ÙÙˆ!'
      ],
      follow: 'Ù‡Ø§ØŒ ÙƒØ¯Ù‡ ØªÙ…Ø§Ù…ØŸ ØªØ­Ø¨ Ù†Ø´Ø±Ø­Ù‡Ø§ Ø¨ØªÙØµÙŠÙ„ Ø£ÙƒØªØ± Ø£Ùˆ Ù†Ø¬ÙŠØ¨ Ù…Ø«Ø§Ù„ØŸ',
    };

    const chat = document.getElementById('chat');
    const textInput = document.getElementById('textInput');
    const lectureInput = document.getElementById('lectureInput');
    const recStatus = document.getElementById('recStatus');
    const micBtn = document.getElementById('micBtn');
    const speakBtn = document.getElementById('speakBtn');
    const quizSlot = document.getElementById('quizSlot');
    const uploadsList = document.getElementById('uploadsList');
    const lectureStats = document.getElementById('lectureStats');
    const pdfFiles = document.getElementById('pdfFiles');
    const screenPreview = document.getElementById('screenPreview');
    const ocrStatus = document.getElementById('ocrStatus');
    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent || '');
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent || '');
    let mediaStream = null;
    let mediaRecorder = null;
    let recordChunks = [];
    let readingQueue = [];
    let readingIndex = 0;
    let readingActive = false;
    

    // --------------- Helpers ---------------
    function appendMsg(role, text) {
      const wrap = document.createElement('div');
      wrap.className = `msg ${role==='user'?'from-user':'from-ai'}`;
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      wrap.appendChild(b);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      state.history.push({ role, text });
    }

    function pickWarmup(){
      const arr = persona.warmups;
      return arr[Math.floor(Math.random()*arr.length)];
    }

    function clean(text){ return (text||'').replace(/\s+/g,' ').trim(); }

    function splitSentences(t){
      return (t||'').split(/[.!ØŸ\n]+/).map(s=>clean(s)).filter(Boolean);
    }

    function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }

    function updateLectureStats(){
      try{
        const len = (lectureInput?.value||'').length;
        if (lectureStats) lectureStats.textContent = `Ø­Ø¬Ù… Ø§Ù„Ù†Øµ: ${len.toLocaleString()} Ø­Ø±Ù`;
      }catch(_){ }
    }

    // --------------- Smart Context Chunking ---------------
    function selectContextFor(question){
      const text = getLecture();
      if(!text) return '';
      // Further increased limits to include more of the lecture in answers
      const chunkSize = 20000; // chars per chunk
      const maxSend = 60000; // total chars to send
      const chunks = [];
      for(let i=0;i<text.length;i+=chunkSize){ chunks.push(text.slice(i, i+chunkSize)); }
      const qTokens = (clean(question).toLowerCase().split(/\s+/).filter(t=>t.length>2));
      const scored = chunks.map((c,idx)=>{
        const score = qTokens.reduce((acc,t)=> acc + (c.toLowerCase().includes(t)?1:0), 0);
        return { idx, c, score };
      });
      scored.sort((a,b)=> b.score - a.score);
      let picked = '';
      // pick more top chunks within the new maxSend limit
      for(const s of scored.slice(0,4)){
        if((picked.length + s.c.length) <= maxSend){ picked += (picked?"\n\n":"") + s.c; }
      }
      return picked || text.slice(0, maxSend);
    }

    // --------------- TTS (speechSynthesis) ---------------
    function waitForVoices(timeoutMs = 1500){
      return new Promise((resolve)=>{
        try{
          const have = speechSynthesis.getVoices();
          if(have && have.length){ resolve(true); return; }
          let done = false;
          const onv = ()=>{ if(!done){ done=true; resolve(true); speechSynthesis.onvoiceschanged=null; } };
          speechSynthesis.onvoiceschanged = onv;
          setTimeout(()=>{ if(!done){ done=true; resolve(true); speechSynthesis.onvoiceschanged=null; } }, timeoutMs);
        }catch(_){ resolve(true); }
      });
    }
    function getArabicVoice(){
      const voices = speechSynthesis.getVoices() || [];
      // Prefer high-quality Arabic voices if available
      const prefs = [
        /Google.*Arabic/i,
        /Microsoft.*Arabic/i,
        /ar-SA/i,
        /ar-XA/i,
        /Arabic/i,
        /ar/i
      ];
      for (const re of prefs){
        const v = voices.find(v => re.test(`${v.name} ${v.lang}`));
        if (v) return v;
      }
      return voices[0] || null;
    }

    async function speak(text){
      if(!('speechSynthesis' in window)) return;
      // On mobile, require explicit enable due to autoplay policy
      if (isMobile && !state.audioEnabled) return;
      try{ await waitForVoices(1500); }catch(_){ }
      try{ if (speechSynthesis.paused) speechSynthesis.resume(); }catch(_){ }
      const u = new SpeechSynthesisUtterance(text);
      const v = getArabicVoice();
      if(v) u.voice = v;
      u.lang = (v && v.lang) || 'ar-SA';
      // Slightly slower, clearer rate for mobile; normal for desktop
      u.rate = isMobile ? 0.9 : 1.0; 
      u.pitch = 1.02; 
      u.volume = 1.0;
      try{ window.speechSynthesis.cancel(); }catch(_){ }
      u.onstart = ()=>{
        state.speaking = true;
        // Pause recognition while speaking to avoid echo
        try{ if(recog && state.recognizing) recog.stop(); }catch(_){ }
      };
      u.onend = ()=>{
        state.speaking = false;
        // Auto-resume listening in live mode
        if(state.live && recog && !state.recognizing){
          try{ recog.start(); }catch(_){ }
        }
      };
      window.speechSynthesis.speak(u);
      state.lastUtterance = text;
      speakBtn.disabled = false;
    }

    function ttsPlayLast(){ if(state.lastUtterance) speak(state.lastUtterance); }

    // Long-form reading of the lecture in chunks
    function splitLectureForReading(text){
      const maxChunk = 1600; // longer paragraph per utterance for fewer breaks
      const parts = [];
      let i = 0;
      while(i < text.length){
        let end = Math.min(i + maxChunk, text.length);
        // try to cut at sentence/phrase boundary for Arabic
        const slice = text.slice(i, end);
        const stops = ['.','!','ØŸ','â€¦','\n','ØŒ'];
        let lastStop = -1;
        for(const s of stops){ const p = slice.lastIndexOf(s); if(p > lastStop) lastStop = p; }
        if(lastStop > 200){ end = i + lastStop + 1; }
        parts.push(text.slice(i, end).trim());
        i = end;
      }
      return parts.filter(Boolean);
    }

    function stopReading(){
      readingActive = false;
      try{ window.speechSynthesis.cancel(); }catch(_){ }
      appendMsg('ai', 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.');
      try{ logActivity('lecture_read_end', 'Ø¥ÙŠÙ‚Ø§Ù Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨ØµÙˆØª', 'book'); }catch(_){ }
    }

    async function readLectureAloud(){
      const lecture = getLecture();
      if(!lecture || lecture.length < 30){
        appendMsg('ai', 'Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø£ÙˆÙ„ Ø¹Ø´Ø§Ù† Ø£Ù‚Ø±Ø£Ù‡.');
        return;
      }
      if(isMobile && !state.audioEnabled){
        appendMsg('ai', 'Ù‚Ø¨Ù„ Ù…Ø§ Ø£Ù‚Ø±Ø£ØŒ Ø§Ø¶ØºØ· "ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š" Ø¹Ù„Ø´Ø§Ù† Ø§Ù„ØµÙˆØª ÙŠØ´ØªØºÙ„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.');
        return;
      }
      if(readingActive){ appendMsg('ai', 'Ø£Ù†Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ù‚Ø±Ø£. ØªÙ‚Ø¯Ø± ØªØ¶ØºØ· "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©" Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§.'); return; }
      readingQueue = splitLectureForReading(lecture);
      if(!readingQueue.length){ appendMsg('ai', 'Ù„Ù… Ø£Ø¬Ø¯ ÙÙ‚Ø±Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©.'); return; }
      readingIndex = 0;
      readingActive = true;
      appendMsg('ai', 'Ø­Ø§Ø¶Ø±ØŒ Ù‡Ø§Ù‚Ø±Ø£ Ù„Ùƒ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ÙÙ‚Ø±Ø© ÙÙ‚Ø±Ø©. ØªÙ‚Ø¯Ø± ØªÙˆÙ‚Ù ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.');
      try{ logActivity('lecture_read_start', 'Ø¨Ø¯Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨ØµÙˆØª', 'book'); }catch(_){ }
      const speakNext = ()=>{
        if(!readingActive) return;
        if(readingIndex >= readingQueue.length){ readingActive = false; appendMsg('ai', 'Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.'); return; }
        const chunk = readingQueue[readingIndex++];
        const u = new SpeechSynthesisUtterance(chunk);
        const v = getArabicVoice(); if(v) u.voice = v; u.lang = (v && v.lang) || 'ar-SA';
        u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
        u.onend = ()=>{ if(readingActive){ setTimeout(speakNext, 250); } };
        try{ window.speechSynthesis.speak(u); }catch(_){ readingActive = false; }
      };
      speakNext();
    }

    // Mobile audio unlock (required for TTS on iOS/Android)
    function enableAudioOnMobile(){
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          const ctx = new AC();
          const buffer = ctx.createBuffer(1, 1, 22050);
          const src = ctx.createBufferSource();
          src.buffer = buffer; src.connect(ctx.destination); src.start(0);
        }
      } catch(_){ }
      state.audioEnabled = true;
      const btn = document.getElementById('audioEnableBtn');
      if (btn) btn.style.display = 'none';
      try { if (state.lastUtterance) speakBtn.disabled = false; } catch(_){ }
      appendMsg('ai', 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ. Ø§Ø³Ø£Ù„Ù†ÙŠ ÙˆØ³ÙˆÙ Ø£Ø¬ÙŠØ¨Ùƒ Ø¨ØµÙˆØª.');
    }

    // --------------- STT (SpeechRecognition) ---------------
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog = null;
    if(SR){
      recog = new SR();
      recog.lang = 'ar-SA';
      // iOS Safari is more stable with non-continuous mode
      recog.continuous = isIOS ? false : true; // live loop on Android/Desktop
      recog.interimResults = false;
      recog.maxAlternatives = 1;

      recog.onstart = ()=>{ state.recognizing = true; recStatus.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...'; micBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† â¹ï¸'; };
      recog.onend = ()=>{
        state.recognizing = false; 
        recStatus.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØªÙˆÙ‚Ù'; 
        micBtn.textContent = 'ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ğŸ™ï¸';
        // If in live mode and not speaking, restart listening
        if(state.live && !state.speaking){
          try{ recog.start(); }catch(_){ }
        }
      };
      recog.onerror = ()=>{ state.recognizing = false; recStatus.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹'; };
      recog.onresult = (e)=>{
        const t = e.results[0][0].transcript || '';
        if(t){ appendMsg('user', t); handleUserQuery(t); }
      };
    }

    function toggleMic(){
      if(!recog){ alert('Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ¹Ø±Ù‘Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. ÙŠÙÙØ¶Ù‘Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome.'); return; }
      // Toggle live conversation mode similar to Gemini Live
      if(state.live || state.recognizing){
        state.live = false;
        try{ recog.stop(); }catch(_){ }
        return;
      }
      state.live = true;
      try{ recog.start(); }catch(_){ }
    }

    // --------------- Core Logic ---------------
    const API_BASE = 'https://student-platform-backend-one.vercel.app';
    async function ensureSession(){
      try{
        if(!window.supabaseClient) window.initializeSupabase();
        const { data } = await window.supabaseAuth.getSession();
        const tok = data?.session?.access_token;
        if(tok) state.token = tok;
        try{ state.userId = data?.session?.user?.id || state.userId; }catch(_){ }
        return tok;
      }catch(_){ return null; }
    }

    // Lightweight activity logger (safe no-op if table not present)
    async function logActivity(type, description, icon='star'){
      try{
        if(!window.supabaseDB || !window.supabaseDB.activities || !window.supabaseDB.activities.create) return;
        const tok = await ensureSession().catch(()=>null);
        const userId = state.userId || null;
        if(!tok || !userId) return; // require auth
        await window.supabaseDB.activities.create({
          user_id: userId,
          type: type,
          description: description,
          icon: icon,
          created_at: new Date().toISOString()
        });
      }catch(_){ }
    }

    async function uploadFile(file){
      try{
        const tok = await ensureSession();
        if(!tok){ return null; }
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch(`${API_BASE}/api/upload`, { method:'POST', headers:{ 'Authorization': `Bearer ${tok}` }, body: fd });
        if(!res.ok) return null;
        const json = await res.json();
        return json;
      }catch(_){ return null; }
    }

    function renderUploads(){
      if(!state.uploads.length){ uploadsList.textContent = ''; return; }
      uploadsList.innerHTML = state.uploads.map(u=>`âœ”ï¸ ${u.name || 'Ù…Ù„Ù'} â€” ${Math.round((u.size||0)/1024)}KB`).join('<br/>');
    }

    async function uploadSelectedFiles(){
      const files = (pdfFiles && pdfFiles.files) ? Array.from(pdfFiles.files) : [];
      if(!files.length){ alert('Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹'); return; }
      for(const f of files){
        // For TXT/MD, extract locally as immediate fallback
        try{
          if(/\.(txt|md)$/i.test(f.name)){
            const localText = await f.text();
            if (localText && localText.trim()) {
              lectureInput.value = (lectureInput.value ? (lectureInput.value + "\n\n") : '') + localText;
            }
          }
        } catch (_) {}
      }

      // For PDFs, extract full text on the client using PDF.js with live progress
      try {
        if (window['pdfjsLib']) {
          for (const f of files) {
            if(/\.(pdf)$/i.test(f.name)){
              try {
                const buf = await f.arrayBuffer();
                const doc = await pdfjsLib.getDocument({ data: buf }).promise;
                for (let i = 1; i <= doc.numPages; i++) {
                  const page = await doc.getPage(i);
                  const content = await page.getTextContent();
                  const pageText = content.items.map(it => (it.str || '')).join(' ');
                  // Append per-page to avoid huge in-memory strings
                  lectureInput.value = (lectureInput.value ? (lectureInput.value + '\n\n') : '') + pageText;
                  updateLectureStats();
                  // Lightweight yield to keep UI responsive
                  await new Promise(r=>setTimeout(r,0));
                  // Show progress
                  if (uploadsList) uploadsList.textContent = `Ø¬Ø§Ø±Ù Ø§Ø³ØªØ®Ø±Ø§Ø¬: ${f.name} â€” ØµÙØ­Ø© ${i}/${doc.numPages}`;
                }
                state.uploads.push({ name: f.name, size: f.size });
                renderUploads();
              } catch(_) {}
            }
          }
        }
      } catch(_) {}

      // Optional server upload (only if logged in)
      try{
        const tokCheck = await ensureSession();
        if (tokCheck) {
          for(const f of files){
            try{
              const r = await uploadFile(f);
              if(r){
                state.uploads.push(r);
                if(r.extractedText && r.extractedText.trim()){
                  lectureInput.value = (lectureInput.value ? (lectureInput.value + "\n\n") : '') + r.extractedText;
                }
              }
              renderUploads();
            }catch(_){ }
          }
        }
      }catch(_){ }
      if(pdfFiles) pdfFiles.value = '';
      // Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¯Ù…Ø¬ Ø§Ù„Ù†Øµ
      try { 
        const lectureText = getLecture();
        if(!lectureText || lectureText.length < 30){
          appendMsg('ai', `${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ ÙˆØ§Ø¶Ø­ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ø´Ø±Ø­. Ø¬Ø±Ù‘Ø¨ Ø±ÙØ¹ PDF Ø£Ùˆ TXT/MD ÙˆØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ø¨Ø§Ø´Ø±Ø©.`);
          speak(`${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ø¨Ø¯Ø£ Ø£Ø´Ø±Ø­.`);
        } else {
          // Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„: Ø§Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯Ø«
          if (isMobile && !state.audioEnabled) {
            appendMsg('ai', 'Ù‚Ø¨Ù„ Ù…Ø§ Ø£ØªÙƒÙ„Ù…ØŒ Ø§Ø¶ØºØ· Ø²Ø± "ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š" ÙÙˆÙ‚ Ø¹Ù„Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£ØªÙƒÙ„Ù… Ø¨ØµÙˆØª Ø¹Ù„Ù‰ Ø¬ÙˆØ§Ù„Ùƒ. Ø¨Ø¹Ø¯ ÙƒØ¯Ù‡ Ø§Ø³Ø£Ù„Ù†ÙŠ ÙˆØ£Ù†Ø§ Ù‡Ø¬Ø§ÙˆØ¨Ùƒ Ø¨ØµÙˆØª.');
          } else {
            await startAutoExplain();
            try{ logActivity('lecture_uploaded', 'ØªÙ… Ø±ÙØ¹ Ù…Ù„ÙØ§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ù†Øµ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø©', 'upload'); }catch(_){ }
          }
        }
      } catch(_){ }
    }

    async function askGemini(question){
      try{
        const tok = await ensureSession().catch(()=>null);
        const ctx = selectContextFor(question);
        const headers = { 'Content-Type':'application/json' };
        if (tok) headers['Authorization'] = `Bearer ${tok}`;
        const res = await fetch(`${API_BASE}/api/ai/ask`, { method:'POST', headers, body: JSON.stringify({ question, context: ctx }) });
        if(!res.ok) return null;
        const json = await res.json();
        return json?.response || null;
      }catch(_){ return null; }
    }

    // Streaming via SSE (fetch + manual SSE parse)
    async function askGeminiStream(question, onDelta){
      const tok = await ensureSession().catch(()=>null);
      const ctx = selectContextFor(question);
      const headers = { 'Content-Type':'application/json' };
      if (tok) headers['Authorization'] = `Bearer ${tok}`;
      const res = await fetch(`${API_BASE}/api/ai/stream`, { method:'POST', headers, body: JSON.stringify({ question, context: ctx }) });
      if(!res.ok || !res.body) throw new Error('no-stream');
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      while(true){
        const {done, value} = await reader.read(); if(done) break;
        buffer += decoder.decode(value, { stream:true });
        const parts = buffer.split(/\n\n/);
        buffer = parts.pop() || '';
        for(const evt of parts){
          const line = evt.split("\n").find(l=>l.startsWith('data: '));
          if(!line) continue;
          try{
            const payload = JSON.parse(line.slice(6));
            if(payload && payload.text){ onDelta(payload.text); }
          }catch(_){ }
        }
      }
    }

    async function summarizeLecture(){
      const content = getLecture();
      if(!content || content.length < 30){
        appendMsg('ai', `${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£Ø¹Ù…Ù„ ØªÙ„Ø®ÙŠØµ Ø¯Ù‚ÙŠÙ‚.`);
        speak('Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£Ø¹Ù…Ù„ ØªÙ„Ø®ÙŠØµ Ø¯Ù‚ÙŠÙ‚.');
        return;
      }
      const prompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³ÙŠ Ø¹Ø±Ø¨ÙŠ. Ù„Ø¯ÙŠÙƒ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨ÙŠÙ† ÙŠØ¯ÙŠÙƒ. Ù„Ø®Ù‘Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù†Ù‚Ø§Ø· ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø®ØªØµØ±Ø© Ø¬Ø¯Ø§Ù‹ (3-6 Ù†Ù‚Ø§Ø· ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)ØŒ Ø¨Ø¯ÙˆÙ† Ø­Ø´ÙˆØŒ ÙˆØ¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ù…Ø¨Ø³Ø·Ø©. Ù„Ø§ ØªØ¶Ù Ù…Ù‚Ø¯Ù…Ø§Øª Ø£Ùˆ Ø®ØªØ§Ù….`;
      let replyText = await askGemini(prompt);
      if(!replyText){
        const sents = splitSentences(content).slice(0,6);
        replyText = `â€¢ ${sents.slice(0,4).join('\nâ€¢ ')}`;
      }
      replyText = `${persona.prefix} \n${replyText}`;
      appendMsg('ai', replyText);
      speak(replyText);
      try{ logActivity('ai_summary', 'ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµÙˆØªÙŠØ©', 'star'); }catch(_){ }
    }

    async function explainLecture(){
      const content = getLecture();
      if(!content || content.length < 30){
        appendMsg('ai', `${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ ÙƒÙØ§ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ø´Ø±Ø­.`);
        speak('Ù…Ø­ØªØ§Ø¬ Ù†Øµ ÙƒÙØ§ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¹Ø´Ø§Ù† Ø£Ø´Ø±Ø­.');
        return;
      }
      const prompt = `Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ù‘Ø· ÙˆØ¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ù†Ù‚Ø·ØªÙŠÙ† Ø£Ùˆ Ø«Ù„Ø§Ø« Ù…Ù† Ø£Ù‡Ù… Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ù…Ø¹ Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ ØµØºÙŠØ± Ù„ÙƒÙ„ Ù†Ù‚Ø·Ø©ØŒ Ø¨Ø¯ÙˆÙ† Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø©.`;
      let replyText = await askGemini(prompt);
      if(!replyText){
        const sents = splitSentences(content);
        const take = sents.slice(0,3).join(' ');
        replyText = `Ø§Ù„Ø®Ù„Ø§ØµØ©: ${take}`;
      }
      replyText = `${persona.prefix} ${replyText}`;
      appendMsg('ai', replyText);
      speak(replyText);
    }

    // Generate a single MP3 file that contains the Arabic explanation of the lecture
    async function generateAudioFromLecture(){
      try{
        const content = getLecture();
        if(!content || content.length < 30){
          appendMsg('ai', `${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø£ÙˆÙ„ (Ø§Ø±ÙØ¹ PDF Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ).`);
          return;
        }
        appendMsg('ai', 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø±Ø­ Ù…ÙˆØ¬Ø² ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ØµÙˆØª...');
        const prompt = `Ø§Ù‚Ø±Ø£ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆÙ‚Ø¯Ù‘Ù… Ø´Ø±Ø­Ù‹Ø§ Ù…Ø¨Ø³Ù‘Ø·Ù‹Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ ÙÙ‚Ø±ØªÙŠÙ† Ø¥Ù„Ù‰ Ø«Ù„Ø§Ø« ÙÙ‚Ø±Ø§Øª Ù‚ØµÙŠØ±Ø© Ù…Ø¹ Ø£Ù…Ø«Ù„Ø© Ø³Ø±ÙŠØ¹Ø© ÙŠÙ…ÙƒÙ† Ø³Ù…Ø§Ø¹Ù‡Ø§ ÙÙŠ Ø£Ù‚Ù„ Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚.`;
        const explanation = await askGemini(prompt) || content.slice(0, 1200);
        // Request backend TTS (returns data URL)
        const headers = { 'Content-Type':'application/json' };
        const r = await fetch(`${API_BASE}/api/tts`, { method:'POST', headers, body: JSON.stringify({ text: explanation }) });
        if(!r.ok){ appendMsg('ai', 'ØªØ¹Ø°Ù‘Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ù…ÙØªØ§Ø­ OPENAI_API_KEY Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.'); return; }
        const j = await r.json();
        const url = j && j.audio;
        if(!url){ appendMsg('ai', 'Ù„Ù… ÙŠØµÙ„Ù†ÙŠ Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….'); return; }
        // Show custom player styled like the screenshot
        const audio = document.getElementById('aiAudio');
        const link = document.getElementById('audioDownload');
        if(audio){ audio.src = url; audio.style.display='none'; }
        if(link){ link.href = url; link.style.display='none'; }
        setupCustomPlayer(url);
        appendMsg('ai', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙÙ„Ø®Ù‘Øµ ØµÙˆØªÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„Ù‡ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„Ù‡ Ù…Ù† Ø§Ù„Ù…Ø´ØºÙ‘Ù„ Ø£Ø¯Ù†Ø§Ù‡.');
      }catch(_){
        appendMsg('ai', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØª.');
      }
    }

    // ---------------- Custom Audio Player ----------------
    function fmtTime(s){ s = Math.max(0, s|0); const m = (s/60)|0; const ss = (s%60)|0; return `${m}:${ss<10?'0':''}${ss}`; }
    function setupCustomPlayer(url){
      const cp = document.getElementById('customPlayer');
      const bar = document.getElementById('cpBar');
      const time = document.getElementById('cpTime');
      const play = document.getElementById('cpPlay');
      const back = document.getElementById('cpBack');
      const fwd = document.getElementById('cpFwd');
      const spd = document.getElementById('cpSpeed');
      const dl = document.getElementById('cpDownload');
      if(!cp) return;
      // single hidden audio element reused
      const a = document.getElementById('aiAudio');
      a.src = url; a.preload = 'metadata';
      cp.style.display = 'block';
      dl.onclick = ()=>{ try{ const x = document.createElement('a'); x.href=url; x.download='lecture-explain.mp3'; document.body.appendChild(x); x.click(); x.remove(); }catch(_){}}
      let speeds = [1, 1.25, 1.5, 2]; let si = 0; spd.onclick = ()=>{ si=(si+1)%speeds.length; a.playbackRate = speeds[si]; spd.textContent = `${speeds[si]}x`; };
      back.onclick = ()=>{ try{ a.currentTime = Math.max(0, a.currentTime - 10); }catch(_){ } };
      fwd.onclick = ()=>{ try{ a.currentTime = Math.min((a.duration||0), a.currentTime + 10); }catch(_){ } };
      play.onclick = async ()=>{
        try{
          if(a.paused){ await a.play(); play.textContent='â¸ï¸'; } else { a.pause(); play.textContent='â–¶ï¸'; }
        }catch(_){ }
      };
      a.onloadedmetadata = ()=>{
        try{ bar.value = 0; time.textContent = `0:00 / ${fmtTime(a.duration||0)}`; }catch(_){ }
      };
      a.ontimeupdate = ()=>{
        try{
          const d = a.duration||0; const c = a.currentTime||0; bar.value = d? Math.round((c/d)*100) : 0; time.textContent = `${fmtTime(c)} / ${fmtTime(d)}`;
        }catch(_){ }
      };
      bar.oninput = ()=>{
        try{ const d=a.duration||0; if(d){ a.currentTime = (+bar.value/100)*d; } }catch(_){ }
      };
    }

    // Quick entry to Live mode for the uploaded lecture (like Gemini Live)
    function startLiveAboutLecture(){
      const content = getLecture();
      if(!content || content.length < 30){ appendMsg('ai', 'Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø£Ùˆ Ø§Ù„ØµÙ‚ Ù†ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯Ø« Live.'); return; }
      appendMsg('ai', 'ÙˆØ¶Ø¹ Live Ù…ÙØ¹Ù‘Ù„. ØªÙƒÙ„Ù‘Ù… Ø§Ù„Ø¢Ù† ÙˆØ³Ø£Ø±Ø¯Ù‘ Ù…Ø¹ØªÙ…Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.');
      // Ensure STT is running
      try{
        if(!recog){ alert('Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ¹Ø±Ù‘Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. ÙŠÙÙØ¶Ù‘Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome.'); return; }
        if(!state.live){ state.live = true; }
        if(!state.recognizing){ recog.start(); }
      }catch(_){ }
    }

    async function startAutoExplain(){
      const content = getLecture();
      if(!content || content.length < 30){
        appendMsg('ai', `${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø£ÙˆÙ„ Ø¹Ø´Ø§Ù† Ø£Ø¨Ø¯Ø£ Ø£Ø´Ø±Ø­. Ø§Ø±ÙØ¹ PDF Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ.`);
        speak(`${persona.prefix} Ù…Ø­ØªØ§Ø¬ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø£ÙˆÙ„ Ø¹Ø´Ø§Ù† Ø£Ø¨Ø¯Ø£ Ø£Ø´Ø±Ø­.`);
        return;
      }
      const prompt = `Ø§Ù‚Ø±Ø£ Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚ ÙˆÙ‚Ø¯Ù‘Ù… Ø´Ø±Ø­Ù‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§ ÙˆÙ…Ù†Ø¸Ù…Ù‹Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:
- Ø¬Ù…Ù„ØªØ§Ù† ØªÙ„Ø®Ù‘ØµØ§Ù† Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.
- Ù†Ù‚Ø·ØªØ§Ù† Ø£Ùˆ Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø®ØªØµØ±Ø©.
- Ù…Ø«Ø§Ù„ ØµØºÙŠØ± ÙˆØ§Ø­Ø¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰.
Ù„Ø§ ØªØ¶Ù Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø©.`;
      const aiResp = await askGemini(prompt);
      const fallback = (()=>{
        const sents = splitSentences(content);
        const head = sents.slice(0,2).join(' ');
        const bullets = sents.slice(2,5).map(s=>`â€¢ ${s}`).join('\n');
        return `${head}\n${bullets}`;
      })();
      const replyText = aiResp ? `${persona.prefix} ${aiResp}` : `${persona.prefix} ${fallback}`;
      appendMsg('ai', replyText);
      speak(replyText);
    }
    function getLecture(){ return clean(lectureInput.value); }

    function answerFromLecture(question){
      const lecture = getLecture();
      const q = clean(question).toLowerCase();
      if(!lecture){
        const msg = `${persona.prefix} Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯ÙŠ Ù…Ø´ Ù…Ø°ÙƒÙˆØ±Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù„ÙŠ Ø±ÙØ¹ØªÙ‡Ø§. Ù„ÙƒÙ† Ø¹Ø´Ø§Ù† ØªØ³ØªÙÙŠØ¯ØŒ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…: Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„Ø§Ø²Ù… ØªØ­Ø· Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù‡Ù†Ø§ Ø§Ù„Ø£ÙˆÙ„.`;
        return { text: msg, fromLecture: false };
      }
      // Naive extractive approach: pick sentences containing key tokens
      const sents = splitSentences(lecture);
      const tokens = q.split(/\s+/).filter(x=>x.length>2);
      let scored = sents.map(s=>({ s, score: tokens.reduce((acc,t)=>acc+(s.includes(t)?1:0),0) }));
      scored.sort((a,b)=>b.score-a.score);
      const top = scored.slice(0, 2).map(x=>x.s).filter(Boolean);
      if(top.length===0){
        const fallback = `${persona.prefix} Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯ÙŠ Ù…Ø´ Ù…Ø°ÙƒÙˆØ±Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù„ÙŠ Ø±ÙØ¹ØªÙ‡Ø§. Ù„ÙƒÙ† Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ù…Ù…ÙƒÙ† Ù†Ù‚ÙˆÙ„: Ø­Ø§ÙˆÙ„ ØªØ±Ø¨Ø· Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ø§Ù„ÙˆØ§Ø¶Ø­Ø© ÙÙŠ Ø§Ù„Ù†Øµ.`;
        return { text: fallback, fromLecture: false };
      }
      const concise = `${persona.prefix} ${top[0]}${top[1]? ' â€” '+top[1] : ''}. ${pickWarmup()}!`;
      return { text: concise, fromLecture: true, context: top.join(' | ') };
    }

    async function handleUserQuery(text){
      const q = (text||'').toLowerCase();
      if(/(ØªÙ„Ø®ÙŠØµ|Ù„Ø®Øµ|Ø®Ù„Ø§ØµØ©)/.test(q)){
        await summarizeLecture();
        return;
      }
      if(/(Ø§Ø´Ø±Ø­|Ø´Ø±Ø­)/.test(q)){
        await explainLecture();
        return;
      }
      if (/(Ø§Ø³Ø¦Ù„Ø©|Ø£Ø³Ø¦Ù„Ø©|Ø³Ø¤Ø§Ù„|Ø§Ø®ØªØ¨Ø§Ø±|ÙƒÙˆÙŠØ²)/.test(q)){
        try{ makeAdaptiveQuestion(); }catch(_){ }
        appendMsg('ai', `${persona.prefix} Ø¹Ù…Ù„Øª Ù„Ùƒ Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©. Ø¬Ø±Ù‘Ø¨ ØªØ¬Ø§ÙˆØ¨Ù‡!`);
        speak('Ø¹Ù…Ù„Øª Ù„Ùƒ Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.');
        try{ logActivity('ai_quiz_generated', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¤Ø§Ù„ Ù…ØªÙƒÙŠÙ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©', 'star'); }catch(_){ }
        return;
      }
      if (/(Ø§ØµØ¹Ø¨|Ø£ØµØ¹Ø¨|ØµØ¹Ø¨|Ø²ÙˆØ¯ Ø§Ù„ØµØ¹ÙˆØ¨Ø©|Ø²ÙˆØ¯|Ø£Ø¹Ù„Ù‰ ØµØ¹ÙˆØ¨Ø©)/.test(q)){
        try{ toggleTougher(); }catch(_){ }
        appendMsg('ai', `${persona.prefix} ØªÙ…Ø§Ù…ØŒ Ø²ÙˆÙ‘Ø¯Ù†Ø§ Ø§Ù„ØµØ¹ÙˆØ¨Ø© Ø®Ø·ÙˆØ©.`);
        speak('Ø²ÙˆÙ‘Ø¯Ù†Ø§ Ø§Ù„ØµØ¹ÙˆØ¨Ø© Ø®Ø·ÙˆØ©.');
        return;
      }
      if (/(Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø±Ø­|Ø§Ø¨Ø¯Ø£|Ø§Ø¨Ø¯Ø§ Ø§Ù„Ø´Ø±Ø­|Ø§Ø¨Ø¯Ø§)/.test(q)){
        await startAutoExplain();
        return;
      }
      // Try streaming first
      let bubbleWrap = document.createElement('div');
      bubbleWrap.className = 'msg from-ai';
      let bubble = document.createElement('div'); bubble.className = 'bubble'; bubble.textContent = persona.prefix + ' ';
      bubbleWrap.appendChild(bubble); chat.appendChild(bubbleWrap); chat.scrollTop = chat.scrollHeight;

      let collected = '';
      let speakBuffer = '';
      const flushSpeak = ()=>{
        const sentences = splitSentences(speakBuffer);
        if(sentences.length){ speak(sentences.join('. ')); speakBuffer=''; }
      };
      try{
        await askGeminiStream(text, (delta)=>{
          collected += delta;
          bubble.textContent = `${persona.prefix} ${collected}`;
          // accumulate until sentence end for TTS
          speakBuffer += delta;
          if(/[.!ØŸ]\s*$/.test(delta)){
            const toSpeak = speakBuffer; speakBuffer=''; speak(toSpeak);
          }
        });
        // speak any remainder
        if(speakBuffer.trim()){ flushSpeak(); }
      }catch(_){
        // Fallback non-stream
        let replyText = null;
        const aiResp = await askGemini(text);
        if(aiResp){ replyText = `${persona.prefix} ${aiResp}`; }
        else {
          const local = answerFromLecture(text);
          if(local && (local.fromLecture || local.text)) replyText = local.text; else replyText = `${persona.prefix} ${pickWarmup()}! Ù‚Ù„ Ù„ÙŠ: Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† Ø£Ø´Ø±Ø­ Ø£Ùˆ Ø£Ø³Ù‡Ù‘Ù„ØŸ`;
        }
        bubble.textContent = replyText;
        speak(replyText);
      }
      state.questionsSinceBreak++;

      if(!state.directAnswer){
        // Human-like small pause then follow-up
        await delay(1000);
        const follow = persona.follow;
        appendMsg('ai', follow);
        speak(follow);

        // Break hint every 5 Qs
        if(state.questionsSinceBreak % 5 === 0){
          const br = 'Ø¨ØµØ±Ø§Ø­Ø© ØªØ±ÙƒÙŠØ²Ùƒ Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ù‹Ø§! Ø®Ù…Ø³ Ø¯Ù‚Ø§ÙŠÙ‚ Ø¨Ø±ÙŠÙƒ ÙˆØ§Ø±Ø¬Ø¹ØŒ ÙˆÙ„Ø§ ØªØ­Ø¨ Ù†Ø®Ù„Øµ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯ÙŠ ÙˆÙ†Ù‚ÙˆÙ…ØŸ';
          appendMsg('ai', br);
          speak(br);
        }
      }
    }

    function submitText(){
      const t = clean(textInput.value);
      if(!t) return;
      textInput.value='';
      appendMsg('user', t);
      handleUserQuery(t);
    }

    function clearChat(){
      chat.innerHTML = '';
      state.history = [];
      appendMsg('ai', `${persona.prefix} ØªÙ…Ø§Ù…ØŒ ÙŠÙ„Ø§ Ø¨ÙŠÙ†Ø§ Ù†Ø±ÙƒØ². Ù†Ø¨Ø¯Ø£ Ù…Ù†ÙŠÙ†ØŸ`);
    }

    function loadSample(){
      lectureInput.value = `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø§Ù„Ø¨Ø±Ø§ÙƒÙŠÙ† ÙˆØ­Ø±ÙƒØ© Ø§Ù„ØµÙØ§Ø¦Ø­ Ø§Ù„ØªÙƒØªÙˆÙ†ÙŠØ©

Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ø¨Ø±Ø§ÙƒÙŠÙ† Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ØµÙØ§Ø¦Ø­: ØªÙ†Ø´Ø£ Ù…Ø¹Ø¸Ù… Ø§Ù„Ø¨Ø±Ø§ÙƒÙŠÙ† Ø¹Ù„Ù‰ Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙØ§Ø¦Ø­ Ø§Ù„ØªÙƒØªÙˆÙ†ÙŠØ©ØŒ ÙˆØ®Ø§ØµØ© Ø¹Ù†Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø§Ù†Ø¯Ø³Ø§Ø³ Ø­ÙŠØ« ØªÙ†ØºÙ…Ø³ ØµÙÙŠØ­Ø© Ù…Ø­ÙŠØ·ÙŠØ© Ø£Ø³ÙÙ„ ØµÙÙŠØ­Ø© Ù‚Ø§Ø±ÙŠØ© Ù…Ù…Ø§ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø§Ù†ØµÙ‡Ø§Ø± Ø§Ù„ØµØ®ÙˆØ± ÙˆØ§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ‡Ø§Ø±Ø©. ÙƒØ°Ù„Ùƒ ØªØ¸Ù‡Ø± Ø¨Ø±Ø§ÙƒÙŠÙ† Ø¹Ù†Ø¯ ØªØ¨Ø§Ø¹Ø¯ Ø§Ù„ØµÙØ§Ø¦Ø­ (Ø§Ù„Ø­ÙŠØ¯ Ø§Ù„ÙˆØ³Ø· Ù…Ø­ÙŠØ·ÙŠØ©) Ø­ÙŠØ« ØªØµØ¹Ø¯ Ø§Ù„ØµÙ‡Ø§Ø±Ø© Ù„Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§Øº.

Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø¤Ø«Ø±Ø© Ø¹Ù„Ù‰ Ø´Ø¯Ø© Ø§Ù„Ø¨Ø±ÙƒØ§Ù†: Ù„Ø²ÙˆØ¬Ø© Ø§Ù„ØµÙ‡Ø§Ø±Ø©ØŒ ÙƒÙ…ÙŠØ© Ø§Ù„ØºØ§Ø² Ø§Ù„Ø°Ø§Ø¦Ø¨ØŒ ÙˆØªØ±ÙƒÙŠØ¨ Ø§Ù„ØµÙ‡Ø§Ø±Ø©. ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯Øª Ø§Ù„Ù„Ø²ÙˆØ¬Ø© ÙˆØ§Ø²Ø¯Ø§Ø¯ Ø§Ù„ØºØ§Ø² Ø§Ø±ØªÙØ¹ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ø²Ø¯Ø§Ø¯Øª Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±Ø§Øª.

Ø§Ù„Ø¢Ø«Ø§Ø±: ØªØ¤Ø«Ø± Ø§Ù„Ø¨Ø±Ø§ÙƒÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø§Ø® Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¹Ø¨Ø± Ø§Ù†Ø¨Ø¹Ø§Ø« Ø§Ù„Ø±Ù…Ø§Ø¯ ÙˆØ§Ù„ÙƒØ¨Ø±ÙŠØªØ§Øª Ø§Ù„ØªÙŠ ØªØ¹ÙƒØ³ Ø£Ø´Ø¹Ø© Ø§Ù„Ø´Ù…Ø³ØŒ ÙˆÙ‚Ø¯ ØªÙØ®ØµÙ‘Ø¨ Ø§Ù„ØªØ±Ø¨Ø© Ø¨Ø§Ù„Ù…Ø¹Ø§Ø¯Ù†.
`;
    }

    function resetLecture(){ lectureInput.value=''; }

    // --------------- Adaptive Quiz (very light) ---------------
    function makeAdaptiveQuestion(){
      const lecture = getLecture();
      const sents = splitSentences(lecture);
      if(!sents.length){ quizSlot.textContent = 'Ø£Ø¶Ù Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹.'; return; }
      // Pick a sentence and mask a term
      const base = state.tougher ? sents.slice(0, Math.max(2, Math.floor(sents.length/2))) : sents;
      const s = base[Math.floor(Math.random()*base.length)];
      const words = s.split(/\s+/).filter(w=>w.length>3);
      if(words.length<3){ quizSlot.textContent = 'Ø§Ù„Ù†Øµ Ù‚ØµÙŠØ± Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³Ø¤Ø§Ù„.'; return; }
      const idx = Math.floor(Math.random()*words.length);
      const answer = words[idx];
      const question = s.replace(answer, '_____');
      quizSlot.innerHTML = `<div><strong>Ø³Ø¤Ø§Ù„:</strong> Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº: ${question}</div><div style="margin-top:6px"><input id="quizAns" class="input" placeholder="Ø¥Ø¬Ø§Ø¨ØªÙƒ"/><button class=\"btn btn-primary\" style=\"margin-top:8px\" onclick=\"gradeAdaptive('${encodeURIComponent(answer)}')\">ØªØ­Ù‚Ù‚</button></div>`;
    }

    function gradeAdaptive(correctEnc){
      const correct = decodeURIComponent(correctEnc);
      const inp = document.getElementById('quizAns');
      const got = clean(inp.value||'');
      if(!got){ return; }
      if(got === correct){
        quizSlot.innerHTML = '<span style="color:var(--accent);font-weight:700">Ø¨Ø±Ø§ÙÙˆ! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©.</span>';
        speak('Ø¨Ø±Ø§ÙÙˆ!');
      } else {
        quizSlot.innerHTML = `<span style="color:var(--danger);font-weight:700">ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correct}</span>`;
        speak('Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙˆÙŠØ³Ø©!');
      }
    }

    function toggleTougher(){ state.tougher = !state.tougher; alert(state.tougher? 'ØªÙ… ØªÙØ¹ÙŠÙ„ ØµØ¹ÙˆØ¨Ø© Ø£Ø¹Ù„Ù‰' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©'); }

    // Toggle direct answer vs. conversational follow-ups
    function toggleDirectMode(){
      state.directAnswer = !state.directAnswer;
      const btn = document.getElementById('modeBtn');
      if(btn){
        btn.textContent = `ÙˆØ¶Ø¹ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©: ${state.directAnswer ? 'Ù…ÙØ¹Ù„' : 'Ù…ØªÙˆÙ‚Ù'}`;
      }
    }

    // --------------- Screen Share + OCR ---------------
    async function startScreenShare(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia){
        alert('Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.');
        return;
      }
      try{
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            frameRate: 15,
            // Hint browsers to capture current tab on mobile-supported environments
            preferCurrentTab: true,
            displaySurface: 'browser'
          },
          audio: false
        });
        state.screenStream = stream;
        screenPreview.srcObject = stream;
        document.getElementById('shareBtn').disabled = true;
        document.getElementById('stopShareBtn').disabled = false;
        document.getElementById('snapOcrBtn').disabled = false;
        stream.getVideoTracks()[0].addEventListener('ended', ()=>{
          stopScreenShare();
        });
      }catch(err){
        console.error(err);
        alert('ØªØ¹Ø°Ù‘Ø± Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS ÙˆØ§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ (Chrome Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯) Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø±ÙØ¹ ØµÙˆØ±Ø©.');
      }
    }

    function stopScreenShare(){
      try{
        if(state.screenStream){
          state.screenStream.getTracks().forEach(t=>t.stop());
        }
      }catch(_){ }
      state.screenStream = null;
      if(screenPreview){ screenPreview.srcObject = null; }
      document.getElementById('shareBtn').disabled = false;
      document.getElementById('stopShareBtn').disabled = true;
      document.getElementById('snapOcrBtn').disabled = true;
    }

    async function captureAndOCR(){
      if(!state.screenStream){ alert('Ø§Ø¨Ø¯Ø£ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
      const track = state.screenStream.getVideoTracks()[0];
      const imageCapture = ('ImageCapture' in window) ? new ImageCapture(track) : null;
      try{
        ocrStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§...';
        let bitmap;
        if(imageCapture && imageCapture.grabFrame){
          bitmap = await imageCapture.grabFrame();
        } else {
          // Fallback: draw current frame from video
          await new Promise(r=>setTimeout(r, 100));
          const v = screenPreview;
          const c = document.createElement('canvas');
          c.width = v.videoWidth || 1280; c.height = v.videoHeight || 720;
          const ctx = c.getContext('2d');
          ctx.drawImage(v, 0, 0, c.width, c.height);
          const dataUrl = c.toDataURL('image/png');
          const img = new Image();
          await new Promise(res=>{ img.onload=()=>res(); img.src=dataUrl; });
          const c2 = document.createElement('canvas');
          c2.width = img.width; c2.height = img.height;
          c2.getContext('2d').drawImage(img,0,0);
          bitmap = await createImageBitmap(img);
        }

        // Draw bitmap to canvas for OCR
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width; canvas.height = bitmap.height;
        const ctx2 = canvas.getContext('2d');
        ctx2.drawImage(bitmap, 0, 0);

        // Run OCR via Tesseract.js (Arabic + English)
        const worker = await Tesseract.createWorker('ara+eng');
        const { data } = await worker.recognize(canvas);
        await worker.terminate();

        const extracted = (data && data.text) ? data.text.trim() : '';
        if(extracted){
          lectureInput.value = (lectureInput.value ? lectureInput.value + '\n\n' : '') + extracted;
          appendMsg('ai', `${persona.prefix} ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ¯Ø±.`);
          speak('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡.');
          ocrStatus.textContent = `ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© (${extracted.length} Ø­Ø±Ù).`;
        } else {
          ocrStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Øµ ÙˆØ§Ø¶Ø­. Ø¬Ø±Ù‘Ø¨ ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­.';
        }
      }catch(err){
        console.error(err);
        ocrStatus.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬.';
      }
    }

    // Initial gentle voice greeting (non-blocking)
    window.addEventListener('load', ()=>{
      // On mobile, do not auto-speak; show enable button instead
      if (isMobile) {
        const btn = document.getElementById('audioEnableBtn');
        if (btn) btn.style.display = 'inline-block';
        // Auto-enable audio on first user interaction (one-time) to satisfy autoplay policies
        const first = ()=>{ try{ enableAudioOnMobile(); }catch(_){}; document.removeEventListener('touchend', first); document.removeEventListener('click', first); };
        document.addEventListener('touchend', first, { once: true });
        document.addEventListener('click', first, { once: true });
      } else {
        try { speak('Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ø¨Ø·Ù„! Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ø£Ø°Ø§ÙƒØ± Ù…Ø¹Ø§Ùƒ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¯ÙŠ. Ø¥ÙŠÙ‡ Ø£ÙˆÙ„ Ø¬Ø²Ø¡ Ø­Ø§Ø¨Ø¨ Ù†Ø±ÙƒØ² Ø¹Ù„ÙŠÙ‡ØŸ'); } catch(_) {}
      }
      if(typeof speechSynthesis !== 'undefined'){
        // Ensure voices are loaded
        speechSynthesis.onvoiceschanged = ()=>{};
      }
      try{ ensureSession(); }catch(_){}
      // Feature detection to guide UI
      const hasShare = !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia);
      if(!hasShare){
        const btn = document.getElementById('shareBtn'); if(btn) btn.disabled = true;
        const snap = document.getElementById('snapOcrBtn'); if(snap) snap.disabled = true;
      }
      // Update stats if prefilled
      updateLectureStats();
    });
    
  </script>
</body>
</html>
