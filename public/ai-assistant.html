<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ | Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
    <meta name="description" content="Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø§Øª ÙÙˆØ±ÙŠØ© Ø¹Ù† Ø£Ø³Ø¦Ù„ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ù† Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ.">
    <meta name="keywords" content="Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ, Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªØ¹Ù„ÙŠÙ…ÙŠ, Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©, Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø©, Ù…Ø³Ø§Ø¹Ø¯ Ø·Ù„Ø§Ø¨ÙŠ, ØªØ¹Ù„Ù… ØªÙØ§Ø¹Ù„ÙŠ">
    <meta name="author" content="ÙØ±ÙŠÙ‚ Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <meta property="og:description" content="Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø°ÙƒÙŠ ÙŠØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙƒ ÙˆÙŠÙ†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ù† Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://student-platform-frontend.vercel.app/ai-assistant.html">
    <meta property="og:site_name" content="Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <meta property="og:locale" content="ar_SA">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://student-platform-frontend.vercel.app/ai-assistant.html">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .chat-message { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        .message { margin-bottom: 1rem; }
        .user-message {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 0.25rem 1rem;
            margin-left: 2rem;
            text-align: right;
        }
        .ai-message {
            background: #f3f4f6;
            color: #374151;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 1rem 0.25rem;
            margin-right: 2rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button onclick="window.location.href='index.html'" class="text-gray-600 hover:text-gray-900 ml-4">
                        <i class="fas fa-arrow-right text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900 mr-4">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span id="userEmail" class="text-sm text-gray-600"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-sign-out-alt ml-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Q&A Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-comments text-blue-500 ml-3"></i>
                    Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
                </h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©:</label>
                    <select id="qaLectureSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="enableQA()">
                        <option value="">-- Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© --</option>
                    </select>
                </div>

                <div id="chatArea" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto mb-4 border">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ§Ø³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ØªØ±ÙŠØ¯</p>
                    </div>
                </div>

                <div class="flex space-x-2 space-x-reverse">
                    <input type="text" id="questionInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." 
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           disabled onkeypress="handleEnterKey(event)">
                    <button id="askBtn" onclick="sendMessage()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Quiz Section -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-clipboard-question ml-3"></i>
                        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±
                    </h2>
                    <p class="text-green-100 mt-2">Ø£Ù†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø± ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>
                </div>
                
                <div class="p-6">
                    <!-- Quiz Settings -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</label>
                            <select id="quizLectureSelect" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent h-32">
                            </select>
                            <p class="text-xs text-gray-500 mt-1">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ø¹ Ctrl</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                <select id="questionType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="multiple">Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯</option>
                                    <option value="truefalse">ØµØ­ ÙˆØ®Ø·Ø£</option>
                                    <option value="mixed">Ù…Ø®ØªÙ„Ø·</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                <select id="questionCount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="5">5 Ø£Ø³Ø¦Ù„Ø©</option>
                                    <option value="10" selected>10 Ø£Ø³Ø¦Ù„Ø©</option>
                                    <option value="15">15 Ø³Ø¤Ø§Ù„</option>
                                    <option value="20">20 Ø³Ø¤Ø§Ù„</option>
                                    <option value="25">25 Ø³Ø¤Ø§Ù„</option>
                                    <option value="30">30 Ø³Ø¤Ø§Ù„</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button id="generateQuizBtn" onclick="generateQuiz()" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-magic ml-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ÙÙˆØ±ÙŠ
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Display Area -->
        <div id="quizContainer" class="hidden mt-8">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center justify-between">
                        <span><i class="fas fa-clipboard-check ml-3"></i>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span>
                        <span id="quizTimer" class="text-purple-100"></span>
                    </h2>
                </div>
                
                <div class="p-6">
                    <div id="quizContent"></div>
                    
                    <div class="flex justify-between items-center mt-6">
                        <div class="text-sm text-gray-600">
                            Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="currentQuestion">1</span> Ù…Ù† <span id="totalQuestions">10</span>
                        </div>
                        <div class="space-x-2 space-x-reverse">
                            <button id="prevBtn" onclick="previousQuestion()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg disabled:opacity-50">
                                Ø§Ù„Ø³Ø§Ø¨Ù‚
                            </button>
                            <button id="nextBtn" onclick="nextQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                Ø§Ù„ØªØ§Ù„ÙŠ
                            </button>
                            <button id="submitQuizBtn" onclick="submitQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg hidden">
                                Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Results -->
        <div id="quizResults" class="hidden mt-8">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-trophy ml-3"></i>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </h2>
                </div>
                
                <div class="p-6" id="resultsContent">
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        // Gemini API Configuration
        // ğŸ›‘ ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø§Ø¦Ø¨ Ø¨Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­.
        // Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ø§Ù„Ø¢Ù† Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… ÙˆØ­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø§Øª Gemini.
        const GEMINI_API_KEY ="AIzaSyBp5fSEvq0yoTANjQlxpstYMmG2fT1EScs";
        
        let currentUser = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];

        /**
         * Get AI response from Google Gemini API
         * @param {string} textPrompt - User's question or prompt
         * @param {object} lectureContext - Lecture context for educational responses
         */
        async function getGeminiResponse(textPrompt, lectureContext = null) {
            // âœ… FIX: Changed model name from gemini-1.5-flash-latest to gemini-2.5-flash
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const parts = [];

                // Add context about the lecture if available
                let contextualPrompt = textPrompt;
                if (lectureContext) {
                    // Build comprehensive context from lecture data
                    let lectureContent = '';
                    if (lectureContext.full_content) {
                        lectureContent = lectureContext.full_content;
                    } else {
                        lectureContent = `Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lectureContext.title}`;
                        if (lectureContext.description) {
                            lectureContent += `\nÙˆØµÙ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lectureContext.description}`;
                        }
                        if (lectureContext.content_type) {
                            lectureContent += `\nÙ†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${lectureContext.content_type}`;
                        }
                        if (lectureContext.file_content) {
                            lectureContent += `\nÙ…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù: ${lectureContext.file_content}`;
                        }
                        if (lectureContext.notes) {
                            lectureContent += `\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: ${lectureContext.notes}`;
                        }
                    }

                    contextualPrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø°ÙƒÙŠ ÙˆÙ…ØªØ®ØµØµ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©. Ù„Ø¯ÙŠÙƒ Ù…Ø¹Ø±ÙØ© ÙˆØ§Ø³Ø¹Ø© ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ø³Ø¦Ù„ØªÙ‡Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©.

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©:
${lectureContent}

Ø³Ø¤Ø§Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨: ${textPrompt}

Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:
- Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„ÙˆØ§Ø³Ø¹Ø© Ù„ØªÙ‚Ø¯ÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø§Øª Ø´Ø§Ù…Ù„Ø© ÙˆÙ…ÙÙŠØ¯Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø©
- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…ØªØ¹Ù„Ù‚Ø§Ù‹ Ø¨Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ Ø§Ø±Ø¨Ø· Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØªØ§Ø­ ÙˆØ§Ø³ØªØ´Ù‡Ø¯ Ø¨Ø£Ø¬Ø²Ø§Ø¡ Ù…Ù†Ù‡
- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ø§Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØŒ Ù‚Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© ÙˆÙ…ÙÙŠØ¯Ø©
- Ø§Ø°ÙƒØ± Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„Ù…ÙØ§Ù‡ÙŠÙ… ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø´Ø®ØµÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
- Ù‚Ø¯Ù… Ø§Ù„Ø³ÙŠØ§Ù‚ ÙˆØ§Ù„Ø£Ø³Ø¨Ø§Ø¨ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø£Ù…Ø«Ù„Ø© Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠØ©
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙˆØ§Ø¶Ø­Ø© ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø·Ù„Ø§Ø¨
- Ù†Ø¸Ù… Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø·Ù‚ÙŠ ÙˆÙ…Ø±ØªØ¨ Ù…Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ÙÙ‚Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
- Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© ÙÙŠ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ£Ø´Ø± Ø¥Ù„Ù‰ Ø°Ù„Ùƒ
- ÙƒÙ† Ù…ÙÙŠØ¯Ø§Ù‹ ÙˆØªØ¹Ù„ÙŠÙ…ÙŠØ§Ù‹ ÙˆØªÙØ§Ø¹Ù„ÙŠØ§Ù‹ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ`;
                }

                parts.push({ text: contextualPrompt });

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
                }

                const result = await response.json();
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponse) {
                    return aiResponse;
                } else {
                    throw new Error('Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¯.');
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                // Return a user-friendly error message
                return `Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ: ${error.message}`;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Supabase
                if (window.initializeSupabase) {
                    await window.initializeSupabase();
                }
                
                // Wait for authentication
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check authentication
                const isAuthenticated = await checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                // Load user data and lectures
                await loadUserData();
                await loadLectures();
                
                console.log('âœ… AI Assistant initialized successfully');
                
            } catch (error) {
                console.error('âŒ Error initializing AI assistant:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ', 'error');
            }
        });

        // Check authentication
        async function checkAuthentication() {
            try {
                if (!window.supabaseClient || !window.supabaseAuth) {
                    return false;
                }
                
                const { data } = await window.supabaseAuth.getSession();
                if (data?.session?.user) {
                    currentUser = data.session.user;
                    localStorage.setItem('userEmail', currentUser.email);
                    localStorage.setItem('userId', currentUser.id);
                    localStorage.setItem('userName', currentUser.user_metadata?.full_name || currentUser.email.split('@')[0]);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Authentication check error:', error);
                return false;
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const userName = localStorage.getItem('userName') || currentUser?.email?.split('@')[0] || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                const userEmail = localStorage.getItem('userEmail') || currentUser?.email || '';
                document.getElementById('userEmail').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${userName}`;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load lectures for dropdown
        async function loadLectures() {
            try {
                if (!currentUser) {
                    console.warn('No current user available');
                    return;
                }

                // Load subjects from database
                const subjectsResult = await window.supabaseDB.subjects.getByUser(currentUser.id);
                if (subjectsResult.error) {
                    console.error('Error loading subjects:', subjectsResult.error);
                    return;
                }

                const subjects = subjectsResult.data || [];
                const qaLectureSelect = document.getElementById('qaLectureSelect');
                const quizLectureSelect = document.getElementById('quizLectureSelect');
                
                qaLectureSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© --</option>';
                quizLectureSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© --</option>';

                // Load lectures for each subject
                for (const subject of subjects) {
                    const lecturesResult = await window.supabaseDB.lectures.getBySubject(subject.id);
                    if (lecturesResult.data && lecturesResult.data.length > 0) {
                        const lectures = lecturesResult.data;
                        
                        lectures.forEach(lecture => {
                            // Add to Q&A dropdown
                            const qaOption = document.createElement('option');
                            qaOption.value = lecture.id;
                            qaOption.textContent = `${lecture.title} - ${subject.name}`;
                            qaOption.dataset.subjectId = subject.id;
                            qaLectureSelect.appendChild(qaOption);

                            // Add to Quiz dropdown
                            const quizOption = document.createElement('option');
                            quizOption.value = lecture.id;
                            quizOption.textContent = `${lecture.title} - ${subject.name}`;
                            quizOption.dataset.subjectId = subject.id;
                            quizLectureSelect.appendChild(quizOption);
                        });
                    }
                }

                if (qaLectureSelect.children.length === 1) {
                    qaLectureSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…ØªØ§Ø­Ø© - Ø£Ø¶Ù Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</option>';
                    quizLectureSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…ØªØ§Ø­Ø© - Ø£Ø¶Ù Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</option>';
                }

                console.log('âœ… Lectures loaded from database');

            } catch (error) {
                console.error('âŒ Error loading lectures:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª', 'error');
            }
        }

        // Enable Q&A when lecture is selected
        function enableQA() {
            const lectureId = document.getElementById('qaLectureSelect').value;
            const questionInput = document.getElementById('questionInput');
            const askBtn = document.getElementById('askBtn');
            
            if (lectureId) {
                questionInput.disabled = false;
                askBtn.disabled = false;
                
                const chatArea = document.getElementById('chatArea');
                chatArea.innerHTML = `
                    <div class="ai-message chat-message">
                        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ù„Ù‚Ø¯ Ø§Ø®ØªØ±Øª Ù…Ø­Ø§Ø¶Ø±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø·Ø±Ø­ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.</p>
                    </div>
                `;
            } else {
                questionInput.disabled = true;
                askBtn.disabled = true;
            }
        }

        // Enable quiz generation when lectures are selected
        document.getElementById('quizLectureSelect').addEventListener('change', function() {
            const selectedLectures = Array.from(this.selectedOptions);
            document.getElementById('generateQuizBtn').disabled = selectedLectures.length === 0;
        });

        // Handle Enter key for questions
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('questionInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const lectureSelect = document.getElementById('qaLectureSelect');
            if (!lectureSelect.value) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¶Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message';
            typingDiv.innerHTML = `
                <div class="ai-message">
                    <div class="flex items-center">
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="mr-2">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙƒØªØ¨...</span>
                    </div>
                </div>
            `;
            document.getElementById('chatArea').appendChild(typingDiv);
            scrollToBottom();

            try {
                const lectureId = lectureSelect.value;
                
                // Get lecture content from database including file content
                const lectureResult = await window.supabaseDB.lectures.getWithContent(lectureId);
                const lecture = lectureResult.data;
                
                if (!lecture) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©');
                }

                // Generate AI response using Gemini API with actual content
                const response = await getGeminiResponse(message, lecture);
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add AI response
                addMessage(response, 'ai');
                
            } catch (error) {
                console.error('Error generating response:', error);
                typingDiv.remove();
                addMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø¤Ø§Ù„Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'ai');
            }
        }

        // Generate quiz
        async function generateQuiz() {
            const lectureSelect = document.getElementById('quizLectureSelect');
            const selectedOptions = Array.from(lectureSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }

            try {
                // Show loading state
                const quizContainer = document.getElementById('quizContainer');
                quizContainer.classList.remove('hidden');
                quizContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-magic ml-3"></i>Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                                <p class="text-gray-600">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...</p>
                                <p class="text-sm text-gray-500 mt-2">Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù</p>
                            </div>
                        </div>
                    </div>
                `;

                // Get quiz settings
                const questionCount = parseInt(document.getElementById('questionCount').value) || 10;
                const questionType = document.getElementById('questionType').value || 'multiple';
                
                // Get lecture content from the first selected lecture
                const lectureId = selectedOptions[0].value;
                const lectureResult = await window.supabaseDB.lectures.getWithContent(lectureId);
                const lecture = lectureResult.data;
                
                if (!lecture) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©');
                }

                // Build comprehensive lecture content
                let lectureContent = '';
                if (lecture.full_content) {
                    lectureContent = lecture.full_content;
                } else {
                    lectureContent = `Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lecture.title}`;
                    if (lecture.description) {
                        lectureContent += `\nÙˆØµÙ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lecture.description}`;
                    }
                    if (lecture.content_type) {
                        lectureContent += `\nÙ†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${lecture.content_type}`;
                    }
                    if (lecture.file_content) {
                        lectureContent += `\nÙ…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù: ${lecture.file_content}`;
                    }
                    if (lecture.notes) {
                        lectureContent += `\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: ${lecture.notes}`;
                    }
                }

                // Generate quiz prompt based on question type
                let questionTypeInstructions = '';
                let exampleFormat = '';
                
                if (questionType === 'multiple') {
                    questionTypeInstructions = `Ø¥Ù†Ø´Ø§Ø¡ ${questionCount} Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ØŒ ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 4 Ø®ÙŠØ§Ø±Ø§Øª (Ø£ØŒ Ø¨ØŒ Ø¬ØŒ Ø¯)`;
                    exampleFormat = `{
      "question": "Ù…Ø§ Ù‡Ùˆ...ØŸ",
      "type": "multiple",
      "options": ["Ø£) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„", "Ø¨) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø¬) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«", "Ø¯) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹"],
      "correct": 0
    }`;
                } else if (questionType === 'truefalse') {
                    questionTypeInstructions = `Ø¥Ù†Ø´Ø§Ø¡ ${questionCount} Ø³Ø¤Ø§Ù„ ØµØ­ ÙˆØ®Ø·Ø£ØŒ ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø±ÙŠÙ†: ØµØ­ Ø£Ùˆ Ø®Ø·Ø£`;
                    exampleFormat = `{
      "question": "Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ØµØ­ÙŠØ­Ø©...",
      "type": "truefalse",
      "options": ["ØµØ­", "Ø®Ø·Ø£"],
      "correct": 0
    }`;
                } else if (questionType === 'mixed') {
                    const multipleCount = Math.ceil(questionCount * 0.6);
                    const trueFalseCount = questionCount - multipleCount;
                    questionTypeInstructions = `Ø¥Ù†Ø´Ø§Ø¡ ${multipleCount} Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ Ùˆ ${trueFalseCount} Ø³Ø¤Ø§Ù„ ØµØ­ ÙˆØ®Ø·Ø£`;
                    exampleFormat = `{
      "question": "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ",
      "type": "multiple", // Ø£Ùˆ "truefalse"
      "options": ["Ø£) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„", "Ø¨) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø¬) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«", "Ø¯) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹"], // Ø£Ùˆ ["ØµØ­", "Ø®Ø·Ø£"]
      "correct": 0
    }`;
                }
                
                const quizPrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©:
${lectureContent}

Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
- ${questionTypeInstructions}
- ÙŠØ¬Ø¨ Ø£Ù† ØªØºØ·ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¬ÙˆØ§Ù†Ø¨ Ù…Ø®ØªÙ„ÙØ© Ù…Ù† Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©
- Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø©
- ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©
- Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
- Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…ÙÙ‡ÙˆÙ…Ø© Ù„Ù„Ø·Ù„Ø§Ø¨
- ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø© Ù…Ø¹Ù‚ÙˆÙ„Ø© ÙˆÙ„ÙŠØ³Øª ÙˆØ§Ø¶Ø­Ø© Ø§Ù„Ø®Ø·Ø£

ÙŠØ±Ø¬Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø· (JSON ØµØ§Ù„Ø­ ÙÙ‚Ø·):
{
  "title": "Ø§Ø®ØªØ¨Ø§Ø±: ${lecture.title}",
  "questions": [
    ${exampleFormat}
  ]
}

ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØªÙƒÙˆÙ† JSON ØµØ§Ù„Ø­ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ JSON.`;

                const aiResponse = await getGeminiResponse(quizPrompt);
                
                // Parse AI response to extract quiz data
                let quizData;
                try {
                    // Clean the response and extract JSON
                    let cleanResponse = aiResponse.trim();
                    
                    // Remove any markdown code blocks
                    cleanResponse = cleanResponse.replace(/```json\s*/g, '').replace(/```\s*/g, '');
                    
                    // Find JSON object
                    const jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        quizData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', parseError);
                    console.log('AI Response:', aiResponse);
                    // Fallback: create a simple quiz based on lecture info
                    quizData = createFallbackQuiz(lecture, questionCount, questionType);
                }

                // Validate and fix quiz data
                if (!quizData.questions || quizData.questions.length === 0) {
                    quizData = createFallbackQuiz(lecture, questionCount, questionType);
                }

                // Ensure all questions have proper structure
                quizData.questions = quizData.questions.map((q, index) => {
                    if (!q.question || !q.options || !Array.isArray(q.options)) {
                        return {
                            question: `Ø³Ø¤Ø§Ù„ ${index + 1}: Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŸ`,
                            type: questionType === 'mixed' ? 'multiple' : questionType,
                            options: questionType === 'truefalse' ? ['ØµØ­', 'Ø®Ø·Ø£'] : 
                                    ['Ø£) Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ', 'Ø¨) Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø®ØªÙ„Ù', 'Ø¬) Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¶ÙˆØ¹', 'Ø¯) Ø¬Ù…ÙŠØ¹ Ù…Ø§ Ø³Ø¨Ù‚'],
                            correct: 0
                        };
                    }
                    
                    // Ensure correct answer index is valid
                    if (typeof q.correct !== 'number' || q.correct < 0 || q.correct >= q.options.length) {
                        q.correct = 0;
                    }
                    
                    return q;
                });

                currentQuiz = quizData;
                currentQuestionIndex = 0;
                userAnswers = new Array(currentQuiz.questions.length).fill(-1);
                
                displayQuiz();
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
            } catch (error) {
                console.error('Error generating quiz:', error);
                document.getElementById('quizContainer').innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-red-500 to-red-600 p-6">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-exclamation-triangle ml-3"></i>Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                            </h2>
                        </div>
                        <div class="p-6 text-center">
                            <div class="text-red-500 mb-4">
                                <i class="fas fa-exclamation-triangle text-4xl"></i>
                            </div>
                            <p class="text-red-600 mb-4">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
                            <button onclick="generateQuiz()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                                <i class="fas fa-redo ml-2"></i>Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                            </button>
                        </div>
                    </div>
                `;
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }

        // Create fallback quiz when AI generation fails
        function createFallbackQuiz(lecture, questionCount = 10, questionType = 'multiple') {
            const questions = [];
            
            for (let i = 0; i < questionCount; i++) {
                if (questionType === 'truefalse' || (questionType === 'mixed' && i >= Math.ceil(questionCount * 0.6))) {
                    questions.push({
                        question: `Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ØµØ­ÙŠØ­Ø©: Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "${lecture.title}" ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ÙÙŠØ¯Ø©.`,
                        type: 'truefalse',
                        options: ['ØµØ­', 'Ø®Ø·Ø£'],
                        correct: 0
                    });
                } else {
                    questions.push({
                        question: `Ù…Ø§ Ù‡Ùˆ Ø¹Ù†ÙˆØ§Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŸ`,
                        type: 'multiple',
                        options: [
                            `Ø£) ${lecture.title}`,
                            'Ø¨) Ù…Ø­Ø§Ø¶Ø±Ø© Ø£Ø®Ø±Ù‰',
                            'Ø¬) Ù„Ø§ Ø£Ø¹Ø±Ù',
                            'Ø¯) Ø¬Ù…ÙŠØ¹ Ù…Ø§ Ø³Ø¨Ù‚'
                        ],
                        correct: 0
                    });
                }
            }
            
            return {
                title: `Ø§Ø®ØªØ¨Ø§Ø±: ${lecture.title}`,
                questions: questions
            };
        }

        // Display quiz
        function displayQuiz() {
            if (!currentQuiz || !currentQuiz.questions || currentQuiz.questions.length === 0) {
                console.error('No quiz data available');
                return;
            }

            // Initialize user answers array
            // NOTE: It is better to rely on existing answers if they exist (e.g., if navigating back and forth)
            if (userAnswers.length !== currentQuiz.questions.length) {
                userAnswers = new Array(currentQuiz.questions.length).fill(-1);
            }
            
            const quizArea = document.getElementById('quizContainer');
            quizArea.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-green-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-green-800">${currentQuiz.title}</h3>
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm" id="questionCounter">
                            Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${currentQuiz.questions.length}
                        </span>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span>
                            <span class="text-sm font-medium text-green-600" id="progressPercentage">
                                ${Math.round(((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100)}%
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                            <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" 
                                 id="progressBar" style="width: ${((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>ØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ <span id="answeredCount">${userAnswers.filter(a => a !== -1).length}</span> Ù…Ù† ${currentQuiz.questions.length} Ø³Ø¤Ø§Ù„</span>
                            <span>${currentQuiz.questions.length - userAnswers.filter(a => a !== -1).length} Ø³Ø¤Ø§Ù„ Ù…ØªØ¨Ù‚ÙŠ</span>
                        </div>
                    </div>

                    <div id="questionContainer" class="mb-6">
                        ${renderQuestion(currentQuestionIndex)}
                    </div>

                    <div class="flex justify-between">
                        <button id="prevBtn" onclick="previousQuestion()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-right ml-2"></i>
                            Ø§Ù„Ø³Ø§Ø¨Ù‚
                        </button>
                        
                        <button id="nextBtn" onclick="nextQuestion()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors">
                            ${currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                                '<i class="fas fa-check ml-2"></i>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 
                                'Ø§Ù„ØªØ§Ù„ÙŠ<i class="fas fa-arrow-left mr-2"></i>'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderQuestion(index) {
            const question = currentQuiz.questions[index];
            if (!question) return '';

            let optionsHtml = '';
            question.options.forEach((option, optionIndex) => {
                const isSelected = userAnswers[index] === optionIndex;
                optionsHtml += `
                    <div class="mb-3">
                        <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200'}">
                            <input type="radio" name="question_${index}" value="${optionIndex}" 
                                   onchange="selectAnswer(${index}, ${optionIndex})" 
                                   ${isSelected ? 'checked' : ''} class="ml-3">
                            <span class="text-gray-800">${option}</span>
                        </label>
                    </div>
                `;
            });

            return `
                <div class="question-content">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}: ${question.question}</h4>
                    <div class="options-container">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }

        function selectAnswer(questionIndex, answerIndex) {
            userAnswers[questionIndex] = answerIndex;
            
            // Update progress indicators immediately
            updateQuizProgress();
            
            // Add visual feedback
            const selectedOption = document.querySelector(`input[name="question_${questionIndex}"][value="${answerIndex}"]`);
            if (selectedOption) {
                const label = selectedOption.closest('label');
                // Remove previous selections
                document.querySelectorAll(`input[name="question_${questionIndex}"]`).forEach(input => {
                    const parentLabel = input.closest('label');
                    parentLabel.classList.remove('border-green-500', 'bg-green-50');
                    parentLabel.classList.add('border-gray-200');
                });
                
                // Highlight selected option
                label.classList.remove('border-gray-200');
                label.classList.add('border-green-500', 'bg-green-50');
            }
            
            console.log('Answer selected:', questionIndex, answerIndex, 'Total answered:', userAnswers.filter(a => a !== -1).length);
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
                updateNavigationButtons();
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
                updateNavigationButtons();
            }
        }

        function updateQuizProgress() {
            const progressBar = document.getElementById('progressBar');
            const questionCounter = document.getElementById('questionCounter');
            const progressPercentage = document.getElementById('progressPercentage');
            const answeredCount = document.getElementById('answeredCount');
            
            if (!currentQuiz) return; // Guard against null quiz
            
            if (progressBar) {
                const progressPercent = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
                progressBar.style.width = `${progressPercent}%`;
            }
            
            if (questionCounter) {
                questionCounter.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${currentQuiz.questions.length}`;
            }
            
            if (progressPercentage) {
                progressPercentage.textContent = `${Math.round(((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100)}%`;
            }
            
            if (answeredCount) {
                const answered = userAnswers.filter(a => a !== -1).length;
                answeredCount.textContent = `${answered}`;
                
                // Update remaining count
                const remainingElement = answeredCount.parentElement.nextElementSibling;
                if (remainingElement) {
                    remainingElement.textContent = `${currentQuiz.questions.length - answered} Ø³Ø¤Ø§Ù„ Ù…ØªØ¨Ù‚ÙŠ`;
                }
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentQuestionIndex === 0;
            }
            
            if (nextBtn) {
                nextBtn.innerHTML = currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                    '<i class="fas fa-check ml-2"></i>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 
                    'Ø§Ù„ØªØ§Ù„ÙŠ<i class="fas fa-arrow-left mr-2"></i>';
            }
        }

        function finishQuiz() {
            const score = calculateScore();
            const percentage = Math.round((score / currentQuiz.questions.length) * 100);
            
            // Calculate grade
            let gradeColor = 'text-red-600';
            let gradeMessage = 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ';
            
            if (percentage >= 90) {
                gradeColor = 'text-green-600';
                gradeMessage = 'Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹! ';
            } else if (percentage >= 80) {
                gradeColor = 'text-green-600';
                gradeMessage = 'Ù…Ù…ØªØ§Ø²! ';
            } else if (percentage >= 70) {
                gradeColor = 'text-blue-600';
                gradeMessage = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! ';
            } else if (percentage >= 60) {
                gradeColor = 'text-yellow-600';
                gradeMessage = 'Ø¬ÙŠØ¯! ';
            } else if (percentage >= 50) {
                gradeColor = 'text-orange-600';
                gradeMessage = 'Ù…Ù‚Ø¨ÙˆÙ„ ';
            }
            
            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-blue-200 p-6 text-center">
                    <div class="mb-6">
                        <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h3>
                        <p class="text-gray-600">Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                        <div class="text-4xl font-bold text-blue-600">${percentage}%</div>
                        <div class="text-lg text-gray-700 mb-2">${score} Ù…Ù† ${currentQuiz.questions.length} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
                        <div class="text-lg font-medium ${gradeColor}">${gradeMessage}</div>
                    </div>
                    
                    <div class="flex gap-4 justify-center">
                        <button onclick="reviewAnswers()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-eye ml-2"></i>
                            Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                        </button>
                        <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-redo ml-2"></i>
                            Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            `;
        }

        function calculateScore() {
            let score = 0;
            for (let i = 0; i < currentQuiz.questions.length; i++) {
                if (userAnswers[i] === currentQuiz.questions[i].correct) {
                    score++;
                }
            }
            return score;
        }

        function reviewAnswers() {
            let reviewHtml = `
                <div class="bg-white rounded-lg border-2 border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-list-check ml-2"></i>
                            Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                        </h4>
                        <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-plus ml-1"></i>
                            Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
            `;

            currentQuiz.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = question.correct;
                const isCorrect = userAnswer === correctAnswer;
                const wasAnswered = userAnswer !== -1;

                reviewHtml += `
                    <div class="mb-6 p-4 border rounded-lg ${
                        !wasAnswered ? 'border-gray-300 bg-gray-50' :
                        isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'
                    }">
                        <div class="flex items-center mb-3">
                            <i class="fas ${
                                !wasAnswered ? 'fa-question-circle text-gray-500' :
                                isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'
                            } ml-2"></i>
                            <span class="font-semibold">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}</span>
                        </div>
                        <p class="font-medium mb-3">${question.question}</p>
                        <div class="text-sm space-y-1">
                            ${wasAnswered ? `
                                <div class="flex items-center">
                                    <span class="text-gray-600 ml-2">Ø¥Ø¬Ø§Ø¨ØªÙƒ:</span>
                                    <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${question.options[userAnswer]}</span>
                                </div>
                            ` : `
                                <div class="flex items-center">
                                    <span class="text-gray-600 ml-2">Ø¥Ø¬Ø§Ø¨ØªÙƒ:</span>
                                    <span class="text-gray-500">Ù„Ù… ØªØ¬Ø¨ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„</span>
                                </div>
                            `}
                            ${!isCorrect || !wasAnswered ? `
                                <div class="flex items-center">
                                    <span class="text-gray-600 ml-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</span>
                                    <span class="text-green-600">${question.options[correctAnswer]}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            reviewHtml += `
                </div>
            `;

            document.getElementById('quizContainer').innerHTML = reviewHtml;
        }

        // Generate new quiz
        function generateNewQuiz() {
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            
            // Reset quiz state
            currentQuiz = null;
            currentQuestionIndex = 0;
            userAnswers = [];
            
            // Reset form
            document.getElementById('quizLectureSelect').selectedIndex = 0;
            document.getElementById('generateQuizBtn').disabled = true;
            
            // Scroll to quiz generation section
            document.querySelector('.bg-gradient-to-r.from-green-500').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Add message to chat
        function addMessage(message, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message chat-message`;
            messageDiv.innerHTML = `<p>${message}</p>`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Scroll to bottom of chat area
        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white font-medium z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Logout function
        async function logout() {
            try {
                if (window.supabaseAuth) {
                    await window.supabaseAuth.signOut();
                }
                localStorage.clear();
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('âŒ Logout error:', error);
                window.location.href = 'auth.html';
            }
        }
    </script>
</body>
</html>

