<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>المساعد الذكي - منصة الطالب الذكي | مساعد تعليمي بالذكاء الاصطناعي</title>
    <meta name="description" content="استخدم المساعد الذكي المدعوم بالذكاء الاصطناعي للحصول على إجابات فورية عن أسئلتك التعليمية وإنشاء اختبارات تفاعلية من محاضراتك.">
    <meta name="keywords" content="مساعد ذكي, ذكاء اصطناعي تعليمي, اختبارات تفاعلية, أسئلة وأجوبة, مساعد طلابي, تعلم تفاعلي">
    <meta name="author" content="فريق منصة الطالب الذكي">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="المساعد الذكي - منصة الطالب الذكي">
    <meta property="og:description" content="مساعد تعليمي ذكي يجيب على أسئلتك وينشئ اختبارات تفاعلية من محاضراتك">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://student-platform-frontend.vercel.app/ai-assistant.html">
    <meta property="og:site_name" content="منصة الطالب الذكي">
    <meta property="og:locale" content="ar_SA">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://student-platform-frontend.vercel.app/ai-assistant.html">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .chat-message { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        .message { margin-bottom: 1rem; }
        .user-message {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 0.25rem 1rem;
            margin-left: 2rem;
            text-align: right;
            max-width: 85%;
            word-wrap: break-word;
        }
        .ai-message {
            background: #f3f4f6;
            color: #374151;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 1rem 0.25rem;
            margin-right: 2rem;
            max-width: 85%;
            word-wrap: break-word;
        }
        /* Custom scrollbar for chat area */
        #chatArea::-webkit-scrollbar {
            width: 8px;
        }
        #chatArea::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
        #chatArea::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button onclick="window.location.href='index.html'" class="text-gray-600 hover:text-gray-900 ml-4">
                        <i class="fas fa-arrow-right text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900 mr-4">المساعد الذكي</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span id="userEmail" class="text-sm text-gray-600"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-sign-out-alt ml-2"></i>تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Q&A Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-comments text-blue-500 ml-3"></i>
                    محادثة مع المساعد الذكي
                </h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">اختر المحاضرة:</label>
                    <select id="qaLectureSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="enableQA()">
                        <option value="">-- اختر محاضرة --</option>
                    </select>
                </div>

                <div id="chatArea" class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto mb-4 border">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p>مرحباً! اختر محاضرة واسأل أي سؤال تريد</p>
                    </div>
                </div>

                <div class="flex space-x-2 space-x-reverse">
                    <input type="text" id="questionInput" placeholder="اكتب سؤالك هنا..." 
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           disabled onkeypress="handleEnterKey(event)">
                    <button id="askBtn" onclick="sendMessage()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Quiz Section -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-clipboard-question ml-3"></i>
                        إنشاء اختبار
                    </h2>
                    <p class="text-green-100 mt-2">أنشئ اختبار فوري من المحاضرات</p>
                </div>
                
                <div class="p-6">
                    <!-- Quiz Settings -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اختر المحاضرات</label>
                            <select id="quizLectureSelect" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent h-32">
                            </select>
                            <p class="text-xs text-gray-500 mt-1">يمكنك اختيار عدة محاضرات بالضغط مع Ctrl</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">نوع الأسئلة</label>
                                <select id="questionType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="multiple">اختيار متعدد</option>
                                    <option value="truefalse">صح وخطأ</option>
                                    <option value="mixed">مختلط</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">عدد الأسئلة</label>
                                <select id="questionCount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="5">5 أسئلة</option>
                                    <option value="10" selected>10 أسئلة</option>
                                    <option value="15">15 سؤال</option>
                                    <option value="20">20 سؤال</option>
                                    <option value="25">25 سؤال</option>
                                    <option value="30">30 سؤال</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button id="generateQuizBtn" onclick="generateQuiz()" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-magic ml-2"></i>إنشاء اختبار فوري
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Display Area -->
        <div id="quizContainer" class="hidden mt-8">
            <!-- Quiz content will be injected here -->
        </div>

        <!-- Quiz Results -->
        <div id="quizResults" class="hidden mt-8">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-trophy ml-3"></i>نتائج الاختبار
                    </h2>
                </div>
                
                <div class="p-6" id="resultsContent">
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        // Gemini API Configuration
        // تأكد من أن هذا المفتاح صحيح لضمان عمل النموذج 'الحقيقي'
        const GEMINI_API_KEY ="AIzaSyB8p4Vh8TmQplHOMrKaGwProWRLn5Dn2uc";
        
        let currentUser = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];

        /**
         * Get AI text response from Gemini API for Q&A, grounded in lecture context.
         * @param {string} textPrompt - User's question or prompt
         * @param {object} lectureContext - Lecture context for educational responses
         * @returns {Promise<string>} The generated text response.
         */
        async function getGeminiQaResponse(textPrompt, lectureContext) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            // Build comprehensive context from lecture data
            let lectureContent = '';
            // Prioritize the dedicated full content if available
            if (lectureContext.full_content) {
                lectureContent = lectureContext.full_content;
            } else {
                // Fallback compilation if full_content is missing
                lectureContent = `عنوان المحاضرة: ${lectureContext.title}\n`;
                if (lectureContext.description) lectureContent += `وصف المحاضرة: ${lectureContext.description}\n`;
                if (lectureContext.file_content) lectureContent += `محتوى الملف: ${lectureContext.file_content}\n`;
                // Add any available URL so the model knows the source when no extracted text exists
                const urlField = lectureContext.file_url || lectureContext.content_url || lectureContext.url || lectureContext.attachment_url || lectureContext.download_url || '';
                if (urlField) lectureContent += `رابط الملف: ${urlField}\n`;
                if (lectureContext.notes) lectureContent += `ملاحظات إضافية: ${lectureContext.notes}\n`;
            }

            // Determine content strength
            const contentWeak = !lectureContext.full_content && (!lectureContext.file_content || String(lectureContext.file_content).trim().length < 80);

            // System Instruction (Persona and Rules) - **Updated: added rule 4 to suppress lecture type/title**
            const systemInstructionText = contentWeak
                ? `أنت **خبير أكاديمي**. الإجابة يجب أن تكون باللغة العربية الفصحى وبنمط واضح.

                قواعد:
                1) إن كان محتوى المحاضرة المتاح محدوداً، صِف ذلك أولاً بجملة قصيرة مثل: "بالاعتماد على المعلومات المتاحة (عنوان/وصف)، سيتم تقديم إجابة عامة".
                2) بعد ذلك قدّم إجابة تعليمية عامة دقيقة ومرتبة وفق أفضل الممارسات الأكاديمية (عناوين، قوائم).
                3) لا تذكر مصادر خارجية صراحة؛ اجعل الإجابة مفهومة ومباشرة للطالب.
                4) إذا كانت هناك نقاط تحتاج معلومات إضافية، وضّح ما يلزم بالضبط.`
                : `أنت **خبير أكاديمي ومتخصص في تحليل المحاضرات**. مهمتك هي الإجابة على سؤال الطالب بأقصى دقة، ويجب أن تكون إجابتك **مؤسسة بالكامل** على محتوى المحاضرة المقدم.
                
                قواعد الإجابة:
                1) استخدم محتوى المحاضرة فقط ولا تخمن.
                2) اجعل اللغة عربية فصحى احترافية ومنسقة.
                3) إن لم تجد المعلومة داخل النص، اذكر ذلك بصراحة.`;

            // User Query Content
            const userContentParts = [
                {
                    text: `محتوى المحاضرة المتاح الذي يجب عليك الاعتماد عليه:
======================================
${lectureContent}
======================================`
                },
                {
                    text: `سؤال الطالب: ${textPrompt}`
                }
            ];

            const payload = {
                contents: [{ parts: userContentParts }],
                systemInstruction: { parts: [{ text: systemInstructionText }] },
            };

            try {
                // Implementing simple retry mechanism for robustness
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    if (i < MAX_RETRIES - 1) {
                        console.warn(`Retry attempt ${i + 1} for Gemini Q&A due to status ${response.status}`);
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Exponential backoff
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `خطأ في الخادم: ${response.status}`);
                    }
                }

                const result = await response.json();
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponse) {
                    // If content was weak, show a gentle notice once
                    try {
                        if (contentWeak) {
                            showNotification('تنبيه: لا يوجد نص للمحاضرة، تم تقديم إجابة عامة بناءً على العنوان/الوصف.', 'info');
                        }
                    } catch (_) {}
                    return aiResponse;
                } else {
                    throw new Error('لم يتمكن الذكاء الاصطناعي من إنشاء رد (قد يكون المحتوى غير كافٍ للإجابة).');
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                // Return a user-friendly error message
                return `عذراً، حدث خطأ في الاتصال بالذكاء الاصطناعي أو انتهت مهلة الرد: ${error.message}. يرجى المحاولة بسؤال آخر أو اختيار محاضرة مختلفة.`;
            }
        }

        /**
         * Get AI structured JSON response for Quiz generation.
         */
        async function getGeminiQuiz(lectureContent, questionCount, questionType) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            // Define the JSON schema for the quiz structure (ensures 100% valid JSON output)
            const quizSchema = {
                type: "OBJECT",
                properties: {
                    title: { type: "STRING", description: "عنوان جذاب ومناسب للاختبار." },
                    questions: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                question: { type: "STRING", description: "نص السؤال." },
                                type: { type: "STRING", description: "نوع السؤال: 'multiple' أو 'truefalse'." },
                                options: { 
                                    type: "ARRAY", 
                                    items: { type: "STRING" },
                                    description: "قائمة بالخيارات (مثلاً: أ) الخيار الأول، ب) الخيار الثاني، ج) الخيار الثالث، د) الخيار الرابع) أو (صح، خطأ)."
                                },
                                correct: { type: "INTEGER", description: "مؤشر الإجابة الصحيحة في قائمة الخيارات (0، 1، 2، 3 أو 0، 1)." }
                            },
                            required: ["question", "type", "options", "correct"]
                        }
                    }
                },
                required: ["title", "questions"]
            };

            let questionTypeInstructions = '';
            if (questionType === 'multiple') {
                questionTypeInstructions = `أنشئ ${questionCount} سؤال اختيار من متعدد (multiple) بـ 4 خيارات لكل سؤال.`;
            } else if (questionType === 'truefalse') {
                questionTypeInstructions = `أنشئ ${questionCount} سؤال صح وخطأ (truefalse) بخيارين (صح أو خطأ) لكل سؤال.`;
            } else if (questionType === 'mixed') {
                const multipleCount = Math.ceil(questionCount * 0.6);
                const trueFalseCount = questionCount - multipleCount;
                questionTypeInstructions = `أنشئ ${multipleCount} سؤال اختيار من متعدد (multiple) و ${trueFalseCount} سؤال صح وخطأ (truefalse).`;
            }

            const quizPrompt = `أنت خبير في إنشاء اختبارات تعليمية. مهمتك هي إنشاء اختبار تعليمي باللغة العربية حصراً بناءً على محتوى المحاضرة المقدم.

            **التعليمات:**
            - **المحتوى**: يجب أن تكون جميع الأسئلة والإجابات الصحيحة مستمدة **فقط** من محتوى المحاضرة المرفق أدناه.
            - **العدد والنوع**: ${questionTypeInstructions}
            - **التنسيق**: يجب أن يكون الإخراج بصيغة JSON صالح يتبع المخطط المحدد، ولا يجب أن يحتوي على أي نص إضافي قبل أو بعد الـ JSON.

            محتوى المحاضرة:
            ======================================
            ${lectureContent}
            ======================================`;

            const payload = {
                contents: [{ parts: [{ text: quizPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: quizSchema
                }
            };

            try {
                // Implementing simple retry mechanism for robustness
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    if (i < MAX_RETRIES - 1) {
                        console.warn(`Retry attempt ${i + 1} for Gemini Quiz due to status ${response.status}`);
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Exponential backoff
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `خطأ في الخادم: ${response.status}`);
                    }
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    return JSON.parse(jsonText);
                } else {
                    throw new Error('لم يتمكن الذكاء الاصطناعي من إنشاء JSON صالح أو كانت الاستجابة فارغة.');
                }
            } catch (error) {
                console.error("Gemini API Error (Quiz):", error);
                throw new Error(`فشل الاتصال بـ Gemini أو تحليل الاستجابة: ${error.message}`);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Supabase
                if (window.initializeSupabase) {
                    await window.initializeSupabase();
                }
                
                // Wait for authentication
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check authentication
                const isAuthenticated = await checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                // Load user data and lectures
                await loadUserData();
                await loadLectures();
                
                console.log('✅ AI Assistant initialized successfully');
                
            } catch (error) {
                console.error('❌ Error initializing AI assistant:', error);
                showNotification('حدث خطأ في تحميل المساعد الذكي', 'error');
            }
        });

        // Check authentication
        async function checkAuthentication() {
            try {
                if (!window.supabaseClient || !window.supabaseAuth) {
                    return false;
                }
                
                const { data } = await window.supabaseAuth.getSession();
                if (data?.session?.user) {
                    currentUser = data.session.user;
                    localStorage.setItem('userEmail', currentUser.email);
                    localStorage.setItem('userId', currentUser.id);
                    localStorage.setItem('userName', currentUser.user_metadata?.full_name || currentUser.email.split('@')[0]);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Authentication check error:', error);
                return false;
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const userName = localStorage.getItem('userName') || currentUser?.email?.split('@')[0] || 'المستخدم';
                // const userEmail = localStorage.getItem('userEmail') || currentUser?.email || ''; // Unused variable
                document.getElementById('userEmail').textContent = `مرحباً، ${userName}`;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load lectures for dropdown
        async function loadLectures() {
            try {
                if (!currentUser) {
                    console.warn('No current user available');
                    return;
                }

                // Load subjects from database
                const subjectsResult = await window.supabaseDB.subjects.getByUser(currentUser.id);
                if (subjectsResult.error) {
                    console.error('Error loading subjects:', subjectsResult.error);
                    return;
                }

                const subjects = subjectsResult.data || [];
                const qaLectureSelect = document.getElementById('qaLectureSelect');
                const quizLectureSelect = document.getElementById('quizLectureSelect');
                
                qaLectureSelect.innerHTML = '<option value="">-- اختر محاضرة --</option>';
                quizLectureSelect.innerHTML = ''; // Keep quiz empty until data is loaded

                // Load lectures for each subject
                let hasLectures = false;
                for (const subject of subjects) {
                    const lecturesResult = await window.supabaseDB.lectures.getBySubject(subject.id);
                    if (lecturesResult.data && lecturesResult.data.length > 0) {
                        hasLectures = true;
                        lecturesResult.data.forEach(lecture => {
                            const lectureTitle = `${lecture.title} - ${subject.name}`;

                            // Add to Q&A dropdown
                            const qaOption = document.createElement('option');
                            qaOption.value = lecture.id;
                            qaOption.textContent = lectureTitle;
                            qaLectureSelect.appendChild(qaOption);

                            // Add to Quiz dropdown
                            const quizOption = document.createElement('option');
                            quizOption.value = lecture.id;
                            quizOption.textContent = lectureTitle;
                            quizLectureSelect.appendChild(quizOption);
                        });
                    }
                }

                if (!hasLectures) {
                    const noLectureText = '<option value="" disabled>لا توجد محاضرات متاحة - أضف محاضرات</option>';
                    qaLectureSelect.innerHTML = noLectureText;
                    quizLectureSelect.innerHTML = noLectureText;
                } else {
                     // Add a default selection prompt for quiz selection if needed
                     // Not necessary for multi-select, but helpful for single select Q&A
                }

                console.log('✅ Lectures loaded from database');

            } catch (error) {
                console.error('❌ Error loading lectures:', error);
                showNotification('حدث خطأ في تحميل المحاضرات', 'error');
            }
        }

        // Enable Q&A when lecture is selected
        function enableQA() {
            const lectureId = document.getElementById('qaLectureSelect').value;
            const questionInput = document.getElementById('questionInput');
            const askBtn = document.getElementById('askBtn');
            const chatArea = document.getElementById('chatArea');
            
            if (lectureId) {
                questionInput.disabled = false;
                askBtn.disabled = false;
                
                chatArea.innerHTML = `
                    <div class="ai-message chat-message">
                        <p>مرحباً! لقد اخترت محاضرة. يمكنك الآن طرح أي سؤال عن محتوى هذه المحاضرة.</p>
                    </div>
                `;
            } else {
                questionInput.disabled = true;
                askBtn.disabled = true;
                chatArea.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p>مرحباً! اختر محاضرة واسأل أي سؤال تريد</p>
                    </div>
                `;
            }
            scrollToBottom();
        }

        // Enable quiz generation when lectures are selected
        document.getElementById('quizLectureSelect').addEventListener('change', function() {
            const selectedLectures = Array.from(this.selectedOptions);
            document.getElementById('generateQuizBtn').disabled = selectedLectures.length === 0;
        });

        // Handle Enter key for questions
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('questionInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const lectureSelect = document.getElementById('qaLectureSelect');
            if (!lectureSelect.value) {
                showNotification('يرجى اختيار محاضرة أولاً', 'error');
                return;
            }

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message typing-indicator-wrapper';
            typingDiv.innerHTML = `
                <div class="ai-message">
                    <div class="flex items-center">
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="mr-2">المساعد يكتب...</span>
                    </div>
                </div>
            `;
            document.getElementById('chatArea').appendChild(typingDiv);
            scrollToBottom();

            try {
                const lectureId = lectureSelect.value;
                
                // Get lecture content from database including file content
                const lectureResult = await window.supabaseDB.lectures.getWithContent(lectureId);
                const lecture = lectureResult.data;
                
                if (!lecture) {
                    throw new Error('لم يتم العثور على المحاضرة');
                }

                // Generate AI response using the updated grounded function
                const response = await getGeminiQaResponse(message, lecture);
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add AI response
                addMessage(response, 'ai');
                
            } catch (error) {
                console.error('Error generating response:', error);
                typingDiv.remove();
                addMessage('عذراً، حدث خطأ في معالجة سؤالك. يرجى المحاولة مرة أخرى.', 'ai');
            }
        }

        // Generate quiz
        async function generateQuiz() {
            const lectureSelect = document.getElementById('quizLectureSelect');
            const selectedOptions = Array.from(lectureSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                showNotification('يرجى اختيار محاضرة واحدة على الأقل', 'error');
                return;
            }

            const generateQuizBtn = document.getElementById('generateQuizBtn');
            const originalBtnText = generateQuizBtn.innerHTML;
            generateQuizBtn.disabled = true;
            generateQuizBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';

            try {
                // Show loading state
                const quizContainer = document.getElementById('quizContainer');
                quizContainer.classList.remove('hidden');
                quizContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-magic ml-3"></i>جاري إنشاء الاختبار
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                                <p class="text-gray-600">جاري إنشاء الاختبار بواسطة الذكاء الاصطناعي...</p>
                                <p class="text-sm text-gray-500 mt-2">قد يستغرق هذا بضع ثوانٍ</p>
                            </div>
                        </div>
                    </div>
                `;

                // Get quiz settings
                const questionCount = parseInt(document.getElementById('questionCount').value) || 10;
                const questionType = document.getElementById('questionType').value || 'multiple';
                
                // Use content from the first selected lecture for simplicity in prompting
                const lectureId = selectedOptions[0].value;
                const lectureResult = await window.supabaseDB.lectures.getWithContent(lectureId);
                const lecture = lectureResult.data;
                
                if (!lecture) {
                    throw new Error('لم يتم العثور على المحاضرة');
                }

                // Build comprehensive lecture content for prompting
                let lectureContent = '';
                if (lecture.full_content) {
                    lectureContent = lecture.full_content;
                } else {
                    lectureContent = `عنوان المحاضرة: ${lecture.title}\n`;
                    if (lecture.description) lectureContent += `وصف المحاضرة: ${lecture.description}\n`;
                    if (lecture.file_content) lectureContent += `محتوى الملف: ${lecture.file_content}\n`;
                    if (lecture.notes) lectureContent += `ملاحظات إضافية: ${lecture.notes}\n`;
                }

                // Generate quiz data using the structured response function
                const quizData = await getGeminiQuiz(lectureContent, questionCount, questionType);
                
                // Reset button state
                generateQuizBtn.innerHTML = originalBtnText;
                generateQuizBtn.disabled = false;

                // Validation (minimal check before display)
                if (!quizData || !quizData.questions || quizData.questions.length === 0) {
                    throw new Error('الاستجابة كانت فارغة أو غير مكتملة. ربما المحتوى كان قصيراً جداً.');
                }

                currentQuiz = quizData;
                currentQuestionIndex = 0;
                userAnswers = new Array(currentQuiz.questions.length).fill(-1);
                
                displayQuiz();
                showNotification('تم إنشاء الاختبار بنجاح!', 'success');
                
            } catch (error) {
                console.error('Error generating quiz:', error);
                
                // Reset button state
                generateQuizBtn.innerHTML = originalBtnText;
                generateQuizBtn.disabled = Array.from(lectureSelect.selectedOptions).length === 0;

                document.getElementById('quizContainer').innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-red-500 to-red-600 p-6">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-exclamation-triangle ml-3"></i>خطأ في إنشاء الاختبار
                            </h2>
                        </div>
                        <div class="p-6 text-center">
                            <div class="text-red-500 mb-4">
                                <i class="fas fa-exclamation-triangle text-4xl"></i>
                            </div>
                            <p class="text-red-600 mb-4">${error.message || 'حدث خطأ غير متوقع في إنشاء الاختبار'}</p>
                            <button onclick="generateQuiz()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                                <i class="fas fa-redo ml-2"></i>المحاولة مرة أخرى
                            </button>
                        </div>
                    </div>
                `;
                showNotification('حدث خطأ في إنشاء الاختبار', 'error');
            }
        }

        // Display quiz
        function displayQuiz() {
            if (!currentQuiz || !currentQuiz.questions || currentQuiz.questions.length === 0) {
                console.error('No quiz data available');
                return;
            }

            // Initialize user answers array
            if (userAnswers.length !== currentQuiz.questions.length) {
                userAnswers = new Array(currentQuiz.questions.length).fill(-1);
            }
            
            const quizArea = document.getElementById('quizContainer');
            quizArea.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-green-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-green-800">${currentQuiz.title || 'الاختبار الجديد'}</h3>
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm" id="questionCounter">
                            السؤال ${currentQuestionIndex + 1} من ${currentQuiz.questions.length}
                        </span>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">التقدم في الاختبار</span>
                            <span class="text-sm font-medium text-green-600" id="progressPercentage">
                                ${Math.round(((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100)}%
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                            <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" 
                                 id="progressBar" style="width: ${((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>تم الإجابة على <span id="answeredCount">${userAnswers.filter(a => a !== -1).length}</span> من ${currentQuiz.questions.length} سؤال</span>
                            <span>${currentQuiz.questions.length - userAnswers.filter(a => a !== -1).length} سؤال متبقي</span>
                        </div>
                    </div>

                    <div id="questionContainer" class="mb-6">
                        ${renderQuestion(currentQuestionIndex)}
                    </div>

                    <div class="flex justify-between flex-wrap gap-3">
                        <button id="prevBtn" onclick="previousQuestion()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-right ml-2"></i>
                            السابق
                        </button>
                        
                        <button id="nextBtn" onclick="nextQuestion()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors flex-1 min-w-[120px]">
                            ${currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                                '<i class="fas fa-check ml-2"></i>إنهاء الاختبار' : 
                                'التالي<i class="fas fa-arrow-left mr-2"></i>'}
                        </button>
                    </div>
                </div>
            `;
            // Scroll to quiz section
            quizArea.scrollIntoView({ behavior: 'smooth' });
        }

        function renderQuestion(index) {
            const question = currentQuiz.questions[index];
            if (!question) return '';

            let optionsHtml = '';
            question.options.forEach((option, optionIndex) => {
                const isSelected = userAnswers[index] === optionIndex;
                optionsHtml += `
                    <div class="mb-3">
                        <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200'}">
                            <input type="radio" name="question_${index}" value="${optionIndex}" 
                                   onchange="selectAnswer(${index}, ${optionIndex})" 
                                   ${isSelected ? 'checked' : ''} class="ml-3">
                            <span class="text-gray-800">${option}</span>
                        </label>
                    </div>
                `;
            });

            return `
                <div class="question-content">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">السؤال ${index + 1}: ${question.question}</h4>
                    <div class="options-container">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }

        function selectAnswer(questionIndex, answerIndex) {
            userAnswers[questionIndex] = answerIndex;
            
            // Update progress indicators immediately
            updateQuizProgress();
            
            // Add visual feedback
            const selectedOption = document.querySelector(`input[name="question_${questionIndex}"][value="${answerIndex}"]`);
            if (selectedOption) {
                const label = selectedOption.closest('label');
                // Remove previous selections
                document.querySelectorAll(`input[name="question_${questionIndex}"]`).forEach(input => {
                    const parentLabel = input.closest('label');
                    parentLabel.classList.remove('border-green-500', 'bg-green-50');
                    parentLabel.classList.add('border-gray-200');
                });
                
                // Highlight selected option
                label.classList.remove('border-gray-200');
                label.classList.add('border-green-500', 'bg-green-50');
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
                updateNavigationButtons();
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
                updateNavigationButtons();
            }
        }

        function updateQuizProgress() {
            const progressBar = document.getElementById('progressBar');
            const questionCounter = document.getElementById('questionCounter');
            const progressPercentage = document.getElementById('progressPercentage');
            const answeredCount = document.getElementById('answeredCount');
            
            if (!currentQuiz) return; // Guard against null quiz
            
            if (progressBar) {
                const progressPercent = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
                progressBar.style.width = `${progressPercent}%`;
            }
            
            if (questionCounter) {
                questionCounter.textContent = `السؤال ${currentQuestionIndex + 1} من ${currentQuiz.questions.length}`;
            }
            
            if (progressPercentage) {
                progressPercentage.textContent = `${Math.round(((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100)}%`;
            }
            
            if (answeredCount) {
                const answered = userAnswers.filter(a => a !== -1).length;
                answeredCount.textContent = `${answered}`;
                
                // Update remaining count
                const remainingElement = answeredCount.parentElement.nextElementSibling;
                if (remainingElement) {
                    remainingElement.textContent = `${currentQuiz.questions.length - answered} سؤال متبقي`;
                }
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentQuestionIndex === 0;
            }
            
            if (nextBtn) {
                nextBtn.innerHTML = currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                    '<i class="fas fa-check ml-2"></i>إنهاء الاختبار' : 
                    'التالي<i class="fas fa-arrow-left mr-2"></i>';
            }
        }

        function finishQuiz() {
            const score = calculateScore();
            const percentage = Math.round((score / currentQuiz.questions.length) * 100);
            
            // Calculate grade
            let gradeColor = 'text-red-600';
            let gradeMessage = 'يحتاج تحسين ';
            
            if (percentage >= 90) {
                gradeColor = 'text-green-600';
                gradeMessage = 'ممتاز جداً! ';
            } else if (percentage >= 80) {
                gradeColor = 'text-green-600';
                gradeMessage = 'ممتاز! ';
            } else if (percentage >= 70) {
                gradeColor = 'text-blue-600';
                gradeMessage = 'جيد جداً! ';
            } else if (percentage >= 60) {
                gradeColor = 'text-yellow-600';
                gradeMessage = 'جيد! ';
            } else if (percentage >= 50) {
                gradeColor = 'text-orange-600';
                gradeMessage = 'مقبول ';
            }
            
            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-blue-200 p-6 text-center">
                    <div class="mb-6">
                        <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">انتهى الاختبار!</h3>
                        <p class="text-gray-600">لقد أكملت الاختبار بنجاح</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                        <div class="text-4xl font-bold text-blue-600">${percentage}%</div>
                        <div class="text-lg text-gray-700 mb-2">${score} من ${currentQuiz.questions.length} إجابة صحيحة</div>
                        <div class="text-lg font-medium ${gradeColor}">${gradeMessage}</div>
                    </div>
                    
                    <div class="flex gap-4 justify-center flex-wrap">
                        <button onclick="reviewAnswers()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-eye ml-2"></i>
                            مراجعة الإجابات
                        </button>
                        <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-redo ml-2"></i>
                            اختبار جديد
                        </button>
                    </div>
                </div>
            `;
            quizContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function calculateScore() {
            let score = 0;
            for (let i = 0; i < currentQuiz.questions.length; i++) {
                if (userAnswers[i] === currentQuiz.questions[i].correct) {
                    score++;
                }
            }
            return score;
        }

        function reviewAnswers() {
            let reviewHtml = `
                <div class="bg-white rounded-lg border-2 border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6 flex-wrap gap-2">
                        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-list-check ml-2"></i>
                            مراجعة الإجابات
                        </h4>
                        <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-plus ml-1"></i>
                            اختبار جديد
                        </button>
                    </div>
            `;

            currentQuiz.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = question.correct;
                const isCorrect = userAnswer === correctAnswer;
                const wasAnswered = userAnswer !== -1;

                // Ensure options are safe
                const correctOptionText = question.options[correctAnswer] || 'غير متاح';
                const userAnswerText = wasAnswered ? (question.options[userAnswer] || 'غير متاح') : 'لم تجب على هذا السؤال';

                reviewHtml += `
                    <div class="mb-6 p-4 border rounded-lg ${
                        !wasAnswered ? 'border-gray-300 bg-gray-50' :
                        isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'
                    }">
                        <div class="flex items-center mb-3">
                            <i class="fas ${
                                !wasAnswered ? 'fa-question-circle text-gray-500' :
                                isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'
                            } ml-2"></i>
                            <span class="font-semibold">السؤال ${index + 1}</span>
                        </div>
                        <p class="font-medium mb-3">${question.question}</p>
                        <div class="text-sm space-y-2 border-t pt-3">
                            <div class="flex items-start">
                                <span class="text-gray-600 ml-2 min-w-[70px]">إجابتك:</span>
                                <span class="${wasAnswered && isCorrect ? 'text-green-600 font-medium' : wasAnswered ? 'text-red-600 line-through' : 'text-gray-500 italic'}">${userAnswerText}</span>
                            </div>
                            
                            ${!isCorrect || !wasAnswered ? `
                                <div class="flex items-start">
                                    <span class="text-gray-600 ml-2 min-w-[70px]">الصحيحة:</span>
                                    <span class="text-green-600 font-medium">${correctOptionText}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            reviewHtml += `
                </div>
            `;

            document.getElementById('quizContainer').innerHTML = reviewHtml;
            document.getElementById('quizContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Generate new quiz
        function generateNewQuiz() {
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            
            // Reset quiz state
            currentQuiz = null;
            currentQuestionIndex = 0;
            userAnswers = [];
            
            // Scroll to quiz generation section
            document.querySelector('.bg-gradient-to-r.from-green-500').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Add message to chat
        function addMessage(message, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message`;
            
            // Create inner content with correct class
            const innerDiv = document.createElement('div');
            innerDiv.className = `${sender}-message chat-message`;
            
            // Apply line breaks for formatting
            innerDiv.innerHTML = `<p>${message.replace(/\n/g, '<br>')}</p>`;
            
            messageDiv.appendChild(innerDiv);
            chatArea.appendChild(messageDiv);
            
            // Remove any old typing indicators if they somehow persisted
            document.querySelectorAll('.typing-indicator-wrapper').forEach(el => el.remove());
            
            scrollToBottom();
        }

        // Scroll to bottom of chat area
        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white font-medium z-50 transition-all duration-300 transform translate-x-0 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animation for removal
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                notification.classList.remove('translate-x-0');
            }, 2500);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Logout function
        async function logout() {
            try {
                if (window.supabaseAuth) {
                    await window.supabaseAuth.signOut();
                }
                localStorage.clear();
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('❌ Logout error:', error);
                window.location.href = 'auth.html';
            }
        }
    </script>
</body>
</html>
