<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>المساعد الذكي - منصة الطالب الذكي | مساعد تعليمي بالذكاء الاصطناعي</title>
    <meta name="description" content="استخدم المساعد الذكي المدعوم بالذكاء الاصطناعي للحصول على إجابات فورية عن أسئلتك التعليمية وإنشاء اختبارات تفاعلية من محاضراتك.">
    <meta name="keywords" content="مساعد ذكي, ذكاء اصطناعي تعليمي, اختبارات تفاعلية, أسئلة وأجوبة, مساعد طلابي, تعلم تفاعلي">
    <meta name="author" content="فريق منصة الطالب الذكي">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="المساعد الذكي - منصة الطالب الذكي">
    <meta property="og:description" content="مساعد تعليمي ذكي يجيب على أسئلتك وينشئ اختبارات تفاعلية من محاضراتك">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://student-platform-frontend.vercel.app/ai-assistant.html">
    <meta property="og:site_name" content="منصة الطالب الذكي">
    <meta property="og:locale" content="ar_SA">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://student-platform-frontend.vercel.app/ai-assistant.html">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .chat-message { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        .message { margin-bottom: 1rem; }
        .user-message {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 0.25rem 1rem;
            margin-left: auto; /* Aligns to the right */
            text-align: right;
            max-width: 85%;
            word-wrap: break-word;
        }
        .ai-message {
            background: #f3f4f6;
            color: #374151;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 1rem 0.25rem;
            margin-right: auto; /* Aligns to the left */
            max-width: 85%;
            word-wrap: break-word;
        }
        /* Custom scrollbar for chat area */
        #chatArea::-webkit-scrollbar {
            width: 8px;
        }
        #chatArea::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
        #chatArea::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }
        /* RTL adjustments */
        .space-x-reverse > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button onclick="window.location.href='index.html'" class="text-gray-600 hover:text-gray-900 ml-4">
                        <i class="fas fa-arrow-right text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900 mr-4">المساعد الذكي</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span id="userEmail" class="text-sm text-gray-600"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-sign-out-alt ml-2"></i>تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Q&A Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-comments text-blue-500 ml-3"></i>
                    محادثة مع المساعد الذكي
                </h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">اختر المحاضرة:</label>
                    <select id="qaLectureSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="enableQA()">
                        <option value="">-- اختر محاضرة --</option>
                    </select>
                </div>

                <div id="chatArea" class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto mb-4 border">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p>مرحباً! اختر محاضرة واسأل أي سؤال تريد</p>
                    </div>
                </div>

                <div class="flex space-x-2 space-x-reverse">
                    <input type="text" id="questionInput" placeholder="اكتب سؤالك هنا..." 
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           disabled onkeypress="handleEnterKey(event)">
                    <button id="askBtn" onclick="sendMessage()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Quiz Section -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-clipboard-question ml-3"></i>
                        إنشاء اختبار
                    </h2>
                    <p class="text-green-100 mt-2">أنشئ اختبار فوري من المحاضرات</p>
                </div>
                
                <div class="p-6">
                    <!-- Quiz Settings -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اختر المحاضرات</label>
                            <select id="quizLectureSelect" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent h-32">
                            </select>
                            <p class="text-xs text-gray-500 mt-1">يمكنك اختيار عدة محاضرات بالضغط مع Ctrl</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">نوع الأسئلة</label>
                                <select id="questionType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="multiple">اختيار متعدد</option>
                                    <option value="truefalse">صح وخطأ</option>
                                    <option value="mixed">مختلط</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">عدد الأسئلة</label>
                                <select id="questionCount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="5">5 أسئلة</option>
                                    <option value="10" selected>10 أسئلة</option>
                                    <option value="15">15 سؤال</option>
                                    <option value="20">20 سؤال</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button id="generateQuizBtn" onclick="generateQuiz()" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-magic ml-2"></i>إنشاء اختبار فوري
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Display Area -->
        <div id="quizContainer" class="hidden mt-8">
            <!-- Quiz content will be injected here -->
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        // ===================================================================================
        // !! تنبيه أمان هام جداً !!
        // ===================================================================================
        // لا تضع مفتاح API الخاص بك هنا في نسخة الإنتاج (Production).
        // أي شخص يمكنه رؤيته وسرقته. هذا المفتاح مخصص للتجربة المحلية فقط.
        // الحل الصحيح: قم بإنشاء واجهة خلفية (Backend) مثل Supabase Edge Function
        // لتتعامل مع طلبات Gemini API بشكل آمن.
        // ===================================================================================
        const GEMINI_API_KEY = "ادخل-مفتاح-GEMINI-الخاص-بك-هنا";

        // --- المتغيرات العامة ---
        let currentUser = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];

        /**
         * Checks if the Gemini API key has been set by the developer.
         * @returns {boolean} True if the key is set, false otherwise.
         */
        function isApiKeySet() {
            if (GEMINI_API_KEY === "ادخل-مفتاح-GEMINI-الخاص-بك-هنا" || !GEMINI_API_KEY) {
                showNotification('خطأ: مفتاح Gemini API غير مهيأ في الكود.', 'error');
                return false;
            }
            return true;
        }

        /**
         * Fetches a response from the Gemini API with retry logic.
         * @param {object} payload - The payload to send to the Gemini API.
         * @returns {Promise<object>} The JSON response from the API.
         */
        async function fetchGeminiWithRetry(payload) {
            // Updated to a more recent model
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            const MAX_RETRIES = 3;

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }

                    // Handle specific, common errors
                    const errorData = await response.json();
                    if (response.status === 400) {
                         throw new Error(`خطأ في الطلب: ${errorData.error?.message || 'تأكد من صحة البيانات المرسلة.'}`);
                    }
                     if (response.status === 429) {
                        throw new Error('تم تجاوز حد الطلبات. يرجى الانتظار والمحاولة مرة أخرى.');
                    }
                    if (attempt < MAX_RETRIES - 1) {
                        console.warn(`Attempt ${attempt + 1} failed with status ${response.status}. Retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt))); // Exponential backoff
                    } else {
                        throw new Error(errorData.error?.message || `خطأ في الخادم: ${response.status}`);
                    }
                } catch (error) {
                    // Rethrow caught errors to be handled by the calling function
                    if (attempt >= MAX_RETRIES - 1) throw error;
                    console.error(`Fetch error on attempt ${attempt + 1}:`, error);
                }
            }
        }
        
        /**
         * Get AI text response from Gemini API for Q&A, grounded in lecture context.
         * @param {string} textPrompt - User's question or prompt
         * @param {object} lectureContext - Lecture context for educational responses
         * @returns {Promise<string>} The generated text response.
         */
        async function getGeminiQaResponse(textPrompt, lectureContext) {
            let lectureContent = lectureContext.full_content || `عنوان: ${lectureContext.title}\nوصف: ${lectureContext.description || ''}\nمحتوى: ${lectureContext.file_content || ''}\nملاحظات: ${lectureContext.notes || ''}`;

            const systemInstructionText = `أنت خبير أكاديمي متخصص في تحليل المحاضرات. مهمتك هي الإجابة على سؤال الطالب بدقة، ويجب أن تكون إجابتك مؤسسة بالكامل على محتوى المحاضرة المقدم.
            قواعد الإجابة:
            1.  استخدم محتوى المحاضرة فقط. لا تخمن.
            2.  قدم إجابة شاملة بلغة عربية فصحى احترافية.
            3.  إذا لم تجد المعلومة، اذكر ذلك بوضوح. مثال: "بناءً على المحاضرة، لا تتوفر هذه المعلومة...".
            4.  لا تذكر عنوان المحاضرة في الرد. كن مباشراً.`;

            const payload = {
                contents: [{
                    parts: [
                        { text: `محتوى المحاضرة:\n================\n${lectureContent}\n================` },
                        { text: `سؤال الطالب: ${textPrompt}` }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemInstructionText }] },
            };

            try {
                const result = await fetchGeminiWithRetry(payload);
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!aiResponse) {
                    throw new Error('لم يتمكن الذكاء الاصطناعي من إنشاء رد (قد يكون المحتوى غير كافٍ).');
                }
                return aiResponse;
            } catch (error) {
                console.error("Gemini Q&A Error:", error);
                return `عذراً، حدث خطأ: ${error.message}. يرجى التحقق من مفتاح API والمحاولة مرة أخرى.`;
            }
        }

        /**
         * Get AI structured JSON response for Quiz generation.
         */
        async function getGeminiQuiz(lectureContent, questionCount, questionType) {
            const quizSchema = {
                type: "OBJECT",
                properties: {
                    title: { type: "STRING", description: "عنوان جذاب للاختبار." },
                    questions: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                question: { type: "STRING", description: "نص السؤال." },
                                type: { type: "STRING", description: "نوع السؤال: 'multiple' أو 'truefalse'." },
                                options: { type: "ARRAY", items: { type: "STRING" }, description: "قائمة الخيارات." },
                                correct: { type: "INTEGER", description: "مؤشر الإجابة الصحيحة (يبدأ من 0)." }
                            },
                            required: ["question", "type", "options", "correct"]
                        }
                    }
                },
                required: ["title", "questions"]
            };

            let questionTypeInstructions = '';
            if (questionType === 'mixed') {
                const multiCount = Math.ceil(questionCount * 0.6);
                questionTypeInstructions = `أنشئ ${multiCount} سؤال اختيار من متعدد و ${questionCount - multiCount} سؤال صح وخطأ.`;
            } else {
                questionTypeInstructions = `أنشئ ${questionCount} سؤال من نوع '${questionType}'.`;
            }

            const quizPrompt = `أنت خبير في إنشاء اختبارات تعليمية. مهمتك هي إنشاء اختبار باللغة العربية حصراً بناءً على محتوى المحاضرة التالي.
            التعليمات:
            - يجب أن تكون جميع الأسئلة والإجابات مستمدة فقط من محتوى المحاضرة.
            - ${questionTypeInstructions}
            - يجب أن يكون الإخراج بصيغة JSON صالح يتبع المخطط المحدد تماماً.

            محتوى المحاضرة:
            ================
            ${lectureContent}
            ================`;

            const payload = {
                contents: [{ parts: [{ text: quizPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: quizSchema
                }
            };

            try {
                const result = await fetchGeminiWithRetry(payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error('استجابة API كانت فارغة.');
                }
                return JSON.parse(jsonText);
            } catch (error) {
                console.error("Gemini Quiz Error:", error);
                throw new Error(`فشل إنشاء الاختبار: ${error.message}`);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (window.initializeSupabase) await window.initializeSupabase();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (!(await checkAuthentication())) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                await loadUserData();
                await loadLectures();
                console.log('✅ AI Assistant initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing AI assistant:', error);
                showNotification('حدث خطأ في تحميل المساعد الذكي', 'error');
            }
        });

        async function checkAuthentication() {
            try {
                if (!window.supabaseClient || !window.supabaseAuth) return false;
                const { data } = await window.supabaseAuth.getSession();
                if (data?.session?.user) {
                    currentUser = data.session.user;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Authentication check error:', error);
                return false;
            }
        }

        function loadUserData() {
            const userName = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
            document.getElementById('userEmail').textContent = `مرحباً، ${userName}`;
        }

        async function loadLectures() {
            try {
                if (!currentUser) return;
                const { data: subjects, error: subjectsError } = await window.supabaseDB.subjects.getByUser(currentUser.id);
                if (subjectsError) throw subjectsError;

                const qaSelect = document.getElementById('qaLectureSelect');
                const quizSelect = document.getElementById('quizLectureSelect');
                qaSelect.innerHTML = '<option value="">-- اختر محاضرة --</option>';
                quizSelect.innerHTML = '';

                let lectureCount = 0;
                for (const subject of subjects) {
                    const { data: lectures, error: lecturesError } = await window.supabaseDB.lectures.getBySubject(subject.id);
                    if (lecturesError) throw lecturesError;
                    
                    if (lectures && lectures.length > 0) {
                        lectureCount += lectures.length;
                        lectures.forEach(lecture => {
                            const title = `${lecture.title} - ${subject.name}`;
                            [qaSelect, quizSelect].forEach(select => {
                                const option = document.createElement('option');
                                option.value = lecture.id;
                                option.textContent = title;
                                select.appendChild(option);
                            });
                        });
                    }
                }

                if (lectureCount === 0) {
                    const noLectureText = '<option value="" disabled>لا توجد محاضرات. أضف بعض المحاضرات أولاً.</option>';
                    qaSelect.innerHTML = noLectureText;
                    quizSelect.innerHTML = noLectureText;
                }
            } catch (error) {
                console.error('❌ Error loading lectures:', error);
                showNotification('حدث خطأ في تحميل المحاضرات', 'error');
            }
        }

        function enableQA() {
            const lectureId = document.getElementById('qaLectureSelect').value;
            const questionInput = document.getElementById('questionInput');
            const askBtn = document.getElementById('askBtn');
            
            const isEnabled = !!lectureId;
            questionInput.disabled = !isEnabled;
            askBtn.disabled = !isEnabled;
            
            if (isEnabled) {
                 document.getElementById('chatArea').innerHTML = `<div class="ai-message chat-message"><p>لقد اخترت محاضرة. يمكنك الآن طرح أي سؤال عنها.</p></div>`;
            } else {
                document.getElementById('chatArea').innerHTML = `<div class="text-center text-gray-500 py-8"><i class="fas fa-robot text-4xl mb-2"></i><p>اختر محاضرة لبدء المحادثة</p></div>`;
            }
        }

        document.getElementById('quizLectureSelect').addEventListener('change', function() {
            document.getElementById('generateQuizBtn').disabled = this.selectedOptions.length === 0;
        });

        function handleEnterKey(event) {
            if (event.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            if (!isApiKeySet()) return;
            const input = document.getElementById('questionInput');
            const message = input.value.trim();
            if (!message) return;

            const lectureId = document.getElementById('qaLectureSelect').value;
            if (!lectureId) {
                showNotification('يرجى اختيار محاضرة أولاً', 'error');
                return;
            }

            addMessage(message, 'user');
            input.value = '';
            showTypingIndicator();

            try {
                const { data: lecture } = await window.supabaseDB.lectures.getWithContent(lectureId);
                if (!lecture) throw new Error('لم يتم العثور على المحاضرة');

                const response = await getGeminiQaResponse(message, lecture);
                addMessage(response, 'ai');
            } catch (error) {
                console.error('Error in sendMessage:', error);
                addMessage(`عذراً، حدث خطأ: ${error.message}`, 'ai');
            } finally {
                hideTypingIndicator();
            }
        }
        
        async function generateQuiz() {
            if (!isApiKeySet()) return;

            const lectureSelect = document.getElementById('quizLectureSelect');
            const selectedOptions = Array.from(lectureSelect.selectedOptions);
            if (selectedOptions.length === 0) {
                showNotification('يرجى اختيار محاضرة واحدة على الأقل', 'error');
                return;
            }

            const btn = document.getElementById('generateQuizBtn');
            const originalBtnHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';

            try {
                showQuizLoadingState();

                const questionCount = document.getElementById('questionCount').value;
                const questionType = document.getElementById('questionType').value;
                
                // Combine content from all selected lectures for a richer quiz
                let combinedContent = '';
                for (const option of selectedOptions) {
                    const { data: lecture } = await window.supabaseDB.lectures.getWithContent(option.value);
                    if(lecture) {
                        combinedContent += (lecture.full_content || `عنوان: ${lecture.title}\nمحتوى: ${lecture.file_content || ''}\n`) + "\n\n---\n\n";
                    }
                }
                
                if (!combinedContent.trim()) throw new Error('محتوى المحاضرات المحدد فارغ.');

                const quizData = await getGeminiQuiz(combinedContent, questionCount, questionType);
                
                if (!quizData || !quizData.questions || quizData.questions.length === 0) {
                    throw new Error('لم يتمكن الذكاء الاصطناعي من إنشاء أسئلة. قد يكون المحتوى قصيراً جداً.');
                }
                
                currentQuiz = quizData;
                currentQuestionIndex = 0;
                userAnswers = new Array(currentQuiz.questions.length).fill(-1);
                
                displayQuiz();
                showNotification('تم إنشاء الاختبار بنجاح!', 'success');

            } catch (error) {
                console.error('Error generating quiz:', error);
                showQuizErrorState(error.message);
                showNotification('حدث خطأ في إنشاء الاختبار', 'error');
            } finally {
                btn.innerHTML = originalBtnHtml;
                btn.disabled = lectureSelect.selectedOptions.length === 0;
            }
        }

        function showQuizLoadingState() {
             const quizContainer = document.getElementById('quizContainer');
             quizContainer.classList.remove('hidden');
             quizContainer.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                    <p class="text-gray-600">جاري إنشاء الاختبار بواسطة الذكاء الاصطناعي...</p>
                    <p class="text-sm text-gray-500 mt-2">قد يستغرق هذا بضع ثوانٍ</p>
                </div>`;
            quizContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function showQuizErrorState(errorMessage) {
            document.getElementById('quizContainer').innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6 text-center border-2 border-red-200">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <h3 class="text-lg font-semibold text-red-700">خطأ في إنشاء الاختبار</h3>
                    <p class="text-red-600 my-4">${errorMessage}</p>
                    <button onclick="generateQuiz()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-redo ml-2"></i>المحاولة مرة أخرى
                    </button>
                </div>`;
        }
        
        // --- Quiz Display and Logic (No major changes needed here) ---
        function displayQuiz() {
            if (!currentQuiz || !currentQuiz.questions) return;
            const quizArea = document.getElementById('quizContainer');
            quizArea.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-green-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-green-800">${currentQuiz.title || 'الاختبار'}</h3>
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                            ${currentQuestionIndex + 1} / ${currentQuiz.questions.length}
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                        <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-300" 
                             style="width: ${((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100}%"></div>
                    </div>
                    <div id="questionContainer" class="mb-6">
                        ${renderQuestion(currentQuestionIndex)}
                    </div>
                    <div class="flex justify-between">
                        <button onclick="previousQuestion()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg disabled:opacity-50"
                                ${currentQuestionIndex === 0 ? 'disabled' : ''}>السابق</button>
                        <button onclick="nextQuestion()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            ${currentQuestionIndex === currentQuiz.questions.length - 1 ? 'إنهاء الاختبار' : 'التالي'}
                        </button>
                    </div>
                </div>`;
            quizArea.scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderQuestion(index) {
            const question = currentQuiz.questions[index];
            let optionsHtml = question.options.map((option, i) => `
                <div class="mb-3">
                    <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 ${userAnswers[index] === i ? 'border-green-500 bg-green-50' : 'border-gray-200'}">
                        <input type="radio" name="q_${index}" value="${i}" onchange="selectAnswer(${index}, ${i})" ${userAnswers[index] === i ? 'checked' : ''} class="ml-3">
                        <span>${option}</span>
                    </label>
                </div>`).join('');

            return `<h4 class="text-lg font-semibold mb-4">السؤال ${index + 1}: ${question.question}</h4><div>${optionsHtml}</div>`;
        }
        
        function selectAnswer(qIndex, aIndex) {
            userAnswers[qIndex] = aIndex;
            // Re-render to show selection
             document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                displayQuiz();
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuiz();
            }
        }
        
        function finishQuiz() {
            let score = userAnswers.reduce((acc, answer, i) => acc + (answer === currentQuiz.questions[i].correct ? 1 : 0), 0);
            const percentage = Math.round((score / currentQuiz.questions.length) * 100);
            
            let grade = { text: 'يحتاج تحسين', color: 'text-red-600' };
            if (percentage >= 90) grade = { text: 'ممتاز جداً!', color: 'text-green-600' };
            else if (percentage >= 80) grade = { text: 'ممتاز!', color: 'text-green-600' };
            else if (percentage >= 70) grade = { text: 'جيد جداً!', color: 'text-blue-600' };
            else if (percentage >= 60) grade = { text: 'جيد!', color: 'text-yellow-600' };

            document.getElementById('quizContainer').innerHTML = `
                <div class="bg-white rounded-lg p-6 text-center">
                    <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">انتهى الاختبار!</h3>
                    <div class="bg-gray-100 rounded-lg p-6 my-6">
                        <div class="text-4xl font-bold text-blue-600">${percentage}%</div>
                        <div class="text-lg mb-2">${score} من ${currentQuiz.questions.length} إجابة صحيحة</div>
                        <div class="text-lg font-medium ${grade.color}">${grade.text}</div>
                    </div>
                    <div class="flex gap-4 justify-center">
                        <button onclick="reviewAnswers()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">مراجعة الإجابات</button>
                        <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">اختبار جديد</button>
                    </div>
                </div>`;
        }

        function reviewAnswers() {
            let reviewHtml = `<div class="bg-white rounded-lg p-6">
                <h4 class="text-lg font-semibold mb-6">مراجعة الإجابات</h4>`;
            
            currentQuiz.questions.forEach((q, i) => {
                const userAnswer = userAnswers[i];
                const isCorrect = userAnswer === q.correct;
                reviewHtml += `
                    <div class="mb-6 p-4 border rounded-lg ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                        <p class="font-medium mb-3"><b>السؤال ${i + 1}:</b> ${q.question}</p>
                        <div class="text-sm space-y-2 border-t pt-3">
                            <p class="${isCorrect ? 'text-green-700' : 'text-red-700 line-through'}"><b>إجابتك:</b> ${userAnswer > -1 ? q.options[userAnswer] : 'لم تجب'}</p>
                            ${!isCorrect ? `<p class="text-green-700"><b>الصحيحة:</b> ${q.options[q.correct]}</p>` : ''}
                        </div>
                    </div>`;
            });
            reviewHtml += `</div>`;
            document.getElementById('quizContainer').innerHTML = reviewHtml;
        }

        function generateNewQuiz() {
            document.getElementById('quizContainer').classList.add('hidden');
            currentQuiz = null;
            document.querySelector('#quizLectureSelect').scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- Chat UI Helpers ---
        function addMessage(message, sender) {
            const chatArea = document.getElementById('chatArea');
            // Sanitize message to prevent HTML injection
            const safeMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');

            chatArea.insertAdjacentHTML('beforeend', `
                <div class="message flex ${sender === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="${sender}-message chat-message">
                        <p>${safeMessage}</p>
                    </div>
                </div>`);
            scrollToBottom();
        }

        function showTypingIndicator() {
            hideTypingIndicator(); // Remove any old ones
            document.getElementById('chatArea').insertAdjacentHTML('beforeend', `
                <div class="message flex justify-start typing-indicator-wrapper">
                    <div class="ai-message">
                        <div class="flex items-center">
                            <span class="typing-indicator"></span><span class="typing-indicator"></span><span class="typing-indicator"></span>
                            <span class="mr-2 text-sm">المساعد يكتب...</span>
                        </div>
                    </div>
                </div>`);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.querySelector('.typing-indicator-wrapper')?.remove();
        }

        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function showNotification(message, type = 'info') {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            const notification = document.createElement('div');
            notification.className = `fixed top-5 right-5 p-4 rounded-lg text-white font-medium z-50 transition-transform duration-300 translate-x-full ${colors[type]}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function logout() {
            try {
                if (window.supabaseAuth) await window.supabaseAuth.signOut();
            } finally {
                localStorage.clear();
                window.location.href = 'auth.html';
            }
        }
    </script>
</body>
</html>

