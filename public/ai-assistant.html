<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ | Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
    <meta name="description" content="Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø§Øª ÙÙˆØ±ÙŠØ© Ø¹Ù† Ø£Ø³Ø¦Ù„ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ù† Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ.">
    <meta name="keywords" content="Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ, Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªØ¹Ù„ÙŠÙ…ÙŠ, Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©, Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø©, Ù…Ø³Ø§Ø¹Ø¯ Ø·Ù„Ø§Ø¨ÙŠ, ØªØ¹Ù„Ù… ØªÙØ§Ø¹Ù„ÙŠ">
    <meta name="author" content="ÙØ±ÙŠÙ‚ Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <meta property="og:description" content="Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø°ÙƒÙŠ ÙŠØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙƒ ÙˆÙŠÙ†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ù† Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourwebsite.com/ai-assistant.html">
    <meta property="og:site_name" content="Ù…Ù†ØµØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <meta property="og:locale" content="ar_SA">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://yourwebsite.com/ai-assistant.html">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .chat-message { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        .message { margin-bottom: 1rem; }
        .user-message {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 0.25rem 1rem;
            margin-left: 2rem;
            text-align: right;
        }
        .ai-message {
            background: #f3f4f6;
            color: #374151;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 1rem 0.25rem;
            margin-right: 2rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button onclick="window.location.href='index.html'" class="text-gray-600 hover:text-gray-900 ml-4">
                        <i class="fas fa-arrow-right text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900 mr-4">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span id="userEmail" class="text-sm text-gray-600"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-sign-out-alt ml-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Q&A Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-comments text-blue-500 ml-3"></i>
                    Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
                </h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©:</label>
                    <select id="qaLectureSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="enableQA()">
                        <option value="">-- Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© --</option>
                    </select>
                </div>

                <div id="chatArea" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto mb-4 border">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ§Ø³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ØªØ±ÙŠØ¯</p>
                    </div>
                </div>

                <div class="flex space-x-2 space-x-reverse">
                    <input type="text" id="questionInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." 
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           disabled onkeypress="handleEnterKey(event)">
                    <button id="askBtn" onclick="sendMessage()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Quiz Section -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-clipboard-question ml-3"></i>
                        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±
                    </h2>
                    <p class="text-green-100 mt-2">Ø£Ù†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø± ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>
                </div>
                
                <div class="p-6">
                    <!-- Quiz Settings -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</label>
                            <select id="quizLectureSelect" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent h-32">
                            </select>
                            <p class="text-xs text-gray-500 mt-1">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ø¹ Ctrl</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                <select id="questionType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="multiple">Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯</option>
                                    <option value="truefalse">ØµØ­ ÙˆØ®Ø·Ø£</option>
                                    <option value="mixed">Ù…Ø®ØªÙ„Ø·</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                <select id="questionCount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="5">5 Ø£Ø³Ø¦Ù„Ø©</option>
                                    <option value="10" selected>10 Ø£Ø³Ø¦Ù„Ø©</option>
                                    <option value="15">15 Ø³Ø¤Ø§Ù„</option>
                                    <option value="20">20 Ø³Ø¤Ø§Ù„</option>
                                    <option value="25">25 Ø³Ø¤Ø§Ù„</option>
                                    <option value="30">30 Ø³Ø¤Ø§Ù„</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button id="generateQuizBtn" onclick="generateQuiz()" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-magic ml-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ÙÙˆØ±ÙŠ
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Display Area -->
        <div id="quizContainer" class="hidden mt-8">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center justify-between">
                        <span><i class="fas fa-clipboard-check ml-3"></i>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span>
                        <span id="quizTimer" class="text-purple-100"></span>
                    </h2>
                </div>
                
                <div class="p-6">
                    <div id="quizContent"></div>
                    
                    <div class="flex justify-between items-center mt-6">
                        <div class="text-sm text-gray-600">
                            Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="currentQuestion">1</span> Ù…Ù† <span id="totalQuestions">10</span>
                        </div>
                        <div class="space-x-2 space-x-reverse">
                            <button id="prevBtn" onclick="previousQuestion()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg disabled:opacity-50">
                                Ø§Ù„Ø³Ø§Ø¨Ù‚
                            </button>
                            <button id="nextBtn" onclick="nextQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                Ø§Ù„ØªØ§Ù„ÙŠ
                            </button>
                            <button id="submitQuizBtn" onclick="submitQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg hidden">
                                Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Results -->
        <div id="quizResults" class="hidden mt-8">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-trophy ml-3"></i>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </h2>
                </div>
                
                <div class="p-6" id="resultsContent">
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        // Gemini API Configuration
        const GEMINI_API_KEY = "AIzaSyBQKDuazYnENme5oLyKoOH9uQiZejiyLpg";
        
        let currentUser = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];

        /**
         * Get AI response from Google Gemini API
         * @param {string} textPrompt - User's question or prompt
         * @param {object} lectureContext - Lecture context for educational responses
         */
        async function getGeminiResponse(textPrompt, lectureContext = null) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const parts = [];

                // Add context about the lecture if available
                let contextualPrompt = textPrompt;
                if (lectureContext) {
                    contextualPrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø°ÙƒÙŠ ÙˆÙ…ØªØ®ØµØµ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©. Ù„Ø¯ÙŠÙƒ Ù…Ø¹Ø±ÙØ© ÙˆØ§Ø³Ø¹Ø© ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ø³Ø¦Ù„ØªÙ‡Ù….

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©:
${lectureContext.full_content || `Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lectureContext.title}
${lectureContext.description ? `ÙˆØµÙ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lectureContext.description}` : ''}
${lectureContext.content_type ? `Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${lectureContext.content_type}` : ''}
${lectureContext.file_content ? `Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù: ${lectureContext.file_content}` : ''}`}

Ø³Ø¤Ø§Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨: ${textPrompt}

Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:
- Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„ÙˆØ§Ø³Ø¹Ø© Ù„ØªÙ‚Ø¯ÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø§Øª Ø´Ø§Ù…Ù„Ø© ÙˆÙ…ÙÙŠØ¯Ø©
- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…ØªØ¹Ù„Ù‚Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ Ø§Ø±Ø¨Ø· Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…ØªØ§Ø­
- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙŠ (Ø®Ø§ØµØ© ÙØªØ±Ø© 1952-1973)ØŒ Ù‚Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© ÙˆØ¯Ù‚ÙŠÙ‚Ø©
- Ø§Ø°ÙƒØ± Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„Ø´Ø®ØµÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
- Ù‚Ø¯Ù… Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ ÙˆØ§Ù„Ø£Ø³Ø¨Ø§Ø¨ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙˆØ§Ø¶Ø­Ø© ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø·Ù„Ø§Ø¨
- ÙƒÙ† Ù…ÙÙŠØ¯Ø§Ù‹ ÙˆØªØ¹Ù„ÙŠÙ…ÙŠØ§Ù‹ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ`;
                }

                parts.push({ text: contextualPrompt });

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
                }

                const result = await response.json();
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponse) {
                    return aiResponse;
                } else {
                    throw new Error('Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¯.');
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                return `Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ: ${error.message}`;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Supabase
                if (window.initializeSupabase) {
                    await window.initializeSupabase();
                }
                
                // Wait for authentication
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check authentication
                const isAuthenticated = await checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                // Load user data and lectures
                await loadUserData();
                await loadLectures();
                
                console.log('âœ… AI Assistant initialized successfully');
                
            } catch (error) {
                console.error('âŒ Error initializing AI assistant:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ', 'error');
            }
        });

        // Check authentication
        async function checkAuthentication() {
            try {
                if (!window.supabaseClient || !window.supabaseAuth) {
                    return false;
                }
                
                const { data } = await window.supabaseAuth.getSession();
                if (data?.session?.user) {
                    currentUser = data.session.user;
                    localStorage.setItem('userEmail', currentUser.email);
                    localStorage.setItem('userId', currentUser.id);
                    localStorage.setItem('userName', currentUser.user_metadata?.full_name || currentUser.email.split('@')[0]);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Authentication check error:', error);
                return false;
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const userName = localStorage.getItem('userName') || currentUser?.email?.split('@')[0] || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                const userEmail = localStorage.getItem('userEmail') || currentUser?.email || '';
                document.getElementById('userEmail').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${userName}`;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load lectures for dropdown
        async function loadLectures() {
            try {
                if (!currentUser) {
                    console.warn('No current user available');
                    return;
                }

                // Load subjects from database
                const subjectsResult = await window.supabaseDB.subjects.getByUser(currentUser.id);
                if (subjectsResult.error) {
                    console.error('Error loading subjects:', subjectsResult.error);
                    return;
                }

                const subjects = subjectsResult.data || [];
                const qaLectureSelect = document.getElementById('qaLectureSelect');
                const quizLectureSelect = document.getElementById('quizLectureSelect');
                
                qaLectureSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© --</option>';
                quizLectureSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¶Ø±Ø© --</option>';

                // Load lectures for each subject
                for (const subject of subjects) {
                    const lecturesResult = await window.supabaseDB.lectures.getBySubject(subject.id);
                    if (lecturesResult.data && lecturesResult.data.length > 0) {
                        const lectures = lecturesResult.data;
                        
                        lectures.forEach(lecture => {
                            // Add to Q&A dropdown
                            const qaOption = document.createElement('option');
                            qaOption.value = lecture.id;
                            qaOption.textContent = `${lecture.title} - ${subject.name}`;
                            qaOption.dataset.subjectId = subject.id;
                            qaLectureSelect.appendChild(qaOption);

                            // Add to Quiz dropdown
                            const quizOption = document.createElement('option');
                            quizOption.value = lecture.id;
                            quizOption.textContent = `${lecture.title} - ${subject.name}`;
                            quizOption.dataset.subjectId = subject.id;
                            quizLectureSelect.appendChild(quizOption);
                        });
                    }
                }

                if (qaLectureSelect.children.length === 1) {
                    qaLectureSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…ØªØ§Ø­Ø© - Ø£Ø¶Ù Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</option>';
                    quizLectureSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…ØªØ§Ø­Ø© - Ø£Ø¶Ù Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</option>';
                }

                console.log('âœ… Lectures loaded from database');

            } catch (error) {
                console.error('âŒ Error loading lectures:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª', 'error');
            }
        }

        // Enable Q&A when lecture is selected
        function enableQA() {
            const lectureId = document.getElementById('qaLectureSelect').value;
            const questionInput = document.getElementById('questionInput');
            const askBtn = document.getElementById('askBtn');
            
            if (lectureId) {
                questionInput.disabled = false;
                askBtn.disabled = false;
                
                const chatArea = document.getElementById('chatArea');
                chatArea.innerHTML = `
                    <div class="ai-message chat-message">
                        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ù„Ù‚Ø¯ Ø§Ø®ØªØ±Øª Ù…Ø­Ø§Ø¶Ø±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø·Ø±Ø­ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.</p>
                    </div>
                `;
            } else {
                questionInput.disabled = true;
                askBtn.disabled = true;
            }
        }

        // Enable quiz generation when lectures are selected
        document.getElementById('quizLectureSelect').addEventListener('change', function() {
            const selectedLectures = Array.from(this.selectedOptions);
            document.getElementById('generateQuizBtn').disabled = selectedLectures.length === 0;
        });

        // Handle Enter key for questions
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('questionInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const lectureSelect = document.getElementById('qaLectureSelect');
            if (!lectureSelect.value) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¶Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message';
            typingDiv.innerHTML = `
                <div class="ai-message">
                    <div class="flex items-center">
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="mr-2">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙƒØªØ¨...</span>
                    </div>
                </div>
            `;
            document.getElementById('chatArea').appendChild(typingDiv);
            scrollToBottom();

            try {
                const lectureId = lectureSelect.value;
                
                // Get lecture content from database including file content
                const lectureResult = await window.supabaseDB.lectures.getWithContent(lectureId);
                const lecture = lectureResult.data;
                
                if (!lecture) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©');
                }

                // Generate AI response using Gemini API with actual content
                const response = await getGeminiResponse(message, lecture);
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add AI response
                addMessage(response, 'ai');
                
            } catch (error) {
                console.error('Error generating response:', error);
                typingDiv.remove();
                addMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø¤Ø§Ù„Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'ai');
            }
        }

        // Generate quiz
        async function generateQuiz() {
            const lectureSelect = document.getElementById('quizLectureSelect');
            if (!lectureSelect.value) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¶Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            try {
                // Get selected lecture details
                const selectedOption = lectureSelect.selectedOptions[0];
                const lectureId = lectureSelect.value;
                const subjectId = selectedOption.dataset.subjectId;
                
                // Get lecture content from database
                const lectureResult = await window.supabaseDB.lectures.getWithContent(lectureId);
                const lecture = lectureResult.data;
                
                if (!lecture) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©');
                }

                // Show loading state
                const quizContainer = document.getElementById('quizContainer');
                quizContainer.classList.remove('hidden');
                quizContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-magic ml-3"></i>Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                                <p class="text-gray-600">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...</p>
                            </div>
                        </div>
                    </div>
                `;
                // Generate quiz using Gemini API
                const questionCount = document.getElementById('questionCount').value || '10';
                const questionType = document.getElementById('questionType').value || 'multiple';
                
                let questionTypeInstructions = '';
                let questionFormat = '';
                
                if (questionType === 'multiple') {
                    questionTypeInstructions = `- Ø¥Ù†Ø´Ø§Ø¡ ${questionCount} Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯
- ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 4 Ø®ÙŠØ§Ø±Ø§Øª (Ø£ØŒ Ø¨ØŒ Ø¬ØŒ Ø¯)`;
                    questionFormat = `{
      "question": "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ",
      "type": "multiple",
      "options": ["Ø£) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„", "Ø¨) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø¬) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«", "Ø¯) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹"],
      "correct": 0
    }`;
                } else if (questionType === 'truefalse') {
                    questionTypeInstructions = `- Ø¥Ù†Ø´Ø§Ø¡ ${questionCount} Ø³Ø¤Ø§Ù„ ØµØ­ ÙˆØ®Ø·Ø£
- ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø±ÙŠÙ† ÙÙ‚Ø·: ØµØ­ Ø£Ùˆ Ø®Ø·Ø£`;
                    questionFormat = `{
      "question": "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ",
      "type": "truefalse",
      "options": ["ØµØ­", "Ø®Ø·Ø£"],
      "correct": 0
    }`;
                } else if (questionType === 'mixed') {
                    const multipleCount = Math.ceil(questionCount * 0.6);
                    const trueFalseCount = questionCount - multipleCount;
                    questionTypeInstructions = `- Ø¥Ù†Ø´Ø§Ø¡ ${multipleCount} Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ Ùˆ ${trueFalseCount} Ø³Ø¤Ø§Ù„ ØµØ­ ÙˆØ®Ø·Ø£
- Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯: 4 Ø®ÙŠØ§Ø±Ø§Øª (Ø£ØŒ Ø¨ØŒ Ø¬ØŒ Ø¯)
- Ø£Ø³Ø¦Ù„Ø© ØµØ­ ÙˆØ®Ø·Ø£: Ø®ÙŠØ§Ø±ÙŠÙ† ÙÙ‚Ø· (ØµØ­ØŒ Ø®Ø·Ø£)`;
                    questionFormat = `{
      "question": "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ",
      "type": "multiple", // Ø£Ùˆ "truefalse"
      "options": ["Ø£) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„", "Ø¨) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø¬) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«", "Ø¯) Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹"], // Ø£Ùˆ ["ØµØ­", "Ø®Ø·Ø£"]
      "correct": 0
    }`;
                }
                
                const quizPrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©:
${lecture.full_content || `Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lecture.title}
${lecture.description ? `ÙˆØµÙ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lecture.description}` : ''}
${lecture.content_type ? `Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${lecture.content_type}` : ''}
${lecture.file_content ? `Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù: ${lecture.file_content}` : ''}`}

Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
${questionTypeInstructions}
- ÙŠØ¬Ø¨ Ø£Ù† ØªØºØ·ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¬ÙˆØ§Ù†Ø¨ Ù…Ø®ØªÙ„ÙØ© Ù…Ù† Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©
- Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
- ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©
- Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª

ÙŠØ±Ø¬Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø·:
{
  "title": "Ø§Ø®ØªØ¨Ø§Ø±: ${lecture.title}",
  "questions": [
    ${questionFormat}
  ]
}

ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØªÙƒÙˆÙ† JSON ØµØ§Ù„Ø­ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ.`;

                const aiResponse = await getGeminiResponse(quizPrompt);
                
                // Parse AI response to extract quiz data
                let quizData;
                try {
                    // Try to extract JSON from the response
                    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        quizData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©');
                    }
                } catch (parseError) {
                    console.error('Error parsing AI response:', parseError);
                    // Fallback: create a simple quiz based on lecture info
                    quizData = createFallbackQuiz(lecture);
                }

                // Validate quiz data
                if (!quizData.questions || quizData.questions.length === 0) {
                    quizData = createFallbackQuiz(lecture);
                }

                currentQuiz = quizData;
                currentQuestionIndex = 0;
                userAnswers = [];
                
                displayQuiz();
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
            } catch (error) {
                console.error('Error generating quiz:', error);
                document.getElementById('quizArea').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-500 mb-4">
                            <i class="fas fa-exclamation-triangle text-4xl"></i>
                        </div>
                        <p class="text-red-600">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
                        <button onclick="generateQuiz()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                            Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                        </button>
                    </div>
                `;
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }

        // Create fallback quiz when AI generation fails
        function createFallbackQuiz(lecture) {
            return {
                title: `Ø§Ø®ØªØ¨Ø§Ø±: ${lecture.title}`,
                questions: [
                    {
                        question: `Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "${lecture.title}"ØŸ`,
                        options: [
                            `Ø£) ${lecture.description || 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ'}`,
                            "Ø¨) Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø®ØªÙ„Ù ØªÙ…Ø§Ù…Ø§Ù‹",
                            "Ø¬) Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø­Ø¯Ø¯",
                            "Ø¯) Ø¬Ù…ÙŠØ¹ Ù…Ø§ Ø³Ø¨Ù‚"
                        ],
                        correct: 0
                    },
                    {
                        question: `Ù…ØªÙ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŸ`,
                        options: [
                            `Ø£) ${new Date(lecture.created_at).toLocaleDateString('ar-SA')}`,
                            "Ø¨) Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠ",
                            "Ø¬) Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ",
                            "Ø¯) Ù„Ø§ Ø£Ø¹Ø±Ù"
                        ],
                        correct: 0
                    },
                    {
                        question: `Ù…Ø§ Ù‡Ùˆ Ù†ÙˆØ¹ Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŸ`,
                        options: [
                            `Ø£) ${lecture.content_type || 'Ù…Ø­ØªÙˆÙ‰ ØªØ¹Ù„ÙŠÙ…ÙŠ'}`,
                            "Ø¨) Ù…Ø­ØªÙˆÙ‰ ØªØ±ÙÙŠÙ‡ÙŠ",
                            "Ø¬) Ù…Ø­ØªÙˆÙ‰ Ø¥Ø¹Ù„Ø§Ù†ÙŠ",
                            "Ø¯) Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰"
                        ],
                        correct: 0
                    }
                ]
            };
        }

        // Display quiz
        function displayQuiz() {
            if (!currentQuiz || !currentQuiz.questions || currentQuiz.questions.length === 0) {
                console.error('No quiz data available');
                return;
            }

            // Initialize user answers array
            userAnswers = new Array(currentQuiz.questions.length).fill(-1);
            
            const quizArea = document.getElementById('quizContainer');
            quizArea.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-green-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-green-800">${currentQuiz.title}</h3>
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                            Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${currentQuiz.questions.length}
                        </span>
                    </div>
                    
                    <div class="mb-6">
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-300" 
                                 style="width: ${((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100}%"></div>
                        </div>
                    </div>

                    <div id="questionContainer" class="mb-6">
                        ${renderQuestion(currentQuestionIndex)}
                    </div>

                    <div class="flex justify-between">
                        <button id="prevBtn" onclick="previousQuestion()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-right ml-2"></i>
                            Ø§Ù„Ø³Ø§Ø¨Ù‚
                        </button>
                        
                        <button id="nextBtn" onclick="nextQuestion()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            ${currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                                '<i class="fas fa-check ml-2"></i>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 
                                'Ø§Ù„ØªØ§Ù„ÙŠ<i class="fas fa-arrow-left mr-2"></i>'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderQuestion(index) {
            const question = currentQuiz.questions[index];
            if (!question) return '';

            let optionsHtml = '';
            question.options.forEach((option, optionIndex) => {
                const isSelected = userAnswers[index] === optionIndex;
                optionsHtml += `
                    <div class="mb-3">
                        <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200'}">
                            <input type="radio" name="question_${index}" value="${optionIndex}" 
                                   onchange="selectAnswer(${index}, ${optionIndex})" 
                                   ${isSelected ? 'checked' : ''} class="ml-3">
                            <span class="text-gray-800">${option}</span>
                        </label>
                    </div>
                `;
            });

            return `
                <div class="question-content">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">${question.question}</h4>
                    <div class="options-container">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }

        function selectAnswer(questionIndex, answerIndex) {
            userAnswers[questionIndex] = answerIndex;
            console.log('Answer selected:', questionIndex, answerIndex);
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
            }
        }

        function updateQuizProgress() {
            const progressBar = document.querySelector('.bg-green-500');
            const questionCounter = document.querySelector('.bg-green-100');
            
            if (progressBar) {
                progressBar.style.width = `${((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100}%`;
            }
            
            if (questionCounter) {
                questionCounter.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${currentQuiz.questions.length}`;
            }

            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentQuestionIndex === 0;
            }
            
            if (nextBtn) {
                nextBtn.innerHTML = currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                    '<i class="fas fa-check ml-2"></i>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 
                    'Ø§Ù„ØªØ§Ù„ÙŠ<i class="fas fa-arrow-left mr-2"></i>';
            }
        }

        function finishQuiz() {
            const score = calculateScore();
            const percentage = Math.round((score / currentQuiz.questions.length) * 100);
            
            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-blue-200 p-6 text-center">
                    <div class="mb-6">
                        <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h3>
                        <p class="text-gray-600">Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                        <div class="text-4xl font-bold text-blue-600">${percentage}%</div>
                        <div class="text-lg text-gray-700 mb-2">${results.correctAnswers} Ù…Ù† ${results.totalQuestions} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
                        <div class="text-lg font-medium ${gradeColor}">${gradeMessage}</div>
                    </div>
                    
                    <div class="flex gap-4 justify-center">
                        <button onclick="reviewAnswers()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-eye ml-2"></i>
                            Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                        </button>
                        <button onclick="generateQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-redo ml-2"></i>
                            Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            `;
        }

        function calculateScore() {
            let score = 0;
            for (let i = 0; i < currentQuiz.questions.length; i++) {
                if (userAnswers[i] === currentQuiz.questions[i].correct) {
                    score++;
                }
            }
            return score;
        }

        function reviewAnswers() {
            let reviewHtml = `
                <div class="bg-white rounded-lg border-2 border-gray-200 p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-list-check ml-2"></i>
                        Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                    </h4>
            `;

            currentQuiz.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = question.correct;
                const isCorrect = userAnswer === correctAnswer;

                reviewHtml += `
                    <div class="mb-6 p-4 border rounded-lg ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                        <div class="flex items-center mb-3">
                            <i class="fas ${isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'} ml-2"></i>
                            <span class="font-semibold">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}</span>
                        </div>
                        <p class="font-medium mb-3">${question.question}</p>
                        <div class="text-sm space-y-1">
                            <div class="flex items-center">
                                <span class="text-gray-600 ml-2">Ø¥Ø¬Ø§Ø¨ØªÙƒ:</span>
                                <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${question.options[userAnswer]}</span>
                            </div>
                            ${!isCorrect ? `
                                <div class="flex items-center">
                                    <span class="text-gray-600 ml-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</span>
                                    <span class="text-green-600">${question.options[correctAnswer]}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            reviewHtml += `
                    <div class="text-center">
                        <button onclick="generateQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-redo ml-2"></i>
                            Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('quizContainer').innerHTML = reviewHtml;
        }

        // Display quiz results
        function displayQuizResults(results) {
            const quizContainer = document.getElementById('quizContainer');
            const quizResults = document.getElementById('quizResults');
            
            // Hide quiz container and show results
            quizContainer.classList.add('hidden');
            quizResults.classList.remove('hidden');
            
            const resultsContent = document.getElementById('resultsContent');
            
            let gradeColor = 'text-red-600';
            let gradeMessage = 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ğŸ“š';
            
            if (results.percentage >= 80) {
                gradeColor = 'text-green-600';
                gradeMessage = 'Ù…Ù…ØªØ§Ø²! ğŸ‰';
            } else if (results.percentage >= 60) {
                gradeColor = 'text-blue-600';
                gradeMessage = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! ğŸ‘';
            }
            
            // Generate detailed results
            let detailedResults = '';
            results.results.forEach((result, index) => {
                const questionTypeIcon = result.type === 'truefalse' ? 'âœ“/âœ—' : 'ABC';
                const statusIcon = result.isCorrect ? 'âœ…' : 'âŒ';
                
                detailedResults += `
                    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0">
                        <div class="flex items-start justify-between mb-2">
                            <span class="text-sm text-gray-500">${questionTypeIcon} Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}</span>
                            <span class="text-lg">${statusIcon}</span>
                        </div>
                        <h4 class="font-medium text-gray-800 mb-2">${result.question}</h4>
                        <div class="text-sm space-y-1">
                            <div class="flex items-center">
                                <span class="text-gray-600 ml-2">Ø¥Ø¬Ø§Ø¨ØªÙƒ:</span>
                                <span class="${result.isCorrect ? 'text-green-600' : 'text-red-600'}">${result.userAnswer}</span>
                            </div>
                            ${!result.isCorrect ? `
                                <div class="flex items-center">
                                    <span class="text-gray-600 ml-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</span>
                                    <span class="text-green-600">${result.correctAnswer}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = `
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-100 to-green-100 rounded-full mb-4">
                        <i class="fas fa-trophy text-3xl text-yellow-500"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                    <div class="text-6xl font-bold ${gradeColor} mb-2">${results.percentage}%</div>
                    <div class="text-lg text-gray-700 mb-2">${results.correctAnswers} Ù…Ù† ${results.totalQuestions} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
                    <div class="text-lg font-medium ${gradeColor}">${gradeMessage}</div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600">${results.totalQuestions}</div>
                        <div class="text-sm text-blue-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-600">${results.correctAnswers}</div>
                        <div class="text-sm text-green-800">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-600">${results.totalQuestions - results.correctAnswers}</div>
                        <div class="text-sm text-red-800">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-list-check ml-2"></i>
                        Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                    </h4>
                    <div class="max-h-96 overflow-y-auto">
                        ${detailedResults}
                    </div>
                </div>
                
                <div class="flex justify-center space-x-4 space-x-reverse mt-6">
                    <button onclick="retakeQuiz()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-redo ml-2"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                    <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-plus ml-2"></i>Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
        }

        // Retake quiz
        function retakeQuiz() {
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuiz.questions.length).fill(-1);
            
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('quizContainer').classList.remove('hidden');
            
            displayQuiz();
        }

        // Generate new quiz
        function generateNewQuiz() {
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            
            // Reset quiz state
            currentQuiz = null;
            currentQuestionIndex = 0;
            userAnswers = [];
            
            // Scroll to quiz generation section
            document.querySelector('.bg-gradient-to-r.from-green-500').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Add message to chat
        function addMessage(message, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message chat-message`;
            messageDiv.innerHTML = `<p>${message}</p>`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Scroll to bottom of chat area
        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white font-medium z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Logout function
        async function logout() {
            try {
                if (window.supabaseAuth) {
                    await window.supabaseAuth.signOut();
                }
                localStorage.clear();
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('âŒ Logout error:', error);
                window.location.href = 'auth.html';
            }
        }
    </script>
</body>
</html>