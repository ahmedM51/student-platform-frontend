<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>المساعد الذكي - منصة الطالب الذكي | مساعد تعليمي بالذكاء الاصطناعي</title>
    <meta name="description" content="استخدم المساعد الذكي المدعوم بالذكاء الاصطناعي للحصول على إجابات فورية عن أسئلتك التعليمية وإنشاء اختبارات تفاعلية من محاضراتك.">
    <meta name="keywords" content="مساعد ذكي, ذكاء اصطناعي تعليمي, اختبارات تفاعلية, أسئلة وأجوبة, مساعد طلابي, تعلم تفاعلي">
    <meta name="author" content="فريق منصة الطالب الذكي">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="المساعد الذكي - منصة الطالب الذكي">
    <meta property="og:description" content="مساعد تعليمي ذكي يجيب على أسئلتك وينشئ اختبارات تفاعلية من محاضراتك">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://student-platform-frontend.vercel.app/ai-assistant.html">
    <meta property="og:site_name" content="منصة الطالب الذكي">
    <meta property="og:locale" content="ar_SA">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://student-platform-frontend.vercel.app/ai-assistant.html">

    <script>try{var t=localStorage.getItem('theme');var d=t?t==='dark':(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches);if(d){document.documentElement.classList.add('dark')}}catch(e){}</script>
    <link href="css/dark-mode.css" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js for client-side PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" referrerpolicy="no-referrer"></script>
    <script>
      if (window['pdfjsLib']) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
    </script>
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.14.0/dist/pptxgen.bundle.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .chat-message { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        

        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        .message { margin-bottom: 1rem; }
        .user-message {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 0.25rem 1rem;
            margin-left: 2rem;
            text-align: right;
            max-width: 95%;
            word-wrap: break-word;
        }
        .ai-message {
            background: #f3f4f6;
            color: #374151;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 1rem 0.25rem;
            margin-right: 2rem;
            max-width: 95%;
            word-wrap: break-word;
        }
        /* Custom scrollbar for chat area */
        #chatArea::-webkit-scrollbar {
            width: 8px;
        }
        #chatArea::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
        #chatArea::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }
    </style>
    <script src="js/i18n.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <script>
        try {
            var plan = localStorage.getItem('subscriptionPlan');
            if (!plan) {
                localStorage.setItem('subscriptionPlan', 'free');
            }
        } catch (e) {}
    </script>
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button onclick="window.location.href='index.html'" class="text-gray-600 hover:text-gray-900 ml-4">
                        <i class="fas fa-arrow-right text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900 mr-4" data-i18n="ai.title">المساعد الذكي</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <select id="langSelect" onchange="setLanguage(this.value)" class="bg-gray-100 text-gray-800 px-2 py-2 rounded-lg text-sm">
                        <option value="ar">العربية</option>
                        <option value="en">English</option>
                    </select>
                    <span id="userEmail" class="text-sm text-gray-600"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-sign-out-alt ml-2"></i><span data-i18n="nav.logout">تسجيل الخروج</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Q&A Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-comments text-blue-500 ml-3"></i>
                    <span data-i18n="ai.qa.title">محادثة مع المساعد الذكي</span>
                </h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ai.qa.choose_lecture">اختر المحاضرة:</label>
                    <select id="qaLectureSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="enableQA()">
                        <option value="" data-i18n="ai.qa.placeholder_option">-- اختر محاضرة --</option>
                    </select>
                    <div class="mt-2">
                        <button type="button" onclick="addCurrentLectureToQaUploads()" class="px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200" data-i18n="ai.qa.add_current_to_uploads">إضافة هذه المحاضرة إلى "الملفات المرفوعة" للمحادثة</button>
                    </div>
                    <div class="mt-3 grid grid-cols-1 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="ai.qa.upload_files_label">أو ارفع ملفات (PDF, DOCX, TXT, MD)</label>
                            <input id="qaFiles" type="file" multiple accept=".pdf,.docx,.txt,.md" class="block w-full text-sm text-gray-700"
                                   onchange="handleQaFilesChange(this.files)">
                            <p class="text-xs text-gray-500 mt-1" data-i18n="ai.qa.select_hint">اختر من القائمة: المحاضرات أو "الملفات المرفوعة" أو "المنصة (عام)"</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="ai.qa.url_label">أو أدخل رابط مباشر (PDF أو TXT/MD)</label>
                            <div class="flex gap-2">
                                <input id="qaUrl" type="url" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-i18n-attr="placeholder:home.mynotes.open_page" placeholder="https://example.com/lecture.pdf">
                                <button type="button" onclick="handleQaUrl()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" data-i18n="ai.qa.use_url">استخدام الرابط</button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="ai.qa.cors_hint">قد تمنع بعض المواقع الوصول بسبب CORS. يفضّل رابط مباشر للملف.</p>
                        </div>
                    </div>
                </div>

                <div id="chatArea" class="bg-gray-50 rounded-lg p-4 h-[70vh] resize-y overflow-y-auto mb-4 border">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p data-i18n="ai.qa.empty">مرحباً! اختر محاضرة واسأل أي سؤال تريد</p>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2 mb-4">
                    <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm" onclick="explainFullSource()">
                        <i class="fas fa-chalkboard-teacher ml-1"></i> شرح كامل
                    </button>
                    <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm" onclick="summarizeFullSource()">
                        <i class="fas fa-list ml-1"></i> تلخيص كامل
                    </button>
                    <button class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg text-sm" onclick="audioSummaryFullSource()">
                        <i class="fas fa-headphones ml-1"></i> ملخص صوتي
                    </button>
                    <audio id="aiSummaryAudio" class="hidden" controls></audio>
                </div>

                <div class="mt-2">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">قوالب جاهزة</h4>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="px-3 py-2 bg-gray-100 text-gray-800 rounded hover:bg-gray-200 text-sm" onclick="openTemplate('research')">
                            بحث شامل
                        </button>
                        <button type="button" class="px-3 py-2 bg-gray-100 text-gray-800 rounded hover:bg-gray-200 text-sm" onclick="openTemplate('paper')">
                            تحليل ورقة PDF
                        </button>
                        <button type="button" class="px-3 py-2 bg-gray-100 text-gray-800 rounded hover:bg-gray-200 text-sm" onclick="openTemplate('paraphrase')">
                            إعادة صياغة
                        </button>
                        <button type="button" class="px-3 py-2 bg-gray-100 text-gray-800 rounded hover:bg-gray-200 text-sm" onclick="openTemplate('topics')">
                            مواضيع وثغرات
                        </button>
                    </div>
                </div>

                <div class="flex space-x-2 space-x-reverse">
                    <input type="text" id="questionInput" data-i18n-attr="placeholder:ai.qa.input.placeholder" placeholder="اكتب سؤالك هنا..." 
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           disabled onkeypress="handleEnterKey(event)">
                    <button id="askBtn" onclick="sendMessage()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-paper-plane"></i> <span data-i18n="ai.qa.button.send"></span>
                    </button>
                </div>
            </div>

            <!-- Quiz Section -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-clipboard-question ml-3"></i>
                        <span data-i18n="ai.quiz.title">إنشاء اختبار</span>
                    </h2>
                    <p class="text-green-100 mt-2" data-i18n="ai.quiz.subtitle">أنشئ اختبار فوري من المحاضرات</p>
                </div>
                
                <div class="p-6">
                    <!-- Quiz Settings -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ai.quiz.choose_lectures">اختر المحاضرات</label>
                            <select id="quizLectureSelect" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent h-32">
                            </select>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="ai.quiz.multi_hint">يمكنك اختيار عدة محاضرات بالضغط مع Ctrl</p>
                            <div class="mt-2">
                                <button type="button" onclick="addSelectedLecturesToQuizUploads()" class="px-3 py-2 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200" data-i18n="ai.quiz.add_selected_to_uploads">إضافة المحاضرات المحددة إلى "الملفات المرفوعة" للاختبار</button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ai.quiz.upload_label">أو ارفع ملفات لإنشاء اختبار منها (PDF, DOCX, TXT, MD)</label>
                            <input id="quizFiles" type="file" multiple accept=".pdf,.docx,.txt,.md" class="block w-full text-sm text-gray-700"
                                   onchange="handleQuizFilesChange(this.files)">
                            <p class="text-xs text-gray-500 mt-1" data-i18n="ai.quiz.upload_hint">إذا رُفعت ملفات هنا سيتم استخدامها كمصدر رئيسي للأسئلة</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ai.quiz.url_label">أو أدخل رابط مباشر لملف المحتوى (PDF أو TXT/MD)</label>
                            <div class="flex gap-2">
                                <input id="quizUrl" type="url" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="https://example.com/file.pdf">
                                <button type="button" onclick="handleQuizUrl()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600" data-i18n="ai.quiz.use_url">استخدام الرابط</button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="ai.quiz.url_hint">ملاحظة: يجب أن يكون الرابط مباشراً. بعض الروابط قد تُحجب (CORS).</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ai.quiz.settings.type">نوع الأسئلة</label>
                                <select id="questionType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="multiple">اختيار متعدد</option>
                                    <option value="truefalse">صح وخطأ</option>
                                    <option value="mixed">مختلط</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ai.quiz.settings.count">عدد الأسئلة</label>
                                <input id="questionCount" type="number" min="1" step="1" value="100"
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                            </div>
                        </div>
                    </div>

                    <button id="generateQuizBtn" onclick="generateQuiz()" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-magic ml-2"></i><span data-i18n="ai.quiz.button.generate">إنشاء اختبار فوري</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Display Area -->
        <div id="quizContainer" class="hidden mt-8">
            <!-- Quiz content will be injected here -->
        </div>

        <!-- Quiz Results -->
        <div id="quizResults" class="hidden mt-8">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-6">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-trophy ml-3"></i><span data-i18n="ai.quiz.results_title">نتائج الاختبار</span>
                    </h2>
                </div>
                
                <div class="p-6" id="resultsContent">
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        // Simple per-plan daily usage limiter for AI assistant
        function canAskQuestion() {
            try {
                var plan = localStorage.getItem('subscriptionPlan') || 'free';
                var today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                var key = 'ai_usage_' + today;
                var usage;
                try {
                    usage = JSON.parse(localStorage.getItem(key) || '{"count":0}');
                } catch (e) {
                    usage = { count: 0 };
                }

                var limit = 10; // free
                if (plan === 'plus' || plan === 'خطة برو' || plan === 'خطة برو (بلس)') limit = 60;
                if (plan === 'pro_plus' || plan === 'خطة برو بلس') limit = 300;
                if (plan === 'teachers' || plan === 'خطة المدرسين') limit = 1000;

                if (usage.count >= limit) {
                    alert('لقد وصلت إلى الحد الأقصى للأسئلة اليوم في خطتك الحالية. يمكنك الترقية من صفحة الاشتراك لزيادة الحدود.');
                    return false;
                }

                usage.count += 1;
                localStorage.setItem(key, JSON.stringify(usage));
                return true;
            } catch (e) {
                return true; // في حالة أي خطأ لا نمنع المستخدم
            }
        }

        // -------- Lecture content enrichment (PDF/Text extraction) --------
        function normalizePdfUrl(url) {
            try {
                const u = new URL(url);
                const href = u.href;
                // Google Drive: use uc?export=download&id=
                if (u.hostname.includes('drive.google.com')) {
                    const idMatch = href.match(/\/file\/d\/([^/]+)\//);
                    const idFromQuery = u.searchParams.get('id');
                    const fileId = idMatch ? idMatch[1] : idFromQuery;
                    if (fileId) return `https://drive.google.com/uc?export=download&id=${fileId}`;
                }
                // Dropbox share -> direct
                if (u.hostname.includes('dropbox.com')) {
                    // dl=1 forces direct download
                    u.searchParams.set('dl', '1');
                    return u.toString();
                }
                return url;
            } catch (_) { return url; }
        }
        function isPdfUrl(url) { return /\.pdf(?:[?#].*)?$/i.test(url || ''); }
        async function looksLikePdfByContentType(url) {
            try {
                // Try HEAD first
                const h = await fetch(url, { method: 'HEAD' });
                const ct = h.headers.get('content-type') || '';
                if (/application\/pdf/i.test(ct)) return true;
            } catch (_) { /* ignore, may be blocked */ }
            try {
                // Fallback tiny GET if HEAD blocked (some CDNs)
                const g = await fetch(url, { method: 'GET', headers: { 'Range': 'bytes=0-0' } });
                const ct2 = g.headers.get('content-type') || '';
                if (/application\/pdf/i.test(ct2)) return true;
            } catch (_) { /* CORS or blocked */ }
            return false;
        }
        async function extractTextFromPdf(url) {
            if (!window.pdfjsLib) return '';
            try {
                const loadingTask = pdfjsLib.getDocument({ url, withCredentials: false });
                const pdf = await loadingTask.promise;
                let fullText = '';
                for (let p = 1; p <= pdf.numPages; p++) {
                    const page = await pdf.getPage(p);
                    const content = await page.getTextContent();
                    const strings = content.items.map(it => it.str).filter(Boolean);
                    fullText += strings.join(' ') + '\n\n';
                }
                return fullText.trim();
            } catch (e) { console.warn('PDF extraction failed:', e); return ''; }
        }

        // Extract text from a locally uploaded PDF file using pdf.js
        async function extractTextFromLocalPdf(file) {
            if (!window.pdfjsLib) return '';
            try {
                const buffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: buffer });
                const pdf = await loadingTask.promise;
                let fullText = '';
                for (let p = 1; p <= pdf.numPages; p++) {
                    const page = await pdf.getPage(p);
                    const content = await page.getTextContent();
                    const strings = content.items.map(it => it.str).filter(Boolean);
                    fullText += strings.join(' ') + '\n\n';
                }
                return fullText.trim();
            } catch (e) { console.warn('Local PDF extraction failed:', e); return ''; }
        }

        async function extractTextFromLocalDocx(file) {
            try {
                if (!window.mammoth || !window.mammoth.extractRawText) return '';
                const buffer = await file.arrayBuffer();
                const result = await window.mammoth.extractRawText({ arrayBuffer: buffer });
                return (result && result.value) ? result.value.trim() : '';
            } catch (e) { console.warn('Local DOCX extraction failed:', e); return ''; }
        }

        // Handlers to read uploaded files and build concatenated text content
        async function handleQaFilesChange(fileList) {
            if (!fileList || fileList.length === 0) {
                // Do not clear previous uploads; simply return
                return;
            }
            showNotification('جاري معالجة الملفات للمحادثة...', 'info');
            const parts = [];
            for (const file of fileList) {
                const name = file.name || 'ملف';
                if (/\.pdf$/i.test(name)) {
                    const t = await extractTextFromLocalPdf(file);
                    if (t) parts.push(`-- ${name} --\n${t}`);
                } else if (/\.docx$/i.test(name)) {
                    const t = await extractTextFromLocalDocx(file);
                    if (t) parts.push(`-- ${name} --\n${t}`);
                } else if (/\.(txt|md)$/i.test(name)) {
                    try { const t = await file.text(); if (t) parts.push(`-- ${name} --\n${t}`); } catch(_) {}
                } else {
                    showNotification(`صيغة غير مدعومة: ${name}`, 'error');
                }
            }
            const newChunk = parts.join('\n\n');
            uploadedQaText = uploadedQaText ? (uploadedQaText + '\n\n' + newChunk) : newChunk;
            try { const f = fileList[0]; if (f && f.name) { currentExportBaseName = (f.name || 'ملفات مرفوعة').replace(/\.[^.]+$/, ''); } } catch(_){ }
            if (uploadedQaText && uploadedQaText.length > 50) {
                showNotification('تم تجهيز محتوى الملفات للمحادثة', 'success');
            }
            // Enable/select uploaded option
            const sel = document.getElementById('qaLectureSelect');
            let opt = sel?.querySelector('option[value="__uploaded__"]');
            if (!opt) {
                opt = document.createElement('option');
                opt.value = '__uploaded__';
                opt.textContent = t('subjects.stats.files');
                sel?.insertBefore(opt, sel.firstChild?.nextSibling);
            }
            opt.disabled = false;
            sel.value = '__uploaded__';
            enableQA();
            // Allow selecting the same files again by clearing the input value
            try { const qaInput = document.getElementById('qaFiles'); if (qaInput) qaInput.value = ''; } catch(_) {}
        }

        async function handleQuizFilesChange(fileList) {
            const sel = document.getElementById('quizLectureSelect');
            if (!fileList || fileList.length === 0) {
                // Do not clear previous uploads; simply return
                return;
            }
            showNotification('جاري معالجة الملفات للاختبار...', 'info');
            const parts = [];
            for (const file of fileList) {
                const name = file.name || 'ملف';
                if (/\.pdf$/i.test(name)) {
                    const t = await extractTextFromLocalPdf(file);
                    if (t) parts.push(`-- ${name} --\n${t}`);
                } else if (/\.(txt|md)$/i.test(name)) {
                    try { const t = await file.text(); if (t) parts.push(`-- ${name} --\n${t}`); } catch(_) {}
                } else {
                    showNotification(`صيغة غير مدعومة: ${name}`, 'error');
                }
            }
            const newChunk = parts.join('\n\n');
            uploadedQuizText = uploadedQuizText ? (uploadedQuizText + '\n\n' + newChunk) : newChunk;
            if (uploadedQuizText && uploadedQuizText.length > 50) {
                showNotification('تم تجهيز محتوى الملفات للاختبار', 'success');
            }
            // Enable/select uploaded option
            let opt = sel?.querySelector('option[value="__uploaded__"]');
            if (!opt) {
                opt = document.createElement('option');
                opt.value = '__uploaded__';
                opt.textContent = t('subjects.stats.files');
                sel?.insertBefore(opt, sel.firstChild);
            }
            opt.disabled = false;
            sel.value = '__uploaded__';
            // Allow selecting the same files again by clearing the input value
            try { const quizInput = document.getElementById('quizFiles'); if (quizInput) quizInput.value = ''; } catch(_) {}
        }

        // Use direct URL as Q&A source (PDF/TXT/MD)
        async function handleQaUrl() {
            try {
                const input = document.getElementById('qaUrl');
                let url = (input?.value || '').trim();
                if (!url) { showNotification('يرجى إدخال رابط صالح', 'error'); return; }

                url = normalizePdfUrl(url);
                showNotification('جاري قراءة المحتوى من الرابط...', 'info');
                let text = '';

                if (isPdfUrl(url) || await looksLikePdfByContentType(url)) {
                    text = await extractTextFromPdf(url);
                } else if (/\.(txt|md)(?:[?#].*)?$/i.test(url)) {
                    try { const r = await fetch(url); if (r.ok) text = await r.text(); } catch(_) {}
                } else {
                    try {
                        const r = await fetch(url, { headers: { 'Accept': 'text/plain' } });
                        if (r.ok) {
                            const ct = r.headers.get('content-type') || '';
                            if (/text\//i.test(ct)) text = await r.text();
                        }
                    } catch(_) {}
                }

                if (!text || text.trim().length < 50) {
                    showNotification('تعذر قراءة محتوى كافٍ من الرابط. تأكد أن الرابط مباشر لملف PDF أو TXT.', 'warning');
                    return;
                }

                uploadedQaText = `-- URL --\n${text}`;
                try { currentExportBaseName = deriveNameFromUrl(url); } catch(_){ }

                // select uploaded option and enable QA
                const sel = document.getElementById('qaLectureSelect');
                let opt = sel?.querySelector('option[value="__uploaded__"]');
                if (!opt) {
                    opt = document.createElement('option');
                    opt.value = '__uploaded__';
                    opt.textContent = t('subjects.stats.files');
                    sel?.insertBefore(opt, sel.firstChild?.nextSibling);
                }
                opt.disabled = false;
                sel.value = '__uploaded__';
                enableQA();

                showNotification('تم تجهيز محتوى الرابط للمحادثة', 'success');
            } catch (e) {
                console.warn('handleQaUrl error:', e);
                showNotification('حدث خطأ أثناء معالجة الرابط', 'error');
            }
        }

        // Aggregate selected lectures into the uploaded pools
        async function addCurrentLectureToQaUploads() {
            try {
                const sel = document.getElementById('qaLectureSelect');
                const val = sel?.value || '';
                if (!val || val === '__uploaded__' || val === '__platform__') {
                    showNotification('يرجى اختيار محاضرة فعلية لإضافتها', 'warning');
                    return;
                }

                const lectureResult = await window.supabaseDB.lectures.getWithContent(val);
                const lecture = lectureResult?.data;
                if (!lecture) { showNotification('تعذر العثور على المحاضرة', 'error'); return; }

                // Enrich/collect content
                let content = '';
                try {
                    content = await buildLectureContentFallback(lecture);
                } catch(_) {}
                if (!content || content.trim().length < 20) {
                    showNotification('لا يوجد محتوى كافٍ في هذه المحاضرة', 'warning');
                    return;
                }

                const title = lecture.title || 'محاضرة';
                try { currentExportBaseName = title; } catch(_){ }
                const chunk = `-- ${title} --\n${content}`;
                uploadedQaText = uploadedQaText ? (uploadedQaText + "\n\n" + chunk) : chunk;

                // Ensure uploaded option exists and select it
                let opt = sel.querySelector('option[value="__uploaded__"]');
                if (!opt) {
                    opt = document.createElement('option');
                    opt.value = '__uploaded__';
                    opt.textContent = t('subjects.stats.files');
                    sel?.insertBefore(opt, sel.firstChild?.nextSibling);
                }
                opt.disabled = false;
                sel.value = '__uploaded__';
                enableQA();
                showNotification('تمت إضافة المحاضرة إلى الملفات المرفوعة للمحادثة', 'success');
            } catch (e) {
                console.warn('addCurrentLectureToQaUploads error:', e);
                showNotification('حدث خطأ أثناء إضافة المحاضرة', 'error');
            }
        }

        async function addSelectedLecturesToQuizUploads() {
            try {
                const sel = document.getElementById('quizLectureSelect');
                const ids = Array.from(sel?.selectedOptions || [])
                    .map(o => o.value)
                    .filter(v => v && v !== '__uploaded__');
                if (!ids.length) {
                    showNotification('يرجى اختيار محاضرة أو أكثر لإضافتها', 'warning');
                    return;
                }

                showNotification('جاري جمع محتوى المحاضرات المختارة...', 'info');
                const parts = [];
                for (const id of ids) {
                    try {
                        const lectureResult = await window.supabaseDB.lectures.getWithContent(id);
                        const lecture = lectureResult?.data;
                        if (!lecture) continue;
                        let content = '';
                        try { content = await buildLectureContentFallback(lecture); } catch(_) {}
                        if (content && content.trim().length >= 20) {
                            const title = lecture.title || 'محاضرة';
                            parts.push(`-- ${title} --\n${content}`);
                        }
                    } catch(_) {}
                }

                if (!parts.length) {
                    showNotification('لم يتم العثور على محتوى كافٍ في المحاضرات المختارة', 'warning');
                    return;
                }

                // Merge into uploaded quiz text (append to existing content if present)
                const newChunk = parts.join('\n\n');
                uploadedQuizText = uploadedQuizText ? (uploadedQuizText + '\n\n' + newChunk) : newChunk;

                // Ensure uploaded option exists and select it
                let opt = sel.querySelector('option[value="__uploaded__"]');
                if (!opt) {
                    opt = document.createElement('option');
                    opt.value = '__uploaded__';
                    opt.textContent = t('subjects.stats.files');
                    sel?.insertBefore(opt, sel.firstChild);
                }
                opt.disabled = false;
                sel.value = '__uploaded__';

                const btn = document.getElementById('generateQuizBtn');
                if (btn) btn.disabled = false;

                showNotification('تم جمع المحاضرات في الملفات المرفوعة للاختبار', 'success');
            } catch (e) {
                console.warn('addSelectedLecturesToQuizUploads error:', e);
                showNotification('حدث خطأ أثناء جمع المحاضرات', 'error');
            }
        }
        // Use direct URL as quiz source (PDF/TXT/MD)
        async function handleQuizUrl() {
            try {
                const input = document.getElementById('quizUrl');
                let url = (input?.value || '').trim();
                if (!url) { showNotification('يرجى إدخال رابط صالح', 'error'); return; }

                url = normalizePdfUrl(url);
                showNotification('جاري قراءة المحتوى من الرابط...', 'info');
                let text = '';

                if (isPdfUrl(url) || await looksLikePdfByContentType(url)) {
                    text = await extractTextFromPdf(url);
                } else if (/\.(txt|md)(?:[?#].*)?$/i.test(url)) {
                    try { const r = await fetch(url); if (r.ok) text = await r.text(); } catch(_) {}
                } else {
                    try {
                        const r = await fetch(url, { headers: { 'Accept': 'text/plain' } });
                        if (r.ok) {
                            const ct = r.headers.get('content-type') || '';
                            if (/text\//i.test(ct)) text = await r.text();
                        }
                    } catch(_) {}
                }

                if (!text || text.trim().length < 50) {
                    showNotification('تعذر قراءة محتوى كافٍ من الرابط. تأكد أن الرابط مباشر لملف PDF أو TXT.', 'warning');
                    return;
                }

                uploadedQuizText = `-- URL --\n${text}`;

                // select uploaded option and enable generate
                const sel = document.getElementById('quizLectureSelect');
                let opt = sel?.querySelector('option[value="__uploaded__"]');
                if (!opt) {
                    opt = document.createElement('option');
                    opt.value = '__uploaded__';
                    opt.textContent = 'الملفات المرفوعة';
                    sel?.insertBefore(opt, sel.firstChild);
                }
                opt.disabled = false;
                sel.value = '__uploaded__';
                const btn = document.getElementById('generateQuizBtn');
                if (btn) btn.disabled = false;

                showNotification('تم تجهيز محتوى الرابط للاختبار', 'success');
            } catch (e) {
                console.warn('handleQuizUrl error:', e);
                showNotification('حدث خطأ أثناء معالجة الرابط', 'error');
            }
        }

        
        async function buildLectureContentFallback(lecture) {
            // If DB already has rich content, prefer it
            if (lecture.full_content && String(lecture.full_content).trim()) return lecture.full_content;
            if (lecture.file_content && String(lecture.file_content).trim()) return lecture.file_content;

            let url = lecture.file_url || lecture.content_url || lecture.url || lecture.attachment_url || lecture.download_url || '';
            if (url) url = normalizePdfUrl(url);
            if (url) {
                if (isPdfUrl(url) || await looksLikePdfByContentType(url)) {
                    const text = await extractTextFromPdf(url);
                    if (text && text.length > 100) return text;
                } else if (/\.(txt|md)(?:[?#].*)?$/i.test(url)) {
                    try { const r = await fetch(url); if (r.ok) { const t = await r.text(); if (t && t.trim()) return t; } } catch(_) {}
                } else {
                    // Inform user once if URL likely not readable due to CORS/HTML viewer
                    try { showNotification('الرابط ليس PDF مباشر أو يمنع الوصول (CORS). استخدم رابط PDF مباشر أو ارفع الملف.', 'info'); } catch(_) {}
                }
            }

            // Minimal but structured fallback
            let content = `عنوان المحاضرة: ${lecture.title || ''}` + "\n";
            if (lecture.description) content += `وصف المحاضرة: ${lecture.description}` + "\n";
            if (url) content += `رابط الملف: ${url}` + "\n";
            if (lecture.notes) content += `ملاحظات إضافية: ${lecture.notes}` + "\n";
            return content;
        }
        // Gemini API Configuration
        // تأكد من أن هذا المفتاح صحيح لضمان عمل النموذج 'الحقيقي'
        const GEMINI_API_KEY ="AIzaSyDmhatjaBlH9Vs_Zt8vgp7cnosrZuLzMZc";
        
        let currentUser = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let uploadedQaText = '';
        let uploadedQuizText = '';
        let lastUserQuestion = "";
        let currentExportBaseName = "";

        function detectLanguage(text) {
            try {
                const sample = (text || '').slice(0, 2000);
                const arMatches = sample.match(/[\u0600-\u06FF]/g) || [];
                const enMatches = sample.match(/[A-Za-z]/g) || [];
                if (arMatches.length === 0 && enMatches.length === 0) return 'ar';
                return arMatches.length >= enMatches.length ? 'ar' : 'en';
            } catch (_) { return 'ar'; }
        }

        // Optional platform context for answering questions about the platform itself
        const platformContext = `المنصة تحتوي على صفحات رئيسية: الصفحة الرئيسية، المواد الدراسية، المخطط الدراسي، مؤقت المذاكرة، والمساعد الذكي. يمكن للمستخدم إضافة مواد، إضافة محاضرات وروابط ملفات لها، ثم استخدام المساعد الذكي لطرح الأسئلة وإنشاء اختبارات.`;

        /**
         * Get AI text response from Gemini API for Q&A, grounded in lecture context.
         * @param {string} textPrompt - User's question or prompt
         * @param {object} lectureContext - Lecture context for educational responses
         * @returns {Promise<string>} The generated text response.
         */
        async function getGeminiQaResponse(textPrompt, lectureContext) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            // Build comprehensive context from lecture data
            let lectureContent = '';
            // Prioritize the dedicated full content if available
            if (lectureContext.full_content) {
                lectureContent = lectureContext.full_content;
            } else {
                // Fallback compilation if full_content is missing
                lectureContent = `عنوان المحاضرة: ${lectureContext.title}\n`;
                if (lectureContext.description) lectureContent += `وصف المحاضرة: ${lectureContext.description}\n`;
                if (lectureContext.file_content) lectureContent += `محتوى الملف: ${lectureContext.file_content}\n`;
                // Add any available URL so the model knows the source when no extracted text exists
                const urlField = lectureContext.file_url || lectureContext.content_url || lectureContext.url || lectureContext.attachment_url || lectureContext.download_url || '';
                if (urlField) lectureContent += `رابط الملف: ${urlField}\n`;
                if (lectureContext.notes) lectureContent += `ملاحظات إضافية: ${lectureContext.notes}\n`;
            }

            // Determine content strength and languages
            const contentWeak = !lectureContext.full_content && (!lectureContext.file_content || String(lectureContext.file_content).trim().length < 80);
            const lectureLang = detectLanguage(lectureContent);
            const questionLang = detectLanguage(textPrompt || '');
            const respLang = questionLang || lectureLang || 'ar';

            const systemInstructionText = respLang === 'ar'
                ? (contentWeak
                    ? `أنت خبير أكاديمي. أجب باللغة العربية الفصحى وبأسلوب واضح.

قواعد:
1) إذا كان المحتوى المتاح محدوداً، اذكر ذلك بجملة قصيرة أولاً.
2) اعتمد فقط على محتوى المحاضرة المرفق، ويمكنك ترجمة المقتطفات للشرح إن كانت بلغة مختلفة.
3) قدّم إجابة تعليمية دقيقة ومنظمة (عناوين، قوائم) دون اختلاق معلومات.
4) إن كانت هناك معلومات ناقصة، وضّح المطلوب.`
                    : `أنت خبير أكاديمي ومتخصص في تحليل المحاضرات. أجب بالعربية واعتمد فقط على محتوى المحاضرة المقدم (ترجم المقتطفات عند الحاجة دون إضافة معلومات خارج النص).

قواعد:
1) استخدم محتوى المحاضرة فقط.
2) اجعل الإجابة عربية فصحى ومنسقة.
3) إذا لم تجد المعلومة داخل النص، اذكر ذلك.`)
                : (contentWeak
                    ? `You are an academic expert. Answer in clear, formal English.

Rules:
1) If the available content is limited, state that briefly first.
2) Ground strictly in the provided lecture content; translate excerpts if the source language differs.
3) Provide a concise, structured answer (headings, lists) without hallucinating.
4) If information is missing, say what exactly is needed.`
                    : `You are an academic expert specialized in lecture analysis. Answer in English strictly based on the provided lecture content (you may translate excerpts when needed, but do not add outside info).

Rules:
1) Use only the lecture content.
2) Keep a professional, structured English style.
3) If the information is not present, say so.`);

            // User Query Content
            const userContentParts = [
                {
                    text: (respLang === 'ar'
                        ? `محتوى المحاضرة المتاح الذي يجب عليك الاعتماد عليه:\n======================================\n${lectureContent}\n======================================`
                        : `Lecture content you must rely on:\n======================================\n${lectureContent}\n======================================`)
                },
                {
                    text: (respLang === 'ar' ? `سؤال الطالب: ${textPrompt}` : `Student question: ${textPrompt}`)
                }
            ];

            const payload = {
                contents: [{ parts: userContentParts }],
                systemInstruction: { parts: [{ text: systemInstructionText }] },
            };

            try {
                // Implementing simple retry mechanism for robustness
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    if (i < MAX_RETRIES - 1) {
                        console.warn(`Retry attempt ${i + 1} for Gemini Q&A due to status ${response.status}`);
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Exponential backoff
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `خطأ في الخادم: ${response.status}`);
                    }
                }

                const result = await response.json();
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponse) {
                    // If content was weak, show a gentle notice once
                    try {
                        if (contentWeak) {
                            showNotification('تنبيه: لا يوجد نص للمحاضرة، تم تقديم إجابة عامة بناءً على العنوان/الوصف.', 'info');
                        }
                    } catch (_) {}
                    return aiResponse;
                } else {
                    throw new Error('لم يتمكن الذكاء الاصطناعي من إنشاء رد (قد يكون المحتوى غير كافٍ للإجابة).');
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                // Return a user-friendly error message
                return `عذراً، حدث خطأ في الاتصال بالذكاء الاصطناعي أو انتهت مهلة الرد: ${error.message}. يرجى المحاولة بسؤال آخر أو اختيار محاضرة مختلفة.`;
            }
        }

        /**
         * Get AI structured JSON response for Quiz generation.
         */
        async function getGeminiQuiz(lectureContent, questionCount, questionType) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            // Define the JSON schema for the quiz structure (ensures 100% valid JSON output)
            const quizSchema = {
                type: "OBJECT",
                properties: {
                    title: { type: "STRING", description: "عنوان جذاب ومناسب للاختبار." },
                    questions: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                question: { type: "STRING", description: "نص السؤال." },
                                type: { type: "STRING", description: "نوع السؤال: 'multiple' أو 'truefalse'." },
                                options: { 
                                    type: "ARRAY", 
                                    items: { type: "STRING" },
                                    description: "قائمة بالخيارات (مثلاً: أ) الخيار الأول، ب) الخيار الثاني، ج) الخيار الثالث، د) الخيار الرابع) أو (صح، خطأ)."
                                },
                                correct: { type: "INTEGER", description: "مؤشر الإجابة الصحيحة في قائمة الخيارات (0، 1، 2، 3 أو 0، 1)." }
                            },
                            required: ["question", "type", "options", "correct"]
                        }
                    }
                },
                required: ["title", "questions"]
            };

            const lang = detectLanguage(lectureContent);
            let questionTypeInstructions = '';
            if (questionType === 'multiple') {
                questionTypeInstructions = (lang === 'ar')
                    ? `أنشئ ${questionCount} سؤال اختيار من متعدد (multiple) بـ 4 خيارات لكل سؤال.`
                    : `Create ${questionCount} multiple-choice (multiple) questions with 4 options each.`;
            } else if (questionType === 'truefalse') {
                questionTypeInstructions = (lang === 'ar')
                    ? `أنشئ ${questionCount} سؤال صح وخطأ (truefalse) بخيارين (صح أو خطأ) لكل سؤال.`
                    : `Create ${questionCount} true/false (truefalse) questions with two options (True or False).`;
            } else if (questionType === 'mixed') {
                const multipleCount = Math.ceil(questionCount * 0.6);
                const trueFalseCount = questionCount - multipleCount;
                questionTypeInstructions = (lang === 'ar')
                    ? `أنشئ ${multipleCount} سؤال اختيار من متعدد (multiple) و ${trueFalseCount} سؤال صح وخطأ (truefalse).`
                    : `Create ${multipleCount} multiple-choice (multiple) and ${trueFalseCount} true/false (truefalse) questions.`;
            }

            const quizPrompt = (lang === 'ar')
                ? `أنت خبير في إنشاء اختبارات تعليمية. مهمتك هي إنشاء اختبار تعليمي باللغة المناسبة للمحتوى (هنا: العربية) بناءً على محتوى المحاضرة المقدم.

**التعليمات:**
- **المحتوى**: يجب أن تكون جميع الأسئلة والإجابات الصحيحة مستمدة **فقط** من محتوى المحاضرة المرفق أدناه.
- **العدد والنوع**: ${questionTypeInstructions}
- **التنسيق**: يجب أن يغطي الإخراج جميع المحاور المهمة في المحتوى، مع أسئلة واضحة ومنظمة، وأجوبة صحيحة واضحة، وبدون مقدمات أو خواتيم.

محتوى المحاضرة:
======================================
${lectureContent}
======================================`
                : `You are an expert at creating educational quizzes. Your task is to produce a quiz in English, based strictly on the provided lecture content.

Instructions:
- Content: All questions and correct answers must be derived ONLY from the lecture content below.
- Count and type: ${questionTypeInstructions}
- Format: Output must be valid JSON following the provided schema, with no extra text before or after the JSON.

Lecture content:
======================================
${lectureContent}
======================================`;

            const payload = {
                contents: [{ parts: [{ text: quizPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: quizSchema
                }
            };

            try {
                // Implementing simple retry mechanism for robustness
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    if (i < MAX_RETRIES - 1) {
                        console.warn(`Retry attempt ${i + 1} for Gemini Quiz due to status ${response.status}`);
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Exponential backoff
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `خطأ في الخادم: ${response.status}`);
                    }
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    return JSON.parse(jsonText);
                } else {
                    throw new Error('لم يتمكن الذكاء الاصطناعي من إنشاء JSON صالح أو كانت الاستجابة فارغة.');
                }
            } catch (error) {
                console.error("Gemini API Error (Quiz):", error);
                throw new Error(`فشل الاتصال بـ Gemini أو تحليل الاستجابة: ${error.message}`);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Supabase
                if (window.initializeSupabase) {
                    await window.initializeSupabase();
                }
                
                // Wait for authentication
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check authentication
                const isAuthenticated = await checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                // Load user data and lectures
                await loadUserData();
                await loadLectures();
                
                console.log('✅ AI Assistant initialized successfully');
                
            } catch (error) {
                console.error('❌ Error initializing AI assistant:', error);
                showNotification('حدث خطأ في تحميل المساعد الذكي', 'error');
            }
        });

        // Check authentication
        async function checkAuthentication() {
            try {
                if (!window.supabaseClient || !window.supabaseAuth) {
                    return false;
                }
                
                const { data } = await window.supabaseAuth.getSession();
                if (data?.session?.user) {
                    currentUser = data.session.user;
                    localStorage.setItem('userEmail', currentUser.email);
                    localStorage.setItem('userId', currentUser.id);
                    localStorage.setItem('userName', currentUser.user_metadata?.full_name || currentUser.email.split('@')[0]);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Authentication check error:', error);
                return false;
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const userName = localStorage.getItem('userName') || currentUser?.email?.split('@')[0] || 'المستخدم';
                // const userEmail = localStorage.getItem('userEmail') || currentUser?.email || ''; // Unused variable
                document.getElementById('userEmail').textContent = `مرحباً، ${userName}`;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load lectures for dropdown
        async function loadLectures() {
            try {
                if (!currentUser) {
                    console.warn('No current user available');
                    return;
                }

                // Load subjects from database
                const subjectsResult = await window.supabaseDB.subjects.getByUser(currentUser.id);
                if (subjectsResult.error) {
                    console.error('Error loading subjects:', subjectsResult.error);
                    return;
                }

                const subjects = subjectsResult.data || [];
                const qaLectureSelect = document.getElementById('qaLectureSelect');
                const quizLectureSelect = document.getElementById('quizLectureSelect');
                
                // Reset and add special options
                qaLectureSelect.innerHTML = '<option value="">-- اختر محاضرة --</option>';
                // Platform (general) option
                const platformOpt = document.createElement('option');
                platformOpt.value = '__platform__';
                platformOpt.textContent = 'المنصة (عام)';
                qaLectureSelect.appendChild(platformOpt);
                // Uploaded files placeholder option (disabled until files uploaded)
                const uploadedQaOpt = document.createElement('option');
                uploadedQaOpt.value = '__uploaded__';
                uploadedQaOpt.textContent = 'الملفات المرفوعة';
                uploadedQaOpt.disabled = !(uploadedQaText && uploadedQaText.length > 0);
                qaLectureSelect.appendChild(uploadedQaOpt);

                // Quiz select reset and uploaded option (disabled until files uploaded)
                quizLectureSelect.innerHTML = '';
                const uploadedQuizOpt = document.createElement('option');
                uploadedQuizOpt.value = '__uploaded__';
                uploadedQuizOpt.textContent = 'الملفات المرفوعة';
                uploadedQuizOpt.disabled = !(uploadedQuizText && uploadedQuizText.length > 0);
                quizLectureSelect.appendChild(uploadedQuizOpt);

                // Load lectures for each subject
                let hasLectures = false;
                for (const subject of subjects) {
                    const lecturesResult = await window.supabaseDB.lectures.getBySubject(subject.id);
                    if (lecturesResult.data && lecturesResult.data.length > 0) {
                        hasLectures = true;
                        lecturesResult.data.forEach(lecture => {
                            const lectureTitle = `${lecture.title} - ${subject.name}`;

                            // Add to Q&A dropdown
                            const qaOption = document.createElement('option');
                            qaOption.value = lecture.id;
                            qaOption.textContent = lectureTitle;
                            qaLectureSelect.appendChild(qaOption);

                            // Add to Quiz dropdown
                            const quizOption = document.createElement('option');
                            quizOption.value = lecture.id;
                            quizOption.textContent = lectureTitle;
                            quizLectureSelect.appendChild(quizOption);
                        });
                    }
                }

                if (!hasLectures) {
                    const noLectureText = '<option value="" disabled>لا توجد محاضرات متاحة - أضف محاضرات</option>';
                    qaLectureSelect.innerHTML = noLectureText;
                    quizLectureSelect.innerHTML = noLectureText;
                }

                console.log('✅ Lectures loaded from database');

            } catch (error) {
                console.error('❌ Error loading lectures:', error);
                showNotification('حدث خطأ في تحميل المحاضرات', 'error');
            }
        }

        // Enable Q&A when lecture is selected
        function enableQA() {
            const lectureId = document.getElementById('qaLectureSelect').value;
            const questionInput = document.getElementById('questionInput');
            const askBtn = document.getElementById('askBtn');
            const chatArea = document.getElementById('chatArea');
            const isUploaded = lectureId === '__uploaded__' && uploadedQaText.length > 0;
            const isPlatform = lectureId === '__platform__';
            
            if ((lectureId && lectureId !== '__uploaded__' && lectureId !== '') || isUploaded || isPlatform) {
                questionInput.disabled = false;
                askBtn.disabled = false;
                
                chatArea.innerHTML = `
                    <div class="ai-message chat-message">
                        <p>مرحباً! يمكنك الآن طرح أي سؤال بناءً على المصدر المحدد (محاضرة/ملفات/وضع المنصة).</p>
                    </div>
                `;
            } else {
                questionInput.disabled = true;
                askBtn.disabled = true;
                chatArea.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-robot text-4xl mb-2"></i>
                        <p>مرحباً! اختر محاضرة واسأل أي سؤال تريد</p>
                    </div>
                `;
            }
            scrollToBottom();
        }

        // Enable quiz generation when lectures are selected
        document.getElementById('quizLectureSelect').addEventListener('change', function() {
            const selectedLectures = Array.from(this.selectedOptions);
            document.getElementById('generateQuizBtn').disabled = selectedLectures.length === 0;
        });

        // Handle Enter key for questions
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function setQuestionValue(text){
            const input = document.getElementById('questionInput');
            if (!input) return;
            input.value = text;
            input.focus();
        }

        function openTemplate(id){
            if (id === 'research'){
                const topic = window.prompt('اكتب موضوعك الرئيسي هنا');
                if (topic === null) return;
                const term1 = window.prompt('اكتب مصطلح 1 (اختياري)');
                const term2 = window.prompt('اكتب مصطلح 2 (اختياري)');
                const style = window.prompt('تنسيق المراجع (مثال: APA 7). اتركه فارغاً لاستخدام APA 7');
                const p = `يا مساعدي الذكي،
أنا أبدأ بحثًا جديدًا حول "${topic}".
أطلب منك تنفيذ المهام التالية:
مراجعة الأدبيات: قم بإجراء مراجعة أدبيات شاملة ومنظمة للأبحاث المنشورة في آخر 5 سنوات (من 2020 إلى 2025) حول هذا الموضوع.
تحديد الثغرات البحثية (Gaps): بناءً على المراجعة، ما هي الفجوات البحثية الرئيسية أو الأسئلة التي لم تتم الإجابة عليها بعد في هذا المجال؟
شرح المفاهيم: اشرح لي بوضوح المفهومين التاليين: ${term1 && term1.trim() ? term1 : '[اكتب مصطلح 1]'} و ${term2 && term2.trim() ? term2 : '[اكتب مصطلح 2]'} في سياق هذا البحث.
إنشاء المراجع: قم بإنشاء قائمة بجميع المراجع التي اعتمدت عليها في المراجعة بتنسيق ${style && style.trim() ? style : 'APA 7'}.
أريد أن يكون التقرير النهائي منظمًا وسهل القراءة.`;
                setQuestionValue(p);
                return;
            }
            if (id === 'paper'){
                const tableNo = window.prompt('رقم الجدول المطلوب شرحه (اختياري)');
                const pageNo = window.prompt('رقم الصفحة للرسوم البيانية (اختياري)');
                const p = `بناءً على الورقة التي قمت برفعها:
ما هي المشكلة البحثية الرئيسية (Research Problem) التي يعالجها المؤلفون؟
لخص لي المنهجية (Methodology) التي اتبعوها في 3 نقاط.
استخرج لي أهم النتائج (Key Findings) التي توصلوا إليها.
اشرح لي الجدول رقم ${tableNo && tableNo.trim() ? tableNo : '[رقم الجدول]'} والرسوم البيانية في الصفحة ${pageNo && pageNo.trim() ? pageNo : '[رقم الصفحة]'}.
هل ذكر المؤلفون أي قيود (Limitations) على دراستهم؟ وما هي؟`;
                setQuestionValue(p);
                return;
            }
            if (id === 'paraphrase'){
                const original = window.prompt('الصق الفقرة الأصلية هنا');
                if (original === null) return;
                const p = `أعد صياغة الفقرة التالية بأسلوب أكاديمي احترافي، مع الحفاظ على المعنى الأصلي. اجعل النص أقوى ورسميًا أكثر، وركز على توضيح العلاقة بين المتغيرات.
${original}`;
                setQuestionValue(p);
                return;
            }
            if (id === 'topics'){
                const field = window.prompt('اكتب المجال العام (مثال: الأمن السيبراني في أنظمة إنترنت الأشياء)');
                if (field === null) return;
                const p = `أنا مهتم بمجال "${field}".
اقترح عليّ 5 مواضيع بحثية جديدة ومبتكرة في هذا المجال. يجب أن تكون هذه المواضيع مبنية على ثغرات بحثية حقيقية (Research Gaps) في الأدبيات الحالية. لكل موضوع، اذكر بإيجاز ما هي الثغرة التي يعالجها.`;
                setQuestionValue(p);
                return;
            }
        }

        // Send message
        async function sendMessage() {
            if (!canAskQuestion()) return;
            const input = document.getElementById('questionInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const lectureSelect = document.getElementById('qaLectureSelect');
            if (!lectureSelect.value) {
                showNotification('يرجى اختيار محاضرة أو رفع ملفات أو تفعيل وضع المنصة أولاً', 'error');
                return;
            }

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message typing-indicator-wrapper';
            typingDiv.innerHTML = `
                <div class="ai-message">
                    <div class="flex items-center">
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="typing-indicator"></span>
                        <span class="mr-2">المساعد يكتب...</span>
                    </div>
                </div>
            `;
            document.getElementById('chatArea').appendChild(typingDiv);
            scrollToBottom();

            try {
                let lecture = null;
                const selVal = lectureSelect.value;
                if (selVal === '__platform__') {
                    lecture = { title: 'منصة الطالب الذكي', full_content: platformContext };
                } else if (selVal === '__uploaded__') {
                    if (!uploadedQaText) throw new Error('لم يتم رفع ملفات بعد');
                    lecture = { title: 'ملفات مرفوعة', full_content: uploadedQaText };
                } else {
                    const lectureId = selVal;
                    const lectureResult = await window.supabaseDB.lectures.getWithContent(lectureId);
                    lecture = lectureResult.data;
                    if (!lecture) throw new Error('لم يتم العثور على المحاضرة');
                }

                // Enrich lecture content if needed
                try {
                    if (!lecture.full_content || !(lecture.file_content || '').trim() || (lecture.file_content || '').trim().length < 80) {
                        const enriched = await buildLectureContentFallback(lecture);
                        if (enriched && enriched.trim()) {
                            lecture.full_content = enriched;
                        }
                    }
                } catch (_) {}

                // Set export base name from current source selection
                try {
                    if (selVal === '__platform__') {
                        currentExportBaseName = 'منصة الطالب الذكي';
                    } else if (selVal === '__uploaded__') {
                        // keep currentExportBaseName as set by upload/url handlers
                        if (!currentExportBaseName) currentExportBaseName = 'ملفات مرفوعة';
                    } else if (lecture && lecture.title) {
                        currentExportBaseName = lecture.title;
                    }
                } catch (_) {}

                const comprehensive = buildComprehensivePrompt(message);
                let response = '';
                try {
                    response = await backendAsk(comprehensive, lecture.full_content || lecture.file_content || '');
                } catch(_) {}
                if (!response || response.trim().length < 5) {
                    response = await getGeminiQaResponse(comprehensive, lecture);
                }
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add AI response
                addMessage(response, 'ai');
                
            } catch (error) {
                console.error('Error generating response:', error);
                typingDiv.remove();
                addMessage('عذراً، حدث خطأ في معالجة سؤالك. يرجى المحاولة مرة أخرى.', 'ai');
            }
        }

        async function resolveCurrentSource() {
            const lectureSelect = document.getElementById('qaLectureSelect');
            const selVal = lectureSelect?.value || '';
            if (selVal === '__platform__') {
                return { title: 'منصة الطالب الذكي', content: platformContext };
            } else if (selVal === '__uploaded__') {
                if (!uploadedQaText) throw new Error('لم يتم رفع ملفات بعد');
                return { title: 'ملفات مرفوعة', content: uploadedQaText };
            } else if (selVal) {
                const lectureResult = await window.supabaseDB.lectures.getWithContent(selVal);
                const lecture = lectureResult?.data;
                if (!lecture) throw new Error('لم يتم العثور على المحاضرة');
                let content = '';
                try { content = await buildLectureContentFallback(lecture); } catch(_) {}
                const merged = content || lecture.full_content || lecture.file_content || '';
                return { title: lecture.title || 'محاضرة', content: merged };
            }
            throw new Error('يرجى اختيار محاضرة أو رفع ملفات أو تفعيل وضع المنصة');
        }

        const API_BASE_FALLBACK = 'https://student-platform-backend-one.vercel.app';
        async function postJsonWithFallback(path, payload){
            // Always prefer calling the backend domain first (works on dev and prod)
            try {
                const rBackend = await fetch(`${API_BASE_FALLBACK}${path}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                if (rBackend.ok) return await rBackend.json();
            } catch(_) { /* proceed to same-origin fallback */ }
            // Fallback to same-origin only if backend unreachable
            try{
                const rSame = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                if (rSame.ok) return await rSame.json();
            }catch(__){ return null; }
            return null;
        }
        async function backendAsk(question, context){
            const j = await postJsonWithFallback('/api/ai/ask', { question, context });
            return j && j.response ? j.response : '';
        }
        function buildComprehensivePrompt(q){
            try{
                const base = (q || '').trim();
                const addon = `\n\nرجاءً قدّم الإجابة مقسّمة ومنظمة بالعناوين التالية (إن وُجدت معلومات لكل جزء)، مع دعم العربية والإنجليزية حسب لغة المحتوى:\n\n1) إذا كان المحتوى أو السؤال باللغة الإنجليزية أو يغلب عليه الإنجليزي:\n- اكتب أولاً شرحاً كاملاً وواضحاً باللغة الإنجليزية.\n- ثم تحته مباشرة اكتب نفس الشرح مترجماً ومفسَّراً باللغة العربية (ليس ترجمة حرفية فقط، بل شرح مبسّط).\n- حافظ على نفس العناوين والأقسام في اللغتين.\n\n2) إذا كان المحتوى أو السؤال باللغة العربية فقط:\n- اجعل الإجابة بالكامل بالعربية كما هي، مع توضيح وتنظيم جيد.\n\nاستخدم الهيكل التالي قدر الإمكان:\n\nشرح / Explanation:\n[شرح مفصل ومبسّط للنص/الموضوع، بالإنجليزي ثم العربي إذا كان النص إنجليزي]\n\nملخص / Summary:\n[تلخيص واضح بالنقاط، بالإنجليزي ثم العربي إذا كان النص إنجليزي]\n\nبحث شامل / Detailed Study:\n[عرض موسّع مع معلومات داعمة ومراجع إن أمكن]\n\nتحليل الورقة (إن وُجدت ورقة PDF) / Paper Analysis:\n[تحليل المنهجية والنتائج والنقاش]\n\nإعادة صياغة / Paraphrasing:\n[إعادة صياغة محكمة للفقرة/النص]\n\nثغرات بحثية / Research Gaps:\n[قائمة بالثغرات والفرص البحثية]\n\nتوصيات / Recommendations:\n[نصائح عملية وخطوات تالية]`;
                return base + addon;
            }catch(_){ return q || ''; }
        }

        // --- TTS helpers ---
        function splitTextForTts(t){
            const maxChunkChars = 1000; // conservative per-request
            const seps = /([\.\!\?\n]|[\u061F\u06D4])+/; // include Arabic question mark/stop
            const parts = t.split(seps).reduce((acc, piece)=>{
                if (!piece) return acc;
                if (seps.test(piece)) { // separator
                    if (acc.length) acc[acc.length-1] += piece;
                    else acc.push(piece);
                } else {
                    acc.push(piece);
                }
                return acc;
            }, []);
            const out = [];
            let buf = '';
            for (const p of parts){
                if ((buf + p).length > maxChunkChars){
                    if (buf) out.push(buf.trim());
                    buf = p;
                } else {
                    buf += p;
                }
            }
            if (buf.trim()) out.push(buf.trim());
            return out;
        }

        async function responseToArrayBuffer(j){
            let src = j?.audio || j?.audioUrl || j?.url || '';
            if (j?.base64) {
                const bstr = atob(j.base64);
                const bytes = new Uint8Array(bstr.length);
                for (let i=0;i<bstr.length;i++) bytes[i] = bstr.charCodeAt(i);
                return bytes.buffer;
            }
            if (!src) return null;
            const r = await fetch(src);
            if (!r.ok) return null;
            return await r.arrayBuffer();
        }

        function concatArrayBuffers(buffers){
            const total = buffers.reduce((s,b)=> s + (b?.byteLength||0), 0);
            const out = new Uint8Array(total);
            let offset = 0;
            for (const b of buffers){
                if (!b) continue;
                const u = new Uint8Array(b);
                out.set(u, offset);
                offset += u.byteLength;
            }
            return out.buffer;
        }

        async function synthesizeLargeTts(text, maxBytes){
            const chunks = splitTextForTts(text);
            const buffers = [];
            let total = 0;
            for (const c of chunks){
                const j = await postJsonWithFallback('/api/tts', { text: c });
                const buf = await responseToArrayBuffer(j);
                if (!buf) continue;
                total += buf.byteLength; if (total > maxBytes) break;
                buffers.push(buf);
            }
            if (!buffers.length) return '';
            // Concatenate MP3 frames (works with most browsers/encoders)
            const merged = concatArrayBuffers(buffers);
            const blob = new Blob([merged], { type: 'audio/mpeg' });
            return URL.createObjectURL(blob);
        }

        // --- Dialogue summary (male teacher vs female student) ---
        async function buildDialogueSummary(fullText){
            try{
                const maxChunk = 12000;
                const chunks = [];
                for (let i=0; i<fullText.length; i+=maxChunk){ chunks.push(fullText.slice(i, i+maxChunk)); }
                if (chunks.length <= 1){
                    const p = 'لخّص المحتوى التالي على هيئة حوار تعليمي موجز بين "المدرّس" (رجل) و"الطالبة" (بنت). اجعل الحوار مناسباً للاستماع: 4–8 تبادلات كحد أقصى، جُمل قصيرة واضحة، تغطي أهم الأفكار مع أمثلة صغيرة عند الحاجة. استخدم صيغاً مثل: المدرّس: ...\nالطالبة: ...';
                    return await getGeminiQaResponse(p, { title: 'ملف', full_content: fullText });
                }
                const outlines = [];
                for (const c of chunks){
                    const p = 'استخرج أهم 5-8 نقاط أساسية من هذا الجزء بشكل موجز مناسب لحوار سمعي.';
                    const r = await getGeminiQaResponse(p, { title: 'جزء', full_content: c });
                    if (r) outlines.push(r);
                }
                const merged = outlines.join('\n');
                const finalPrompt = 'ادمج الملخصات الجزئية التالية في نقاط نهائية موجزة (5-8 نقاط) بالعربية الواضحة بدون أي مقدمة أو خاتمة:';
                return await getGeminiQaResponse(finalPrompt + '\n\n' + merged, { title: 'ملخصات جزئية', full_content: '' });
            }catch(_){ return ''; }
        }

        // Alternating-voice TTS for dialogue
        async function synthesizeDialogueTts(dialogueText, maxBytes){
            const lines = (dialogueText||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
            const utterances = [];
            for (const line of lines){
                const mTeacher = /^المدرّس\s*:\s*(.*)$/i.exec(line);
                const mStudent = /^الطالبة\s*:\s*(.*)$/i.exec(line);
                if (mTeacher) { utterances.push({ text: mTeacher[1], voice: 'male' }); continue; }
                if (mStudent) { utterances.push({ text: mStudent[1], voice: 'female' }); continue; }
                utterances.push({ text: line, voice: 'neutral' });
            }
            const buffers = [];
            let total = 0;
            for (const u of utterances){
                const body = { text: u.text };
                if (u.voice === 'male') body.voice = 'male';
                else if (u.voice === 'female') body.voice = 'female';
                const j = await postJsonWithFallback('/api/tts', body);
                const buf = await responseToArrayBuffer(j);
                if (!buf) continue;
                total += buf.byteLength; if (total > maxBytes) break;
                buffers.push(buf);
            }
            if (!buffers.length) return '';
            const merged = concatArrayBuffers(buffers);
            const blob = new Blob([merged], { type: 'audio/mpeg' });
            return URL.createObjectURL(blob);
        }

        // Keep dialogue length roughly under TTS budget (~10MB ~ ~10 min ~ ~12k chars)
        function fitTextByLines(text, maxChars){
            const lines = (text||'').split(/\r?\n/);
            let out = '';
            for (const ln of lines){
                if ((out.length + ln.length + 1) > maxChars) break;
                out += (out ? '\n' : '') + ln;
            }
            return out;
        }

        async function explainFullSource(){
            try{
                const { title, content } = await resolveCurrentSource();
                if (!content || content.trim().length < 30) { showNotification('لا يوجد محتوى كافٍ للشرح', 'warning'); return; }
                addMessage('أشرح المحاضرة بالكامل: ' + title, 'user');
                const system = 'اشرح المحتوى التالي شرحاً كاملاً على هيئة حوار تعليمي بين "المدرّس" (رجل) و"الطالبة" (بنت). يجب أن يغطي الحوار جميع المحاور المهمة بتدرّج منطقي، مع أسئلة واعتراضات قصيرة من الطالبة وردود واضحة من المدرّس، وأمثلة مركزة عند الحاجة، وبعربية فصحى مبسطة وبدون حشو. استخدم صيغاً مثل: المدرّس: ...\nالطالبة: ...';
                let reply = await backendAsk(system, content);
                if (!reply || reply.trim().length < 10) {
                    try {
                        reply = await clientExplainLarge(content);
                    } catch(_) {}
                }
                addMessage(reply || 'تعذر إنشاء الشرح الآن', 'ai');
            }catch(e){ showNotification('حدث خطأ أثناء الشرح', 'error'); }
        }

        async function summarizeFullSource(){
            try{
                const { content } = await resolveCurrentSource();
                if (!content || content.trim().length < 30) { showNotification('لا يوجد محتوى كافٍ للتلخيص', 'warning'); return; }
                addMessage('ألخّص المحاضرة بالكامل.', 'user');
                const system = 'لخّص المحتوى التالي في نقاط عربية واضحة ومختصرة جداً (5-9 نقاط)، بدون مقدمات أو ختام.';
                let reply = await backendAsk(system, content);
                if (!reply || reply.trim().length < 10) {
                    try {
                        const fallback = await clientSummarizeLarge(content);
                        reply = fallback || reply;
                    } catch(_) {}
                }
                addMessage(reply || 'تعذر إنشاء التلخيص الآن', 'ai');
            }catch(e){ showNotification('حدث خطأ أثناء التلخيص', 'error'); }
        }

        async function clientSummarizeLarge(fullText){
            try{
                const maxChunk = 12000;
                const chunks = [];
                for (let i=0; i<fullText.length; i+=maxChunk){ chunks.push(fullText.slice(i, i+maxChunk)); }
                if (chunks.length <= 1){
                    const p = 'لخّص المحتوى التالي في نقاط عربية واضحة ومختصرة جداً (5-9 نقاط)، بدون مقدمات أو ختام.';
                    return await getGeminiQaResponse(p, { title: 'محاضرة', full_content: fullText });
                }
                const partials = [];
                for (const c of chunks){
                    const p = 'لخّص بإيجاز أبرز النقاط التعليمية من هذا الجزء في 3-5 نقاط عربية.';
                    const r = await getGeminiQaResponse(p, { title: 'جزء محاضرة', full_content: c });
                    if (r) partials.push(r);
                }
                const merged = partials.join('\n');
                const finalPrompt = 'ادمج الملخصات الجزئية التالية في نقاط نهائية موجزة (5-9 نقاط) بالعربية الواضحة بدون أي مقدمة أو خاتمة:';
                return await getGeminiQaResponse(finalPrompt + '\n\n' + merged, { title: 'ملخصات جزئية', full_content: '' });
            }catch(_){ return ''; }
        }

        async function audioSummaryFullSource(){
            try{
                const { content } = await resolveCurrentSource();
                if (!content || content.trim().length < 30) { showNotification('لا يوجد محتوى كافٍ للملخص الصوتي', 'warning'); return; }
                // Create a full dialogue explanation (entire file) suitable for two voices (male/female), concise enough for ~10MB audio
                let dialogue = await backendAsk('اشرح المحتوى التالي شرحاً كاملاً على هيئة حوار تعليمي بين "المدرّس" (رجل) و"الطالبة" (بنت)، يُغطي كل المحاور باختصار ذكي ومركّز يناسب مدّة صوتية لا تتجاوز 10 دقائق تقريباً (حد أقصى ~12000 حرف). اجعل الحوار متدرّجاً مع أسئلة قصيرة من الطالبة وردود واضحة من المدرّس، وأمثلة موجزة عند الحاجة. استخدم الصيغة: المدرّس: ...\nالطالبة: ...', content);
                if (!dialogue || dialogue.trim().length < 10){
                    try { dialogue = await clientExplainLarge(content); } catch(_) {}
                }
                if (!dialogue || dialogue.trim().length < 10){ showNotification('تعذر إنشاء نص الشرح الحواري الكامل', 'error'); return; }
                dialogue = fitTextByLines(dialogue.trim(), 12000);
                const audioEl = document.getElementById('aiSummaryAudio');
                // Try alternating-voice synthesis up to ~10MB
                let url = await synthesizeDialogueTts(dialogue, 10 * 1024 * 1024);
                if (!url){
                    // Fallback to single-shot or multi-chunk neutral TTS
                    if (dialogue.length <= 1200){
                        const j = await postJsonWithFallback('/api/tts', { text: dialogue });
                        if (j){
                            url = j.audio || j.audioUrl || j.url || '';
                            if (!url && j.base64) url = `data:audio/mpeg;base64,${j.base64}`;
                        }
                    }
                    if (!url){ url = await synthesizeLargeTts(dialogue, 10 * 1024 * 1024); }
                }
                if (!url) { showNotification('تعذر إنشاء الصوت', 'error'); return; }
                if (audioEl) { audioEl.src = url; audioEl.classList.remove('hidden'); audioEl.play().catch(()=>{}); }
            }catch(e){ showNotification('حدث خطأ أثناء إنشاء الملخص الصوتي', 'error'); }
        }

        async function clientExplainLarge(fullText){
            const maxChunk = 12000;
            const chunks = [];
            for (let i=0; i<fullText.length; i+=maxChunk){ chunks.push(fullText.slice(i, i+maxChunk)); }
            if (chunks.length <= 1){
                const p = 'اشرح المحتوى التالي شرحاً كاملاً على هيئة حوار تعليمي بين "المدرّس" (رجل) و"الطالبة" (بنت). يجب أن يغطي الحوار جميع المحاور المهمة بتدرّج منطقي، مع أسئلة واعتراضات قصيرة من الطالبة وردود واضحة من المدرّس، وأمثلة مركزة عند الحاجة، وبعربية فصحى مبسطة وبدون حشو. استخدم صيغاً مثل: المدرّس: ...\nالطالبة: ...';
                return await getGeminiQaResponse(p, { title: 'محاضرة', full_content: fullText });
            }
            const outlines = [];
            for (const c of chunks){
                const p = 'استخرج مخططاً تعليمياً موجزاً بالنقاط للمفاهيم والمحاور الأساسية من هذا الجزء.';
                const r = await getGeminiQaResponse(p, { title: 'جزء محاضرة', full_content: c });
                if (r) outlines.push(r);
            }
            const mergedOutline = outlines.join('\n');
            const finalPrompt = 'اعتماداً على المخطط التالي، اكتب الشرح كاملاً على هيئة حوار تعليمي بين "المدرّس" (رجل) و"الطالبة" (بنت). ليكن الحوار متدرّجاً يغطي جميع المحاور، مع أسئلة واعتراضات وجوابها، وأمثلة قصيرة حيث يلزم، وبدون مقدمات أو ختام.';
            return await getGeminiQaResponse(finalPrompt + '\n\n' + mergedOutline, { title: 'مخطط مجمّع', full_content: '' });
        }

        async function clientAudioSummaryLarge(fullText){
            const maxChunk = 12000;
            const chunks = [];
            for (let i=0; i<fullText.length; i+=maxChunk){ chunks.push(fullText.slice(i, i+maxChunk)); }
            if (chunks.length <= 1){
                const p = 'لخّص المحتوى التالي في فقرة عربية قصيرة مفهومة للاستماع (3-6 جمل).';
                return await getGeminiQaResponse(p, { title: 'ملفات', full_content: fullText });
            }
            const partials = [];
            for (const c of chunks){
                const p = 'قدّم خلاصة موجزة جداً لهذا الجزء في جملتين عربيتين كحد أقصى.';
                const r = await getGeminiQaResponse(p, { title: 'جزء', full_content: c });
                if (r) partials.push(r);
            }
            const merged = partials.join(' ');
            const finalPrompt = 'ادمج الخلاصات الجزئية التالية في فقرة عربية واحدة سلسة مناسبة للاستماع (3-6 جمل)، خالية من المقدمات والخواتيم:';
            return await getGeminiQaResponse(finalPrompt + '\n\n' + merged, { title: 'خلاصات جزئية', full_content: '' });
        }

        // Generate quiz
        async function generateQuiz() {
            // If no uploaded content, try to build from selected lectures automatically
            if (!(uploadedQuizText && uploadedQuizText.length > 80)) {
                try {
                    const sel = document.getElementById('quizLectureSelect');
                    const ids = Array.from(sel?.selectedOptions || [])
                        .map(o => o.value)
                        .filter(v => v && v !== '__uploaded__');
                    if (ids.length > 0) {
                        showNotification('جاري جمع محتوى المحاضرات المحددة للاختبار...', 'info');
                        const parts = [];
                        for (const id of ids) {
                            try {
                                const lectureResult = await window.supabaseDB.lectures.getWithContent(id);
                                const lecture = lectureResult?.data;
                                if (!lecture) continue;
                                let content = '';
                                try { content = await buildLectureContentFallback(lecture); } catch(_) {}
                                if (content && content.trim().length >= 20) {
                                    const title = lecture.title || 'محاضرة';
                                    parts.push(`-- ${title} --\n${content}`);
                                }
                            } catch(_) {}
                        }
                        const newChunk = parts.join('\n\n');
                        if (newChunk && newChunk.length > 80) {
                            uploadedQuizText = newChunk;
                        }
                    }
                } catch(_) {}
            }

            if (!(uploadedQuizText && uploadedQuizText.length > 80)) {
                showNotification('يرجى رفع ملفات للاختبار أولاً (PDF أو TXT/MD) أو اختيار محاضرات من القائمة', 'error');
                return;
            }

            const generateQuizBtn = document.getElementById('generateQuizBtn');
            const originalBtnText = generateQuizBtn.innerHTML;
            generateQuizBtn.disabled = true;
            generateQuizBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';

            try {
                // Show loading state
                const quizContainer = document.getElementById('quizContainer');
                quizContainer.classList.remove('hidden');
                quizContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-magic ml-3"></i>جاري إنشاء الاختبار
                            </h2>
                        </div>
                        <div class="p-6">
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                                <p class="text-gray-600">جاري إنشاء الاختبار بواسطة الذكاء الاصطناعي...</p>
                                <p class="text-sm text-gray-500 mt-2">قد يستغرق هذا بضع ثوانٍ</p>
                            </div>
                        </div>
                    </div>
                `;

                // Get quiz settings
                const questionCount = parseInt(document.getElementById('questionCount').value) || 10;
                const questionType = document.getElementById('questionType').value || 'multiple';
                
                // Use uploaded content only
                const lectureContent = uploadedQuizText;

                // Generate quiz data using the structured response function
                const quizData = await getGeminiQuiz(lectureContent, questionCount, questionType);
                
                // Reset button state
                generateQuizBtn.innerHTML = originalBtnText;
                generateQuizBtn.disabled = false;

                // Validation (minimal check before display)
                if (!quizData || !quizData.questions || quizData.questions.length === 0) {
                    throw new Error('الاستجابة كانت فارغة أو غير مكتملة. ربما المحتوى كان قصيراً جداً.');
                }

                currentQuiz = quizData;
                currentQuestionIndex = 0;
                userAnswers = new Array(currentQuiz.questions.length).fill(-1);
                
                displayQuiz();
                showNotification('تم إنشاء الاختبار بنجاح!', 'success');
                
            } catch (error) {
                console.error('Error generating quiz:', error);
                
                // Reset button state
                generateQuizBtn.innerHTML = originalBtnText;
                // Keep disabled state until user changes files/URL

                document.getElementById('quizContainer').innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-red-500 to-red-600 p-6">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-exclamation-triangle ml-3"></i>خطأ في إنشاء الاختبار
                            </h2>
                        </div>
                        <div class="p-6 text-center">
                            <div class="text-red-500 mb-4">
                                <i class="fas fa-exclamation-triangle text-4xl"></i>
                            </div>
                            <p class="text-red-600 mb-4">${error.message || 'حدث خطأ غير متوقع في إنشاء الاختبار'}</p>
                            <button onclick="generateQuiz()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                                <i class="fas fa-redo ml-2"></i>المحاولة مرة أخرى
                            </button>
                        </div>
                    </div>
                `;
                showNotification('حدث خطأ في إنشاء الاختبار', 'error');
            }
        }

        // Display quiz
        function displayQuiz() {
            if (!currentQuiz || !currentQuiz.questions || currentQuiz.questions.length === 0) {
                console.error('No quiz data available');
                return;
            }

            // Initialize user answers array
            if (userAnswers.length !== currentQuiz.questions.length) {
                userAnswers = new Array(currentQuiz.questions.length).fill(-1);
            }
            
            const quizArea = document.getElementById('quizContainer');
            quizArea.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-green-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-green-800">${currentQuiz.title || 'الاختبار الجديد'}</h3>
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm" id="questionCounter">
                            السؤال ${currentQuestionIndex + 1} من ${currentQuiz.questions.length}
                        </span>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">التقدم في الاختبار</span>
                            <span class="text-sm font-medium text-green-600" id="progressPercentage">
                                ${Math.round(((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100)}%
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                            <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" 
                                 id="progressBar" style="width: ${((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>تم الإجابة على <span id="answeredCount">${userAnswers.filter(a => a !== -1).length}</span> من ${currentQuiz.questions.length} سؤال</span>
                            <span>${currentQuiz.questions.length - userAnswers.filter(a => a !== -1).length} سؤال متبقي</span>
                        </div>
                    </div>

                    <div id="questionContainer" class="mb-6">
                        ${renderQuestion(currentQuestionIndex)}
                    </div>

                    <div class="flex justify-between flex-wrap gap-3">
                        <button id="prevBtn" onclick="previousQuestion()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-right ml-2"></i>
                            السابق
                        </button>
                        
                        <button id="nextBtn" onclick="nextQuestion()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors flex-1 min-w-[120px]">
                            ${currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                                '<i class="fas fa-check ml-2"></i>إنهاء الاختبار' : 
                                'التالي<i class="fas fa-arrow-left mr-2"></i>'}
                        </button>
                    </div>
                </div>
            `;
            // Scroll to quiz section
            quizArea.scrollIntoView({ behavior: 'smooth' });
        }

        function renderQuestion(index) {
            const question = currentQuiz.questions[index];
            if (!question) return '';

            let optionsHtml = '';
            question.options.forEach((option, optionIndex) => {
                const isSelected = userAnswers[index] === optionIndex;
                optionsHtml += `
                    <div class="mb-3">
                        <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200'}">
                            <input type="radio" name="question_${index}" value="${optionIndex}" 
                                   onchange="selectAnswer(${index}, ${optionIndex})" 
                                   ${isSelected ? 'checked' : ''} class="ml-3">
                            <span class="text-gray-800">${option}</span>
                        </label>
                    </div>
                `;
            });

            return `
                <div class="question-content">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">السؤال ${index + 1}: ${question.question}</h4>
                    <div class="options-container">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }

        function selectAnswer(questionIndex, answerIndex) {
            userAnswers[questionIndex] = answerIndex;
            
            // Update progress indicators immediately
            updateQuizProgress();
            
            // Add visual feedback
            const selectedOption = document.querySelector(`input[name="question_${questionIndex}"][value="${answerIndex}"]`);
            if (selectedOption) {
                const label = selectedOption.closest('label');
                // Remove previous selections
                document.querySelectorAll(`input[name="question_${questionIndex}"]`).forEach(input => {
                    const parentLabel = input.closest('label');
                    parentLabel.classList.remove('border-green-500', 'bg-green-50');
                    parentLabel.classList.add('border-gray-200');
                });
                
                // Highlight selected option
                label.classList.remove('border-gray-200');
                label.classList.add('border-green-500', 'bg-green-50');
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
                updateNavigationButtons();
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                document.getElementById('questionContainer').innerHTML = renderQuestion(currentQuestionIndex);
                updateQuizProgress();
                updateNavigationButtons();
            }
        }

        function updateQuizProgress() {
            const progressBar = document.getElementById('progressBar');
            const questionCounter = document.getElementById('questionCounter');
            const progressPercentage = document.getElementById('progressPercentage');
            const answeredCount = document.getElementById('answeredCount');
            
            if (!currentQuiz) return; // Guard against null quiz
            
            if (progressBar) {
                const progressPercent = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
                progressBar.style.width = `${progressPercent}%`;
            }
            
            if (questionCounter) {
                questionCounter.textContent = `السؤال ${currentQuestionIndex + 1} من ${currentQuiz.questions.length}`;
            }
            
            if (progressPercentage) {
                progressPercentage.textContent = `${Math.round(((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100)}%`;
            }
            
            if (answeredCount) {
                const answered = userAnswers.filter(a => a !== -1).length;
                answeredCount.textContent = `${answered}`;
                
                // Update remaining count
                const remainingElement = answeredCount.parentElement.nextElementSibling;
                if (remainingElement) {
                    remainingElement.textContent = `${currentQuiz.questions.length - answered} سؤال متبقي`;
                }
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentQuestionIndex === 0;
            }
            
            if (nextBtn) {
                nextBtn.innerHTML = currentQuestionIndex === currentQuiz.questions.length - 1 ? 
                    '<i class="fas fa-check ml-2"></i>إنهاء الاختبار' : 
                    'التالي<i class="fas fa-arrow-left mr-2"></i>';
            }
        }

        function finishQuiz() {
            const score = calculateScore();
            const percentage = Math.round((score / currentQuiz.questions.length) * 100);
            
            // Calculate grade
            let gradeColor = 'text-red-600';
            let gradeMessage = 'يحتاج تحسين ';
            
            if (percentage >= 90) {
                gradeColor = 'text-green-600';
                gradeMessage = 'ممتاز جداً! ';
            } else if (percentage >= 80) {
                gradeColor = 'text-green-600';
                gradeMessage = 'ممتاز! ';
            } else if (percentage >= 70) {
                gradeColor = 'text-blue-600';
                gradeMessage = 'جيد جداً! ';
            } else if (percentage >= 60) {
                gradeColor = 'text-yellow-600';
                gradeMessage = 'جيد! ';
            } else if (percentage >= 50) {
                gradeColor = 'text-orange-600';
                gradeMessage = 'مقبول ';
            }
            
            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-blue-200 p-6 text-center">
                    <div class="mb-6">
                        <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">انتهى الاختبار!</h3>
                        <p class="text-gray-600">لقد أكملت الاختبار بنجاح</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                        <div class="text-4xl font-bold text-blue-600">${percentage}%</div>
                        <div class="text-lg text-gray-700 mb-2">${score} من ${currentQuiz.questions.length} إجابة صحيحة</div>
                        <div class="text-lg font-medium ${gradeColor}">${gradeMessage}</div>
                    </div>
                    
                    <div class="flex gap-4 justify-center flex-wrap">
                        <button onclick="reviewAnswers()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-eye ml-2"></i>
                            مراجعة الإجابات
                        </button>
                        <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-redo ml-2"></i>
                            اختبار جديد
                        </button>
                    </div>
                </div>
            `;
            quizContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function calculateScore() {
            let score = 0;
            for (let i = 0; i < currentQuiz.questions.length; i++) {
                if (userAnswers[i] === currentQuiz.questions[i].correct) {
                    score++;
                }
            }
            return score;
        }

        function reviewAnswers() {
            let reviewHtml = `
                <div class="bg-white rounded-lg border-2 border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6 flex-wrap gap-2">
                        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-list-check ml-2"></i>
                            مراجعة الإجابات
                        </h4>
                        <button onclick="generateNewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-plus ml-1"></i>
                            اختبار جديد
                        </button>
                    </div>
            `;

            currentQuiz.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = question.correct;
                const isCorrect = userAnswer === correctAnswer;
                const wasAnswered = userAnswer !== -1;

                // Ensure options are safe
                const correctOptionText = question.options[correctAnswer] || 'غير متاح';
                const userAnswerText = wasAnswered ? (question.options[userAnswer] || 'غير متاح') : 'لم تجب على هذا السؤال';

                reviewHtml += `
                    <div class="mb-6 p-4 border rounded-lg ${
                        !wasAnswered ? 'border-gray-300 bg-gray-50' :
                        isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'
                    }">
                        <div class="flex items-center mb-3">
                            <i class="fas ${
                                !wasAnswered ? 'fa-question-circle text-gray-500' :
                                isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'
                            } ml-2"></i>
                            <span class="font-semibold">السؤال ${index + 1}</span>
                        </div>
                        <p class="font-medium mb-3">${question.question}</p>
                        <div class="text-sm space-y-2 border-t pt-3">
                            <div class="flex items-start">
                                <span class="text-gray-600 ml-2 min-w-[70px]">إجابتك:</span>
                                <span class="${wasAnswered && isCorrect ? 'text-green-600 font-medium' : wasAnswered ? 'text-red-600 line-through' : 'text-gray-500 italic'}">${userAnswerText}</span>
                            </div>
                            
                            ${!isCorrect || !wasAnswered ? `
                                <div class="flex items-start">
                                    <span class="text-gray-600 ml-2 min-w-[70px]">الصحيحة:</span>
                                    <span class="text-green-600 font-medium">${correctOptionText}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            reviewHtml += `
                </div>
            `;

            document.getElementById('quizContainer').innerHTML = reviewHtml;
            document.getElementById('quizContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Generate new quiz
        function generateNewQuiz() {
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            
            // Reset quiz state
            currentQuiz = null;
            currentQuestionIndex = 0;
            userAnswers = [];
            
            // Scroll to quiz generation section
            document.querySelector('.bg-gradient-to-r.from-green-500').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Add message to chat
        function addMessage(message, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message`;
            
            // Create inner content with correct class
            const innerDiv = document.createElement('div');
            innerDiv.className = `${sender}-message chat-message`;
            
            // Apply line breaks for formatting
            const paragraphized = (message || '')
                .split(/\r?\n\r?\n/g)
                .map(b => `<p>${b.replace(/\n/g, '<br>')}</p>`) 
                .join('');
            innerDiv.innerHTML = paragraphized || '<p></p>';
            
            messageDiv.appendChild(innerDiv);
            chatArea.appendChild(messageDiv);
            
            // Remove any old typing indicators if they somehow persisted
            document.querySelectorAll('.typing-indicator-wrapper').forEach(el => el.remove());
            
            try { if (sender === 'user') { lastUserQuestion = message; } } catch(_) {}
            try { if (sender === 'ai') { createExportActions(messageDiv, message); } } catch(_) {}
            
            scrollToBottom();
            return messageDiv;
        }

        function sanitizeFileName(name) {
            const base = (name || '').toString().slice(0, 80).replace(/[\/:*?"<>|]+/g, ' ').trim();
            return base || 'ملف';
        }
        function currentStamp() {
            const d = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
        }
        function createExportActions(messageDiv, aiText) {
            const existing = messageDiv.querySelector('.export-actions');
            if (existing) return;
            const actions = document.createElement('div');
            actions.className = 'export-actions flex gap-2 mt-2 mr-8';
            const btnPro = document.createElement('button');
            btnPro.className = 'px-3 py-1 text-sm bg-amber-600 hover:bg-amber-700 text-white rounded';
            btnPro.innerHTML = '<i class="fas fa-file-alt ml-2"></i>تقرير احترافي';
            const btnPdf = document.createElement('button');
            btnPdf.className = 'px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded';
            btnPdf.innerHTML = '<i class="fas fa-file-pdf ml-2"></i>تنزيل PDF';
            const btnPpt = document.createElement('button');
            btnPpt.className = 'px-3 py-1 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded';
            btnPpt.innerHTML = '<i class="fas fa-file-powerpoint ml-2"></i>تنزيل PowerPoint';
            const btnCloud = document.createElement('button');
            btnCloud.className = 'px-3 py-1 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded';
            btnCloud.innerHTML = '<i class="fas fa-cloud-upload-alt ml-2"></i>حفظ في السحابة';
            actions.appendChild(btnPro);
            actions.appendChild(btnPdf);
            actions.appendChild(btnPpt);
            actions.appendChild(btnCloud);
            messageDiv.appendChild(actions);
            const sourceName = (currentExportBaseName && currentExportBaseName.trim())
                ? currentExportBaseName
                : ((lastUserQuestion && lastUserQuestion.trim()) ? lastUserQuestion : 'إجابة المساعد');
            const baseName = sanitizeFileName(sourceName) + '_' + currentStamp();
            btnPro.onclick = () => window.openProReport && window.openProReport(aiText);
            btnPdf.onclick = () => exportMessageToPdf(messageDiv, baseName + '.pdf');
            btnPpt.onclick = () => exportMessageToPpt(aiText, baseName + '.pptx');
            btnCloud.onclick = async () => {
                try{
                    const choice = (window.prompt('اختر النوع للحفظ في السحابة: اكتب pdf أو ppt', 'pdf') || '').trim().toLowerCase();
                    if (choice !== 'pdf' && choice !== 'ppt') return;
                    let blob = null, fileName = '', ct = '';
                    if (choice === 'pdf') { blob = await buildPdfBlobFromMessage(messageDiv); fileName = baseName + '.pdf'; ct = 'application/pdf'; }
                    else { blob = await buildPptBlobFromText(aiText); fileName = baseName + '.pptx'; ct = 'application/vnd.openxmlformats-officedocument.presentationml.presentation'; }
                    if (!blob) { showNotification('تعذر إنشاء الملف', 'error'); return; }
                    const url = await uploadBlobToSupabase(blob, fileName, ct);
                    if (url) {
                        showNotification('تم الحفظ في السحابة', 'success');
                        const a = document.createElement('a');
                        a.href = url; a.target = '_blank'; a.rel = 'noopener';
                        a.className = 'px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded';
                        a.textContent = 'فتح الملف';
                        actions.appendChild(a);
                    } else {
                        showNotification('تعذر الرفع للسحابة', 'error');
                    }
                }catch(_){ showNotification('حدث خطأ أثناء الحفظ في السحابة', 'error'); }
            };
        }
        async function exportMessageToPdf(messageDiv, fileName) {
            try {
                if (!window.html2pdf) { showNotification('ميزة PDF غير متاحة حالياً', 'error'); return; }
                // اجمع كل رسائل المساعد في المحادثة
                const allAiMessages = Array.from(document.querySelectorAll('#chatArea .ai-message'));
                if (!allAiMessages.length) { showNotification('لا توجد رسائل للمساعد لتصديرها', 'warning'); return; }

                // حاوية خارجية تمثل خلفية الصفحة الكاملة
                const container = document.createElement('div');
                container.dir = 'rtl';
                container.style.padding = '20px';
                container.style.boxSizing = 'border-box';
                container.style.background = '#f9fafb';
                container.style.width = '100%';
                container.style.display = 'flex';
                container.style.justifyContent = 'center';

                // إطار الورقة الداخلي (برواز أزرق كما في نموذج الامتحان)
                const pageFrame = document.createElement('div');
                pageFrame.style.maxWidth = '794px';
                pageFrame.style.width = '794px';
                pageFrame.style.minHeight = '1123px';
                pageFrame.style.border = '2px solid #1d4ed8';
                pageFrame.style.padding = '24px 28px 40px 28px';
                pageFrame.style.background = '#ffffff';
                pageFrame.style.boxSizing = 'border-box';
                pageFrame.style.color = '#111827';
                pageFrame.style.fontFamily = "'Cairo', Arial, sans-serif";

                // استخرج أول سطر من أول رسالة مساعد ليكون عنوانًا رئيسيًا في أعلى الصفحة
                let mainTitle = '';
                try {
                    const firstMsgText = (allAiMessages[0].innerText || '').trim();
                    if (firstMsgText) {
                        const lines = firstMsgText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                        if (lines.length) mainTitle = lines[0];
                    }
                } catch(_) {}

                // مساحة عنوان علوية (تحتوي على العنوان المستخرج من أول سطر)
                const header = document.createElement('div');
                header.style.textAlign = 'center';
                header.style.marginBottom = '12px';
                header.style.fontSize = '18pt';
                header.style.fontWeight = '700';
                header.style.color = '#1d4ed8';
                header.style.whiteSpace = 'pre-wrap';
                header.textContent = mainTitle || '';
                pageFrame.appendChild(header);

                // المحتوى الأساسي: كل رسائل المساعد كفقرات متتابعة منسقة مثل مستند Word
                allAiMessages.forEach((msgEl, index) => {
                    const section = document.createElement('div');
                    section.style.whiteSpace = 'pre-wrap';
                    section.style.textAlign = 'justify';
                    section.style.textJustify = 'inter-word';
                    section.style.lineHeight = '1.9';
                    section.style.fontSize = '16pt';
                    section.style.wordBreak = 'break-word';
                    section.style.overflowWrap = 'anywhere';
                    section.style.marginTop = index === 0 ? '0' : '24px';

                    // لأول رسالة فقط: احذف السطر الأول من النص (المستخدم كعنوان) لمنع التكرار والفراغ الكبير
                    if (index === 0 && mainTitle) {
                        try {
                            const rawText = (msgEl.innerText || '').replace(/\r/g, '');
                            const lines = rawText.split(/\n/);
                            const remaining = [];
                            let skipped = false;
                            for (let ln of lines) {
                                const t = (ln || '').trim();
                                if (!skipped && t) { skipped = true; continue; }
                                if (skipped) remaining.push(ln);
                            }
                            const restText = remaining.join('\n').trim();
                            if (restText) {
                                // حوّل الأسطر المتبقية إلى فقرات بسيطة باستخدام <br> للحفاظ على البنية
                                const htmlFromText = restText
                                    .split(/\n{2,}/)
                                    .map(block => block.trim())
                                    .filter(Boolean)
                                    .map(block => block.replace(/\n/g, '<br>'))
                                    .join('<br><br>');
                                section.innerHTML = sanitizeForPdf(htmlFromText);
                            } else {
                                section.innerHTML = sanitizeForPdf(msgEl.innerHTML || '');
                            }
                        } catch(_) {
                            section.innerHTML = sanitizeForPdf(msgEl.innerHTML || '');
                        }
                    } else {
                        section.innerHTML = sanitizeForPdf(msgEl.innerHTML || '');
                    }

                    preparePdfContent(section);
                    pageFrame.appendChild(section);
                });

                container.appendChild(pageFrame);
                document.body.appendChild(container);
                const opt = { margin: 12, filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['css', 'legacy'], avoid: ['table','tr','td','th','p','li','ul','ol','pre','code','h1','h2','h3','h4'] } };
                const worker = html2pdf().set(opt).from(container).toPdf();
                await worker.get('pdf').then(pdf => {
                    const total = pdf.internal.getNumberOfPages();
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    for (let i = 1; i <= total; i++) {
                        pdf.setPage(i);
                        // شريط سفلي أزرق مع رقم الصفحة في المنتصف
                        pdf.setFillColor(29, 78, 216); // أزرق داكن
                        pdf.rect(0, pageHeight - 12, pageWidth, 12, 'F');
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(11);
                        pdf.text(`${i} / ${total}`, pageWidth / 2, pageHeight - 4.5, { align: 'center' });
                    }
                });
                await worker.save();
                container.remove();
            } catch(_) { showNotification('تعذر إنشاء PDF', 'error'); }
        }
        function splitToBullets(text) {
            const lines = (text || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
            const bullets = [];
            for (const ln of lines){
                const m = ln.match(/^[-*•\u2022\u25CF]\s*(.*)$/i); if (m && m[1]) { bullets.push(m[1]); continue; }
                const n = ln.match(/^\d+\s*[\)\.\-\:]\s*(.*)$/i); if (n && n[1]) { bullets.push(n[1]); continue; }
            }
            if (!bullets.length) {
                const sentences = (text || '').split(/[\.!?\u061F]+/).map(s=>s.trim()).filter(s=>s.length>0);
                for (const s of sentences) { if (s.length > 2) bullets.push(s); }
            }
            return bullets;
        }
        function extractStructuredSlides(aiText){
            try{
                const t = (aiText || '').replace(/\r/g,'').trim();
                if (!t) return [];
                const hasMarkers = /(أولاً|اولاً|ثانيًا|ثانيا|ثالثًا|ثالثا|📋|الفكرة|⚙️|خطوات|⭐|المميزات|🏁)/.test(t);
                if (!hasMarkers) return [];
                const slides = [];
                const lines = t.split(/\n+/).map(l=>l.trim()).filter(Boolean);
                const titleLine = lines[0]?.replace(/^[^\u0600-\u06FF0-9A-Za-z]+/,'') || '';
                if (titleLine) slides.push({ type:'title', title: titleLine });
                const secRegex = /(أولاً|اولاً|ثانيًا|ثانيا|ثالثًا|ثالثا)\s*[:：\-]\s*([^\n]+)/g;
                const positions = [];
                let m;
                while ((m = secRegex.exec(t))){ positions.push({ idx: m.index, label: m[0], title: m[2] }); }
                const blocks = [];
                if (positions.length){
                    if (positions[0].idx > 0) {
                        blocks.push({ header: '', body: t.slice(0, positions[0].idx) });
                    }
                    for (let i=0;i<positions.length;i++){
                        const start = positions[i].idx;
                        const end = i+1<positions.length ? positions[i+1].idx : t.length;
                        blocks.push({ header: positions[i].label, body: t.slice(start, end) });
                    }
                } else {
                    blocks.push({ header: '', body: t });
                }
                blocks.forEach(b=>{
                    const secTitle = (b.header || '').trim();
                    const urlMatch = b.body.match(/https?:\/\/[^\s]+/i);
                    const url = urlMatch ? urlMatch[0] : '';
                    if (secTitle) slides.push({ type:'header', title: secTitle, url });
                    const ideaMatch = b.body.match(/(?:📋|الفكرة)\s*:?([\s\S]*?)(?=(?:⚙️|خطوات|⭐|المميزات|🏁|$))/);
                    const stepsMatch = b.body.match(/(?:⚙️|خطوات(?:\s*الاستخدام)?)\s*:?([\s\S]*?)(?=(?:⭐|المميزات|🏁|$))/);
                    const featsMatch = b.body.match(/(?:⭐|المميزات)\s*:?([\s\S]*?)(?=(?:🏁|$))/);
                    const idea = ideaMatch ? ideaMatch[1].trim() : '';
                    const stepsRaw = stepsMatch ? stepsMatch[1] : '';
                    const featsRaw = featsMatch ? featsMatch[1] : '';
                    if (idea) slides.push({ type:'text', title:'الفكرة', body: idea });
                    const normList = (raw) => {
                        let arr = (raw || '').split(/\n+/)
                            .map(x=>x.replace(/^[\-\*•\u2022\u25CF]+/,'').replace(/^\d+\s*[\)\.\-\:]/,'').trim())
                            .filter(Boolean);
                        if (arr.length <= 1) {
                            arr = (raw || '').split(/[\.!?\u061F؛،]+/)
                                .map(s=>s.trim())
                                .filter(s=>s.length > 2);
                        }
                        return arr;
                    };
                    const steps = normList(stepsRaw);
                    const feats = normList(featsRaw);
                    if (steps.length) slides.push({ type:'bullets', title:'خطوات الاستخدام', items: steps });
                    if (feats.length) slides.push({ type:'bullets', title:'المميزات', items: feats });
                });
                const summary = t.match(/🏁[\s\S]*$/);
                if (summary){
                    const body = summary[0].replace(/^🏁\s*/,'').trim();
                    if (body) slides.push({ type:'text', title:'النتيجة', body });
                }
                return slides;
            }catch(_){ return []; }
        }
        function setupPptTheme(pptx){
            try{
                if (pptx.__SP_THEME_DEFINED) return;
                const primary = '7C3AED'; // purple-600
                const accent = 'F5F3FF';  // purple-50
                const gray = '111827';    // gray-900
                pptx.defineSlideMaster({
                    title: 'MASTER_TITLE',
                    bkgd: 'FFFFFF',
                    objects: [
                        { rect: { x:0, y:0, w:10, h:0.7, fill: accent } },
                        { rect: { x:9.2, y:0, w:0.8, h:7.5, fill: primary } },
                        { text: { text: 'منصة الطالب الذكي', options: { x:0.6, y:0.18, w:8.4, h:0.5, color: gray, fontSize: 14, bold: true, align: 'right', fontFace: 'Arial' } } }
                    ],
                    slideNumber: { x: 4.8, y: 6.9, color: '9CA3AF', fontSize: 10 }
                });
                pptx.defineSlideMaster({
                    title: 'MASTER_SECTION',
                    bkgd: 'FFFFFF',
                    objects: [
                        { rect: { x:0, y:0, w:10, h:0.55, fill: accent } },
                        { rect: { x:9.2, y:0, w:0.8, h:7.5, fill: primary } }
                    ],
                    slideNumber: { x: 4.8, y: 6.9, color: '9CA3AF', fontSize: 10 }
                });
                pptx.defineSlideMaster({
                    title: 'MASTER_CONTENT',
                    bkgd: 'FFFFFF',
                    objects: [
                        { rect: { x:0, y:0, w:10, h:0.3, fill: accent } },
                        { rect: { x:9.2, y:0, w:0.8, h:7.5, fill: primary } }
                    ],
                    slideNumber: { x: 4.8, y: 6.9, color: '9CA3AF', fontSize: 10 }
                });
                pptx.__SP_THEME_DEFINED = true;
            }catch(_){ }
        }
        function populatePptFromText(pptx, aiText){
            try{
                setupPptTheme(pptx);
                const slides = extractStructuredSlides(aiText);
                if (!slides.length) return false;
                const primary = '7C3AED';
                const gray = '111827';
                let hasCover = false;
                slides.forEach((sl) => {
                    if (sl.type === 'title'){
                        const s = pptx.addSlide({ masterName: 'MASTER_TITLE' });
                        s.addText(sl.title, { x: 0.6, y: 1.6, w: 8.6, h: 1.4, fontSize: 34, bold: true, align: 'right', color: gray, fontFace: 'Arial' });
                        const dt = new Date();
                        s.addText(dt.toLocaleDateString('ar-EG'), { x: 0.6, y: 2.8, w: 8.6, h: 0.6, fontSize: 14, color: '6B7280', align: 'right', fontFace: 'Arial' });
                        hasCover = true;
                    } else if (sl.type === 'header'){
                        const s = pptx.addSlide({ masterName: 'MASTER_SECTION' });
                        s.addText(sl.title, { x: 0.6, y: 1.3, w: 8.6, h: 1.0, fontSize: 28, bold: true, align: 'right', color: primary, fontFace: 'Arial' });
                        if (sl.url) {
                            s.addText([{ text: '🔗 ', options: { bold: true } }, { text: sl.url }], { x: 0.6, y: 2.1, w: 8.6, h: 0.6, fontSize: 14, color: '2563EB', align: 'right', hyperlink: { url: sl.url }, fontFace: 'Arial' });
                        }
                    } else if (sl.type === 'text'){
                        const s = pptx.addSlide({ masterName: 'MASTER_CONTENT' });
                        s.addText(sl.title, { x: 0.6, y: 0.6, w: 8.6, h: 0.8, fontSize: 22, bold: true, align: 'right', color: primary, fontFace: 'Arial' });
                        s.addText(sl.body, { x: 0.6, y: 1.2, w: 8.6, h: 5.0, fontSize: 18, align: 'right', color: gray, fontFace: 'Arial' });
                    } else if (sl.type === 'bullets'){
                        const s = pptx.addSlide({ masterName: 'MASTER_CONTENT' });
                        s.addText(sl.title, { x: 0.6, y: 0.6, w: 8.6, h: 0.8, fontSize: 22, bold: true, align: 'right', color: primary, fontFace: 'Arial' });
                        const items = sl.items.map(t => ({ text: t, options: { bullet: true } }));
                        s.addText(items, { x: 0.8, y: 1.2, w: 8.2, h: 5.0, fontSize: 18, align: 'right', color: gray, fontFace: 'Arial' });
                    }
                });
                if (!hasCover) {
                    const s = pptx.addSlide({ masterName: 'MASTER_TITLE' });
                    s.addText('ملخص العرض', { x: 0.6, y: 1.6, w: 8.6, h: 1.4, fontSize: 34, bold: true, align: 'right', color: gray, fontFace: 'Arial' });
                }
                return true;
            }catch(_){ return false; }
        }
        function sanitizeForPdf(html) {
            try{
                const root = document.createElement('div');
                root.innerHTML = html || '';
                const allowed = new Set(['BR','B','STRONG','I','EM','U','UL','OL','LI','P','SPAN','H1','H2','H3','H4','HR','BLOCKQUOTE','PRE','CODE','A','TABLE','THEAD','TBODY','TFOOT','TR','TH','TD']);
                const walk = (node) => {
                    const children = Array.from(node.children);
                    for (const el of children) {
                        if (!allowed.has(el.tagName)) {
                            const parent = el.parentNode;
                            while (el.firstChild) parent.insertBefore(el.firstChild, el);
                            parent.removeChild(el);
                            continue;
                        }
                        const attrs = Array.from(el.attributes);
                        for (const a of attrs) {
                            const an = a.name.toLowerCase();
                            if (an === 'style') continue;
                            if (el.tagName === 'A' && an === 'href') {
                                try { if ((a.value || '').trim().toLowerCase().startsWith('javascript:')) el.removeAttribute(a.name); } catch(_) {}
                                continue;
                            }
                            el.removeAttribute(a.name);
                        }
                        walk(el);
                    }
                };
                walk(root);
                return root.innerHTML;
            }catch(_){ return html || ''; }
        }
        function preparePdfContent(root){
            try{
                root.setAttribute('lang','ar');
                root.style.direction = 'rtl';
                root.style.unicodeBidi = 'plaintext';
                // avoid page breaks inside paragraphs and list items
                const blocks = root.querySelectorAll('p, li');
                blocks.forEach(el => {
                    el.style.pageBreakInside = 'avoid';
                    el.style.breakInside = 'avoid';
                    el.style.webkitColumnBreakInside = 'avoid';
                    el.style.lineHeight = '1.9';
                    el.style.margin = (el.tagName === 'LI') ? '0 0 6px 0' : '0 0 10px 0';
                });
                // also avoid breaks for entire lists
                root.querySelectorAll('ul, ol').forEach(list => {
                    list.style.pageBreakInside = 'avoid';
                    list.style.breakInside = 'avoid';
                    list.style.webkitColumnBreakInside = 'avoid';
                    list.style.margin = '0 0 10px 0';
                    list.style.paddingRight = '18px';
                });
                // style tables if present
                root.querySelectorAll('table').forEach(table => {
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.margin = '8px 0 12px 0';
                    table.style.pageBreakInside = 'avoid';
                });
                root.querySelectorAll('th, td').forEach(cell => {
                    cell.style.border = '1px solid #e5e7eb';
                    cell.style.padding = '6px 8px';
                    cell.style.verticalAlign = 'top';
                    cell.style.lineHeight = '1.7';
                });
                // Convert bullet-like paragraphs to lists
                const paragraphs = Array.from(root.querySelectorAll('p'));
                const bulletRe = /^[\-\*•\u2022\u25CF\u25AA\u25E6\u2043▪◦]\s+/;
                const numRe = /^(?:\d+|[٠-٩]+)\s*[\)\.\-\:]/;
                paragraphs.forEach(p => {
                    const html = p.innerHTML;
                    if (!/<br\s*\/?/i.test(html)) return;
                    const lines = html.split(/<br\s*\/?\s*>/i).map(s => s.replace(/&nbsp;/g,' ').trim()).filter(Boolean);
                    if (lines.length < 2) return;
                    const bCount = lines.filter(l => bulletRe.test(l)).length;
                    const nCount = lines.filter(l => numRe.test(l)).length;
                    if (bCount >= 2 || nCount >= 2) {
                        const tag = nCount > bCount ? 'ol' : 'ul';
                        const list = document.createElement(tag);
                        list.style.pageBreakInside = 'avoid';
                        list.style.breakInside = 'avoid';
                        list.style.webkitColumnBreakInside = 'avoid';
                        list.style.margin = '0 0 10px 0';
                        list.style.paddingRight = '18px';
                        lines.forEach(l => {
                            const text = l.replace(bulletRe, '').replace(numRe, '').trim();
                            if (!text) return;
                            const li = document.createElement('li');
                            li.textContent = text;
                            list.appendChild(li);
                        });
                        p.replaceWith(list);
                    }
                });
                // Promote section headings (Arabic keywords) into h3
                const headingKeywords = ['شرح','الشرح','ملخص','التلخيص','بحث شامل','تحليل','تحليل الورقة','إعادة صياغة','إعادة الصياغة','ثغرات','ثغرات بحثية','المصادر','المراجع','الخاتمة','المقدمة','المنهجية','المشكلة','الأهداف','النتائج','الاستنتاجات'];
                const kwRe = new RegExp('^(' + headingKeywords.map(k=>k.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|') + ')\\s*[:：\\-—]');
                Array.from(root.querySelectorAll('p')).forEach(p => {
                    const t = (p.textContent || '').trim();
                    if (!t) return;
                    if (kwRe.test(t) || /^#{1,3}\s+/.test(t)) {
                        let label = t.replace(/^#{1,3}\s+/, '');
                        let rest = '';
                        const m = label.match(/^([^:：\\-—]+)\s*[:：\\-—]\s*(.*)$/);
                        if (m) { label = m[1].trim(); rest = (m[2] || '').trim(); }
                        const h = document.createElement('h3');
                        h.textContent = label;
                        h.style.fontWeight = '700';
                        h.style.fontSize = '18pt';
                        h.style.margin = '12px 0 8px 0';
                        if (rest) {
                            const np = document.createElement('p');
                            np.textContent = rest;
                            p.replaceWith(h);
                            h.parentNode.insertBefore(np, h.nextSibling);
                        } else {
                            p.replaceWith(h);
                        }
                    }
                });
                // Wrap Latin segments to avoid bidi artifacts
                wrapLatinSegments(root);
            }catch(_){ }
        }
        function wrapLatinSegments(root){
            try{
                const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
                const nodes = [];
                let n;
                while ((n = walker.nextNode())) { nodes.push(n); }
                const latinRe = /([A-Za-z0-9@#%&*+_=\-\/\\:.]+(?:\s+[A-Za-z0-9@#%&*+_=\-\/\\:.]+)*)/g;
                for (const textNode of nodes){
                    const txt = textNode.nodeValue;
                    if (!latinRe.test(txt)) continue;
                    latinRe.lastIndex = 0;
                    const frag = document.createDocumentFragment();
                    let lastIndex = 0;
                    let m;
                    while ((m = latinRe.exec(txt))){
                        const before = txt.slice(lastIndex, m.index);
                        if (before) frag.appendChild(document.createTextNode(before));
                        const span = document.createElement('span');
                        span.dir = 'ltr';
                        span.style.unicodeBidi = 'isolate';
                        span.style.wordBreak = 'normal';
                        span.textContent = m[0];
                        frag.appendChild(span);
                        lastIndex = m.index + m[0].length;
                    }
                    const after = txt.slice(lastIndex);
                    if (after) frag.appendChild(document.createTextNode(after));
                    textNode.parentNode.replaceChild(frag, textNode);
                }
            }catch(_){ }
        }
        function loadScriptOnce(src){
            return new Promise((resolve)=>{
                try{
                    const s = document.createElement('script');
                    s.src = src;
                    s.async = true;
                    s.defer = true;
                    s.onload = ()=>resolve(true);
                    s.onerror = ()=>resolve(false);
                    document.head.appendChild(s);
                }catch(_){ resolve(false); }
            });
        }
        async function ensurePptxLoaded(){
            try{
                if (getPptxCtor()) return true;
                // حاول أولاً تحميل النسخة المحلية إن وُجدت ضمن المشروع
                const localOk = await loadScriptOnce('js/pptxgen.bundle.js');
                if (localOk && getPptxCtor()) return true;
                const cdns = [
                    'https://cdn.jsdelivr.net/npm/pptxgenjs@3.16.0/dist/pptxgen.bundle.js',
                    'https://unpkg.com/pptxgenjs@3.16.0/dist/pptxgen.bundle.js',
                    'https://cdn.jsdelivr.net/npm/pptxgenjs@3.14.0/dist/pptxgen.bundle.js',
                    'https://unpkg.com/pptxgenjs@3.14.0/dist/pptxgen.bundle.js'
                ];
                for (const url of cdns){
                    const ok = await loadScriptOnce(url);
                    if (ok && getPptxCtor()) return true;
                }
                return !!getPptxCtor();
            }catch(_){ return false; }
        }
        function getPptxCtor(){
            try{
                if (typeof window.PptxGenJS === 'function') return window.PptxGenJS;
                if (window.PptxGenJS && typeof window.PptxGenJS.default === 'function') return window.PptxGenJS.default;
                if (typeof window.pptxgen === 'function') return window.pptxgen;
                if (window.pptxgen && typeof window.pptxgen.default === 'function') return window.pptxgen.default;
                return null;
            }catch(_){ return null; }
        }
        function getPptxInstance(){
            try{
                const C = getPptxCtor();
                if (C && typeof C === 'function') {
                    try { return new C(); } catch(_) {}
                }
                if (window.pptxgen && typeof window.pptxgen === 'object' && typeof window.pptxgen.addSlide === 'function') {
                    return window.pptxgen;
                }
                if (window.PptxGenJS && typeof window.PptxGenJS === 'object' && typeof window.PptxGenJS.addSlide === 'function') {
                    return window.PptxGenJS;
                }
                return null;
            }catch(_){ return null; }
        }
        function deriveNameFromUrl(u){
            try{
                const a = new URL(u);
                const last = a.pathname.split('/').filter(Boolean).pop() || '';
                const n = decodeURIComponent(last).replace(/\.[^.]+$/, '');
                return n || 'رابط';
            }catch(_){ return 'رابط'; }
        }
        async function buildPdfBlobFromMessage(messageDiv){
            if (!window.html2pdf) return null;
            const msg = messageDiv.querySelector('.ai-message') || messageDiv;
            const container = document.createElement('div');
            container.dir = 'rtl';
            container.style.padding = '24px';
            container.style.paddingBottom = '0px';
            container.style.maxWidth = '794px';
            container.style.width = '794px';
            container.style.boxSizing = 'border-box';
            container.style.background = '#ffffff';
            container.style.color = '#111827';
            container.style.fontFamily = "'Cairo', Arial, sans-serif";
            const content = document.createElement('div');
            content.style.whiteSpace = 'pre-wrap';
            content.style.textAlign = 'justify';
            content.style.textJustify = 'inter-word';
            content.style.lineHeight = '1.9';
            content.style.fontSize = '16pt';
            content.style.wordBreak = 'break-word';
            content.style.overflowWrap = 'anywhere';
            content.style.margin = '0';
            content.innerHTML = sanitizeForPdf(msg.innerHTML || '');
            preparePdfContent(content);
            container.appendChild(content);
            document.body.appendChild(container);
            const margins = { top: 18, right: 12, bottom: 20, left: 12 };
            const opt = { margin: margins, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0, letterRendering: true, backgroundColor: '#ffffff' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['css', 'legacy'], avoid: ['table','tr','td','th','p','li','ul','ol','pre','code','h1','h2','h3','h4'] } };
            const worker = html2pdf().set(opt).from(container).toPdf();
            const blob = await worker.get('pdf').then(pdf => {
                const total = pdf.internal.getNumberOfPages();
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                for (let i = 1; i <= total; i++) {
                    pdf.setPage(i);
                    // draw white footer bar to avoid visual overlap
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(0, pageHeight - margins.bottom, pageWidth, margins.bottom, 'F');
                    // page number on top of footer bar
                    pdf.setTextColor(17, 24, 39);
                    pdf.setFontSize(12);
                    pdf.text(`${i} / ${total}`, pageWidth / 2, pageHeight - (margins.bottom / 2), { align: 'center' });
                }
                return pdf.output('blob');
            });
            container.remove();
            return blob;
        }
        async function exportMessageToPpt(aiText, fileName) {
            try {
                const ok = await ensurePptxLoaded();
                if (!ok) { showNotification('ميزة PowerPoint غير متاحة حالياً', 'error'); return; }
                const P = window.PptxGenJS || window.pptxgen || (window.PptxGenJS && window.PptxGenJS.default);
                if (!P) { showNotification('ميزة PowerPoint غير متاحة حالياً', 'error'); return; }
                const pptx = new P();
                const usedStructured = populatePptFromText(pptx, aiText);
                if (!usedStructured) {
                    const bullets = splitToBullets(aiText);
                    if (!bullets.length) {
                        const s = pptx.addSlide({ masterName: 'MASTER_CONTENT' });
                        s.addText(aiText, { x: 0.6, y: 1.2, w: 8.6, h: 5, fontSize: 18, align: 'right' });
                    } else {
                        const chunkSize = 8;
                        for (let i=0;i<bullets.length;i+=chunkSize) {
                            const s = pptx.addSlide({ masterName: 'MASTER_CONTENT' });
                            const group = bullets.slice(i, i+chunkSize);
                            const items = group.map(t => ({ text: t, options: { bullet: true } }));
                            s.addText(items, { x: 0.8, y: 1.2, w: 8.2, h: 5.2, fontSize: 18, align: 'right' });
                        }
                    }
                }
                await pptx.writeFile({ fileName });
            } catch(_) { showNotification('تعذر إنشاء العرض التقديمي', 'error'); }
        }
        async function buildPptBlobFromText(aiText){
            const ok = await ensurePptxLoaded();
            if (!ok) return null;
            const P = window.PptxGenJS || window.pptxgen || (window.PptxGenJS && window.PptxGenJS.default);
            if (!P) return null;
            const pptx = new P();
            const usedStructured = populatePptFromText(pptx, aiText);
            if (!usedStructured) {
                const bullets = splitToBullets(aiText);
                if (!bullets.length) {
                    const s = pptx.addSlide({ masterName: 'MASTER_CONTENT' });
                    s.addText(aiText, { x: 0.6, y: 1.2, w: 8.6, h: 5, fontSize: 18, align: 'right' });
                } else {
                    const chunkSize = 8;
                    for (let i=0;i<bullets.length;i+=chunkSize) {
                        const s = pptx.addSlide({ masterName: 'MASTER_CONTENT' });
                        const group = bullets.slice(i, i+chunkSize);
                        const items = group.map(t => ({ text: t, options: { bullet: true } }));
                        s.addText(items, { x: 0.8, y: 1.2, w: 8.2, h: 5.2, fontSize: 18, align: 'right' });
                    }
                }
            }
            const blob = await pptx.write('blob');
            return blob;
        }
        async function uploadBlobToSupabase(blob, fileName, contentType){
            try{
                const client = window.supabaseClient || (window.initializeSupabase && window.initializeSupabase());
                if (!client) return null;
                const uid = (currentUser && currentUser.id) || localStorage.getItem('userId') || 'anonymous';
                const path = `${uid}/${currentStamp()}/${fileName}`;
                const buckets = ['exports','documents','files','uploads','pdfs'];
                for (const b of buckets){
                    try{
                        const { error } = await client.storage.from(b).upload(path, blob, { contentType, upsert: true });
                        if (!error){
                            const { data } = client.storage.from(b).getPublicUrl(path);
                            return data && data.publicUrl ? data.publicUrl : null;
                        }
                    }catch(_){ }
                }
                return null;
            }catch(_){ return null; }
        }

        try{
            window.openProReport = openProReport;
            window.runProReportTask = runProReportTask;
            window.closeProReport = closeProReport;
            window.proReportToPdf = proReportToPdf;
            window.proReportToPpt = proReportToPpt;
            window.proReportUpload = proReportUpload;
        }catch(_){ }

        // Scroll to bottom of chat area
        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white font-medium z-50 transition-all duration-300 transform translate-x-0 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animation for removal
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                notification.classList.remove('translate-x-0');
            }, 2500);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Logout function
        async function logout() {
            try {
                if (window.supabaseAuth) {
                    await window.supabaseAuth.signOut();
                }
                localStorage.clear();
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('❌ Logout error:', error);
                window.location.href = 'auth.html';
            }
        }
    </script>
    <!-- Site Footer -->
    <footer class="mt-10 border-t bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-sm text-gray-600 flex flex-col md:flex-row items-center justify-between gap-3">
        <div>© <span id="footerYear"></span> منصة الطالب الذكي</div>
        <div class="space-x-4 space-x-reverse">
        </div>
      </div>
    </footer>
    <script>try{document.getElementById('footerYear').textContent=new Date().getFullYear()}catch(e){}</script>
    <script src="js/theme.js"></script>
</body>
</html>
