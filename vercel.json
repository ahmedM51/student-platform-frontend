const express = require('express');
const cors = require('cors');
const path = require('path');
const multer = require('multer');
const fs = require('fs');
const pdf = require('pdf-parse');
const OpenAI = require('openai');
const { GoogleGenerativeAI } = require('@google/generative-ai');
require('dotenv').config();

// Supabase Client
const { createClient } = require('@supabase/supabase-js');

// Initialize Supabase
const supabaseUrl = process.env.SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

let supabase = null;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('âŒ Missing Supabase configuration. Some features will be disabled.');
  console.log('ğŸ“ Please add SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY to Vercel environment variables');
} else {
  try {
    supabase = createClient(supabaseUrl, supabaseServiceKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    });
    console.log('âœ… Supabase client initialized with URL:', supabaseUrl.substring(0, 30) + '...');
  } catch (error) {
    console.error('âŒ Failed to initialize Supabase:', error.message);
    supabase = null;
  }
}

const app = express();
const PORT = process.env.PORT || 3000;

// Initialize AI services
let genAI = null;
let openai = null;

console.log('ğŸ” Checking AI API keys...');

if (process.env.GEMINI_API_KEY && process.env.GEMINI_API_KEY !== 'your-gemini-api-key-here') {
  try {
    genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
    console.log('âœ… Gemini AI initialized successfully');
  } catch (error) {
    console.error('âŒ Failed to initialize Gemini AI:', error.message);
    genAI = null;
  }
} else {
  console.log('âš ï¸ Gemini API key not configured');
}

if (process.env.OPENAI_API_KEY && process.env.OPENAI_API_KEY !== 'your-openai-api-key-here') {
  try {
    openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });
    console.log('âœ… OpenAI initialized successfully');
  } catch (error) {
    console.error('âŒ Failed to initialize OpenAI:', error.message);
    openai = null;
  }
} else {
  console.log('âš ï¸ OpenAI API key not configured');
}

// Create uploads directory
const uploadsDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadsDir)) {
    fs.mkdirSync(uploadsDir, { recursive: true });
}

// Configure multer for file uploads
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, uploadsDir);
  },
  filename: function (req, file, cb) {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, 'file-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const fileFilter = (req, file, cb) => {
  const allowedTypes = ['.pdf', '.doc', '.docx', '.txt'];
  const fileExt = path.extname(file.originalname).toLowerCase();
  
  if (allowedTypes.includes(fileExt)) {
    cb(null, true);
  } else {
    cb(new Error('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠÙØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ù€ PDF, DOC, DOCX, TXT'), false);
  }
};

const upload = multer({ 
  storage: storage,
  fileFilter: fileFilter,
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB
  }
});

// Middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cors());

// Serve static files from both root and public directories
app.use(express.static(__dirname)); // Serve from root directory (for index.html)
app.use(express.static(path.join(__dirname, 'public'))); // Serve from public directory
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// Route for root path to serve index.html
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

// Middleware to verify Supabase JWT token
async function verifySupabaseToken(req, res, next) {
  try {
    const authHeader = req.headers.authorization;
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({ error: 'No authorization token provided' });
    }

    const token = authHeader.substring(7);
    const { data: { user }, error } = await supabase.auth.getUser(token);
    
    if (error || !user) {
      return res.status(401).json({ error: 'Invalid token' });
    }

    req.user = user;
    next();
  } catch (error) {
    console.error('Token verification error:', error);
    res.status(401).json({ error: 'Token verification failed' });
  }
}

// Helper function to update user XP and statistics
async function updateUserXP(userId, xpToAdd, activityType, description) {
  try {
    // Get current user data
    const { data: userData, error: userError } = await supabase
      .from('users')
      .select('xp, level')
      .eq('id', userId)
      .single();

    if (userError && userError.code !== 'PGRST116') {
      console.error('Error getting user data:', userError);
      return;
    }

    const currentXP = userData?.xp || 0;
    const currentLevel = userData?.level || 1;
    const newXP = currentXP + xpToAdd;
    
    // Calculate new level (every 100 XP = 1 level)
    const newLevel = Math.floor(newXP / 100) + 1;

    // Update user XP and level
    await supabase
      .from('users')
      .upsert({
        id: userId,
        xp: newXP,
        level: newLevel,
        updated_at: new Date().toISOString()
      });

    // Record activity
    await supabase
      .from('activities')
      .insert({
        user_id: userId,
        activity_type: activityType,
        description: description,
        xp_earned: xpToAdd,
        created_at: new Date().toISOString()
      });

    console.log(`âœ… Updated user ${userId}: +${xpToAdd} XP, Level ${newLevel}`);
  } catch (error) {
    console.error('Error updating user XP:', error);
  }
}

// Routes
// Authentication endpoints
app.post('/api/auth/register', async (req, res) => {
  try {
    const { email, password, name } = req.body;
    
    if (!email || !password) {
      return res.status(400).json({ error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†' });
    }

    // Create user in Supabase Auth
    const { data, error } = await supabase.auth.admin.createUser({
      email,
      password,
      email_confirm: true,
      user_metadata: { name }
    });

    if (error) {
      console.error('Registration error:', error);
      return res.status(400).json({ error: error.message });
    }

    // Create user profile in database
    const { error: profileError } = await supabase
      .from('users')
      .insert([{
        id: data.user.id,
        email: data.user.email,
        name: name || email.split('@')[0],
        xp: 0,
        level: 1,
        created_at: new Date().toISOString()
      }]);

    if (profileError) {
      console.error('Profile creation error:', profileError);
    }

    res.json({ 
      success: true, 
      user: data.user,
      message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­'
    });

  } catch (error) {
    console.error('Registration error:', error);
    res.status(500).json({ error: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…' });
  }
});

app.post('/api/auth/login', async (req, res) => {
  try {
    const { email, password } = req.body;
    
    if (!email || !password) {
      return res.status(400).json({ error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†' });
    }

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) {
      console.error('Login error:', error);
      return res.status(400).json({ error: error.message });
    }

    res.json({ 
      success: true, 
      user: data.user,
      session: data.session,
      message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­'
    });

  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ error: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…' });
  }
});

// Dashboard statistics endpoint
app.get('/api/dashboard/stats', verifySupabaseToken, async (req, res) => {
  try {
    if (!supabase) {
      return res.json({
        totalFiles: 0,
        totalQuizzes: 0,
        studyHours: 0,
        completedTasks: 0
      });
    }

    const userId = req.user.id;

    // Get total files count
    const { count: filesCount } = await supabase
      .from('files')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', userId);

    // Get total quizzes count
    const { count: quizzesCount } = await supabase
      .from('quiz_sessions')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', userId);

    // Get study hours (mock calculation)
    const studyHours = Math.floor(Math.random() * 100) + 50;

    // Get completed tasks count
    const { count: tasksCount } = await supabase
      .from('tasks')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', userId)
      .eq('completed', true);

    res.json({
      totalFiles: filesCount || 0,
      totalQuizzes: quizzesCount || 0,
      studyHours,
      completedTasks: tasksCount || 0
    });

  } catch (error) {
    console.error('Dashboard stats error:', error);
    res.status(500).json({ error: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' });
  }
});

// Recent activities endpoint
app.get('/api/activities/recent', verifySupabaseToken, async (req, res) => {
  try {
    const userId = req.user.id;
    const limit = parseInt(req.query.limit) || 10;

    const { data, error } = await supabase
      .from('activities')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(limit);

    if (error) throw error;

    res.json(data || []);

  } catch (error) {
    console.error('Recent activities error:', error);
    res.status(500).json({ error: 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©' });
  }
});

// File upload endpoint
app.post('/api/upload', verifySupabaseToken, upload.single('file'), async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: 'Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ù…Ù„Ù' });
    }

    const userId = req.user.id;
    const file = req.file;
    const fileUrl = `/uploads/${file.filename}`;

    // Save file info to database
    const { data, error } = await supabase
      .from('files')
      .insert([{
        user_id: userId,
        name: file.filename,
        original_name: file.originalname,
        file_path: fileUrl,
        file_size: file.size,
        mime_type: file.mimetype,
        upload_status: 'completed'
      }])
      .select()
      .single();

    if (error) throw error;

    // Extract text content if PDF
    let extractedText = '';
    if (file.mimetype === 'application/pdf') {
      try {
        const dataBuffer = fs.readFileSync(file.path);
        const pdfData = await pdf(dataBuffer);
        extractedText = pdfData.text;
      } catch (pdfError) {
        console.error('PDF extraction error:', pdfError);
      }
    }

    res.json({
      success: true,
      url: fileUrl,
      path: fileUrl,
      name: file.originalname,
      size: file.size,
      type: file.mimetype,
      extractedText,
      fileId: data.id
    });

  } catch (error) {
    console.error('File upload error:', error);
    res.status(500).json({ error: 'ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù' });
  }
});

// Delete file endpoint
app.post('/api/delete-file', verifySupabaseToken, async (req, res) => {
  try {
    const { path: filePath } = req.body;
    
    if (!filePath) {
      return res.status(400).json({ error: 'Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù Ù…Ø·Ù„ÙˆØ¨' });
    }

    // Delete from filesystem
    const fullPath = path.join(__dirname, 'public', filePath);
    if (fs.existsSync(fullPath)) {
      fs.unlinkSync(fullPath);
    }

    // Delete from database
    const { error } = await supabase
      .from('files')
      .delete()
      .eq('file_path', filePath)
      .eq('user_id', req.user.id);

    if (error) throw error;

    res.json({ success: true });

  } catch (error) {
    console.error('File deletion error:', error);
    res.status(500).json({ error: 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù' });
  }
});

// AI Chat endpoint
app.post('/api/ai/ask', verifySupabaseToken, async (req, res) => {
  try {
    const { question, lectureId, context } = req.body;
    
    if (!question) {
      return res.status(400).json({ error: 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø·Ù„ÙˆØ¨' });
    }

    let response = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ.';

    // Try Gemini first
    if (genAI) {
      try {
        const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
        const prompt = context 
          ? `Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ: ${context}\n\nØ£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„: ${question}`
          : `Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©: ${question}`;
        
        const result = await model.generateContent(prompt);
        response = result.response.text();
      } catch (geminiError) {
        console.error('Gemini error:', geminiError);
        
        // Fallback to OpenAI
        if (openai) {
          try {
            const completion = await openai.chat.completions.create({
              model: 'gpt-3.5-turbo',
              messages: [
                {
                  role: 'system',
                  content: 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø°ÙƒÙŠ. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.'
                },
                {
                  role: 'user',
                  content: context 
                    ? `Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${context}\n\nØ£Ø¬Ø¨ Ø¹Ù„Ù‰: ${question}`
                    : question
                }
              ],
              max_tokens: 500
            });
            
            response = completion.choices[0]?.message?.content || response;
          } catch (openaiError) {
            console.error('OpenAI error:', openaiError);
          }
        }
      }
    }

    // Log activity
    await supabase
      .from('activities')
      .insert([{
        user_id: req.user.id,
        activity_type: 'ai_question',
        title: 'Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ',
        description: question.substring(0, 100) + '...',
        metadata: { question, response: response.substring(0, 100) }
      }]);

    res.json({ response });

  } catch (error) {
    console.error('AI ask error:', error);
    res.status(500).json({ error: 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø©' });
  }
});

// Quiz generation endpoint
app.post('/api/ai/generate-quiz', verifySupabaseToken, async (req, res) => {
  try {
    const { lectureIds, questionCount = 5, difficulty = 'medium' } = req.body;
    
    if (!lectureIds || lectureIds.length === 0) {
      return res.status(400).json({ error: 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' });
    }

    // Get lecture content
    const { data: lectures, error } = await supabase
      .from('lectures')
      .select('title, content, description')
      .in('id', lectureIds)
      .eq('user_id', req.user.id);

    if (error) throw error;

    const content = lectures.map(l => `${l.title}: ${l.content || l.description}`).join('\n\n');
    
    let quiz = {
      questions: [],
      totalQuestions: questionCount,
      difficulty
    };

    // Try to generate quiz with AI
    if (genAI) {
      try {
        const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
        const prompt = `
Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠØŒ Ø£Ù†Ø´Ø¦ ${questionCount} Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:

${content}

Ù‚Ù… Ø¨Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨ØµÙŠØºØ© JSON ÙÙ‚Ø· Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚:
{
  "questions": [
    {
      "question": "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„",
      "options": ["Ø§Ù„Ø®ÙŠØ§Ø± 1", "Ø§Ù„Ø®ÙŠØ§Ø± 2", "Ø§Ù„Ø®ÙŠØ§Ø± 3", "Ø§Ù„Ø®ÙŠØ§Ø± 4"],
      "correct": 0,
      "explanation": "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©"
    }
  ]
}
        `;
        
        const result = await model.generateContent(prompt);
        const responseText = result.response.text();
        
        try {
          const parsed = JSON.parse(responseText);
          quiz = { ...quiz, ...parsed };
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          // Fallback to default questions
          quiz.questions = generateFallbackQuiz(content, questionCount);
        }
      } catch (aiError) {
        console.error('AI quiz generation error:', aiError);
        quiz.questions = generateFallbackQuiz(content, questionCount);
      }
    } else {
      quiz.questions = generateFallbackQuiz(content, questionCount);
    }

    // Save quiz to database
    const { data: savedQuiz, error: saveError } = await supabase
      .from('quizzes')
      .insert([{
        user_id: req.user.id,
        title: `Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ - ${new Date().toLocaleDateString('ar-SA')}`,
        questions: quiz.questions,
        total_questions: quiz.questions.length,
        difficulty
      }])
      .select()
      .single();

    if (saveError) throw saveError;

    res.json({ ...quiz, id: savedQuiz.id });

  } catch (error) {
    console.error('Quiz generation error:', error);
    res.status(500).json({ error: 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' });
  }
});

// Fallback quiz generation
function generateFallbackQuiz(content, questionCount) {
  const questions = [];
  const keywords = content.split(' ').filter(word => word.length > 4).slice(0, questionCount);
  
  for (let i = 0; i < Math.min(questionCount, keywords.length); i++) {
    questions.push({
      question: `Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù€ "${keywords[i]}"ØŸ`,
      options: [
        `ØªØ¹Ø±ÙŠÙ ØµØ­ÙŠØ­ Ù„Ù€ ${keywords[i]}`,
        `ØªØ¹Ø±ÙŠÙ Ø®Ø§Ø·Ø¦ Ù„Ù€ ${keywords[i]}`,
        `Ù…ÙÙ‡ÙˆÙ… Ø¢Ø®Ø±`,
        `Ù„Ø§ Ø£Ø¹Ø±Ù`
      ],
      correct: 0,
      explanation: `Ù‡Ø°Ø§ Ø³Ø¤Ø§Ù„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­ÙˆÙ„ "${keywords[i]}"`
    });
  }
  
  return questions;
}

// Error handling middleware
app.use((error, req, res, next) => {
  console.error('Server error:', error);
  res.status(500).json({ error: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…' });
});

// Start server
app.listen(PORT, () => {
  console.log(`ğŸš€ Server running on http://localhost:${PORT}`);
  console.log(`ğŸ“Š Dashboard: http://localhost:${PORT}`);
  console.log(`ğŸ” Auth: http://localhost:${PORT}/auth.html`);
});
